---
phase: 05-attachment-manager-foundation
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - pkg/attachment/manager_test.go
  - pkg/attachment/lock_test.go
autonomous: true

must_haves:
  truths:
    - "Unit tests verify AttachmentManager tracks and untracks attachments correctly"
    - "Unit tests verify per-volume locking serializes concurrent operations"
    - "Unit tests verify state rebuild from PV annotations"
  artifacts:
    - path: "pkg/attachment/manager_test.go"
      provides: "Comprehensive unit tests for AttachmentManager"
      contains: "func Test"
      min_lines: 150
    - path: "pkg/attachment/lock_test.go"
      provides: "Unit tests for VolumeLockManager"
      contains: "func Test"
  key_links:
    - from: "pkg/attachment/manager_test.go"
      to: "fake.NewSimpleClientset"
      via: "mock Kubernetes client for testing"
      pattern: "fake\\.NewSimpleClientset"
---

<objective>
Create comprehensive unit tests for the AttachmentManager package.

Purpose: Verify correctness of in-memory tracking, per-volume locking, PV annotation persistence, and state rebuild. Tests use fake Kubernetes client for isolation.

Output: Unit tests covering FENCE-01, FENCE-02, FENCE-03, FENCE-04 requirements with good coverage of edge cases.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.3-ROADMAP.md
@.planning/phases/05-attachment-manager-foundation/05-RESEARCH.md
@.planning/phases/05-attachment-manager-foundation/05-02-SUMMARY.md
@pkg/attachment/manager.go
@pkg/attachment/lock.go
@pkg/attachment/persist.go
@pkg/attachment/rebuild.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VolumeLockManager tests</name>
  <files>pkg/attachment/lock_test.go</files>
  <action>
Create unit tests for VolumeLockManager:

**lock_test.go:**
```go
package attachment

import (
    "sync"
    "testing"
    "time"
)
```

**Test cases:**

1. TestVolumeLockManager_LockUnlock:
   - Create new VolumeLockManager
   - Lock volumeID "vol-1"
   - Verify lock is held (try to lock from goroutine, should block)
   - Unlock "vol-1"
   - Verify can now acquire lock

2. TestVolumeLockManager_DifferentVolumes:
   - Lock "vol-1"
   - Lock "vol-2" from different goroutine (should not block)
   - Verify both locks held independently
   - Unlock both

3. TestVolumeLockManager_ConcurrentSameVolume:
   - Start N goroutines all trying to Lock same volumeID
   - Each goroutine increments a counter while holding lock
   - Verify final counter == N (proves serialization)
   - Use sync.WaitGroup for coordination

4. TestVolumeLockManager_UnlockNonExistent:
   - Create new manager
   - Unlock "vol-nonexistent" (should not panic)
   - Verify no error

Use testing patterns from existing codebase (pkg/nvme/nvme_test.go, pkg/rds/commands_test.go).
  </action>
  <verify>
Run: `go test ./pkg/attachment/... -v -run TestVolumeLockManager`
Expected: All tests pass
  </verify>
  <done>
- TestVolumeLockManager_LockUnlock verifies basic lock/unlock cycle
- TestVolumeLockManager_DifferentVolumes verifies independent per-volume locks
- TestVolumeLockManager_ConcurrentSameVolume verifies serialization
- TestVolumeLockManager_UnlockNonExistent verifies safe unlock of unknown volume
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AttachmentManager core tests</name>
  <files>pkg/attachment/manager_test.go</files>
  <action>
Create unit tests for AttachmentManager in-memory operations:

**manager_test.go:**
```go
package attachment

import (
    "context"
    "testing"
    "time"

    corev1 "k8s.io/api/core/v1"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
    "k8s.io/client-go/kubernetes/fake"
)
```

**Test cases for in-memory tracking:**

1. TestAttachmentManager_TrackAttachment:
   - Create AttachmentManager with nil k8sClient
   - TrackAttachment("vol-1", "node-1")
   - GetAttachment("vol-1") should return state with correct nodeID
   - Verify AttachedAt is set to approximately now

2. TestAttachmentManager_TrackAttachment_Idempotent:
   - TrackAttachment("vol-1", "node-1") twice
   - Second call should return nil (success)
   - GetAttachment should still show single entry

3. TestAttachmentManager_TrackAttachment_ConflictError:
   - TrackAttachment("vol-1", "node-1")
   - TrackAttachment("vol-1", "node-2") should return error
   - Error message should mention "already attached to node node-1"

4. TestAttachmentManager_UntrackAttachment:
   - TrackAttachment("vol-1", "node-1")
   - UntrackAttachment("vol-1")
   - GetAttachment("vol-1") should return false

5. TestAttachmentManager_UntrackAttachment_Idempotent:
   - UntrackAttachment("vol-nonexistent") should return nil
   - UntrackAttachment on already untracked should return nil

6. TestAttachmentManager_ListAttachments:
   - Track multiple volumes
   - ListAttachments() should return all
   - Modify returned map, verify internal state unchanged (copy returned)

7. TestAttachmentManager_ConcurrentTrack:
   - Start N goroutines, each tracking different volumes
   - All should succeed without race conditions
   - Run with -race flag

Use context.Background() for all calls.
  </action>
  <verify>
Run: `go test ./pkg/attachment/... -v -run TestAttachmentManager -race`
Expected: All tests pass, no race conditions detected
  </verify>
  <done>
- Core tracking tests pass
- Idempotency tests verify duplicate tracking works
- Conflict detection test verifies error on different node
- Untrack tests verify removal and idempotency
- Concurrent test verifies thread safety under -race
  </done>
</task>

<task type="auto">
  <name>Task 3: Create persistence and rebuild tests</name>
  <files>pkg/attachment/manager_test.go</files>
  <action>
Add tests for PV annotation persistence and state rebuild:

**Helper function:**
```go
func createTestPV(volumeID, nodeID string) *corev1.PersistentVolume {
    pv := &corev1.PersistentVolume{
        ObjectMeta: metav1.ObjectMeta{
            Name: volumeID,
        },
        Spec: corev1.PersistentVolumeSpec{
            CSI: &corev1.CSIPersistentVolumeSource{
                Driver:       "rds.csi.srvlab.io",
                VolumeHandle: volumeID,
            },
        },
    }
    if nodeID != "" {
        pv.Annotations = map[string]string{
            AnnotationAttachedNode: nodeID,
            AnnotationAttachedAt:   time.Now().Format(time.RFC3339),
        }
    }
    return pv
}
```

**Test cases:**

1. TestAttachmentManager_PersistAttachment:
   - Create fake clientset with a PV
   - Create AttachmentManager with fake client
   - TrackAttachment("vol-1", "node-1")
   - Get PV from fake client
   - Verify annotation AnnotationAttachedNode == "node-1"
   - Verify AnnotationAttachedAt is set

2. TestAttachmentManager_ClearAttachment:
   - Create PV with attachment annotations
   - Create AttachmentManager, track, then untrack
   - Verify annotations removed from PV

3. TestAttachmentManager_RebuildState:
   - Create fake clientset with 3 PVs:
     - pv-1: attached to node-a (has annotations)
     - pv-2: attached to node-b (has annotations)
     - pv-3: no annotations (not attached)
   - Create AttachmentManager
   - Call Initialize()
   - Verify ListAttachments() returns 2 entries
   - Verify correct volume-to-node mappings

4. TestAttachmentManager_RebuildState_IgnoresOtherDrivers:
   - Create PV with different driver name (e.g., "other.csi.io")
   - RebuildState should not include it

5. TestAttachmentManager_RebuildState_NoClient:
   - Create AttachmentManager with nil k8sClient
   - RebuildState should return nil (not error)

6. TestAttachmentManager_PersistRollback:
   - Simulate persistence failure (e.g., PV doesn't exist)
   - Verify in-memory state is rolled back
   - GetAttachment should return false after failed track

Note: fake.NewSimpleClientset doesn't support RetryOnConflict testing well.
For conflict tests, verify the code path exists but accept that fake client
doesn't simulate real conflicts.
  </action>
  <verify>
Run: `go test ./pkg/attachment/... -v -race`
Expected: All tests pass
Run: `go test ./pkg/attachment/... -cover`
Expected: Coverage > 70%
  </verify>
  <done>
- Persistence test verifies annotations written to PV
- Clear test verifies annotations removed
- Rebuild test verifies state reconstructed from PV annotations
- Filter test verifies only rds.csi.srvlab.io PVs processed
- Nil client test verifies graceful handling
- All tests pass with race detector
- Coverage > 70%
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go test ./pkg/attachment/... -v -race` - all tests pass, no races
2. `go test ./pkg/attachment/... -cover` - coverage > 70%
3. `make test` - full test suite passes
</verification>

<success_criteria>
- [ ] lock_test.go tests VolumeLockManager lock/unlock, independence, concurrency
- [ ] manager_test.go tests TrackAttachment, UntrackAttachment, GetAttachment, ListAttachments
- [ ] manager_test.go tests idempotency and conflict detection
- [ ] manager_test.go tests PV annotation persistence and clearing
- [ ] manager_test.go tests RebuildState from PV annotations
- [ ] All tests pass with -race flag
- [ ] Coverage > 70% for pkg/attachment
- [ ] make test passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-attachment-manager-foundation/05-03-SUMMARY.md`
</output>
