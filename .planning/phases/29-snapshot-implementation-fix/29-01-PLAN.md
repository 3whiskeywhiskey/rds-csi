---
phase: 29-snapshot-implementation-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/rds/types.go
  - pkg/rds/commands.go
  - pkg/rds/client.go
  - pkg/utils/snapshotid.go
  - pkg/rds/commands_test.go
autonomous: true

must_haves:
  truths:
    - "CreateSnapshot uses /disk add copy-from= instead of /disk/btrfs/subvolume/add"
    - "Snapshot disks have NO NVMe-tcp-export flags (not network-exported)"
    - "DeleteSnapshot removes disk entry AND backing .img file (belt and suspenders)"
    - "GetSnapshot uses /disk print detail where slot= instead of /disk/btrfs/subvolume/print"
    - "ListSnapshots uses /disk print detail where slot~snap- instead of /disk/btrfs/subvolume/print"
    - "RestoreSnapshot uses /disk add copy-from=<snapshot-slot> with full NVMe export flags"
    - "Snapshot ID format is snap-<source-pvc-uuid>-at-<unix-timestamp>"
  artifacts:
    - path: "pkg/rds/commands.go"
      provides: "Rewritten snapshot SSH commands using /disk add copy-from"
      contains: "copy-from"
    - path: "pkg/rds/types.go"
      provides: "Updated SnapshotInfo and CreateSnapshotOptions types"
      contains: "CreateSnapshotOptions"
    - path: "pkg/utils/snapshotid.go"
      provides: "New snapshot ID generation with timestamp format"
      contains: "snap-"
    - path: "pkg/rds/client.go"
      provides: "Updated RDSClient interface if signatures change"
  key_links:
    - from: "pkg/rds/commands.go CreateSnapshot"
      to: "RouterOS /disk add copy-from="
      via: "SSH command execution"
      pattern: "/disk add.*copy-from"
    - from: "pkg/rds/commands.go DeleteSnapshot"
      to: "RouterOS /disk remove + /file remove"
      via: "SSH command execution"
      pattern: "/disk remove"
---

<objective>
Rewrite all SSH snapshot commands in pkg/rds/ to use RouterOS `/disk add copy-from` CoW instead of broken `/disk/btrfs/subvolume` operations.

Purpose: The v0.10.0 snapshot implementation incorrectly used Btrfs subvolume commands, which don't work for file-backed disk images. File-backed disks on RDS use `/disk add copy-from` for CoW copies on the underlying Btrfs filesystem. This plan rewrites the RDS SSH layer while keeping the RDSClient interface stable for the controller layer.

Output: Working snapshot SSH commands (create, delete, get, list, restore) using `/disk add copy-from` semantics, updated types, updated snapshot ID format, and passing unit tests.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-snapshot-implementation-fix/29-CONTEXT.md
@pkg/rds/commands.go
@pkg/rds/types.go
@pkg/rds/client.go
@pkg/utils/snapshotid.go
@pkg/rds/commands_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update snapshot types, ID generation, and RDSClient interface</name>
  <files>
    pkg/rds/types.go
    pkg/utils/snapshotid.go
    pkg/rds/client.go
  </files>
  <action>
  **pkg/utils/snapshotid.go — Rewrite snapshot ID generation:**

  The snapshot ID format changes from `snap-<deterministic-uuid>` to `snap-<source-pvc-uuid>-at-<unix-timestamp>`.

  1. Remove `SnapshotNameToID()` (no longer needed — CSI controller builds the ID directly).
  2. Add `GenerateSnapshotIDFromSource(sourceVolumeID string) string`:
     - Extracts the UUID portion from the source volume ID (strip `pvc-` prefix).
     - Appends `-at-<unix-timestamp>` using `time.Now().Unix()`.
     - Returns `snap-<source-uuid>-at-<timestamp>`.
     - Example: source `pvc-a1b2c3d4-e5f6-7890-abcd-ef1234567890` -> `snap-a1b2c3d4-e5f6-7890-abcd-ef1234567890-at-1739800000`.
  3. Add `ExtractSourceVolumeIDFromSnapshotID(snapshotID string) (string, error)`:
     - Parses `snap-<uuid>-at-<timestamp>` format.
     - Returns `pvc-<uuid>` (the source volume ID).
     - Returns error if format doesn't match.
  4. Add `ExtractTimestampFromSnapshotID(snapshotID string) (int64, error)`:
     - Parses the `-at-<timestamp>` suffix.
     - Returns Unix timestamp as int64.
  5. Update `ValidateSnapshotID()`:
     - Change the strict pattern to match `snap-<uuid>-at-<digits>` format.
     - Pattern: `^snap-[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}-at-\d+$`
     - Keep the fallback for CSI sanity test IDs (alphanumeric + hyphens, no snap- prefix).
  6. Keep `GenerateSnapshotID()` for backward compatibility but mark deprecated (or remove if not used elsewhere).

  **pkg/rds/types.go — Update snapshot types:**

  1. Update `CreateSnapshotOptions`:
     - Remove `FSLabel` field (no longer needed — not using Btrfs subvolume commands).
     - Add `BasePath string` field (for constructing the snapshot file path, e.g., `/storage-pool/metal-csi`).
     - Keep `Name` and `SourceVolume` fields.
  2. Update `SnapshotInfo`:
     - Remove `ReadOnly` field (snapshots are inherently non-exported, no read-only flag).
     - Remove `FSLabel` field.
     - Add `FilePath string` field (the backing file path on RDS).
     - Keep `Name`, `SourceVolume`, `FileSizeBytes`, `CreatedAt`.
  3. Keep `SnapshotNotFoundError` unchanged.

  **pkg/rds/client.go — Update interface if signatures changed:**

  The `RDSClient` interface method signatures should remain the same since `CreateSnapshotOptions` is passed by value. Just verify the interface compiles with the new types.
  </action>
  <verify>
  Run `cd /Users/whiskey/code/rds-csi && go build ./...` — must compile without errors.
  Run `go vet ./pkg/utils/... ./pkg/rds/...` — no issues.
  </verify>
  <done>
  - `CreateSnapshotOptions` has `BasePath` instead of `FSLabel`
  - `SnapshotInfo` has `FilePath` instead of `ReadOnly`/`FSLabel`
  - `ValidateSnapshotID` accepts new `snap-<uuid>-at-<timestamp>` format
  - `GenerateSnapshotIDFromSource()` produces correct format
  - `ExtractSourceVolumeIDFromSnapshotID()` round-trips correctly
  - Code compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite SSH snapshot commands to use /disk add copy-from</name>
  <files>
    pkg/rds/commands.go
    pkg/rds/commands_test.go
  </files>
  <action>
  **pkg/rds/commands.go — Rewrite all 5 snapshot functions:**

  1. **CreateSnapshot** — Complete rewrite:
     - Validate: `validateSlotName(opts.Name)`, `validateSlotName(opts.SourceVolume)`, `opts.BasePath != ""`.
     - Get source volume info via `c.GetVolume(opts.SourceVolume)` to verify it exists and get its file size.
     - Build snapshot file path: `fmt.Sprintf("%s/%s.img", opts.BasePath, opts.Name)`.
     - Build command: `/disk add type=file copy-from=[find slot=<source-slot>] file-path=<snap-path> slot=<snap-name>`
       - **NO** `nvme-tcp-export`, `nvme-tcp-server-port`, or `nvme-tcp-server-nqn` flags (locked decision: snapshots not NVMe-exported).
       - **Omit** `file-size` — let `copy-from` determine size from source (Claude's discretion).
       - Reference source by slot name using `[find slot=<source>]` (Claude's discretion: slot name is more reliable than file path because it's validated and unique).
     - Execute with retry (3 attempts).
     - Verify snapshot was created via `c.GetSnapshot(opts.Name)`.
     - Populate `SnapshotInfo` with: Name, SourceVolume (from opts), FileSizeBytes (from source volume), CreatedAt (parse from snapshot name timestamp or use time.Now()), FilePath.
     - Return `*SnapshotInfo`.

  2. **DeleteSnapshot** — Rewrite to use `/disk remove` + file cleanup:
     - Validate snapshot ID.
     - Get snapshot info first (for file path). If not found, return nil (idempotent).
     - Step 1: `/disk remove [find slot=<snapshotID>]` — remove disk entry.
     - Step 2: `c.DeleteFile(snapshot.FilePath)` — delete backing .img file (belt and suspenders per locked decision).
     - Log warning (don't fail) if file delete fails (orphan reconciler can clean up).
     - Return nil on success.

  3. **GetSnapshot** — Rewrite to use `/disk print`:
     - Validate snapshot ID.
     - Build command: `/disk print detail where slot=<snapshotID>`.
     - Execute command.
     - Check for empty output (snapshot not found -> `SnapshotNotFoundError`).
     - Parse using `parseSnapshotInfo()` (rewritten below).
     - Return `*SnapshotInfo`.

  4. **ListSnapshots** — Rewrite to use `/disk print`:
     - Build command: `/disk print detail where slot~"snap-"` (matches all snapshot slots).
     - Execute command.
     - Parse using `parseSnapshotList()` (rewritten below).
     - Return `[]SnapshotInfo`.

  5. **RestoreSnapshot** — Rewrite to use `/disk add copy-from`:
     - Validate snapshot ID and new volume options.
     - Verify snapshot exists via `c.GetSnapshot(snapshotID)`.
     - Build command: `/disk add type=file copy-from=[find slot=<snapshotID>] file-path=<new-vol-path> file-size=<size> slot=<new-vol-slot> nvme-tcp-export=yes nvme-tcp-server-port=<port> nvme-tcp-server-nqn=<nqn>`
       - This is essentially `CreateVolume` but with `copy-from` added to populate the file from the snapshot.
       - Include file-size for the restored volume (required for NVMe export, and allows larger-than-snapshot restores per CSI spec).
     - Execute with retry.
     - Verify new volume exists via `c.VerifyVolumeExists(newVolumeOpts.Slot)`.
     - Return nil.

  **Rewrite parseSnapshotInfo():**
  - Parse `/disk print detail` output (same format as `parseVolumeInfo`).
  - Extract: `slot` -> Name, `file-path` -> FilePath, `file-size` -> FileSizeBytes.
  - Extract `source-volume` if present (mock server provides this; real RDS may not).
  - If `source-volume` not in output, attempt to extract from slot name using `ExtractSourceVolumeIDFromSnapshotID()`.
  - Extract creation time: try `creation-time` field first, then fall back to parsing timestamp from snapshot name.
  - **Key difference from parseVolumeInfo**: snapshot entries have NO nvme-tcp-export fields. Check `NVMETCPExport == false` to confirm it's a snapshot (or just parse what's there).

  **Rewrite parseSnapshotList():**
  - Same split-by-entry pattern as `parseVolumeList()`.
  - Only include entries with `snap-` prefix in slot name.
  - Return `[]SnapshotInfo`.

  **pkg/rds/commands_test.go — Update snapshot tests:**
  - Update `TestParseSnapshotInfo` test cases:
    - Change input from `/disk/btrfs/subvolume/print` format to `/disk print detail` format (key=value pairs like existing volume tests).
    - Test cases: snapshot with all fields, snapshot with minimal fields, empty output.
  - Update `TestParseSnapshotList` test cases similarly.
  - Update `TestMockClientSnapshotOperations`:
    - Use new `CreateSnapshotOptions` (with `BasePath` instead of `FSLabel`).
    - Verify snapshot name format matches `snap-<uuid>-at-<ts>`.
    - Keep existing test flow: create -> get -> list -> delete -> verify idempotent delete.
  </action>
  <verify>
  Run `cd /Users/whiskey/code/rds-csi && go test ./pkg/rds/... -v -run TestParseSnapshot` — snapshot parsing tests pass.
  Run `go test ./pkg/rds/... -v -run TestMockClient` — mock client tests pass.
  Run `go test ./pkg/utils/... -v` — snapshot ID tests pass.
  Run `make test` — all tests pass.
  Run `make lint` — no lint errors.
  </verify>
  <done>
  - `CreateSnapshot` uses `/disk add type=file copy-from=[find slot=...]` with NO NVMe flags
  - `DeleteSnapshot` uses `/disk remove` + `DeleteFile` (belt and suspenders)
  - `GetSnapshot` uses `/disk print detail where slot=`
  - `ListSnapshots` uses `/disk print detail where slot~"snap-"`
  - `RestoreSnapshot` uses `/disk add type=file copy-from=[find slot=...]` with full NVMe flags
  - All snapshot parsing tests updated and passing
  - `make test` passes with zero failures
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — entire project compiles
2. `go test ./pkg/rds/... -v` — all RDS package tests pass
3. `go test ./pkg/utils/... -v` — all utils package tests pass
4. `make test` — full test suite passes
5. `make lint` — no linting errors
6. Grep for `/disk/btrfs/subvolume` in `pkg/rds/commands.go` — zero matches (old approach completely removed)
7. Grep for `copy-from` in `pkg/rds/commands.go` — matches found in CreateSnapshot and RestoreSnapshot
</verification>

<success_criteria>
- All snapshot SSH commands use `/disk add copy-from` or `/disk print`/`/disk remove` — NO `/disk/btrfs/subvolume` references remain
- Snapshot disks are created without NVMe export flags
- Snapshot ID format is `snap-<source-uuid>-at-<timestamp>`
- Delete removes both disk entry and backing file
- Restore produces a new NVMe-exported volume from snapshot data
- All tests pass, code compiles, linter clean
</success_criteria>

<output>
After completion, create `.planning/phases/29-snapshot-implementation-fix/29-01-SUMMARY.md`
</output>
