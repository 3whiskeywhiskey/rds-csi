---
phase: 10-observability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/events.go
  - pkg/driver/events_test.go
autonomous: true

must_haves:
  truths:
    - "MigrationStarted event posts to PVC when secondary node attaches"
    - "MigrationCompleted event posts to PVC when source node detaches"
    - "MigrationFailed event posts to PVC when migration times out"
  artifacts:
    - path: "pkg/driver/events.go"
      provides: "Migration event posting methods"
      contains: "PostMigrationStarted"
    - path: "pkg/driver/events_test.go"
      provides: "Unit tests for migration events"
      contains: "TestPostMigrationStarted"
  key_links:
    - from: "pkg/driver/events.go"
      to: "k8s.io/client-go/tools/record"
      via: "recorder.Event"
      pattern: "ep\\.recorder\\.Event.*MigrationStarted"
---

<objective>
Add Kubernetes events for migration lifecycle to provide operator visibility.

Purpose: Operators need to see migration events in `kubectl describe pvc` output. Events show when migrations start, complete, or fail, with context about source/target nodes and duration.

Output: Three new event posting methods (PostMigrationStarted, PostMigrationCompleted, PostMigrationFailed) in pkg/driver/events.go.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-observability/10-RESEARCH.md

# Existing event infrastructure to extend
@pkg/driver/events.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration event reason constants</name>
  <files>pkg/driver/events.go</files>
  <action>
Add three new event reason constants to the const block in events.go:

```go
// Migration lifecycle events
EventReasonMigrationStarted   = "MigrationStarted"
EventReasonMigrationCompleted = "MigrationCompleted"
EventReasonMigrationFailed    = "MigrationFailed"
```

Add them in the existing const block after the attachment lifecycle events.
  </action>
  <verify>
Run `go build ./pkg/driver/...` to verify compilation.
  </verify>
  <done>Three migration event reason constants defined in events.go.</done>
</task>

<task type="auto">
  <name>Task 2: Implement migration event posting methods</name>
  <files>pkg/driver/events.go</files>
  <action>
Add three methods to EventPoster following the existing pattern (e.g., PostVolumeAttached):

1. PostMigrationStarted(ctx context.Context, pvcNamespace, pvcName, volumeID, sourceNode, targetNode string, timeout time.Duration) error
   - Event type: corev1.EventTypeNormal
   - Reason: EventReasonMigrationStarted
   - Message format: "[volumeID]: KubeVirt live migration started - source: sourceNode, target: targetNode, timeout: timeout"
   - Get PVC via clientset, gracefully handle missing PVC (log warning, return nil)
   - Record metric via ep.metrics.RecordEventPosted() if metrics non-nil

2. PostMigrationCompleted(ctx context.Context, pvcNamespace, pvcName, volumeID, sourceNode, targetNode string, duration time.Duration) error
   - Event type: corev1.EventTypeNormal
   - Reason: EventReasonMigrationCompleted
   - Message format: "[volumeID]: KubeVirt live migration completed - source: sourceNode -> target: targetNode (duration: duration.Round(time.Second))"
   - Same PVC handling pattern

3. PostMigrationFailed(ctx context.Context, pvcNamespace, pvcName, volumeID, sourceNode, targetNode, reason string, duration time.Duration) error
   - Event type: corev1.EventTypeWarning (not Normal - this is a failure)
   - Reason: EventReasonMigrationFailed
   - Message format: "[volumeID]: KubeVirt live migration failed - source: sourceNode, attempted target: targetNode, reason: reason, elapsed: duration.Round(time.Second)"
   - Same PVC handling pattern

All methods should log at V(2) level when event is posted, following existing pattern.
  </action>
  <verify>
Run `go build ./pkg/driver/...` to verify compilation.
  </verify>
  <done>PostMigrationStarted, PostMigrationCompleted, and PostMigrationFailed methods exist on EventPoster.</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for migration events</name>
  <files>pkg/driver/events_test.go</files>
  <action>
Add tests for the three new migration event methods. Follow existing test patterns in events_test.go.

Test cases:

1. TestPostMigrationStarted
   - Mock clientset with fake PVC
   - Call PostMigrationStarted with test values
   - Verify event was recorded (check recorder events or follow existing test pattern)
   - Verify message contains source node, target node, and timeout

2. TestPostMigrationStarted_PVCNotFound
   - Mock clientset returning error for PVC get
   - Verify method returns nil (graceful handling)
   - Verify warning logged (or follow existing pattern for testing this)

3. TestPostMigrationCompleted
   - Verify Normal event with correct message format
   - Verify duration is rounded to seconds in message

4. TestPostMigrationFailed
   - Verify Warning event type (not Normal)
   - Verify message includes reason and elapsed time

If existing tests use a specific fake client pattern, follow that pattern.
  </action>
  <verify>
Run `go test -v ./pkg/driver/... -run Migration` to verify tests pass.
  </verify>
  <done>All migration event tests pass.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go test -v ./pkg/driver/...` passes all tests including new migration tests
3. Manually inspect events.go to confirm:
   - Three event reason constants
   - Three PostMigration* methods with correct signatures
   - Warning type for Failed, Normal type for Started/Completed
</verification>

<success_criteria>
- MigrationStarted, MigrationCompleted, MigrationFailed event reason constants defined
- PostMigrationStarted posts Normal event with source/target/timeout context
- PostMigrationCompleted posts Normal event with source/target/duration context
- PostMigrationFailed posts Warning event with source/target/reason/elapsed context
- Graceful handling when PVC cannot be found (no error returned)
- All new functionality has unit test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/10-observability/10-02-SUMMARY.md`
</output>
