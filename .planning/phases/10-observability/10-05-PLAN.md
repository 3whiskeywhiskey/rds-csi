---
phase: 10-observability
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/controller.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "MigrationCompleted event posts to PVC when source node detaches during migration"
    - "Event contains accurate source node, target node, and duration"
  artifacts:
    - path: "pkg/driver/controller.go"
      provides: "PostMigrationCompleted call in ControllerUnpublishVolume"
      contains: "PostMigrationCompleted"
  key_links:
    - from: "pkg/driver/controller.go"
      to: "pkg/driver/events.go"
      via: "eventPoster.PostMigrationCompleted"
      pattern: "PostMigrationCompleted"
---

<objective>
Wire PostMigrationCompleted event into ControllerUnpublishVolume

Purpose: Close the verification gap where MigrationCompleted event method exists but is never called, preventing operators from seeing when migrations complete successfully via kubectl describe pvc.

Output: ControllerUnpublishVolume posts MigrationCompleted event when source node detaches during an active migration (fullyDetached=false after RemoveNodeAttachment).
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.5-ROADMAP.md
@.planning/phases/10-observability/10-VERIFICATION.md
@.planning/phases/10-observability/10-03-SUMMARY.md

Key files to reference:
@pkg/driver/controller.go (ControllerUnpublishVolume at ~line 703, pattern from ControllerPublishVolume at ~line 595)
@pkg/driver/events.go (PostMigrationCompleted at line 357-375)
@pkg/attachment/types.go (AttachmentState with IsMigrating, MigrationStartedAt, Nodes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire PostMigrationCompleted in ControllerUnpublishVolume</name>
  <files>pkg/driver/controller.go</files>
  <action>
Modify ControllerUnpublishVolume to post MigrationCompleted event when a migration completes successfully. Follow the same pattern used for PostMigrationStarted in ControllerPublishVolume.

**Before RemoveNodeAttachment call (~line 732):**
1. Query attachment state using `am.GetAttachment(volumeID)`
2. Check if currently migrating via `existing.IsMigrating()`
3. If migrating, capture:
   - `sourceNode := existing.Nodes[0].NodeID` (node being removed)
   - `targetNode := existing.Nodes[1].NodeID` (node remaining after migration)
   - `migrationStartedAt := *existing.MigrationStartedAt` (copy value before it's cleared)
4. Store boolean `wasMigrating` and captured values for use after RemoveNodeAttachment

**After RemoveNodeAttachment call (~line 743-749):**
In the `else` block where `fullyDetached == false` (partial detach), add:
1. Check `wasMigrating` boolean
2. If true, calculate `duration := time.Since(migrationStartedAt)`
3. Get PVC namespace/name from volume context (note: ControllerUnpublishVolume doesn't have VolumeContext in the request - need to use a different approach)

**VolumeContext problem:** ControllerUnpublishVolumeRequest does NOT include VolumeContext. We cannot get PVC namespace/name directly from the request.

**Alternative approach:** Store PVC namespace/name in AttachmentState when migration starts (in AddSecondaryAttachment), then retrieve it during unpublish.

**Simpler alternative:** Skip event posting in ControllerUnpublishVolume. Instead, the existing metrics recording in RemoveNodeAttachment is sufficient for observability. Document this limitation.

**Recommended approach:** Since the metric is already recorded (`RecordMigrationResult("success", duration)` in manager.go line 359), and getting PVC info in ControllerUnpublishVolume would require either:
- Passing VolumeContext through the request (not available in CSI spec)
- Storing PVC info in AttachmentState (requires changing 3 files)
- Querying PV to get PVC (expensive API call)

The most pragmatic solution is to post the event from ControllerUnpublishVolume by querying the PV to get PVC info. This follows the existing pattern where we have volumeID and can look up the PVC via the PV.

**Implementation steps:**
1. After detecting `wasMigrating && !fullyDetached`:
2. Look up PV via volumeID (PV name often matches volumeID for CSI volumes)
3. Get PVC namespace/name from PV.spec.claimRef
4. Post MigrationCompleted event

If PV lookup fails, log warning and skip event (best effort, same as other events).

Add this code block in the `else` branch after `fullyDetached` check (~line 743):

```go
// Check if this was a migration completion (partial detach = source node removed, target remains)
if wasMigrating && cs.driver.k8sClient != nil {
    duration := time.Since(migrationStartedAt)

    // Look up PV to get PVC reference
    pv, err := cs.driver.k8sClient.CoreV1().PersistentVolumes().Get(ctx, volumeID, metav1.GetOptions{})
    if err == nil && pv.Spec.ClaimRef != nil {
        pvcNamespace := pv.Spec.ClaimRef.Namespace
        pvcName := pv.Spec.ClaimRef.Name
        if pvcNamespace != "" && pvcName != "" {
            eventPoster := NewEventPoster(cs.driver.k8sClient)
            if err := eventPoster.PostMigrationCompleted(ctx, pvcNamespace, pvcName, volumeID, sourceNode, targetNode, duration); err != nil {
                klog.Warningf("Failed to post migration completed event: %v", err)
            }
        }
    } else {
        klog.V(3).Infof("Could not get PVC for migration completed event: %v", err)
    }
}
```
  </action>
  <verify>
1. Run `go build ./...` - compiles without errors
2. Run `go test ./pkg/driver/...` - all existing tests pass
3. Run `grep -n "PostMigrationCompleted" pkg/driver/controller.go` - shows the new call site
4. Run `grep -n "wasMigrating" pkg/driver/controller.go` - shows migration detection in ControllerUnpublishVolume
  </verify>
  <done>
ControllerUnpublishVolume posts MigrationCompleted event when:
- Volume was in migration state (2 nodes attached with MigrationStartedAt set)
- Detach operation is partial (1 node remains after source detaches)
- PVC can be resolved from PV's claimRef
Event includes accurate sourceNode, targetNode, and duration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit test for migration completed event posting</name>
  <files>pkg/driver/controller_test.go</files>
  <action>
Add a test case that verifies PostMigrationCompleted is called during ControllerUnpublishVolume when a migration completes.

Find the existing test file and add a test similar to how MigrationStarted is tested.

The test should:
1. Set up a mock attachment manager with a volume in migration state (2 nodes)
2. Set up a mock k8sClient that returns a PV with ClaimRef
3. Call ControllerUnpublishVolume for the source node
4. Verify the event was posted (or verify the call was made via mock)

If mocking infrastructure is complex, add a simpler test that:
1. Verifies the code path compiles and executes without panic
2. Uses nil k8sClient (event posting skipped gracefully)

Follow existing test patterns in the file.
  </action>
  <verify>
1. Run `go test ./pkg/driver/... -v -run MigrationCompleted` - new test passes
2. Run `go test ./pkg/driver/...` - all tests pass (no regressions)
  </verify>
  <done>
Unit test exists that exercises the migration completed event posting code path.
Test passes and doesn't break existing tests.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Compilation check:**
   ```bash
   go build ./...
   ```

2. **Unit tests:**
   ```bash
   go test ./pkg/driver/... ./pkg/attachment/...
   ```

3. **Code path verification:**
   ```bash
   # PostMigrationCompleted is now called
   grep -n "PostMigrationCompleted" pkg/driver/controller.go

   # Migration detection added
   grep -n "wasMigrating" pkg/driver/controller.go | grep -v "// "

   # Pattern matches ControllerPublishVolume style
   grep -B5 -A5 "PostMigrationCompleted" pkg/driver/controller.go
   ```

4. **Gap closure:**
   The verification gap from 10-VERIFICATION.md should now be addressed:
   - Truth #5 "MigrationCompleted event posts to PVC when source node detaches" is now satisfied
   - The code path from ControllerUnpublishVolume -> PostMigrationCompleted is wired
</verification>

<success_criteria>
1. `PostMigrationCompleted` is called from `ControllerUnpublishVolume` when migration completes
2. Event contains accurate source node, target node, and duration
3. All existing tests pass (no regressions)
4. New test covers the migration completed code path
5. Code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-observability/10-05-SUMMARY.md`
</output>
