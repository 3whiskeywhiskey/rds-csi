---
phase: 10-observability
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - docs/kubevirt-migration.md
autonomous: true

must_haves:
  truths:
    - "Documentation explains RWX is safe ONLY for KubeVirt live migration"
    - "Documentation warns against using RWX for general workloads (data corruption)"
    - "Documentation includes StorageClass configuration for migration timeout"
    - "Documentation shows Prometheus metrics queries and kubectl event commands"
  artifacts:
    - path: "docs/kubevirt-migration.md"
      provides: "User documentation for KubeVirt live migration with RDS CSI"
      contains: "DATA CORRUPTION"
      min_lines: 150
  key_links: []
---

<objective>
Create comprehensive user documentation for KubeVirt live migration safety.

Purpose: Users must understand that RWX block volumes are safe ONLY for KubeVirt live migration due to QEMU I/O coordination. Using RWX for general workloads will cause data corruption. The documentation serves as both a guide and a safety warning.

Output: docs/kubevirt-migration.md with safe usage patterns, warnings, configuration, monitoring, and troubleshooting sections.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-observability/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KubeVirt migration documentation</name>
  <files>docs/kubevirt-migration.md</files>
  <action>
Create docs/kubevirt-migration.md with the following structure:

# KubeVirt Live Migration with RDS CSI Driver

## Overview
Brief intro - RDS CSI driver supports KubeVirt VM live migration through temporary RWX block volume access. Explain this doc covers safe usage patterns and critical limitations.

## Safe Usage: KubeVirt Live Migration ONLY

Use checkmark and X symbols to clearly indicate:

SAFE: KubeVirt VM live migration with block volumes
- Show YAML example of PVC with accessModes: [ReadWriteMany], volumeMode: Block

UNSAFE - DATA CORRUPTION RISK: General RWX workloads
- Show YAML example of what NOT to do (multiple pods using same RWX block volume)
- Explain why this corrupts data

## Why RWX is Safe for KubeVirt (But Not General Use)

### QEMU Coordination During Migration
Explain:
1. Source VM pauses I/O before final handoff
2. Target VM receives memory state including in-flight I/O
3. Only one QEMU process issues writes at any time
4. Migration completes in seconds (< 5 minutes default timeout)

### NO Coordination for General Workloads
The CSI driver does NOT provide:
- Distributed locking between nodes
- I/O fencing to prevent split-brain
- Cluster filesystem (GFS2, OCFS2) support
- Write ordering guarantees across nodes

Result: Two pods on different nodes writing to same block device will corrupt data.

## StorageClass Configuration
Show StorageClass YAML with migrationTimeoutSeconds parameter.
Explain:
- Default: 300 seconds (5 minutes)
- Range: 30-3600 seconds
- When to increase (large VMs, slow network)

## Monitoring Migration

### Prometheus Metrics
Show PromQL queries for:
- rds_csi_migration_active_migrations (active migrations)
- rate(rds_csi_migration_migrations_total{result="success"}[5m])
- rate(rds_csi_migration_migrations_total{result="timeout"}[5m])
- histogram_quantile(0.95, rate(rds_csi_migration_duration_seconds_bucket[5m]))

### Kubernetes Events
Show kubectl commands and example event output:
- MigrationStarted
- MigrationCompleted
- MigrationFailed

## Troubleshooting

### Migration Timeout
- Error message
- Causes (large VM memory, slow network)
- Solutions (increase timeout, check network)

### Data Corruption After Using RWX
- Symptom (VM fails to boot, filesystem errors)
- Cause (multiple pods writing simultaneously)
- Prevention (only use RWX for KubeVirt)
- Recovery (restore from backup - corruption is not recoverable)

## Future Enhancements
List deferred features:
- Cluster filesystem support (GFS2, OCFS2)
- RDS-level namespace reservations
- KubeVirt API integration

Recommend NFS or cluster-aware filesystems for general shared storage needs.
  </action>
  <verify>
Verify the file exists and has substantive content:
- `wc -l docs/kubevirt-migration.md` should show 150+ lines
- `grep -c "DATA CORRUPTION\|UNSAFE\|WARNING" docs/kubevirt-migration.md` should show multiple warnings
  </verify>
  <done>docs/kubevirt-migration.md exists with safety warnings, configuration, monitoring, and troubleshooting sections.</done>
</task>

<task type="auto">
  <name>Task 2: Add documentation to existing docs index</name>
  <files>docs/kubevirt-migration.md</files>
  <action>
Check if there's a docs/README.md or index file that lists documentation.

If exists:
- Add link to kubevirt-migration.md with description "KubeVirt Live Migration - safe RWX usage for VM migration"

If docs/README.md doesn't exist, skip this step (the doc is discoverable via filename).

Also verify docs/ directory exists - if not, create it first.
  </action>
  <verify>
Run `ls -la docs/` to confirm kubevirt-migration.md exists.
  </verify>
  <done>Documentation is in place and discoverable.</done>
</task>

</tasks>

<verification>
1. `docs/kubevirt-migration.md` exists with 150+ lines
2. Document includes clear safety warnings about data corruption
3. Document includes StorageClass configuration section
4. Document includes Prometheus metrics queries
5. Document includes kubectl event commands
6. Document includes troubleshooting section
</verification>

<success_criteria>
- Documentation clearly states RWX is safe ONLY for KubeVirt live migration
- Documentation has prominent warnings about data corruption for general RWX use
- Documentation shows correct StorageClass migrationTimeoutSeconds configuration
- Documentation includes PromQL queries for all three migration metrics
- Documentation shows example kubectl commands for viewing migration events
- Documentation provides troubleshooting guidance for common issues
</success_criteria>

<output>
After completion, create `.planning/phases/10-observability/10-04-SUMMARY.md`
</output>
