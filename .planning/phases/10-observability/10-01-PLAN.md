---
phase: 10-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/observability/prometheus.go
  - pkg/observability/prometheus_test.go
autonomous: true

must_haves:
  truths:
    - "Prometheus /metrics endpoint exposes migrations_total counter with result label"
    - "Prometheus /metrics endpoint exposes migration_duration_seconds histogram"
    - "Prometheus /metrics endpoint exposes active_migrations gauge"
  artifacts:
    - path: "pkg/observability/prometheus.go"
      provides: "Migration metrics definitions and recording methods"
      contains: "migrationsTotal"
    - path: "pkg/observability/prometheus_test.go"
      provides: "Unit tests for migration metrics"
      contains: "TestRecordMigrationStarted"
  key_links:
    - from: "pkg/observability/prometheus.go"
      to: "prometheus.Registry"
      via: "MustRegister"
      pattern: "reg\\.MustRegister.*migrationsTotal"
---

<objective>
Add Prometheus migration metrics to expose KubeVirt live migration observability.

Purpose: Operators need visibility into migration operations - how many occur, how long they take, and how many are currently in progress. These metrics enable alerting on stuck migrations and performance analysis.

Output: Three new Prometheus metrics (migrations_total, migration_duration_seconds, active_migrations) with recording methods in pkg/observability/prometheus.go.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-observability/10-RESEARCH.md

# Existing observability infrastructure to extend
@pkg/observability/prometheus.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration metrics to Metrics struct</name>
  <files>pkg/observability/prometheus.go</files>
  <action>
Add three new metric fields to the Metrics struct:

1. `migrationsTotal` - CounterVec with "result" label (values: success, failed, timeout)
2. `migrationDuration` - Histogram with buckets for migration times: []float64{15, 30, 60, 90, 120, 180, 300, 600}
3. `activeMigrations` - Gauge for current in-flight migrations

All metrics use namespace "rds_csi" (existing constant) and subsystem "migration".

In NewMetrics():
- Initialize each metric with prometheus.CounterOpts/HistogramOpts/GaugeOpts
- Register all three with reg.MustRegister()

Metric names (full):
- rds_csi_migration_migrations_total
- rds_csi_migration_duration_seconds
- rds_csi_migration_active_migrations

Follow existing patterns in the file for Counter/Histogram/Gauge initialization.
  </action>
  <verify>
Run `go build ./...` to verify compilation.
  </verify>
  <done>Metrics struct has three new fields: migrationsTotal, migrationDuration, activeMigrations all registered with prometheus registry.</done>
</task>

<task type="auto">
  <name>Task 2: Add recording methods for migration metrics</name>
  <files>pkg/observability/prometheus.go</files>
  <action>
Add two public methods to Metrics:

1. `RecordMigrationStarted()` - Increments activeMigrations gauge
   - Called when secondary node attaches (migration begins)

2. `RecordMigrationResult(result string, duration time.Duration)` - Records migration completion
   - result must be one of: "success", "failed", "timeout"
   - Increments migrationsTotal with result label
   - Observes duration on migrationDuration histogram (use duration.Seconds())
   - Decrements activeMigrations gauge

These follow the same pattern as existing methods like RecordNVMeConnect/RecordNVMeDisconnect.

IMPORTANT: RecordMigrationResult must ALWAYS decrement the gauge regardless of result type (success/failed/timeout) to prevent gauge leak.
  </action>
  <verify>
Run `go build ./...` to verify compilation.
  </verify>
  <done>RecordMigrationStarted() and RecordMigrationResult() methods exist on Metrics struct.</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for migration metrics</name>
  <files>pkg/observability/prometheus_test.go</files>
  <action>
Add tests for the new migration metrics. Follow existing test patterns in the file.

Test cases to add:

1. TestRecordMigrationStarted - Verify active_migrations gauge increments
2. TestRecordMigrationResult_Success - Verify counter increments with "success" label, histogram observed, gauge decrements
3. TestRecordMigrationResult_Timeout - Verify counter increments with "timeout" label
4. TestRecordMigrationResult_Failed - Verify counter increments with "failed" label
5. TestMigrationDurationHistogram - Verify histogram buckets work correctly (test with 30s and 120s durations)

Use testutil.ToFloat64() to read gauge values, or follow existing test patterns in the file for metric verification.

If the existing tests use a specific pattern for metric verification, follow that pattern.
  </action>
  <verify>
Run `go test -v ./pkg/observability/... -run Migration` to verify tests pass.
  </verify>
  <done>All migration metric tests pass.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go test -v ./pkg/observability/...` passes all tests including new migration tests
3. Manually inspect prometheus.go to confirm:
   - Three new fields in Metrics struct (migrationsTotal, migrationDuration, activeMigrations)
   - Two new methods (RecordMigrationStarted, RecordMigrationResult)
   - All metrics registered in NewMetrics()
</verification>

<success_criteria>
- migrations_total counter with result label is defined and registered
- migration_duration_seconds histogram with appropriate buckets is defined and registered
- active_migrations gauge is defined and registered
- RecordMigrationStarted() increments active gauge
- RecordMigrationResult() increments counter, observes histogram, decrements gauge
- All new functionality has unit test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/10-observability/10-01-SUMMARY.md`
</output>
