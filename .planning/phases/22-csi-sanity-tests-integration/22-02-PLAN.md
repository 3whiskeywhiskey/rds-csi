---
phase: 22-csi-sanity-tests-integration
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - .github/workflows/pr.yml
  - docs/TESTING.md
autonomous: true

must_haves:
  truths:
    - "PR CI workflow includes sanity test job that fails build on test failure"
    - "CI captures sanity test logs and mock RDS command history as artifacts"
    - "TESTING.md documents which CSI capabilities are implemented vs deferred"
    - "TESTING.md explains how to run sanity tests locally"
  artifacts:
    - path: ".github/workflows/pr.yml"
      provides: "CI workflow with sanity test job"
      contains: "test-sanity"
    - path: "docs/TESTING.md"
      provides: "Testing documentation with capability matrix"
      contains: "CSI Capability Matrix"
  key_links:
    - from: ".github/workflows/pr.yml"
      to: "test/sanity/sanity_test.go"
      via: "make test-sanity-mock"
      pattern: "test-sanity"
---

<objective>
Integrate CSI sanity tests into CI pipeline and document CSI capabilities for contributors and operators.

Purpose: Ensure CSI spec compliance is validated on every PR and provide clear documentation of what the driver supports.

Output: Updated CI workflow that runs sanity tests, and TESTING.md with capability matrix and testing guide.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-csi-sanity-tests-integration/22-CONTEXT.md
@.planning/phases/22-csi-sanity-tests-integration/22-RESEARCH.md
@.planning/phases/22-csi-sanity-tests-integration/22-01-SUMMARY.md
@.github/workflows/pr.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sanity tests to CI workflow with artifact capture</name>
  <files>.github/workflows/pr.yml</files>
  <action>
Add a new job to the PR workflow that runs CSI sanity tests and captures artifacts on failure.

Add after the existing `verify` job:

```yaml
  sanity-tests:
    name: CSI Sanity Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run CSI sanity tests
        run: |
          go test -v -race -timeout 15m ./test/sanity/... 2>&1 | tee sanity-output.log
        continue-on-error: true
        id: sanity

      - name: Upload sanity test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sanity-test-logs
          path: |
            sanity-output.log
          retention-days: 7

      - name: Check sanity test result
        if: steps.sanity.outcome == 'failure'
        run: |
          echo "::error::CSI sanity tests failed - see artifacts for details"
          exit 1
```

Key decisions per CONTEXT.md:
- Fail build immediately on any sanity test failure (strict CSI spec compliance)
- No retry logic - fix flakiness properly
- Capture full logs as artifacts for debugging
- 15 minute timeout (sanity tests with 10GB volumes take time)

Do NOT add the job to the `build-test` job - keep it separate for clearer failure attribution.
  </action>
  <verify>
1. Check `.github/workflows/pr.yml` has new `sanity-tests` job
2. Verify job runs `go test ./test/sanity/...`
3. Verify artifact upload step exists with `if: always()`
4. Verify failure check step exits 1 on test failure
  </verify>
  <done>
PR workflow has sanity-tests job that runs csi-sanity and uploads logs as artifacts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TESTING.md with capability matrix and testing guide</name>
  <files>docs/TESTING.md</files>
  <action>
Create comprehensive testing documentation covering:

1. **Overview** - Brief intro to the testing strategy (unit, integration, sanity, E2E)

2. **Running Tests Locally**
   - `make test` - unit tests
   - `make test-integration` - integration tests with mock RDS
   - `make test-sanity-mock` - CSI sanity tests with mock RDS
   - `make test-sanity-real RDS_ADDRESS=x.x.x.x RDS_SSH_KEY=~/.ssh/id_rsa` - sanity with hardware

3. **CSI Capability Matrix** - Per RESEARCH.md and CONTEXT.md decisions:

**Identity Service**
| Capability | Implemented | Tested | Notes |
|------------|-------------|--------|-------|
| CONTROLLER_SERVICE | Yes | Yes (sanity) | Driver has controller component |
| VOLUME_ACCESSIBILITY_CONSTRAINTS | Yes | Yes (sanity) | Topology support |

**Controller Service**
| Capability | Implemented | Tested | Notes |
|------------|-------------|--------|-------|
| CREATE_DELETE_VOLUME | Yes | Yes (sanity) | Core functionality |
| PUBLISH_UNPUBLISH_VOLUME | Yes | Yes (sanity) | Attachment tracking |
| GET_CAPACITY | Yes | Yes (sanity) | RDS pool capacity |
| LIST_VOLUMES | Yes | Yes (sanity) | Enumerates CSI volumes |
| EXPAND_VOLUME | Yes | Yes (sanity) | Online expansion |
| CREATE_DELETE_SNAPSHOT | No | Skipped | Deferred to Phase 26 |
| CLONE_VOLUME | No | Skipped | Not planned |
| GET_VOLUME | No | Skipped | Optional capability |

**Node Service** (Deferred to Phase 24 E2E tests)
| Capability | Implemented | Tested | Notes |
|------------|-------------|--------|-------|
| STAGE_UNSTAGE_VOLUME | Yes | No (skipped) | Requires NVMe/TCP hardware |
| EXPAND_VOLUME | Yes | No (skipped) | Requires mounted filesystem |
| GET_VOLUME_STATS | Yes | No (skipped) | Requires mounted filesystem |
| VOLUME_CONDITION | Yes | No (skipped) | Requires NVMe connection |

4. **Test Infrastructure**
   - Mock RDS server (`test/mock/rds_server.go`) - simulates RouterOS CLI
   - Sanity tests use official csi-test/pkg/sanity package
   - Integration tests validate driver + mock RDS interaction

5. **Debugging Test Failures**
   - Enable verbose logging: `-v` flag
   - Mock RDS command history available in test output
   - CI artifacts contain full logs

6. **Contributing Tests**
   - Unit tests: `pkg/*_test.go`
   - Integration tests: `test/integration/*_test.go`
   - Follow existing patterns, use testify for assertions

Keep it concise - this is a reference doc, not a tutorial.
  </action>
  <verify>
1. File exists at `docs/TESTING.md`
2. Contains CSI Capability Matrix section with tables
3. Contains instructions for running tests locally
4. Contains section on debugging failures
  </verify>
  <done>
- docs/TESTING.md exists with capability matrix showing implemented vs deferred
- Document includes local testing instructions
- Document includes debugging guidance
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `.github/workflows/pr.yml` has sanity-tests job
2. docs/TESTING.md exists with capability matrix
3. `make test-sanity-mock` still works (no regression)
4. Capability matrix accurately reflects driver implementation
</verification>

<success_criteria>
- CI workflow includes sanity test job that fails on test failure
- Sanity test logs captured as CI artifacts
- TESTING.md documents all CSI capabilities (implemented vs deferred)
- TESTING.md provides local testing instructions
- Requirements COMP-01 through COMP-06 are addressed
</success_criteria>

<output>
After completion, create `.planning/phases/22-csi-sanity-tests-integration/22-02-SUMMARY.md`
</output>
