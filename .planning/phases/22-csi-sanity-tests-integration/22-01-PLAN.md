---
phase: 22-csi-sanity-tests-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/sanity/sanity_test.go
  - test/mock/rds_server.go
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Running `make test-sanity-mock` executes csi-sanity against driver with mock RDS"
    - "Identity service tests pass (GetPluginInfo, GetPluginCapabilities, Probe)"
    - "Controller service tests pass (CreateVolume, DeleteVolume, ValidateVolumeCapabilities, GetCapacity, ControllerExpandVolume)"
    - "Idempotency tests pass (CreateVolume called twice with same params returns same volume)"
    - "Mock RDS command history is accessible for debugging test failures"
  artifacts:
    - path: "test/sanity/sanity_test.go"
      provides: "Go-based csi-sanity test runner"
      min_lines: 80
      contains: "sanity.Test"
    - path: "test/mock/rds_server.go"
      provides: "Mock RDS with command logging"
      contains: "GetCommandHistory"
  key_links:
    - from: "test/sanity/sanity_test.go"
      to: "pkg/driver"
      via: "driver.NewDriver"
      pattern: "driver\\.NewDriver"
    - from: "test/sanity/sanity_test.go"
      to: "test/mock/rds_server.go"
      via: "mock.NewMockRDSServer"
      pattern: "mock\\.NewMockRDSServer"
---

<objective>
Create Go-based CSI sanity test infrastructure that validates Identity and Controller service compliance against the CSI specification using the official csi-test/pkg/sanity package.

Purpose: Establish automated CSI spec compliance testing that catches violations before they reach production, using mock RDS for fast and reliable CI execution.

Output: Working sanity test suite runnable via `make test-sanity-mock` that validates all implemented CSI methods against spec requirements.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-csi-sanity-tests-integration/22-CONTEXT.md
@.planning/phases/22-csi-sanity-tests-integration/22-RESEARCH.md
@pkg/driver/identity.go
@pkg/driver/controller.go
@test/mock/rds_server.go
@test/sanity/run-sanity-tests.sh
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Go-based sanity test suite</name>
  <files>test/sanity/sanity_test.go</files>
  <action>
Create a Go test file that runs csi-sanity programmatically against the RDS CSI driver with mock RDS backend.

Implementation requirements:
1. Import `github.com/kubernetes-csi/csi-test/v5/pkg/sanity`
2. Start mock RDS server on port 12222 (avoid conflicts with 2222 used elsewhere)
3. Create driver with controller mode enabled, connected to mock RDS
4. Start driver on Unix socket `/tmp/csi-sanity-test.sock`
5. Configure sanity test with:
   - Address: `unix:///tmp/csi-sanity-test.sock`
   - TestVolumeSize: 10 * 1024 * 1024 * 1024 (10 GiB per CONTEXT.md decision)
   - IdempotentCount: 2 (critical per CONTEXT.md - validate idempotency)
   - TestVolumeParameters: `{"volumePath": "/storage-pool/metal-csi"}` (StorageClass params)
6. Skip Node tests with `--ginkgo.skip="Node"` equivalent (use sanity.GinkgoTest or config)
7. Cleanup mock server, driver, and socket in defer/cleanup

Use the in-process pattern from RESEARCH.md - start driver as goroutine, not subprocess.

Key configuration from existing code:
- Driver name: "rds.csi.srvlab.io" (from pkg/driver/driver.go)
- Uses SSH client for RDS operations
- Controller capabilities: CREATE_DELETE_VOLUME, PUBLISH_UNPUBLISH_VOLUME, GET_CAPACITY, EXPAND_VOLUME, LIST_VOLUMES

Do NOT use container-based testing - in-process is faster and easier to debug.
  </action>
  <verify>
Run `go test -v ./test/sanity/... -run TestCSISanity` and observe:
- Mock RDS starts successfully
- Driver connects to mock
- Sanity tests execute (may see some expected skips)
- Test completes without panics
  </verify>
  <done>
`test/sanity/sanity_test.go` exists with TestCSISanity function that runs csi-sanity against mock RDS
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance mock RDS with command logging and update Makefile</name>
  <files>test/mock/rds_server.go, Makefile</files>
  <action>
Part A: Enhance mock RDS server with command history logging for debug artifacts.

Add to MockRDSServer struct:
1. `commandHistory []CommandLog` field (thread-safe with mutex)
2. `CommandLog` struct with: `Timestamp time.Time, Command string, Response string, ExitCode int`
3. `GetCommandHistory() []CommandLog` method to retrieve history
4. `ClearCommandHistory()` method to reset between tests

Update `executeCommand()` to record each command/response in history before returning.

Part B: Update Makefile with proper sanity test target.

Replace/update `test-sanity-mock` target to run the Go tests instead of shell script:
```makefile
.PHONY: test-sanity-mock
test-sanity-mock:
	@echo "Running CSI sanity tests with mock RDS..."
	go test -v -race -timeout 10m ./test/sanity/... -ginkgo.skip="Node"
```

Keep the existing shell script for backward compatibility but make the Go tests the primary path.
The shell script is useful for hardware testing (RDS_ADDRESS set) but Go tests are preferred for CI.

Note: The existing `sanity` alias points to `test-sanity-mock` which is correct.
  </action>
  <verify>
1. Run `make test-sanity-mock` - should execute Go-based sanity tests
2. Check mock RDS logs show command history being recorded (visible in test output with -v)
3. Verify `go test -v ./test/sanity/...` passes without errors
  </verify>
  <done>
- MockRDSServer has GetCommandHistory() method returning recorded commands
- `make test-sanity-mock` runs Go-based sanity tests successfully
- Tests pass for Identity and Controller services
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `make test-sanity-mock` completes successfully
2. Identity service tests pass: GetPluginInfo, GetPluginCapabilities, Probe
3. Controller service tests pass: CreateVolume, DeleteVolume, ValidateVolumeCapabilities, GetCapacity, ControllerExpandVolume
4. Idempotency validation passes (CreateVolume with same name returns same volume)
5. Node tests are skipped (expected - no NVMe/TCP mock)
</verification>

<success_criteria>
- Go-based sanity test suite exists at test/sanity/sanity_test.go
- Mock RDS captures command history for debugging
- `make test-sanity-mock` runs sanity tests with mock RDS
- All Identity + Controller service tests pass
- Idempotency tests pass (IdempotentCount=2)
</success_criteria>

<output>
After completion, create `.planning/phases/22-csi-sanity-tests-integration/22-01-SUMMARY.md`
</output>
