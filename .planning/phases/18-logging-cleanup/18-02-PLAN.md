---
phase: 18-logging-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/rds/commands.go
  - pkg/driver/controller.go
autonomous: true

must_haves:
  truths:
    - "DeleteVolume produces maximum 2 log statements at V(2) level per operation"
    - "No duplicate outcome logging between pkg/rds and pkg/driver at V(2) level"
    - "Intermediate step logs moved from V(3) to V(4)"
    - "Production logs show outcomes only, not command details"
  artifacts:
    - path: "pkg/rds/commands.go"
      provides: "Rationalized verbosity for RDS operations"
      contains: "klog.V(4)"
    - path: "pkg/driver/controller.go"
      provides: "Reduced controller logging"
      contains: "klog.V(4)"
  key_links:
    - from: "pkg/rds/commands.go"
      to: "DeleteVolume"
      via: "V(2) outcome only"
      pattern: "klog\\.V\\(2\\).*deleted|delete"
---

<objective>
Rationalize verbosity levels in pkg/rds and pkg/driver/controller

Purpose: Reduce DeleteVolume from 6 log statements to maximum 2 at V(2). Move intermediate step logging from V(3) to V(4) (debug level). Production logs should show outcomes only, not command execution details. Critically, ensure no duplicate outcome logging occurs between the rds package and controller package at V(2).

Output:
- DeleteVolume: 1-2 V(2) logs (outcome only)
- CreateVolume/ResizeVolume: same pattern
- Intermediate steps moved to V(4)
- No duplicate outcome logs between layers
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-logging-cleanup/18-CONTEXT.md
@.planning/phases/18-logging-cleanup/18-RESEARCH.md

# Key source files
@pkg/rds/commands.go
@pkg/driver/controller.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rationalize pkg/rds/commands.go verbosity</name>
  <files>pkg/rds/commands.go</files>
  <action>
Apply verbosity rationalization per Kubernetes logging conventions:
- V(2) = Production default (outcomes only)
- V(4) = Debug (intermediate steps, parameters)
- V(5) = Trace (command output, parsing details)

**CreateVolume function:**
Current (2 statements at V(2)):
```go
klog.V(2).Infof("Creating volume %s (size: %d bytes, path: %s)", ...)  // START
klog.V(2).Infof("Successfully created volume %s", opts.Slot)          // END
```
Target:
- Remove start log (outcome is sufficient)
- Keep end log at V(2): "Created volume %s" (past tense, shorter)
- If adding details is useful, put at V(4): "Created volume %s (path=%s, size=%d, nqn=%s)"

**ResizeVolume function:**
Current (3 statements at V(2)):
```go
klog.V(2).Infof("Resizing volume %s to %d bytes", slot, newSizeBytes)  // START
klog.V(2).Infof("Volume %s is already at requested size, skipping resize", slot)  // NO-OP
klog.V(2).Infof("Successfully resized volume %s from %d to %d bytes", ...)  // END
```
Target:
- Remove start log
- Keep no-op log at V(4) (diagnostic, not actionable)
- Keep end log at V(2): "Resized volume %s (%d -> %d bytes)"

**DeleteVolume function (main focus):**
Current (6 statements):
```go
klog.V(2).Infof("Deleting volume %s", slot)                           // V(2) START
klog.V(3).Infof("Volume %s does not exist, skipping deletion", slot)   // V(3) IDEMPOTENT
klog.V(3).Infof("Volume %s has backing file: %s", slot, filePath)      // V(3) DETAIL
klog.V(3).Infof("Volume %s disk slot does not exist, ...", slot)       // V(3) DETAIL
klog.V(3).Infof("Successfully removed disk slot for volume %s", slot)  // V(3) STEP
klog.V(3).Infof("Successfully deleted backing file %s...", filePath)   // V(3) STEP
klog.V(2).Infof("Successfully deleted volume %s", slot)                // V(2) END
```
Target:
- Remove V(2) start log (outcome is sufficient)
- Move idempotent case to V(4): "Volume %s already deleted"
- Move all intermediate V(3) logs to V(4) (diagnostic steps)
- Keep single V(2) outcome log: "Deleted volume %s"

**Other functions (GetVolume, ListVolumes, ListFiles, DeleteFile):**
- These already use V(4) - keep as-is
  </action>
  <verify>
1. Run `go build ./...` to verify compilation
2. Count V(2) in commands.go: `grep -c 'klog.V(2)' pkg/rds/commands.go` should be ~4 (down from 7)
3. Count V(3) in commands.go: `grep -c 'klog.V(3)' pkg/rds/commands.go` should be 0
4. Behavioral verification - simulate DeleteVolume and check log output:
   - At V=2: Should see only "Deleted volume X" (1 line)
   - At V=4: Should see intermediate steps as well
  </verify>
  <done>
CreateVolume: 1 V(2) log (outcome only)
ResizeVolume: 1-2 V(2) logs (outcome + skip)
DeleteVolume: 1 V(2) log (outcome only)
All intermediate steps at V(4) for debugging
  </done>
</task>

<task type="auto">
  <name>Task 2: Rationalize pkg/driver/controller.go verbosity and eliminate duplicate logging</name>
  <files>pkg/driver/controller.go</files>
  <action>
Apply same verbosity rationalization to controller CSI methods. Critical: Ensure no duplicate outcome logging between controller and rds layers.

**Duplicate logging detection:**
Before making changes, identify where both layers log the same outcome:
- If rds.CreateVolume logs "Created volume X" at V(2) AND controller logs "Volume created" at V(2), this is duplicate
- Rule: rds package owns the outcome log, controller logs CSI-level context at V(4)

**CreateVolume:**
Current pattern has multiple V(2) logs for request details and outcomes.
Target:
- Single V(2) for outcome: "CreateVolume completed for %s" or "Volume %s already exists"
- Move request details (parameters, paths) to V(4)
- If rds.CreateVolume already logs outcome at V(2), controller should NOT also log outcome at V(2)

**DeleteVolume:**
Current (lines ~247, ~252):
```go
klog.V(3).Infof("Volume %s not found on RDS, assuming already deleted", volumeID)
klog.V(3).Infof("Deleting volume %s (path=%s, size=%d bytes, ...)", ...)
```
Target:
- Keep "not found" at V(4) (diagnostic)
- Remove "Deleting volume" (RDS layer logs the outcome)
- If rds.DeleteVolume logs "Deleted volume X" at V(2), controller should NOT log "Volume deleted" at V(2)
- Controller can log at V(4): "DeleteVolume CSI call completed for %s"

**ControllerPublishVolume / ControllerUnpublishVolume:**
Audit V(2)/V(3) usage, ensure:
- V(2) for outcomes only (published, unpublished, conflict)
- V(4) for intermediate steps (checking attachments, etc.)

**General rule:** If the rds package already logs the outcome at V(2), controller should log at V(4) to show the CSI operation flow without duplicating. One layer owns the outcome log.
  </action>
  <verify>
1. Run `go build ./...` to verify compilation
2. Run `make test` to verify tests pass
3. Check for duplicate outcome logging at V(2):
   - `grep -n 'klog.V(2).*[Cc]reate' pkg/rds/commands.go pkg/driver/controller.go`
   - `grep -n 'klog.V(2).*[Dd]elete' pkg/rds/commands.go pkg/driver/controller.go`
   - Verify no duplicate outcome messages for same operation
4. Grep for remaining V(2) in controller: `grep -n 'klog.V(2)' pkg/driver/controller.go | head -20`
  </verify>
  <done>
Controller logs reduced - no duplicate outcome logging with rds package.
V(2) shows CSI operation outcomes only (one layer owns each outcome).
V(4) shows intermediate steps and parameter details.
No operation produces duplicate outcome logs at V(2) across layers.
  </done>
</task>

</tasks>

<verification>
1. `make test` passes
2. DeleteVolume operation produces maximum 2 log lines at V(2) (test with V=2)
3. No V(3) statements remain in pkg/rds/commands.go (all moved to V(4))
4. No duplicate V(2) outcome logs between pkg/rds and pkg/driver for same operation
5. Production log output (V=2) is quiet - outcomes only, no command details
</verification>

<success_criteria>
- DeleteVolume: maximum 2 V(2) log statements per operation
- V(3) eliminated in pkg/rds (use V(4) for debug)
- Controller doesn't duplicate rds package outcome logging at V(2)
- Production logs (V=2) contain only actionable outcomes
- Each operation has exactly one layer that owns its V(2) outcome log
</success_criteria>

<output>
After completion, create `.planning/phases/18-logging-cleanup/18-02-SUMMARY.md`
</output>
