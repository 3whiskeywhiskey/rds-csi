---
phase: 18-logging-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/security/logger.go
  - pkg/security/logger_test.go
autonomous: true

must_haves:
  truths:
    - "11 operation-specific Log* methods reduced from ~300 lines to <50 lines total"
    - "Security logger file reduced from 540 lines to <200 lines total"
    - "Existing callers in pkg/driver and pkg/reconciler compile and work unchanged"
    - "Tests verify all outcome types (success, failure, request) produce correct events"
  artifacts:
    - path: "pkg/security/logger.go"
      provides: "Consolidated security logging with table-driven helper"
      max_lines: 200
    - path: "pkg/security/logger_test.go"
      provides: "Tests for consolidated helper"
      contains: "TestLogOperation"
  key_links:
    - from: "pkg/security/logger.go"
      to: "LogOperation helper"
      via: "table-driven config"
      pattern: "OperationLogConfig|LogOperation"
    - from: "pkg/driver/controller.go"
      to: "pkg/security/logger.go"
      via: "unchanged Log* method calls"
      pattern: "securityLogger\\.Log"
---

<objective>
Consolidate security logger from 540 lines to <200 lines using table-driven helper

Purpose: Eliminate repetitive switch/case patterns across 11 operation-specific methods (LogVolumeCreate, LogVolumeDelete, LogVolumeStage, etc.) by extracting a single configurable LogOperation helper with table-driven outcome mapping. The 11 methods currently occupy ~300 lines (lines 221-525); these should become <50 lines of wrapper code calling a shared helper.

Output:
- pkg/security/logger.go reduced by ~65% (540 -> ~150-180 lines)
- Single LogOperation() helper with OperationLogConfig table
- 11 operation methods become thin wrappers (~4-5 lines each)
- Backward compatibility maintained for all existing callers
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-logging-cleanup/18-CONTEXT.md
@.planning/phases/18-logging-cleanup/18-RESEARCH.md

# Key source files
@pkg/security/logger.go
@pkg/security/events.go
@pkg/security/logger_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create table-driven LogOperation helper</name>
  <files>pkg/security/logger.go</files>
  <action>
Add table-driven helper to replace repetitive operation-specific methods:

1. Define OperationLogConfig struct:
```go
type OperationLogConfig struct {
    Operation     string     // e.g., "CreateVolume"
    Category      EventCategory
    SuccessType   EventType
    FailureType   EventType
    RequestType   EventType
    SuccessSev    EventSeverity  // usually SeverityInfo
    FailureSev    EventSeverity  // usually SeverityError or SeverityWarning
    SuccessMsg    string
    FailureMsg    string
    RequestMsg    string
}
```

2. Define operationConfigs map with configs for all 11 operations:
- VolumeCreate, VolumeDelete, VolumeStage, VolumeUnstage
- VolumePublish, VolumeUnpublish, NVMEConnect, NVMEDisconnect
- (SSH methods can remain separate - they have different structure)

3. Create LogOperation() helper:
```go
func (l *Logger) LogOperation(config OperationLogConfig, outcome EventOutcome, fields ...EventField) {
    eventType, severity, message := resolveOutcome(config, outcome)
    event := NewSecurityEvent(eventType, config.Category, severity, message)
    for _, f := range fields {
        f.Apply(event)
    }
    event.Operation = config.Operation
    event.Outcome = outcome
    l.LogEvent(event)
}
```

4. Create EventField functional options:
```go
type EventField func(*SecurityEvent)

func WithVolume(volumeID, volumeName string) EventField
func WithNode(nodeID string) EventField
func WithTarget(ip, nqn string) EventField
func WithDuration(d time.Duration) EventField
func WithMountPath(path string) EventField
func WithError(err error) EventField
```

5. Keep existing methods as thin wrappers for backward compatibility:
```go
func (l *Logger) LogVolumeCreate(volumeID, volumeName string, outcome EventOutcome, err error, duration time.Duration) {
    l.LogOperation(volumeCreateConfig, outcome,
        WithVolume(volumeID, volumeName),
        WithDuration(duration),
        WithError(err))
}
```

Keep SSH-specific methods (LogSSHConnectionAttempt, etc.) as-is since they have different structure.
Keep LogSecurityViolation and LogValidationFailure as-is since they're special cases.
  </action>
  <verify>
1. Run `go build ./...` to verify compilation
2. Run `make test` to verify existing tests still pass
3. Count lines: `wc -l pkg/security/logger.go` should be <200 lines
4. Verify backward compatibility - existing callers unchanged:
   - `grep -n 'securityLogger\.Log' pkg/driver/controller.go pkg/driver/node.go pkg/reconciler/*.go` should show same call patterns
   - All existing calls should compile without modification
  </verify>
  <done>
Security logger reduced from 540 to <200 lines total.
11 operation methods now occupy <50 lines total (thin wrappers).
All operation methods use LogOperation helper internally.
Backward compatibility maintained - existing callers in pkg/driver and pkg/reconciler work unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for consolidated helper</name>
  <files>pkg/security/logger_test.go</files>
  <action>
Add tests for the new LogOperation helper:

1. TestLogOperation_OutcomeMapping:
   - Test success outcome produces correct event type and SeverityInfo
   - Test failure outcome produces correct event type and SeverityError/Warning
   - Test request/unknown outcome produces correct event type and SeverityInfo

2. TestLogOperation_EventFields:
   - Test WithVolume sets VolumeID and VolumeName
   - Test WithNode sets NodeID
   - Test WithTarget sets TargetIP and NQN
   - Test WithDuration sets Duration
   - Test WithMountPath sets MountPath
   - Test WithError sets Error string

3. TestLogOperation_AllOperations:
   - Verify each operation config is defined in operationConfigs map
   - Verify event types match expected patterns

Use a mock or capture pattern to verify events are created correctly.
Ensure existing tests still pass (they test the wrapper methods).
  </action>
  <verify>
Run `make test` - all tests pass.
Run `go test -v ./pkg/security/...` - new tests visible and passing.
  </verify>
  <done>
New tests cover LogOperation helper.
Tests verify outcome mapping for all configurations.
Tests verify EventField functional options apply correctly.
  </done>
</task>

</tasks>

<verification>
1. `make test` passes (existing functionality preserved)
2. `wc -l pkg/security/logger.go` shows <200 lines (down from 540)
3. Wrapper methods (lines 221-525) reduced from ~300 lines to <50 lines
4. `grep -c 'switch outcome' pkg/security/logger.go` shows 0 or 1 (consolidated)
5. Existing callers compile without changes: `go build ./pkg/driver/... ./pkg/reconciler/...`
</verification>

<success_criteria>
- Security logger file consolidated from 540 lines to <200 lines
- 11 operation-specific methods reduced from ~300 lines to <50 lines
- Table-driven LogOperation helper handles all volume operation outcomes
- Backward compatibility maintained (existing Log* method signatures unchanged)
- Existing callers in pkg/driver and pkg/reconciler work without modification
- Tests cover new helper and existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/18-logging-cleanup/18-01-SUMMARY.md`
</output>
