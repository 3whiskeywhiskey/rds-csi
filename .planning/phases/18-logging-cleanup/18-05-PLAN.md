---
phase: 18-logging-cleanup
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/nvme/sysfs.go
  - pkg/nvme/resolver.go
  - pkg/nvme/orphan.go
  - pkg/utils/retry.go
  - pkg/circuitbreaker/breaker.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "V(3) completely eliminated from codebase (all instances moved to V(4))"
    - "Utility packages follow same verbosity pattern as driver/rds packages"
    - "Production logs (V=2) contain no diagnostic information from utility packages"
  artifacts:
    - path: "pkg/nvme/sysfs.go"
      provides: "Device resolution with V(4) diagnostic logging"
      contains: "klog.V(4)"
    - path: "pkg/nvme/resolver.go"
      provides: "Cache diagnostics at V(4)"
      contains: "klog.V(4)"
    - path: "pkg/nvme/orphan.go"
      provides: "Orphan detection at V(2) outcomes, V(4) diagnostics"
      contains: "klog.V(2)"
    - path: "pkg/utils/retry.go"
      provides: "Retry attempts logged at V(4)"
      contains: "klog.V(4)"
    - path: "pkg/circuitbreaker/breaker.go"
      provides: "Breaker creation logged at V(4)"
      contains: "klog.V(4)"
  key_links:
    - from: "pkg/nvme/resolver.go"
      to: "logging verbosity"
      via: "consistent pattern"
      pattern: "V\\(4\\).*cache|invalid|expired"
---

<objective>
Eliminate remaining V(3) usage from nvme, utils, and circuitbreaker packages

Purpose: Close the gap identified during Phase 18 verification - 10 V(3) log statements remain in packages outside the original plan scope. These packages should follow the same verbosity conventions established in plans 18-01 through 18-04.

Output:
- All V(3) statements moved to V(4) across nvme, utils, and circuitbreaker packages
- Complete codebase consistency with V(2)=outcome, V(4)=diagnostic pattern
- Zero V(3) usage remaining in production code
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-logging-cleanup/18-VERIFICATION.md

# Key source files
@pkg/nvme/sysfs.go
@pkg/nvme/resolver.go
@pkg/nvme/orphan.go
@pkg/utils/retry.go
@pkg/circuitbreaker/breaker.go

# Reference for verbosity conventions
@pkg/driver/doc.go
@pkg/rds/doc.go
@pkg/mount/doc.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move pkg/nvme V(3) logs to V(4)</name>
  <files>pkg/nvme/sysfs.go, pkg/nvme/resolver.go, pkg/nvme/orphan.go</files>
  <action>
Move all V(3) statements in the nvme package to V(4) for consistency:

**pkg/nvme/sysfs.go (1 instance):**
- Line 188: `klog.V(3).Infof("FindDeviceByNQN: resolved NQN %s -> %s"`
  - This is diagnostic (intermediate step showing resolution result)
  - Change to V(4)

**pkg/nvme/resolver.go (5 instances):**
- Line 82: `klog.V(3).Infof("DeviceResolver: cache entry for NQN %s invalid"`
  - This is diagnostic (cache invalidation reason)
  - Change to V(4)
- Line 84: `klog.V(3).Infof("DeviceResolver: cache entry for NQN %s expired"`
  - This is diagnostic (cache expiration reason)
  - Change to V(4)
- Line 87: `klog.V(3).Infof("DeviceResolver: cache miss for NQN %s"`
  - This is diagnostic (cache state)
  - Change to V(4)
- Line 115: `klog.V(3).Infof("DeviceResolver: invalidated cache for NQN %s"`
  - This is diagnostic (cache operation)
  - Change to V(4)
- Line 126: `klog.V(3).Infof("DeviceResolver: invalidated entire cache"`
  - This is diagnostic (cache operation)
  - Change to V(4)

**pkg/nvme/orphan.go (1 instance):**
- Line 47: `klog.V(3).Infof("Found %d connected NVMe subsystems"`
  - This is diagnostic (intermediate count during scan)
  - Change to V(4)
  </action>
  <verify>
Run `go build ./pkg/nvme/...` to verify compilation.
Count V(3): `grep -c 'klog.V(3)' pkg/nvme/*.go` should show 0 for all files.
Run `make test` to verify tests pass.
  </verify>
  <done>
All V(3) statements in pkg/nvme moved to V(4).
Device resolution and cache diagnostics are now debug-level logging.
Production logs (V=2) unaffected by nvme package internals.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move pkg/utils and pkg/circuitbreaker V(3) logs to V(4)</name>
  <files>pkg/utils/retry.go, pkg/circuitbreaker/breaker.go</files>
  <action>
Move remaining V(3) statements to V(4):

**pkg/utils/retry.go (2 instances):**
- Line 52: `klog.V(3).Infof("Attempt %d failed with retryable error"`
  - This is diagnostic (retry state)
  - Change to V(4)
- Line 58: `klog.V(3).Infof("Attempt %d failed with non-retryable error"`
  - This is diagnostic (retry state)
  - Change to V(4)

**pkg/circuitbreaker/breaker.go (1 instance):**
- Line 74: `klog.V(3).Infof("Created circuit breaker for volume %s"`
  - This is diagnostic (breaker initialization)
  - Change to V(4)
  </action>
  <verify>
Run `go build ./pkg/utils/... ./pkg/circuitbreaker/...` to verify compilation.
Count V(3): `grep -c 'klog.V(3)' pkg/utils/*.go pkg/circuitbreaker/*.go` should show 0 for all files.
Run `make test` to verify tests pass.
  </verify>
  <done>
All V(3) statements in pkg/utils and pkg/circuitbreaker moved to V(4).
Retry attempt logging and circuit breaker diagnostics are now debug-level.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify zero V(3) codebase-wide and update verification</name>
  <files>.planning/phases/18-logging-cleanup/18-VERIFICATION.md</files>
  <action>
Final verification that V(3) is completely eliminated:

1. Run codebase-wide V(3) scan:
   `grep -r 'klog.V(3)' pkg/ --include='*.go' | grep -v '_test.go'`
   Expected: Empty output (zero V(3) in production code)

2. Update 18-VERIFICATION.md to mark gap as closed:
   - Change status from `gaps_found` to `complete`
   - Update score from 4/5 to 5/5
   - Move gap items to "Resolved" section
   - Add timestamp for gap closure

3. Run full test suite: `make test`
   Expected: All 148+ tests pass
  </action>
  <verify>
`grep -rc 'klog.V(3)' pkg/ --include='*.go' | grep -v '_test.go' | grep -v ':0$'` returns empty (no V(3) in production code).
`make test` passes with all tests.
18-VERIFICATION.md shows status: complete and score 5/5.
  </verify>
  <done>
V(3) completely eliminated from codebase.
Phase 18 verification updated to reflect gap closure.
All packages follow consistent V(2)=outcome, V(4)=diagnostic pattern.
  </done>
</task>

</tasks>

<verification>
1. `grep -rc 'klog.V(3)' pkg/ --include='*.go' | grep -v '_test.go' | grep -v ':0$'` returns empty output
2. `make test` passes with all tests
3. `go build ./...` succeeds without errors
4. All utility packages (nvme, utils, circuitbreaker) now follow verbosity conventions
5. 18-VERIFICATION.md updated to status: complete
</verification>

<success_criteria>
- Zero V(3) statements remain in production code (excluding test files)
- All packages follow V(2)=outcome, V(4)=diagnostic pattern
- Phase 18 verification score updated to 5/5 with gaps resolved
- Test suite passes completely
</success_criteria>

<output>
After completion, create `.planning/phases/18-logging-cleanup/18-05-SUMMARY.md`
</output>
