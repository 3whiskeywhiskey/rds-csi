---
phase: 18-logging-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["18-02"]
files_modified:
  - pkg/mount/mount.go
  - pkg/mount/health.go
  - pkg/mount/recovery.go
  - pkg/mount/stale.go
  - pkg/driver/node.go
  - pkg/reconciler/orphan_reconciler.go
  - pkg/attachment/reconciler.go
autonomous: true

must_haves:
  truths:
    - "All CSI operations follow info=outcome, debug=diagnostic pattern"
    - "V(3) usage eliminated or documented as intentional"
    - "Production logs (V=2) show only actionable information"
  artifacts:
    - path: "pkg/mount/mount.go"
      provides: "Rationalized mount operation logging"
      contains: "klog.V(4)"
    - path: "pkg/driver/node.go"
      provides: "Rationalized node operation logging"
      contains: "klog.V(4)"
  key_links:
    - from: "all packages"
      to: "logging verbosity"
      via: "consistent pattern"
      pattern: "V\\(2\\).*success|complete|done|V\\(4\\).*attempt|check|found"
---

<objective>
Complete codebase verbosity audit for mount, node, and reconciler packages

Purpose: Apply consistent verbosity rationalization across remaining packages. Eliminate V(3) or document intentional use. Ensure production logs (V=2) contain only actionable outcomes.

Output:
- All packages follow V(2)=outcome, V(4)=diagnostic pattern
- V(3) eliminated (or explicitly documented as intentional)
- Verbosity mapping documented for future reference
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-logging-cleanup/18-CONTEXT.md
@.planning/phases/18-logging-cleanup/18-RESEARCH.md

# Key source files
@pkg/mount/mount.go
@pkg/mount/health.go
@pkg/mount/recovery.go
@pkg/driver/node.go
@pkg/reconciler/orphan_reconciler.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rationalize pkg/mount verbosity</name>
  <files>pkg/mount/mount.go, pkg/mount/health.go, pkg/mount/recovery.go, pkg/mount/stale.go, pkg/mount/procmounts.go</files>
  <action>
Audit and rationalize mount package verbosity:

**pkg/mount/mount.go (~25 V(2) statements):**
Current pattern logs both start and success for each operation.

Apply rationalization:
- Mount(): Remove start log, keep success at V(2). Details at V(4).
  - Current: V(2) "Mounting %s to %s" + V(2) "Successfully mounted"
  - Target: V(2) "Mounted %s to %s" (outcome only)

- Unmount(): Same pattern - outcome only at V(2)
  - Keep V(2) "path is not mounted, nothing to unmount" (actionable)

- FormatAndMount(): Outcome at V(2), "device already formatted" at V(4) (no-op)

- ResizeFs(): Outcome at V(2), intermediate steps at V(4)

- ForceUnmount(): Outcome at V(2), retry attempts at V(4)

**pkg/mount/health.go:**
- Keep V(2) "Skipping health check for unsupported filesystem" (actionable info)
- Move V(3) "health check passed" to V(4) (diagnostic)

**pkg/mount/recovery.go:**
- All V(3) statements are retry/step logs - move to V(4)
- Keep final outcome (success/failure) at V(2) if not already

**pkg/mount/stale.go:**
- V(3) "mount not stale" - move to V(4) (diagnostic)
- V(3) "mount not found" - move to V(4)

**pkg/mount/procmounts.go:**
- V(3) "Found mount device" - move to V(4) (diagnostic lookup)
  </action>
  <verify>
Run `go build ./...` to verify compilation.
Count V(3) in mount package: `grep -rc 'klog.V(3)' pkg/mount/` should show 0.
Run `make test` to verify tests pass.
  </verify>
  <done>
Mount package V(3) eliminated - all moved to V(4).
V(2) logs show outcomes only (mounted, unmounted, formatted).
V(4) logs show diagnostic steps (retries, lookups, checks).
  </done>
</task>

<task type="auto">
  <name>Task 2: Rationalize node.go and reconciler verbosity</name>
  <files>pkg/driver/node.go, pkg/reconciler/orphan_reconciler.go, pkg/attachment/reconciler.go</files>
  <action>
Audit and rationalize remaining packages:

**pkg/driver/node.go:**
- V(3) "Could not get device path" at line ~433 - move to V(4)
- Review V(2) statements for start/end duplication
- NodeStageVolume: Outcome at V(2), details at V(4)
- NodePublishVolume: Outcome at V(2), bind mount details at V(4)
- NodeUnstageVolume/NodeUnpublishVolume: Same pattern

**pkg/reconciler/orphan_reconciler.go:**
Current (many V(2) and V(3)):
- V(2) "Starting orphan reconciliation cycle" - keep (actionable)
- V(2) "Orphan reconciliation cycle complete" - keep (actionable summary)
- V(2) "No orphaned disk objects found" - move to V(4) (no-op)
- V(2) "No orphaned files found" - move to V(4) (no-op)
- V(2) "Deleting orphaned volume" - keep (actionable)
- V(3) "Scanning %d PersistentVolumes" - move to V(4) (diagnostic)
- V(3) "Found active PV" - move to V(4) (diagnostic)
- V(3) "RDS volume" - move to V(4) (diagnostic)
- V(3) "Checking %d RDS volumes" - move to V(4) (diagnostic)
- V(3) "Orphaned volume too young" - move to V(4) (diagnostic)

**pkg/attachment/reconciler.go:**
- V(3) "Starting attachment reconciliation" - move to V(4) (high frequency, not actionable unless issues)
- V(3) "Node deleted but within grace period" - move to V(4)
- V(3) "Attachment reconciliation complete" - move to V(4) (no stale = no-op)
- V(3) "Cannot get PV" - move to V(4) (edge case diagnostic)

**pkg/driver/vmi_grouper.go:**
- All V(3) statements are diagnostic - move to V(4)
  </action>
  <verify>
Run `go build ./...` to verify compilation.
Count V(3) across all pkg/: `grep -rc 'klog.V(3)' pkg/ | grep -v ':0$'` should be empty or minimal.
Run `make test` to verify tests pass.
  </verify>
  <done>
Node and reconciler packages follow V(2)=outcome, V(4)=diagnostic.
V(3) eliminated across codebase (except any documented exceptions).
Reconcilers are quiet at V(2) level when no action needed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document verbosity mapping</name>
  <files>pkg/driver/doc.go (create if needed)</files>
  <action>
Create or update package documentation with verbosity mapping:

Create `pkg/driver/doc.go`:
```go
// Package driver implements CSI Controller and Node services for RDS.
//
// # Logging Verbosity Convention
//
// This package follows Kubernetes logging conventions for verbosity levels:
//
//   - V(0): Always visible - panics, programmer errors
//   - V(1): Configuration, frequently repeating errors
//   - V(2): Production default - operation outcomes, state changes
//     Examples: "Created volume X", "Mounted Y to Z", "Deleted volume X"
//   - V(4): Debug level - intermediate steps, parameters, diagnostics
//     Examples: "Checking attachment state", "Found device path"
//   - V(5): Trace level - command I/O, parsing details
//     Examples: "RouterOS output: ...", "SSH command: ..."
//
// V(3) is avoided in favor of V(2) (if actionable) or V(4) (if diagnostic).
//
// Production deployments use V(2) by default. Set --v=4 for troubleshooting.
package driver
```

Add similar doc comments to pkg/mount/doc.go and pkg/rds/doc.go.
  </action>
  <verify>
Check doc.go files exist: `ls pkg/*/doc.go`
Run `go doc ./pkg/driver | head -20` to verify documentation visible.
  </verify>
  <done>
Verbosity conventions documented in package doc.go files.
Future contributors understand V(2) vs V(4) usage.
  </done>
</task>

</tasks>

<verification>
1. `make test` passes
2. `grep -rc 'klog.V(3)' pkg/ | grep -v ':0$' | grep -v '_test.go'` shows minimal/zero results
3. Production logs (V=2) are quiet during normal operation
4. Debug logs (V=4) provide sufficient diagnostic information
5. Verbosity conventions documented in doc.go files
</verification>

<success_criteria>
- V(3) eliminated from production code (or documented as intentional)
- All packages follow V(2)=outcome, V(4)=diagnostic pattern
- Package documentation explains verbosity conventions
- Info level (V=2) contains only actionable information
</success_criteria>

<output>
After completion, create `.planning/phases/18-logging-cleanup/18-03-SUMMARY.md`
</output>
