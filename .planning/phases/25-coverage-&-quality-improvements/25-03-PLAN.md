---
phase: 25-coverage-quality
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - pkg/driver/controller_test.go
  - pkg/driver/node_test.go
  - test/sanity/sanity_test.go
autonomous: true

must_haves:
  truths:
    - "CSI negative tests validate all required error codes"
    - "Idempotency is tested for all controller operations"
    - "Edge cases from sanity test failures have regression tests"
  artifacts:
    - path: "pkg/driver/controller_test.go"
      provides: "CSI negative test scenarios"
      contains: "TestCSI_NegativeScenarios"
    - path: "pkg/driver/node_test.go"
      provides: "Node negative test scenarios"
      contains: "TestNodeCSI_NegativeScenarios"
  key_links:
    - from: "pkg/driver/controller.go"
      to: "google.golang.org/grpc/status"
      via: "CSI error code mapping"
      pattern: "status\\.Errorf\\(codes\\."
    - from: "pkg/driver/node.go"
      to: "google.golang.org/grpc/status"
      via: "CSI error code mapping"
      pattern: "status\\.Errorf\\(codes\\."
---

<objective>
Add negative test scenarios validating CSI error codes and idempotency, plus regression tests for edge cases found in sanity testing.

Purpose: COV-03 requires edge cases from sanity test failures have regression tests. COV-04 requires negative test scenarios validate error handling returns correct CSI error codes. This plan consolidates CSI-spec negative testing.

Output: Comprehensive negative test suite ensuring CSI spec compliance for error scenarios.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-coverage-&-quality-improvements/25-RESEARCH.md

@pkg/driver/controller.go
@pkg/driver/controller_test.go
@pkg/driver/node.go
@pkg/driver/node_test.go
@test/sanity/sanity_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSI negative test scenarios for controller</name>
  <files>pkg/driver/controller_test.go</files>
  <action>
Add `TestCSI_NegativeScenarios_Controller` covering all CSI-required error codes for controller service.

**CSI Error Code Requirements (per CSI spec 1.5.0):**

| Scenario | Required Code | CSI Spec Reference |
|----------|---------------|-------------------|
| Missing volume name | InvalidArgument | CreateVolume |
| Missing volume capabilities | InvalidArgument | CreateVolume |
| Unsupported volume capability | InvalidArgument | CreateVolume |
| Volume already exists (diff params) | AlreadyExists | CreateVolume |
| Insufficient capacity | ResourceExhausted | CreateVolume |
| Missing volume ID | InvalidArgument | DeleteVolume |
| Volume not found (delete) | OK (idempotent) | DeleteVolume |
| Missing volume ID (publish) | InvalidArgument | ControllerPublishVolume |
| Missing node ID (publish) | InvalidArgument | ControllerPublishVolume |
| Volume not found (publish) | NotFound | ControllerPublishVolume |
| Node not found (publish) | NotFound | ControllerPublishVolume |
| RWO conflict | FailedPrecondition | ControllerPublishVolume |
| Missing volume ID (unpublish) | InvalidArgument | ControllerUnpublishVolume |
| Not published (unpublish) | OK (idempotent) | ControllerUnpublishVolume |

Structure as comprehensive table-driven test:
```go
func TestCSI_NegativeScenarios_Controller(t *testing.T) {
    tests := []struct {
        name       string
        method     string  // "CreateVolume", "DeleteVolume", etc.
        request    interface{}
        setupMock  func(*rds.MockClient)
        wantCode   codes.Code
        wantErrMsg string
    }{
        // cases...
    }
    // ...
}
```

This consolidates and extends existing validation tests with explicit CSI spec references.
  </action>
  <verify>
Run `go test -v -run TestCSI_NegativeScenarios_Controller ./pkg/driver/...` - all 14+ cases pass with correct codes.
  </verify>
  <done>
All CSI-required error codes for controller service are tested with spec references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSI negative test scenarios for node service</name>
  <files>pkg/driver/node_test.go</files>
  <action>
Add `TestCSI_NegativeScenarios_Node` covering CSI-required error codes for node service.

**CSI Error Code Requirements:**

| Scenario | Required Code | Method |
|----------|---------------|--------|
| Missing volume ID | InvalidArgument | NodeStageVolume |
| Missing staging path | InvalidArgument | NodeStageVolume |
| Missing volume capability | InvalidArgument | NodeStageVolume |
| Already staged (same params) | OK (idempotent) | NodeStageVolume |
| Already staged (diff params) | AlreadyExists | NodeStageVolume |
| Missing volume ID | InvalidArgument | NodeUnstageVolume |
| Missing staging path | InvalidArgument | NodeUnstageVolume |
| Not staged | OK (idempotent) | NodeUnstageVolume |
| Missing volume ID | InvalidArgument | NodePublishVolume |
| Missing target path | InvalidArgument | NodePublishVolume |
| Missing staging path | InvalidArgument | NodePublishVolume |
| Already published (same) | OK (idempotent) | NodePublishVolume |
| Missing volume ID | InvalidArgument | NodeUnpublishVolume |
| Missing target path | InvalidArgument | NodeUnpublishVolume |
| Not published | OK (idempotent) | NodeUnpublishVolume |
| Missing volume ID | InvalidArgument | NodeGetVolumeStats |
| Missing volume path | InvalidArgument | NodeGetVolumeStats |

Test idempotency carefully - critical for Kubernetes retry behavior during pod lifecycle.
  </action>
  <verify>
Run `go test -v -run TestCSI_NegativeScenarios_Node ./pkg/driver/...` - all 17+ cases pass.
  </verify>
  <done>
All CSI-required error codes for node service are tested with idempotency verified.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sanity test edge case regression tests</name>
  <files>pkg/driver/controller_test.go, pkg/driver/node_test.go</files>
  <action>
Review CSI sanity test output for any edge cases and create regression tests.

Run sanity tests to identify any edge cases:
```bash
go test -v ./test/sanity/... 2>&1 | grep -E "(FAIL|Error|edge case)"
```

Common sanity test edge cases to add regression tests for:

1. **CreateVolume with 0-byte capacity** - Should use default minimum (1GiB)
2. **CreateVolume with negative capacity** - Should return InvalidArgument
3. **CreateVolume with max int64 capacity** - Should return OutOfRange or ResourceExhausted
4. **ControllerPublishVolume with readonly flag** - Should succeed or return InvalidArgument if not supported
5. **NodeStageVolume with empty secrets** - Should handle gracefully (secrets optional)
6. **Volume context parameters validation** - fsType, nvmeAddress, etc.

Add tests in appropriate test files with comment indicating they are sanity regression tests:
```go
// TestSanityRegression_CreateVolumeZeroCapacity is a regression test
// for CSI sanity edge case: capacity_range with required_bytes=0
func TestSanityRegression_CreateVolumeZeroCapacity(t *testing.T) {
    // ...
}
```
  </action>
  <verify>
Run sanity tests: `go test -v -timeout 5m ./test/sanity/...` - no new failures. Run regression tests: `go test -v -run TestSanityRegression ./pkg/driver/...` - all pass.
  </verify>
  <done>
Edge cases from sanity tests have corresponding regression tests preventing reoccurrence.
  </done>
</task>

</tasks>

<verification>
```bash
# Run all negative and regression tests
go test -v -run "CSI_NegativeScenarios|SanityRegression" ./pkg/driver/...

# Run sanity tests to verify no regressions
go test -v -timeout 10m ./test/sanity/...

# Check that error codes are properly documented
grep -r "codes\." pkg/driver/*_test.go | grep -E "(InvalidArgument|NotFound|AlreadyExists|ResourceExhausted|FailedPrecondition|Unavailable)"
```

Expected: All negative scenarios pass, sanity tests pass, error codes match CSI spec.
</verification>

<success_criteria>
1. TestCSI_NegativeScenarios_Controller exists with 14+ cases covering all required codes
2. TestCSI_NegativeScenarios_Node exists with 17+ cases covering all required codes
3. At least 6 sanity regression tests added
4. All tests pass
5. CSI sanity test suite still passes (no regressions introduced)
6. Each test case documents the CSI spec requirement being validated
</success_criteria>

<output>
After completion, create `.planning/phases/25-coverage-&-quality-improvements/25-03-SUMMARY.md`
</output>
