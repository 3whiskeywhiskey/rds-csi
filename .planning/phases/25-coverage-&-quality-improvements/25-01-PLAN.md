---
phase: 25-coverage-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/controller_test.go
  - pkg/rds/client_test.go
autonomous: true

must_haves:
  truths:
    - "SSH connection failures return codes.Unavailable"
    - "Disk full scenarios return codes.ResourceExhausted"
    - "Invalid volume parameters return codes.InvalidArgument"
    - "SSH timeout scenarios are tested with proper retries"
  artifacts:
    - path: "pkg/driver/controller_test.go"
      provides: "Controller error path tests"
      contains: "TestCreateVolume_SSHFailures"
    - path: "pkg/rds/client_test.go"
      provides: "RDS client error path tests"
      contains: "TestClient_ErrorScenarios"
  key_links:
    - from: "pkg/driver/controller.go"
      to: "pkg/rds/client.go"
      via: "SSH error propagation"
      pattern: "codes\\.(Unavailable|ResourceExhausted)"
---

<objective>
Add comprehensive error path test coverage for controller service SSH failures, disk full scenarios, and invalid parameters.

Purpose: COV-01 requires error paths in controller service have test coverage for SSH failures, disk full scenarios, and invalid parameters. Current pkg/driver coverage is 50.8% and pkg/rds is 61.9% - both need improvement to reach 70% overall.

Output: Table-driven error path tests that validate correct CSI gRPC error codes are returned for each failure scenario.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-coverage-&-quality-improvements/25-RESEARCH.md

@pkg/driver/controller.go
@pkg/driver/controller_test.go
@pkg/rds/client.go
@pkg/rds/client_test.go
@pkg/rds/mock_client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add controller SSH failure error path tests</name>
  <files>pkg/driver/controller_test.go</files>
  <action>
Add table-driven tests for controller service error scenarios. Create a new test function `TestCreateVolume_ErrorScenarios` that covers:

1. **SSH Connection Failures** - MockClient returns connection refused error
   - Setup: `mockRDS.SetError(errors.New("ssh: connection refused"))`
   - Expected: `codes.Unavailable` with message mentioning "RDS unavailable"

2. **SSH Timeout** - MockClient returns timeout error
   - Setup: `mockRDS.SetError(errors.New("ssh: timeout after 30s"))`
   - Expected: `codes.Unavailable` with message mentioning timeout

3. **Disk Full on RDS** - MockClient returns "not enough space" error
   - Setup: `mockRDS.SetError(errors.New("not enough space on device"))`
   - Expected: `codes.ResourceExhausted` with message mentioning capacity

4. **Command Parsing Error** - MockClient returns garbled output
   - Setup: `mockRDS.SetError(errors.New("unexpected output format"))`
   - Expected: `codes.Internal` with message about parsing

5. **Volume Already Exists with Different Size** - Idempotency edge case
   - Setup: Add existing volume with 1GiB, request 2GiB
   - Expected: `codes.AlreadyExists` per CSI spec

Test structure should follow existing pattern in controller_test.go using table-driven tests with `t.Run()`. Use `status.FromError(err)` to validate gRPC codes.

The MockClient needs a `SetError(err error)` method if not present - check mock_client.go first. If missing, add to rds/mock_client.go:

```go
func (m *MockClient) SetError(err error) {
    m.mu.Lock()
    defer m.mu.Unlock()
    m.nextError = err
}
```

And modify CreateVolume to return this error when set.
  </action>
  <verify>
Run `go test -v -run TestCreateVolume_ErrorScenarios ./pkg/driver/...` - all test cases pass with correct error codes.
  </verify>
  <done>
At least 5 error scenarios tested with verified gRPC error codes matching CSI spec requirements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add RDS client error path tests</name>
  <files>pkg/rds/client_test.go, pkg/rds/mock_client.go</files>
  <action>
Add tests to improve pkg/rds coverage from 61.9% to target 70%. Create `TestClient_ErrorScenarios` covering:

1. **SSH Handshake Failure** - Invalid credentials
   - Test that client properly wraps SSH errors
   - Verify error message is actionable

2. **Command Execution Timeout** - Command hangs
   - Test timeout handling
   - Verify retry behavior

3. **RouterOS Parse Errors** - Malformed output
   - Test various malformed /disk print outputs
   - Verify parse errors are properly wrapped

4. **Volume Not Found** - Delete non-existent volume
   - Test idempotent delete behavior
   - Verify no error returned (per CSI spec)

5. **Concurrent Operations** - Race condition handling
   - Test concurrent CreateVolume calls
   - Verify no data races (use -race flag)

Add mock enhancements to mock_client.go if needed:
- `SetLatency(duration time.Duration)` for timeout testing
- `SetParseError(bool)` for malformed output simulation

Use existing test patterns from client_test.go. Focus on error paths that have 0% coverage in current coverage report.
  </action>
  <verify>
Run `go test -v -race -coverprofile=/tmp/rds-cov.out ./pkg/rds/...` and verify coverage increased. Check `go tool cover -func=/tmp/rds-cov.out | grep -E "^git.*pkg/rds"` shows improvement toward 70%.
  </verify>
  <done>
pkg/rds coverage improved from 61.9% to at least 68% with all SSH/parse error paths tested.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add DeleteVolume error path tests</name>
  <files>pkg/driver/controller_test.go</files>
  <action>
Add `TestDeleteVolume_ErrorScenarios` table-driven tests covering:

1. **SSH Failure During Delete** - Connection lost mid-operation
   - Expected: `codes.Unavailable`

2. **Volume In Use** - Volume still attached (if applicable)
   - Expected: `codes.FailedPrecondition`

3. **Invalid Volume ID Format** - Injection attempt variations
   - `"pvc-test; rm -rf /"` -> `codes.InvalidArgument`
   - `""` (empty) -> `codes.InvalidArgument`
   - `"not-a-pvc-format"` -> `codes.InvalidArgument`

4. **Idempotent Delete** - Delete already-deleted volume
   - Expected: Success (no error) per CSI spec
   - This is critical for Kubernetes retry behavior

5. **Partial Failure Recovery** - Volume removed but SSH disconnects before response
   - Test that re-delete succeeds (idempotent)

Structure tests using existing pattern with `testControllerServer(t)` helper.
  </action>
  <verify>
Run `go test -v -run TestDeleteVolume_ErrorScenarios ./pkg/driver/...` - all cases pass with correct gRPC codes.
  </verify>
  <done>
DeleteVolume error paths have test coverage for SSH failures, invalid IDs, and idempotency.
  </done>
</task>

</tasks>

<verification>
```bash
# Run all controller tests
go test -v -race ./pkg/driver/...

# Run RDS client tests
go test -v -race ./pkg/rds/...

# Check coverage improvement
go test -covermode=atomic -coverprofile=/tmp/cov.out ./pkg/driver/... ./pkg/rds/...
go tool cover -func=/tmp/cov.out | grep total
```

Expected: pkg/driver coverage should increase from 50.8% toward 60%+, pkg/rds from 61.9% toward 70%.
</verification>

<success_criteria>
1. TestCreateVolume_ErrorScenarios exists with 5+ error cases
2. TestDeleteVolume_ErrorScenarios exists with 5+ error cases
3. TestClient_ErrorScenarios exists with 5+ RDS client error cases
4. All tests pass with -race flag
5. Coverage increased: pkg/driver > 55%, pkg/rds > 68%
6. gRPC error codes match CSI spec (Unavailable for SSH, ResourceExhausted for disk full, InvalidArgument for validation)
</success_criteria>

<output>
After completion, create `.planning/phases/25-coverage-&-quality-improvements/25-01-SUMMARY.md`
</output>
