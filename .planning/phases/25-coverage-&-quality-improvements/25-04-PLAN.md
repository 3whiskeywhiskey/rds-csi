---
phase: 25-coverage-quality
plan: 04
type: execute
wave: 3
depends_on: ["25-03"]
files_modified:
  - .gitea/workflows/full-test.yml
  - .go-test-coverage.yml
  - TESTING.md
autonomous: true

must_haves:
  truths:
    - "CI fails builds below 65% coverage"
    - "Flaky tests are identified and documented"
    - "TESTING.md documents skipped tests with rationale"
  artifacts:
    - path: ".gitea/workflows/full-test.yml"
      provides: "CI coverage enforcement at 65%"
      contains: "COVERAGE < 65"
    - path: "TESTING.md"
      provides: "Flaky test documentation"
      contains: "Flaky Tests"
  key_links:
    - from: ".gitea/workflows/full-test.yml"
      to: "coverage.out"
      via: "coverage threshold check"
      pattern: "go tool cover"
---

<objective>
Update CI coverage threshold to 65%, detect flaky tests, and document findings in TESTING.md.

Purpose: COV-05 requires coverage enforcement in CI fails builds below 65% baseline. COV-06 requires flaky tests are identified and either fixed or skipped with documented rationale.

Output: CI threshold updated, flaky tests detected and documented, TESTING.md updated.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-coverage-&-quality-improvements/25-RESEARCH.md

@.gitea/workflows/full-test.yml
@.go-test-coverage.yml
@TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run flaky test detection</name>
  <files>TESTING.md</files>
  <action>
Run flaky test detection using `-count=N` pattern:

```bash
# Run all tests 10 times to detect flaky behavior
go test -count=10 -race -timeout 30m ./pkg/... 2>&1 | tee /tmp/flaky-detection.log

# Check for any failures
grep -E "^--- FAIL:" /tmp/flaky-detection.log || echo "No failures detected"

# Run specific packages suspected of flakiness (timing-dependent)
go test -count=20 -v -race ./pkg/nvme/... 2>&1 | tee /tmp/nvme-flaky.log
go test -count=20 -v -race ./pkg/mount/... 2>&1 | tee /tmp/mount-flaky.log
go test -count=20 -v -race ./test/mock/... 2>&1 | tee /tmp/mock-flaky.log
```

**Document findings:**
- If flaky test found: Note which test, how often it fails, suspected cause
- If test cannot be fixed: Add `t.Skip()` with reason and create tracking issue

**Common flaky patterns to check:**
1. Timing assumptions (time.Sleep, fixed timeouts)
2. Map iteration order
3. Concurrent access without synchronization
4. File system race conditions
5. Port conflicts in mock servers

Document all findings in TESTING.md under new "Flaky Tests" section.
  </action>
  <verify>
Run `go test -count=10 -race ./pkg/...` and verify either: (a) no flaky tests found, or (b) flaky tests documented in TESTING.md with skip rationale.
  </verify>
  <done>
Flaky test detection completed with all findings documented. Either no flaky tests or all flaky tests have documented rationale.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CI coverage threshold to 65%</name>
  <files>.gitea/workflows/full-test.yml</files>
  <action>
Update the coverage threshold check in `.gitea/workflows/full-test.yml`:

Change the threshold from 60% to 65%:
```yaml
      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"

          if (( $(echo "$COVERAGE < 65" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below 65% threshold"
            exit 1
          fi

          echo "::notice::Coverage ${COVERAGE}% meets 65% threshold"
```

Also update the log message to be clearer:
- Use `::error::` for failures (renders as error annotation in Gitea)
- Use `::notice::` for success

This change should only be made AFTER plans 25-01, 25-02, and 25-03 have increased coverage above 65%.
  </action>
  <verify>
Check current coverage: `go test -covermode=atomic -coverprofile=/tmp/cov.out ./pkg/... && go tool cover -func=/tmp/cov.out | grep total` - should show >= 65%.
  </verify>
  <done>
CI threshold updated to 65% and current codebase meets this threshold.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update TESTING.md with comprehensive documentation</name>
  <files>TESTING.md</files>
  <action>
Update TESTING.md with:

1. **Add "Flaky Tests" section** (after Troubleshooting):
```markdown
## Flaky Tests

### Detected Flaky Tests

| Test | Package | Failure Rate | Cause | Status |
|------|---------|--------------|-------|--------|
| (none currently) | - | - | - | - |

### Detection Methodology

Flaky tests are detected using:
```bash
go test -count=10 -race ./pkg/...
```

A test is considered flaky if it fails intermittently across multiple runs.

### Skipped Tests

| Test | Package | Reason | Tracking Issue |
|------|---------|--------|----------------|
| (none currently) | - | - | - |

If a flaky test cannot be fixed immediately, it is skipped with `t.Skip("reason")`
and tracked for future resolution.
```

2. **Update "Test Coverage Goals" section** with current status:
```markdown
### Current Status (v0.9.0)

- **Overall Coverage**: ~65% (target 70%)
- **CI Threshold**: 65% minimum
- **Package Thresholds**:
  - pkg/rds: 70% (critical path)
  - pkg/mount: 70% (system interaction)
  - pkg/nvme: 55% (hardware-dependent)
  - pkg/utils: 80% (pure utility)
  - pkg/attachment: 80% (state management)
```

3. **Add "Running Specific Test Suites" section** listing commands:
```markdown
### Running Specific Test Suites

```bash
# Unit tests only
make test

# Unit tests with coverage
make test-coverage

# E2E tests (mock environment)
make e2e-test

# CSI sanity tests
go test -v -timeout 15m ./test/sanity/...

# Stress tests
go test -v -race -timeout 5m ./test/mock/... -run TestConcurrent

# Flaky test detection
go test -count=10 -race ./pkg/...
```
```

4. **Update "Last Updated" timestamp** at bottom of file.
  </action>
  <verify>
Read TESTING.md and verify all sections are present and accurate. Validate markdown renders correctly.
  </verify>
  <done>
TESTING.md is comprehensive with flaky test documentation, current coverage status, and clear instructions.
  </done>
</task>

</tasks>

<verification>
```bash
# Verify CI threshold works
COVERAGE=$(go test -covermode=atomic -coverprofile=/tmp/cov.out ./pkg/... 2>/dev/null && go tool cover -func=/tmp/cov.out | grep total | awk '{print $3}' | sed 's/%//')
echo "Current coverage: ${COVERAGE}%"
if (( $(echo "$COVERAGE < 65" | bc -l) )); then
  echo "WARNING: Coverage below threshold - plans 25-01/02/03 may not have run"
else
  echo "Coverage meets 65% threshold"
fi

# Verify TESTING.md has required sections
grep -q "Flaky Tests" TESTING.md && echo "Flaky Tests section exists"
grep -q "65%" TESTING.md && echo "65% threshold documented"
```
</verification>

<success_criteria>
1. Flaky test detection run with results documented
2. CI threshold updated from 60% to 65%
3. TESTING.md has "Flaky Tests" section with detection methodology
4. TESTING.md has updated coverage goals reflecting current state
5. TESTING.md has "Running Specific Test Suites" section
6. Current codebase coverage meets 65% threshold
</success_criteria>

<output>
After completion, create `.planning/phases/25-coverage-&-quality-improvements/25-04-SUMMARY.md`
</output>
