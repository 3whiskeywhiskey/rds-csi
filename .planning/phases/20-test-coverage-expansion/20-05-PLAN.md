---
phase: 20-test-coverage-expansion
plan: 05
type: execute
wave: 2
depends_on: ["20-01", "20-02", "20-03"]
files_modified:
  - .go-test-coverage.yml
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Coverage enforcement is configured with 80% threshold per package"
    - "Coverage check can be run via make command"
    - "CI can fail builds when coverage drops below threshold"
    - "Critical packages (rds, mount, nvme) meet 60% minimum threshold"
  artifacts:
    - path: ".go-test-coverage.yml"
      provides: "Coverage enforcement configuration"
      min_lines: 15
    - path: "Makefile"
      provides: "Coverage check target"
      contains: "test-coverage-check"
  key_links:
    - from: "Makefile"
      to: ".go-test-coverage.yml"
      via: "make target runs go-test-coverage with config"
      pattern: "go-test-coverage"
---

<objective>
Configure coverage enforcement tooling to prevent regression and verify phase coverage targets are met.

Purpose: Automated coverage enforcement ensures the work done in plans 01-04 is maintained over time and prevents new code from degrading coverage.

Output: Coverage configuration file and Makefile target for automated enforcement.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-test-coverage-expansion/20-RESEARCH.md
@.planning/phases/20-test-coverage-expansion/20-01-SUMMARY.md
@.planning/phases/20-test-coverage-expansion/20-02-SUMMARY.md
@.planning/phases/20-test-coverage-expansion/20-03-SUMMARY.md

@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create coverage enforcement configuration</name>
  <files>.go-test-coverage.yml</files>
  <action>
Create .go-test-coverage.yml configuration for the go-test-coverage tool:

```yaml
# go-test-coverage configuration
# https://github.com/vladopajic/go-test-coverage

# Overall coverage thresholds
threshold:
  # Minimum coverage per file (some files may be intentionally lower)
  file: 0      # Disabled - enforce at package level instead
  # Minimum coverage per package
  package: 60  # 60% minimum for all packages (realistic given hardware dependencies)
  # Total coverage across all packages
  total: 55    # 55% overall minimum

# Package-specific overrides
override:
  # Critical packages with higher requirements
  - threshold: 70
    path: ^pkg/rds$
  - threshold: 70
    path: ^pkg/mount$
  - threshold: 55
    path: ^pkg/nvme$       # Lower due to hardware dependencies
  - threshold: 80
    path: ^pkg/utils$      # Pure utility code, should have high coverage
  - threshold: 80
    path: ^pkg/attachment$ # State management, well-testable

# Exclusions - files/packages that don't need coverage
exclude:
  # Test files themselves
  - path: _test\.go$
  # Generated files
  - path: _generated\.go$
  # Main entry point (mostly wiring)
  - path: ^cmd/
  # Integration tests (not counted in unit coverage)
  - path: ^test/integration/
  # Mock implementations (test helpers)
  - path: mock\.go$

# Output configuration
output:
  # Generate badge for README
  badge:
    enabled: false  # Enable when ready for README badge
    path: coverage.svg
```

**Rationale for thresholds:**
- package: 60% - Realistic baseline given hardware dependencies in nvme/mount
- pkg/rds: 70% - Control plane, mostly testable with mocks
- pkg/mount: 70% - Data plane, some OS dependencies
- pkg/nvme: 55% - Heavy hardware dependencies, legacy functions
- pkg/utils: 80% - Pure Go utilities, highly testable
- pkg/attachment: 80% - State management, well-testable
  </action>
  <verify>
```bash
cat .go-test-coverage.yml
```
Config file exists with proper YAML structure.
  </verify>
  <done>
- Configuration file created with package thresholds
- Exclusions defined for test files, generated files, integration tests
- Realistic thresholds accounting for hardware dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Makefile target for coverage checking</name>
  <files>Makefile</files>
  <action>
Add coverage checking targets to existing Makefile:

```makefile
# Coverage enforcement
.PHONY: test-coverage-check install-coverage-tool

# Install go-test-coverage tool
install-coverage-tool:
	@echo "Installing go-test-coverage..."
	go install github.com/vladopajic/go-test-coverage/v2@latest

# Run tests with coverage and check thresholds
test-coverage-check: install-coverage-tool
	@echo "Running tests with coverage..."
	go test -coverprofile=coverage.out -covermode=atomic ./pkg/...
	@echo "Checking coverage thresholds..."
	go-test-coverage --config=.go-test-coverage.yml --profile=coverage.out
	@echo "Coverage check passed!"

# Generate coverage report without enforcement (for local development)
test-coverage-report:
	go test -coverprofile=coverage.out -covermode=atomic ./pkg/...
	go tool cover -func=coverage.out
	@echo ""
	@echo "For HTML report: go tool cover -html=coverage.out"
```

Add these targets after the existing test targets in the Makefile. Ensure proper spacing and alignment with existing targets.

**Usage:**
- `make test-coverage-check` - CI/CD enforcement (fails if below threshold)
- `make test-coverage-report` - Local development (shows report, doesn't fail)
  </action>
  <verify>
```bash
make test-coverage-report
```
Coverage report is generated successfully.
  </verify>
  <done>
- Makefile has test-coverage-check target
- Makefile has test-coverage-report target for local use
- Coverage tool installation is automated
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify current coverage meets thresholds</name>
  <files></files>
  <action>
Run coverage check to verify all packages meet their thresholds after the work from plans 01-04:

```bash
# Run the coverage check
make test-coverage-report

# Check specific package coverages
go test -coverprofile=/tmp/cov.out ./pkg/rds/... && go tool cover -func=/tmp/cov.out | tail -1
go test -coverprofile=/tmp/cov.out ./pkg/mount/... && go tool cover -func=/tmp/cov.out | tail -1
go test -coverprofile=/tmp/cov.out ./pkg/nvme/... && go tool cover -func=/tmp/cov.out | tail -1
go test -coverprofile=/tmp/cov.out ./pkg/attachment/... && go tool cover -func=/tmp/cov.out | tail -1
go test -coverprofile=/tmp/cov.out ./pkg/utils/... && go tool cover -func=/tmp/cov.out | tail -1
```

If any package is below threshold, document the gap and create a follow-up todo for gap closure.

Expected minimum after plans 01-04:
- pkg/rds: >55% (was 44.4%)
- pkg/mount: >65% (was 55.9%)
- pkg/nvme: >50% (was 43.3%)
- pkg/attachment: already >80%
- pkg/utils: already >80%
  </action>
  <verify>
```bash
make test-coverage-report 2>&1 | grep -E "total:|pkg/"
```
All packages show coverage percentages.
  </verify>
  <done>
- Coverage report shows current state of all packages
- Any gaps below threshold are documented
- Phase 20 coverage targets verified
  </done>
</task>

</tasks>

<verification>
Run full coverage check:
```bash
make test-coverage-report
```

Verify configuration is valid:
```bash
cat .go-test-coverage.yml | head -20
grep "test-coverage" Makefile
```

Optional (if tool is installed): Run enforcement check:
```bash
make test-coverage-check || echo "Some packages below threshold - documented in summary"
```
</verification>

<success_criteria>
1. .go-test-coverage.yml exists with valid configuration
2. Makefile has test-coverage-check and test-coverage-report targets
3. `make test-coverage-report` runs successfully
4. Coverage thresholds are documented and realistic
5. Current package coverages documented in summary
</success_criteria>

<output>
After completion, create `.planning/phases/20-test-coverage-expansion/20-05-SUMMARY.md`

Include in summary:
- Final coverage percentages for each critical package
- Comparison with starting coverage (from research)
- Any packages still below target with explanation
- Recommendations for future coverage work
</output>
