---
phase: 06-csi-publish-unpublish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/driver.go
  - pkg/driver/events.go
autonomous: true

must_haves:
  truths:
    - "ControllerGetCapabilities returns PUBLISH_UNPUBLISH_VOLUME capability"
    - "Attachment conflicts can be posted as Kubernetes events to PVCs"
  artifacts:
    - path: "pkg/driver/driver.go"
      provides: "PUBLISH_UNPUBLISH_VOLUME capability declaration"
      contains: "RPC_PUBLISH_UNPUBLISH_VOLUME"
    - path: "pkg/driver/events.go"
      provides: "PostAttachmentConflict event method"
      contains: "PostAttachmentConflict"
  key_links:
    - from: "pkg/driver/driver.go"
      to: "csi.ControllerServiceCapability_RPC_PUBLISH_UNPUBLISH_VOLUME"
      via: "addControllerServiceCapabilities"
      pattern: "PUBLISH_UNPUBLISH_VOLUME"
---

<objective>
Add PUBLISH_UNPUBLISH_VOLUME capability and attachment conflict event posting.

Purpose: Enable external-attacher to call ControllerPublish/Unpublish and give operators visibility into attachment conflicts via kubectl describe pvc.
Output: Capability declared in driver.go, PostAttachmentConflict method in events.go
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.3-ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-csi-publish-unpublish/06-CONTEXT.md
@.planning/phases/06-csi-publish-unpublish/06-RESEARCH.md

# Existing implementation references
@pkg/driver/driver.go
@pkg/driver/events.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PUBLISH_UNPUBLISH_VOLUME capability</name>
  <files>pkg/driver/driver.go</files>
  <action>
Add PUBLISH_UNPUBLISH_VOLUME capability to the controller service capabilities in addControllerServiceCapabilities().

Append to the existing cscaps slice:

```go
{
    Type: &csi.ControllerServiceCapability_Rpc{
        Rpc: &csi.ControllerServiceCapability_RPC{
            Type: csi.ControllerServiceCapability_RPC_PUBLISH_UNPUBLISH_VOLUME,
        },
    },
},
```

This must be added AFTER the existing capabilities (CREATE_DELETE_VOLUME, GET_CAPACITY, EXPAND_VOLUME).

Do NOT modify any other part of driver.go.
  </action>
  <verify>
Run `go build ./...` to verify syntax. Grep for PUBLISH_UNPUBLISH_VOLUME in driver.go.
  </verify>
  <done>
ControllerGetCapabilities response includes PUBLISH_UNPUBLISH_VOLUME capability. External-attacher will now call ControllerPublishVolume/ControllerUnpublishVolume.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PostAttachmentConflict event method</name>
  <files>pkg/driver/events.go</files>
  <action>
Add a new event reason constant and method for attachment conflict events.

1. Add constant after existing event reasons:

```go
// Attachment conflict events
EventReasonAttachmentConflict = "AttachmentConflict"
```

2. Add PostAttachmentConflict method to EventPoster (follow existing pattern from PostMountFailure):

```go
// PostAttachmentConflict posts a Warning event when a volume attachment is rejected
// due to the volume being attached to a different node.
// Parameters: ctx, pvcNamespace, pvcName, volumeID, requestedNode, attachedNode
func (ep *EventPoster) PostAttachmentConflict(ctx context.Context, pvcNamespace, pvcName, volumeID, requestedNode, attachedNode string) error {
    pvc, err := ep.clientset.CoreV1().PersistentVolumeClaims(pvcNamespace).Get(ctx, pvcName, metav1.GetOptions{})
    if err != nil {
        // Don't fail the operation just because event couldn't be posted
        klog.Warningf("Failed to get PVC %s/%s for attachment conflict event: %v", pvcNamespace, pvcName, err)
        return nil
    }

    // Format message with actionable information for operators
    eventMessage := fmt.Sprintf("[%s]: Attachment to node %s rejected - volume already attached to node %s. Delete the pod on %s to release the volume.", volumeID, requestedNode, attachedNode, attachedNode)

    ep.recorder.Event(pvc, corev1.EventTypeWarning, EventReasonAttachmentConflict, eventMessage)

    // Record metric
    if ep.metrics != nil {
        ep.metrics.RecordEventPosted(EventReasonAttachmentConflict)
    }

    klog.V(2).Infof("Posted attachment conflict event to PVC %s/%s: %s", pvcNamespace, pvcName, eventMessage)
    return nil
}
```

Key points:
- Warning event type (not Normal) since this blocks pod scheduling
- Message includes both nodes and actionable guidance
- Follows existing pattern: get PVC, post event, record metric, log
- Returns nil on error (don't fail main operation due to event posting)
  </action>
  <verify>
Run `go build ./...` to verify syntax. Grep for PostAttachmentConflict in events.go.
  </verify>
  <done>
PostAttachmentConflict method exists and follows the EventPoster pattern. Operators will see "AttachmentConflict" events via `kubectl describe pvc` when RWO volumes are attached elsewhere.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` passes without errors
2. `grep -n "PUBLISH_UNPUBLISH_VOLUME" pkg/driver/driver.go` shows capability
3. `grep -n "PostAttachmentConflict" pkg/driver/events.go` shows method
4. `grep -n "AttachmentConflict" pkg/driver/events.go` shows constant
</verification>

<success_criteria>
- CSI-04 (PUBLISH_UNPUBLISH_VOLUME capability declared) is satisfied
- OBS-02 partial (attachment conflict events) is prepared for Phase 6 usage
- Both changes compile and maintain existing patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-csi-publish-unpublish/06-01-SUMMARY.md`
</output>
