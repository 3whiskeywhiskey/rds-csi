---
phase: 19-error-handling
plan: 04
type: execute
wave: 2
depends_on: ["19-02"]
files_modified:
  - .golangci.yml
autonomous: true

must_haves:
  truths:
    - "errorlint detects incorrect %v usage with errors"
    - "errcheck catches unchecked errors"
    - "Linting runs without false positives on existing code"
  artifacts:
    - path: ".golangci.yml"
      provides: "Linter configuration"
      contains: "errorlint"
  key_links:
    - from: ".golangci.yml"
      to: "make lint"
      via: "golangci-lint config"
      pattern: "errorlint"
---

<objective>
Add golangci-lint configuration with error linting rules

Purpose: Enforce error handling patterns automatically in CI and development

Output: .golangci.yml with errorlint and errcheck configured
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-error-handling/19-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create golangci-lint configuration</name>
  <files>.golangci.yml</files>
  <action>
Create `.golangci.yml` in the project root with error-focused linters:

```yaml
# golangci-lint configuration for RDS CSI Driver
# Run with: make lint (or golangci-lint run)

run:
  timeout: 5m
  tests: true
  build-tags:
    - integration

linters:
  enable:
    # Error handling linters
    - errcheck      # Check for unchecked errors
    - errorlint     # Enforce Go 1.13+ error patterns

    # Code quality (already used)
    - gofmt
    - goimports
    - govet
    - ineffassign
    - staticcheck
    - unused

  disable:
    # Disabled intentionally
    - wrapcheck     # Too strict for this codebase - many internal errors don't need wrapping

linters-settings:
  errcheck:
    # Check for unchecked errors in type assertions
    check-type-assertions: true
    # Check for unchecked errors in blank assignments
    check-blank: false
    # Don't require checking Close() errors (common pattern)
    exclude-functions:
      - (io.Closer).Close
      - (*os.File).Close

  errorlint:
    # Require %w for error wrapping in fmt.Errorf
    errorf: true
    # Suggest errors.Is instead of == comparison
    comparison: true
    # Suggest errors.As instead of type assertion
    asserts: true

  goimports:
    # Group local imports separately
    local-prefixes: git.srvlab.io/whiskey/rds-csi-driver

issues:
  # Don't limit issues per linter
  max-issues-per-linter: 0
  max-same-issues: 0

  exclude-rules:
    # Allow %v in test files (test error messages don't need chains)
    - path: _test\.go
      linters:
        - errorlint
      text: "non-wrapping format verb"

    # Ignore errcheck in test files
    - path: _test\.go
      linters:
        - errcheck

    # Allow type assertions in test mocks
    - path: test/mock/
      linters:
        - errorlint
      text: "type assertion"
```

This configuration:
1. Enables errorlint to catch incorrect %v usage with errors
2. Enables errcheck to find unchecked errors
3. Excludes test files from strict error wrapping rules
4. Sets 5-minute timeout (matches existing Makefile)
5. Groups local imports for goimports
  </action>
  <verify>
Run: `cat .golangci.yml` - file exists with correct content
Run: `golangci-lint run --new-from-rev=HEAD~1 2>&1 | head -20` - runs without config errors
  </verify>
  <done>
.golangci.yml created with errorlint and errcheck configured, test file exclusions applied
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify linting passes on existing code</name>
  <files>N/A (verification only)</files>
  <action>
Run the linter to verify the configuration doesn't flag false positives on existing code:

1. Run `make lint` or `golangci-lint run`
2. Review any errors reported
3. If errors are found:
   - For legitimate issues: Note them for fixing (these should be minimal given the 96% compliance)
   - For false positives: Adjust exclude-rules in .golangci.yml

The existing codebase should pass linting because:
- 147 fmt.Errorf calls already use %w correctly
- The 6 %v instances are formatting non-error values (pids, durations, access modes)
- Test files are excluded from errorlint

If any legitimate issues are found, document them but don't fix in this task (out of scope - would require modifying code files not in files_modified).
  </action>
  <verify>
Run: `make lint` - exits 0 (passes)
Or if issues found: Document them and confirm they're legitimate (not false positives)
  </verify>
  <done>
Linting verified to pass on existing code, or legitimate issues documented for future work
  </done>
</task>

</tasks>

<verification>
1. `.golangci.yml` exists in project root
2. Config includes errorlint and errcheck
3. `make lint` runs successfully
4. No false positives on existing compliant code
5. Test files excluded from strict error linting
</verification>

<success_criteria>
- .golangci.yml created with error-focused linters
- errorlint enforces %w usage for errors
- errcheck catches unchecked errors
- Existing codebase passes lint (or issues documented)
- Test files excluded from strict rules
- ERR-04 partially addressed: automated detection of error handling issues
</success_criteria>

<output>
After completion, create `.planning/phases/19-error-handling/19-04-SUMMARY.md`
</output>
