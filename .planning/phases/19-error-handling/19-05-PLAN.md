---
phase: 19-error-handling
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/rds/commands.go
  - pkg/rds/ssh_client.go
  - pkg/driver/controller.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "RDS layer returns sentinel errors for volume not found and resource exhausted conditions"
    - "Driver layer uses errors.Is() instead of string matching for error classification"
    - "Error chains are preserved so both sentinel checks and detailed messages work"
  artifacts:
    - path: "pkg/rds/commands.go"
      provides: "Returns ErrVolumeNotFound when volume not found"
      contains: "ErrVolumeNotFound"
    - path: "pkg/rds/ssh_client.go"
      provides: "Uses ErrResourceExhausted sentinel for space errors"
      contains: "ErrResourceExhausted"
    - path: "pkg/driver/controller.go"
      provides: "Uses errors.Is() for error classification"
      contains: "errors.Is"
  key_links:
    - from: "pkg/rds/commands.go"
      to: "pkg/utils/errors.go"
      via: "import and sentinel usage"
      pattern: "utils\\.ErrVolumeNotFound"
    - from: "pkg/driver/controller.go"
      to: "pkg/rds/commands.go"
      via: "errors.Is() check"
      pattern: "errors\\.Is.*ErrResourceExhausted"
---

<objective>
Integrate sentinel error infrastructure into RDS and driver packages

Purpose: Close gap identified in Phase 19 verification - sentinel errors defined but not integrated into driver code. String matching with error messages is fragile; sentinel errors with errors.Is() provides type-safe error classification.

Output: RDS layer returns sentinel errors, driver layer uses errors.Is() for classification
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-error-handling/19-02-SUMMARY.md
@pkg/utils/errors.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: RDS layer returns sentinel errors</name>
  <files>pkg/rds/commands.go, pkg/rds/ssh_client.go</files>
  <action>
Update pkg/rds/commands.go:
1. Add import for "git.srvlab.io/whiskey/rds-csi-driver/pkg/utils"
2. In GetVolume(), when volume not found, wrap error with sentinel:
   - Replace `return nil, fmt.Errorf("volume %s not found", slot)` with
   - `return nil, utils.WrapVolumeError(utils.ErrVolumeNotFound, slot, "")`
3. In DeleteVolume(), use errors.Is() to check for not found:
   - Replace `strings.Contains(err.Error(), "not found")` with `errors.Is(err, utils.ErrVolumeNotFound)`
   - Replace `strings.Contains(err.Error(), "no such item")` - keep as-is since this is RouterOS output, not Go error

Update pkg/rds/ssh_client.go:
1. Add import for "git.srvlab.io/whiskey/rds-csi-driver/pkg/utils"
2. In isNonRetryableError(), when detecting "not enough space":
   - After detecting the pattern, wrap the error: return `fmt.Errorf("%s: %w", errStr, utils.ErrResourceExhausted)`
   - Actually, the function returns bool, so instead we need to ensure the CALLER wraps appropriately
   - Better approach: Add a new function `classifyRDSError(err error) error` that wraps errors with sentinels
3. In runCommandWithRetry(), after detecting non-retryable error, wrap it with appropriate sentinel:
   - If "not enough space" detected, wrap with ErrResourceExhausted
   - Keep original error message for context

Key patterns:
- Use WrapVolumeError for volume-specific errors to include volumeID
- Use fmt.Errorf with %w to preserve error chain
- Sentinels at RDS layer, classification at driver layer
  </action>
  <verify>
grep -n "utils.ErrVolumeNotFound\|utils.ErrResourceExhausted" pkg/rds/*.go
go build ./pkg/rds/...
go test ./pkg/rds/... -v -run TestGetVolume
  </verify>
  <done>
RDS package returns sentinel-wrapped errors that can be checked with errors.Is()
  </done>
</task>

<task type="auto">
  <name>Task 2: Driver layer uses errors.Is() for classification</name>
  <files>pkg/driver/controller.go</files>
  <action>
Update pkg/driver/controller.go:
1. Add import for "errors" (stdlib)
2. In CreateVolume() (around line 196), replace string matching:
   - Before: `if containsString(err.Error(), "not enough space")`
   - After: `if errors.Is(err, utils.ErrResourceExhausted)`
3. In ControllerExpandVolume() (around line 879), replace string matching:
   - Before: `if containsString(err.Error(), "not enough space")`
   - After: `if errors.Is(err, utils.ErrResourceExhausted)`
4. Keep the containsString function for now (may be used elsewhere), but add comment marking it for potential removal

Note: The errors.IsNotFound() calls at lines 357 and in reconciler.go are CORRECT - they check for Kubernetes API NotFound errors, not RDS volume errors. Do NOT change those.
  </action>
  <verify>
grep -n "errors.Is.*ErrResourceExhausted" pkg/driver/controller.go
go build ./pkg/driver/...
go test ./pkg/driver/... -v -run TestCreateVolume -count=1
  </verify>
  <done>
Driver uses errors.Is() for type-safe error classification instead of string matching
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for sentinel error integration</name>
  <files>pkg/rds/commands_test.go</files>
  <action>
Add test to verify sentinel error chain preservation:

func TestGetVolumeNotFoundReturnsSentinel(t *testing.T) {
    // Setup mock that returns "not found"
    // Verify errors.Is(err, utils.ErrVolumeNotFound) returns true
    // Verify err.Error() still contains volume ID for context
}

If commands_test.go doesn't exist or doesn't have suitable infrastructure, add tests to existing test file or create minimal integration test.

The key verification is that errors.Is() works with the wrapped errors.
  </action>
  <verify>
go test ./pkg/rds/... -v -run TestGetVolume
go test ./pkg/... -v -run Sentinel
  </verify>
  <done>
Tests verify sentinel errors are returned and can be checked with errors.Is()
  </done>
</task>

</tasks>

<verification>
```bash
# Build passes
go build ./...

# All tests pass
make test

# Sentinel errors are used in RDS layer
grep -rn "ErrVolumeNotFound\|ErrResourceExhausted" pkg/rds/*.go | grep -v "_test.go"

# errors.Is() used in driver layer
grep -n "errors.Is" pkg/driver/controller.go

# No new string matching for error classification
grep -n "containsString.*not enough space" pkg/driver/controller.go | wc -l  # Should be 0
```
</verification>

<success_criteria>
1. RDS layer returns sentinel-wrapped errors (ErrVolumeNotFound, ErrResourceExhausted)
2. Driver layer uses errors.Is() instead of containsString() for error classification
3. Error chains preserved - both errors.Is() and detailed messages work
4. All existing tests pass (no regressions)
5. Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-error-handling/19-05-SUMMARY.md`
</output>
