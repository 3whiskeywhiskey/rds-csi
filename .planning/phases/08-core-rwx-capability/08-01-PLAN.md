---
phase: 08-core-rwx-capability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/driver.go
  - pkg/driver/controller.go
autonomous: true

must_haves:
  truths:
    - "Driver declares MULTI_NODE_MULTI_WRITER volume capability"
    - "CreateVolume accepts RWX + Block combination without error"
    - "CreateVolume rejects RWX + Filesystem with actionable error message"
    - "ValidateVolumeCapabilities returns unconfirmed for RWX + Filesystem"
  artifacts:
    - path: "pkg/driver/driver.go"
      provides: "MULTI_NODE_MULTI_WRITER in vcaps array"
      contains: "MULTI_NODE_MULTI_WRITER"
    - path: "pkg/driver/controller.go"
      provides: "RWX validation in CreateVolume and validateVolumeCapabilities"
      contains: "MULTI_NODE_MULTI_WRITER"
  key_links:
    - from: "pkg/driver/driver.go"
      to: "vcaps array"
      via: "addVolumeCapabilities function"
      pattern: "VolumeCapability_AccessMode_MULTI_NODE_MULTI_WRITER"
    - from: "pkg/driver/controller.go"
      to: "CreateVolume"
      via: "validateVolumeCapabilities call"
      pattern: "MULTI_NODE_MULTI_WRITER.*Block"
---

<objective>
Add MULTI_NODE_MULTI_WRITER capability declaration and implement RWX block-only validation.

Purpose: Enable RWX PVCs to be created for KubeVirt live migration while preventing unsafe RWX filesystem volumes that would corrupt data. This satisfies RWX-01 and RWX-02.

Output: Driver declares RWX capability, CreateVolume validates RWX+block only.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-core-rwx-capability/08-RESEARCH.md
@.planning/phases/08-core-rwx-capability/08-CONTEXT.md
@pkg/driver/driver.go
@pkg/driver/controller.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MULTI_NODE_MULTI_WRITER to volume capabilities</name>
  <files>pkg/driver/driver.go</files>
  <action>
In `addVolumeCapabilities()`, add MULTI_NODE_MULTI_WRITER to the vcaps array:

```go
func (d *Driver) addVolumeCapabilities() {
    d.vcaps = []*csi.VolumeCapability_AccessMode{
        {Mode: csi.VolumeCapability_AccessMode_SINGLE_NODE_WRITER},
        {Mode: csi.VolumeCapability_AccessMode_SINGLE_NODE_READER_ONLY},
        {Mode: csi.VolumeCapability_AccessMode_MULTI_NODE_MULTI_WRITER},  // NEW: for KubeVirt live migration
    }
}
```

This advertises RWX support. Validation happens at CreateVolume time to reject unsafe RWX+filesystem combinations.
  </action>
  <verify>
Run `go build ./...` to verify no syntax errors.
Grep for MULTI_NODE_MULTI_WRITER in driver.go to confirm it's added.
  </verify>
  <done>
addVolumeCapabilities() includes MULTI_NODE_MULTI_WRITER in the vcaps slice.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add RWX+block validation to existing validateVolumeCapabilities</name>
  <files>pkg/driver/controller.go</files>
  <action>
Update the EXISTING `validateVolumeCapabilities` function (at ~line 765) to add RWX-specific validation. This function already validates access modes and access types - add the RWX+block constraint after the existing checks:

```go
// validateVolumeCapabilities checks if the requested capabilities are supported
func (cs *ControllerServer) validateVolumeCapabilities(caps []*csi.VolumeCapability) error {
    for _, cap := range caps {
        // Check access mode (EXISTING CODE)
        accessMode := cap.GetAccessMode().GetMode()
        supported := false
        for _, supportedMode := range cs.driver.vcaps {
            if accessMode == supportedMode.GetMode() {
                supported = true
                break
            }
        }

        if !supported {
            return fmt.Errorf("access mode %v is not supported", accessMode)
        }

        // Check access type (must be block or mount) (EXISTING CODE)
        if cap.GetBlock() == nil && cap.GetMount() == nil {
            return fmt.Errorf("volume capability must specify either block or mount")
        }

        // NEW: RWX block-only validation (ROADMAP-4)
        // RWX with filesystem volumes risks data corruption - reject with actionable error
        if accessMode == csi.VolumeCapability_AccessMode_MULTI_NODE_MULTI_WRITER {
            if cap.GetMount() != nil {
                return fmt.Errorf("RWX access mode requires volumeMode: Block. " +
                    "Filesystem volumes risk data corruption with multi-node access. " +
                    "For KubeVirt VM live migration, use volumeMode: Block in your PVC")
            }
            // Log valid RWX block usage for debugging/auditing
            klog.V(2).Info("RWX block volume capability validated (KubeVirt live migration use case)")
        }
    }

    return nil
}
```

This is a modification to the existing validateVolumeCapabilities function, not a new function. The existing CreateVolume already calls this function at line 66, so RWX+filesystem will fail fast with a clear error.

The existing ValidateVolumeCapabilities method (line 271) already returns an unconfirmed response when validateVolumeCapabilities returns an error (lines 290-294), so no changes needed there.
  </action>
  <verify>
Run `go build ./...` to verify compilation.
Run `make test` to ensure existing tests pass.
Grep for "RWX access mode requires volumeMode: Block" to confirm error message is present.
  </verify>
  <done>
- validateVolumeCapabilities accepts RWX+block (no error)
- validateVolumeCapabilities rejects RWX+filesystem with actionable error message
- ValidateVolumeCapabilities returns unconfirmed (not error) for unsupported combos (existing behavior preserved)
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `make test` passes (existing tests)
3. Grep confirms MULTI_NODE_MULTI_WRITER in driver.go vcaps
4. Grep confirms RWX filesystem rejection message in controller.go
</verification>

<success_criteria>
- MULTI_NODE_MULTI_WRITER appears in vcaps array in addVolumeCapabilities()
- CreateVolume will reject RWX+filesystem with error containing "volumeMode: Block"
- CreateVolume will accept RWX+block without error
- Code compiles and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-rwx-capability/08-01-SUMMARY.md`
</output>
