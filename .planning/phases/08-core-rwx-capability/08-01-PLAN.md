---
phase: 08-core-rwx-capability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/driver.go
  - pkg/driver/controller.go
autonomous: true

must_haves:
  truths:
    - "Driver declares MULTI_NODE_MULTI_WRITER volume capability"
    - "CreateVolume accepts RWX + Block combination without error"
    - "CreateVolume rejects RWX + Filesystem with actionable error message"
    - "ValidateVolumeCapabilities returns unconfirmed for RWX + Filesystem"
  artifacts:
    - path: "pkg/driver/driver.go"
      provides: "MULTI_NODE_MULTI_WRITER in vcaps array"
      contains: "MULTI_NODE_MULTI_WRITER"
    - path: "pkg/driver/controller.go"
      provides: "RWX validation in CreateVolume and validateVolumeCapabilities"
      contains: "MULTI_NODE_MULTI_WRITER"
  key_links:
    - from: "pkg/driver/driver.go"
      to: "vcaps array"
      via: "addVolumeCapabilities function"
      pattern: "VolumeCapability_AccessMode_MULTI_NODE_MULTI_WRITER"
    - from: "pkg/driver/controller.go"
      to: "CreateVolume"
      via: "validateVolumeCapabilities call"
      pattern: "MULTI_NODE_MULTI_WRITER.*Block"
---

<objective>
Add MULTI_NODE_MULTI_WRITER capability declaration and implement RWX block-only validation.

Purpose: Enable RWX PVCs to be created for KubeVirt live migration while preventing unsafe RWX filesystem volumes that would corrupt data. This satisfies RWX-01 and RWX-02.

Output: Driver declares RWX capability, CreateVolume validates RWX+block only.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-core-rwx-capability/08-RESEARCH.md
@.planning/phases/08-core-rwx-capability/08-CONTEXT.md
@pkg/driver/driver.go
@pkg/driver/controller.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MULTI_NODE_MULTI_WRITER to volume capabilities</name>
  <files>pkg/driver/driver.go</files>
  <action>
In `addVolumeCapabilities()`, add MULTI_NODE_MULTI_WRITER to the vcaps array:

```go
func (d *Driver) addVolumeCapabilities() {
    d.vcaps = []*csi.VolumeCapability_AccessMode{
        {Mode: csi.VolumeCapability_AccessMode_SINGLE_NODE_WRITER},
        {Mode: csi.VolumeCapability_AccessMode_SINGLE_NODE_READER_ONLY},
        {Mode: csi.VolumeCapability_AccessMode_MULTI_NODE_MULTI_WRITER},  // NEW: for KubeVirt live migration
    }
}
```

This advertises RWX support. Validation happens at CreateVolume time to reject unsafe RWX+filesystem combinations.
  </action>
  <verify>
Run `go build ./...` to verify no syntax errors.
Grep for MULTI_NODE_MULTI_WRITER in driver.go to confirm it's added.
  </verify>
  <done>
addVolumeCapabilities() includes MULTI_NODE_MULTI_WRITER in the vcaps slice.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement RWX validation in CreateVolume</name>
  <files>pkg/driver/controller.go</files>
  <action>
Modify `validateVolumeCapabilities()` to accept RWX but reject RWX+filesystem:

1. Update the validateVolumeCapabilities function to include RWX-specific validation:

```go
func (cs *ControllerServer) validateVolumeCapabilities(caps []*csi.VolumeCapability) error {
    for _, cap := range caps {
        accessMode := cap.GetAccessMode().GetMode()

        // Check access mode is supported
        supported := false
        for _, supportedMode := range cs.driver.vcaps {
            if accessMode == supportedMode.GetMode() {
                supported = true
                break
            }
        }
        if !supported {
            return fmt.Errorf("access mode %v is not supported", accessMode)
        }

        // Check access type (must be block or mount)
        if cap.GetBlock() == nil && cap.GetMount() == nil {
            return fmt.Errorf("volume capability must specify either block or mount")
        }

        // ROADMAP-4: RWX block-only validation
        // RWX with filesystem volumes risks data corruption - reject with actionable error
        if accessMode == csi.VolumeCapability_AccessMode_MULTI_NODE_MULTI_WRITER {
            if cap.GetMount() != nil {
                return fmt.Errorf("RWX access mode requires volumeMode: Block. " +
                    "Filesystem volumes risk data corruption with multi-node access. " +
                    "For KubeVirt VM live migration, use volumeMode: Block in your PVC")
            }
            // Log valid RWX block usage for debugging/auditing
            klog.V(2).Info("RWX block volume capability validated (KubeVirt live migration use case)")
        }
    }
    return nil
}
```

2. The existing CreateVolume already calls validateVolumeCapabilities before provisioning, so RWX+filesystem will fail fast with a clear error.

3. Also update ValidateVolumeCapabilities to return "unconfirmed" (not error) for RWX+filesystem on pre-provisioned volumes, matching CSI spec semantics:

In the ValidateVolumeCapabilities method, check if RWX+filesystem was attempted and return unconfirmed with message instead of confirmed:

```go
func (cs *ControllerServer) ValidateVolumeCapabilities(ctx context.Context, req *csi.ValidateVolumeCapabilitiesRequest) (*csi.ValidateVolumeCapabilitiesResponse, error) {
    // ... existing validation ...

    // Check if volume exists
    if _, err := cs.driver.rdsClient.GetVolume(volumeID); err != nil {
        return nil, status.Errorf(codes.NotFound, "volume %s not found: %v", volumeID, err)
    }

    // Validate capabilities - for pre-provisioned volumes, return unconfirmed rather than error
    if err := cs.validateVolumeCapabilities(req.GetVolumeCapabilities()); err != nil {
        // For RWX+filesystem, return unconfirmed with warning message
        return &csi.ValidateVolumeCapabilitiesResponse{
            Message: err.Error(),
        }, nil
    }

    return &csi.ValidateVolumeCapabilitiesResponse{
        Confirmed: &csi.ValidateVolumeCapabilitiesResponse_Confirmed{
            VolumeCapabilities: req.GetVolumeCapabilities(),
        },
    }, nil
}
```

This is the existing behavior - no change needed, just verify it works correctly.
  </action>
  <verify>
Run `go build ./...` to verify compilation.
Run `make test` to ensure existing tests pass.
Grep for "RWX access mode requires volumeMode: Block" to confirm error message.
  </verify>
  <done>
- validateVolumeCapabilities accepts RWX+block
- validateVolumeCapabilities rejects RWX+filesystem with actionable error message
- ValidateVolumeCapabilities returns unconfirmed (not error) for unsupported combos
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `make test` passes (existing tests)
3. Grep confirms MULTI_NODE_MULTI_WRITER in driver.go vcaps
4. Grep confirms RWX filesystem rejection message in controller.go
</verification>

<success_criteria>
- MULTI_NODE_MULTI_WRITER appears in vcaps array in addVolumeCapabilities()
- CreateVolume will reject RWX+filesystem with error containing "volumeMode: Block"
- CreateVolume will accept RWX+block without error
- Code compiles and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-core-rwx-capability/08-01-SUMMARY.md`
</output>
