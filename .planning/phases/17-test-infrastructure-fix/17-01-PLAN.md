---
phase: 17-test-infrastructure-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/node_test.go
autonomous: true

must_haves:
  truths:
    - "Block volume test suite runs without nil pointer dereferences"
    - "All existing tests pass consistently in CI"
    - "Test infrastructure supports adding new block volume tests"
  artifacts:
    - path: "pkg/driver/node_test.go"
      provides: "Fixed block volume tests"
      contains: "TestNodeStageVolume_BlockVolume"
  key_links:
    - from: "TestNodePublishVolume_BlockVolume"
      to: "mockNVMEConnector"
      via: "NodeServer.nvmeConn field initialization"
      pattern: "nvmeConn.*mockNVMEConnector"
    - from: "TestNodeStageVolume_BlockVolume"
      to: "NodeStageVolume implementation"
      via: "Aligned test expectations"
      pattern: "connector.connectCalled"
---

<objective>
Fix failing block volume tests in pkg/driver/node_test.go

Purpose: Establish stable test baseline for v0.7.1 code quality milestone. All 18 v0.7.1 requirements depend on reliable test infrastructure.

Output: All tests in pkg/driver pass without panics or failures
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-test-infrastructure-fix/17-RESEARCH.md
@pkg/driver/node_test.go
@pkg/driver/node.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TestNodeStageVolume_BlockVolume test expectations</name>
  <files>pkg/driver/node_test.go</files>
  <action>
The test at line 675-757 expects NodeStageVolume for block volumes to:
- Create staging directory
- Write device path to staging/device metadata file

However, the implementation (node.go lines 240-248) follows AWS EBS CSI driver pattern:
- Block volumes do NOT create staging directory
- Device is found by NQN at NodePublishVolume time
- This is per CSI spec - NodeStageVolume just ensures device is ready

Fix the test by:
1. Remove assertions for staging directory creation (lines 740-743)
2. Remove assertions for device metadata file (lines 745-757)
3. Keep assertions that verify:
   - NVMe connect was called
   - Format was NOT called for block volumes
   - Mount was NOT called for block volumes
4. Add assertion verifying NodeStageVolumeResponse is returned successfully

The test should validate actual implementation behavior, not hypothetical staging patterns.
  </action>
  <verify>
Run: `go test -v ./pkg/driver/... -run TestNodeStageVolume_BlockVolume`
Expected: Test passes without errors
  </verify>
  <done>TestNodeStageVolume_BlockVolume passes, validating that block volumes connect but don't format/mount</done>
</task>

<task type="auto">
  <name>Task 2: Fix TestNodePublishVolume_BlockVolume nil pointer dereference</name>
  <files>pkg/driver/node_test.go</files>
  <action>
The test at line 827-890 creates NodeServer without nvmeConn field (lines 864-868):
```go
ns := &NodeServer{
    driver:  driver,
    mounter: mounter,
    nodeID:  "test-node",
    // nvmeConn is MISSING - causes panic at node.go:533
}
```

NodePublishVolume for block volumes calls `ns.nvmeConn.GetDevicePath(nqn)` at line 533, causing nil pointer panic.

Fix by:
1. Add mockNVMEConnector to test setup (use existing mock pattern from TestNodeStageVolume_FilesystemVolume_Unchanged at lines 770-788)
2. Configure mock to return the mock device path created in test setup
3. Add nvmeConn field to NodeServer initialization

Implementation pattern (from line 770-788):
```go
connector := &mockNVMEConnector{
    devicePath: mockDevicePath,  // Use the temp file created in test
}

ns := &NodeServer{
    driver:   driver,
    mounter:  mounter,
    nvmeConn: connector,  // ADD THIS
    nodeID:   "test-node",
}
```

Note: The test already creates staging directory and metadata file, which is correct since TestNodePublishVolume tests the publish step (which reads metadata from staging). The only issue is the missing nvmeConn mock.
  </action>
  <verify>
Run: `go test -v ./pkg/driver/... -run TestNodePublishVolume_BlockVolume`
Expected: Test passes without nil pointer dereference
  </verify>
  <done>TestNodePublishVolume_BlockVolume passes, validating block volume publish creates mknod device node</done>
</task>

<task type="auto">
  <name>Task 3: Verify all driver tests pass and document root cause</name>
  <files>pkg/driver/node_test.go</files>
  <action>
1. Run full driver test suite:
   ```bash
   go test -v -race ./pkg/driver/...
   ```

2. If any other tests fail, investigate and fix following the same patterns:
   - Check for missing mock initialization
   - Check for test expectations misaligned with implementation

3. Add a brief comment at the top of TestNodeStageVolume_BlockVolume documenting the CSI pattern:
   ```go
   // TestNodeStageVolume_BlockVolume tests staging a block volume.
   // Per CSI spec and AWS EBS CSI driver pattern, NodeStageVolume for block volumes
   // only connects to the NVMe device - no staging directory or metadata is created.
   // NodePublishVolume finds the device by NQN and creates a device node at target path.
   ```

4. Add comment at TestNodePublishVolume_BlockVolume:
   ```go
   // TestNodePublishVolume_BlockVolume tests publishing a block volume.
   // Block volume publish finds device by NQN via nvmeConn.GetDevicePath(),
   // then creates a device node at target path using mknod (not bind mount).
   ```

These comments prevent future confusion about expected test behavior vs filesystem volume behavior.
  </action>
  <verify>
Run: `go test -v -race ./pkg/driver/...`
Expected: All tests pass (PASS with 0 failures)
Run: `make test`
Expected: All unit tests pass
  </verify>
  <done>All driver tests pass, root cause documented in test comments, test infrastructure ready for new tests</done>
</task>

</tasks>

<verification>
```bash
# Verify all driver tests pass
go test -v -race ./pkg/driver/...

# Verify full test suite passes
make test

# Verify test count is unchanged (no tests accidentally removed)
go test -v ./pkg/driver/... 2>&1 | grep -c "^=== RUN"
# Should be >= 40 tests (current count)
```
</verification>

<success_criteria>
1. `go test -v -race ./pkg/driver/...` passes with 0 failures
2. No nil pointer dereferences in test output
3. TestNodeStageVolume_BlockVolume validates connect-only behavior
4. TestNodePublishVolume_BlockVolume validates mknod device creation
5. Test comments document expected behavior patterns
6. `make test` passes (all unit tests)
</success_criteria>

<output>
After completion, create `.planning/phases/17-test-infrastructure-fix/17-01-SUMMARY.md`
</output>
