---
phase: 12-compatibility-and-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/node_test.go
  - pkg/driver/controller_test.go
autonomous: true

must_haves:
  truths:
    - "Filesystem volume Stage operation still works (Format + Mount called)"
    - "Filesystem volume Publish operation still works (bind mount)"
    - "Filesystem volume Unpublish operation still works (unmount + cleanup)"
    - "Filesystem volume Unstage operation still works (unmount + disconnect)"
    - "Block volume operations work (no format, metadata-based)"
    - "Invalid volume mode combinations return actionable error messages"
    - "All existing tests continue to pass"
  artifacts:
    - path: "pkg/driver/node_test.go"
      provides: "Comprehensive regression tests for block and filesystem volumes"
      contains: "TestNodePublishVolume_FilesystemVolume"
    - path: "pkg/driver/controller_test.go"
      provides: "Error message validation tests"
      contains: "TestValidateVolumeCapabilities_ErrorMessageStructure"
  key_links:
    - from: "pkg/driver/node_test.go"
      to: "pkg/driver/node.go"
      via: "Tests call NodeServer methods"
      pattern: "ns\\.Node(Stage|Publish|Unstage|Unpublish)Volume"
---

<objective>
Add filesystem Publish/Unpublish regression tests and verify error messages are actionable.

Purpose: Fulfill BLOCK-06 (no regression) and BLOCK-07 (clear error messages) requirements before hardware validation
Output: Complete test coverage for filesystem Publish/Unpublish operations, validated error message quality
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.6-ROADMAP.md
@.planning/phases/12-compatibility-and-quality/12-RESEARCH.md
@pkg/driver/node_test.go
@pkg/driver/controller_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Filesystem Publish/Unpublish Regression Tests</name>
  <files>pkg/driver/node_test.go</files>
  <action>
Add filesystem volume Publish and Unpublish regression tests. Note: Stage/Unstage filesystem tests already exist (`TestNodeStageVolume_FilesystemVolume_Unchanged` at line 756, `TestNodeUnstageVolume_FilesystemVolume_Unchanged` at line 1071). Publish/Unpublish tests for filesystem do NOT exist and need to be added.

Existing coverage:
- TestNodeStageVolume_FilesystemVolume_Unchanged (exists)
- TestNodeUnstageVolume_FilesystemVolume_Unchanged (exists)
- TestNodePublishVolume_BlockVolume (exists)
- TestNodeUnpublishVolume_BlockVolume (exists)

Missing (add these):
1. **TestNodePublishVolume_FilesystemVolume** - Verify filesystem bind mount still works
2. **TestNodeUnpublishVolume_FilesystemVolume** - Verify filesystem unmount still works

Implementation for TestNodePublishVolume_FilesystemVolume:
```go
func TestNodePublishVolume_FilesystemVolume(t *testing.T) {
    tmpDir, err := os.MkdirTemp("", "node-test-fs-publish-*")
    if err != nil {
        t.Fatalf("failed to create temp dir: %v", err)
    }
    defer os.RemoveAll(tmpDir)

    stagingPath := filepath.Join(tmpDir, "staging")
    targetPath := filepath.Join(tmpDir, "target")

    // Setup staging directory (no device metadata file for filesystem volumes)
    if err := os.MkdirAll(stagingPath, 0750); err != nil {
        t.Fatalf("failed to create staging dir: %v", err)
    }

    mounter := &mockMounter{}
    driver := &Driver{
        name:    "rds.csi.srvlab.io",
        version: "test",
        metrics: observability.NewMetrics(),
    }
    ns := &NodeServer{
        driver:  driver,
        mounter: mounter,
        nodeID:  "test-node",
    }

    req := &csi.NodePublishVolumeRequest{
        VolumeId:          "pvc-12345678-1234-1234-1234-123456789012",
        StagingTargetPath: stagingPath,
        TargetPath:        targetPath,
        VolumeCapability:  createFilesystemVolumeCapability(),
        Readonly:          false,
    }

    _, err = ns.NodePublishVolume(context.Background(), req)
    if err != nil {
        t.Fatalf("NodePublishVolume failed: %v", err)
    }

    // Verify: Mount WAS called for filesystem bind mount
    if !mounter.mountCalled {
        t.Error("Mount should be called for filesystem volume bind mount")
    }
}
```

Implementation for TestNodeUnpublishVolume_FilesystemVolume:
```go
func TestNodeUnpublishVolume_FilesystemVolume(t *testing.T) {
    tmpDir, err := os.MkdirTemp("", "node-test-fs-unpublish-*")
    if err != nil {
        t.Fatalf("failed to create temp dir: %v", err)
    }
    defer os.RemoveAll(tmpDir)

    targetPath := filepath.Join(tmpDir, "target")

    // Create target directory (filesystem volumes use directories, not files)
    if err := os.MkdirAll(targetPath, 0750); err != nil {
        t.Fatalf("failed to create target dir: %v", err)
    }

    mounter := &mockMounter{}
    driver := &Driver{
        name:    "rds.csi.srvlab.io",
        version: "test",
        metrics: observability.NewMetrics(),
    }
    ns := &NodeServer{
        driver:  driver,
        mounter: mounter,
        nodeID:  "test-node",
    }

    req := &csi.NodeUnpublishVolumeRequest{
        VolumeId:   "pvc-12345678-1234-1234-1234-123456789012",
        TargetPath: targetPath,
    }

    _, err = ns.NodeUnpublishVolume(context.Background(), req)
    if err != nil {
        t.Fatalf("NodeUnpublishVolume failed: %v", err)
    }

    // Verify: Unmount WAS called
    if !mounter.unmountCalled {
        t.Error("Unmount should be called for filesystem volume")
    }
}
```
  </action>
  <verify>
Run tests:
```bash
go test -v -run "TestNodePublishVolume_FilesystemVolume|TestNodeUnpublishVolume_FilesystemVolume" ./pkg/driver/...
```
Both new tests should pass.
  </verify>
  <done>
- TestNodePublishVolume_FilesystemVolume exists and passes
- TestNodeUnpublishVolume_FilesystemVolume exists and passes
- Tests verify Mount/Unmount called for filesystem volumes
- Full node operation coverage: Stage, Publish, Unpublish, Unstage for both block and filesystem modes
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Existing Test Coverage and Add Error Message Test</name>
  <files>pkg/driver/controller_test.go</files>
  <action>
Verify existing tests cover both volume modes, then add error message structure test.

1. **Verify existing coverage runs correctly:**
Run existing regression tests to confirm Phase 11 changes didn't break filesystem support:
- TestNodeStageVolume_FilesystemVolume_Unchanged
- TestNodeUnstageVolume_FilesystemVolume_Unchanged
- TestNodeStageVolume_BlockVolume
- TestNodeUnstageVolume_BlockVolume
- TestNodePublishVolume_BlockVolume
- TestNodeUnpublishVolume_BlockVolume

2. **Add error message structure test** in controller_test.go:

```go
func TestValidateVolumeCapabilities_ErrorMessageStructure(t *testing.T) {
    cs, _ := testControllerServer(t)

    // RWX filesystem should produce actionable error
    err := cs.validateVolumeCapabilities([]*csi.VolumeCapability{
        {
            AccessMode: &csi.VolumeCapability_AccessMode{
                Mode: csi.VolumeCapability_AccessMode_MULTI_NODE_MULTI_WRITER,
            },
            AccessType: &csi.VolumeCapability_Mount{
                Mount: &csi.VolumeCapability_MountVolume{FsType: "ext4"},
            },
        },
    })

    if err == nil {
        t.Fatal("expected error for RWX filesystem")
    }

    errMsg := err.Error()

    // WHAT: identifies the problem
    if !strings.Contains(errMsg, "RWX") && !strings.Contains(errMsg, "MULTI_NODE") {
        t.Error("error should mention RWX or MULTI_NODE (what's wrong)")
    }

    // HOW: provides remediation
    if !strings.Contains(errMsg, "volumeMode: Block") {
        t.Error("error should provide fix (use volumeMode: Block)")
    }
}
```

3. **Run full test suite** to verify no regressions:
```bash
make test
```

4. **Run coverage** to verify test coverage:
```bash
go test -cover ./pkg/driver/...
```

Ensure coverage is at least maintained or improved from Phase 11 baseline (~48%).
  </action>
  <verify>
Run all verification commands:
```bash
# Existing filesystem tests
go test -v -run "FilesystemVolume_Unchanged|BlockVolume" ./pkg/driver/...

# Error message test
go test -v -run "TestValidateVolumeCapabilities_ErrorMessageStructure" ./pkg/driver/...

# Full test suite
make test

# Coverage check
go test -cover ./pkg/driver/...
```
All tests pass, coverage >= 48%.
  </verify>
  <done>
- Existing Stage/Unstage tests for both volume modes pass
- TestValidateVolumeCapabilities_ErrorMessageStructure exists and passes
- Error message contains WHAT (RWX/MULTI_NODE) and HOW (volumeMode: Block)
- Full test suite passes (`make test`)
- Test coverage maintained or improved (>= 48% in pkg/driver)
- BLOCK-06 satisfied: No regression in filesystem volume functionality
- BLOCK-07 satisfied: Clear, actionable error messages for invalid combinations
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **All new tests pass:**
```bash
go test -v -run "FilesystemVolume|ErrorMessageStructure" ./pkg/driver/...
```

2. **Full test suite passes:**
```bash
make test
```

3. **No regression in existing tests:**
All previously passing tests still pass.

4. **Coverage maintained:**
```bash
go test -cover ./pkg/driver/...
```
Coverage >= 48% in pkg/driver.

5. **Build succeeds:**
```bash
make build
```
</verification>

<success_criteria>
- [ ] TestNodePublishVolume_FilesystemVolume passes
- [ ] TestNodeUnpublishVolume_FilesystemVolume passes
- [ ] TestValidateVolumeCapabilities_ErrorMessageStructure passes
- [ ] `make test` succeeds with no failures
- [ ] Test coverage >= 48% in pkg/driver
- [ ] `make build` succeeds
- [ ] BLOCK-06 requirement satisfied (no regression)
- [ ] BLOCK-07 requirement satisfied (clear error messages)
</success_criteria>

<output>
After completion, create `.planning/phases/12-compatibility-and-quality/12-01-SUMMARY.md`
</output>
