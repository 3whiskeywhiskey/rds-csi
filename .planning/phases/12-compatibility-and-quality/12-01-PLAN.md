---
phase: 12-compatibility-and-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/node_test.go
  - pkg/driver/controller_test.go
autonomous: true

must_haves:
  truths:
    - "Filesystem volume Stage operation still works (Format + Mount called)"
    - "Filesystem volume Publish operation still works (bind mount)"
    - "Filesystem volume Unpublish operation still works (unmount + cleanup)"
    - "Filesystem volume Unstage operation still works (unmount + disconnect)"
    - "Block volume operations work (no format, metadata-based)"
    - "Invalid volume mode combinations return actionable error messages"
    - "All existing tests continue to pass"
  artifacts:
    - path: "pkg/driver/node_test.go"
      provides: "Comprehensive regression tests for block and filesystem volumes"
      contains: "TestNodePublishVolume_FilesystemVolume_Unchanged"
    - path: "pkg/driver/controller_test.go"
      provides: "Error message validation tests"
      contains: "TestValidateVolumeCapabilities_ErrorMessages"
  key_links:
    - from: "pkg/driver/node_test.go"
      to: "pkg/driver/node.go"
      via: "Tests call NodeServer methods"
      pattern: "ns\\.Node(Stage|Publish|Unstage|Unpublish)Volume"
---

<objective>
Add comprehensive regression tests ensuring block volume changes don't break filesystem volumes, and verify error messages are clear and actionable.

Purpose: Fulfill BLOCK-06 (no regression) and BLOCK-07 (clear error messages) requirements before hardware validation
Output: Complete test coverage for both volume modes, validated error message quality
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.6-ROADMAP.md
@.planning/phases/12-compatibility-and-quality/12-RESEARCH.md
@pkg/driver/node_test.go
@pkg/driver/controller_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Missing Filesystem Regression Tests</name>
  <files>pkg/driver/node_test.go</files>
  <action>
Add the missing filesystem volume regression tests to ensure Phase 11 block volume changes didn't break existing functionality.

Create these new test functions following the existing patterns:

1. **TestNodePublishVolume_FilesystemVolume_Unchanged**
   - Create staging directory with NO device metadata file (filesystem volumes don't have it)
   - Create request with filesystem VolumeCapability (Mount type, ext4)
   - Execute NodePublishVolume
   - Verify: Mount WAS called (bind mount from staging to target)
   - Verify: Target directory was created
   - Follow pattern from TestNodePublishVolume_BlockVolume but for filesystem mode

2. **TestNodeUnpublishVolume_FilesystemVolume_Unchanged**
   - Create target directory (not file, unlike block volumes)
   - Execute NodeUnpublishVolume
   - Verify: Unmount WAS called
   - Verify: Target directory was cleaned up
   - Follow pattern from TestNodeUnpublishVolume_BlockVolume but for filesystem mode

Use the existing helper function `createFilesystemVolumeCapability()` for capability creation.

Pattern to follow (from existing tests):
```go
func TestNodePublishVolume_FilesystemVolume_Unchanged(t *testing.T) {
    // Setup temp dirs
    tmpDir, err := os.MkdirTemp("", "node-test-fs-publish-*")
    // ...

    // Setup staging WITHOUT device metadata (filesystem volumes don't have it)
    if err := os.MkdirAll(stagingPath, 0750); err != nil { ... }

    // Setup mocks
    mounter := &mockMounter{}
    // ...

    // Create request with filesystem capability
    req := &csi.NodePublishVolumeRequest{
        VolumeCapability: createFilesystemVolumeCapability(),
        // ...
    }

    // Execute and verify
    // ...
}
```
  </action>
  <verify>
Run tests:
```bash
go test -v -run "TestNodePublishVolume_FilesystemVolume_Unchanged|TestNodeUnpublishVolume_FilesystemVolume_Unchanged" ./pkg/driver/...
```
Both new tests should pass.
  </verify>
  <done>
- TestNodePublishVolume_FilesystemVolume_Unchanged exists and passes
- TestNodeUnpublishVolume_FilesystemVolume_Unchanged exists and passes
- Tests verify Mount/Unmount called for filesystem volumes
- Tests verify filesystem volumes don't use device metadata file pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Comprehensive Table-Driven Volume Mode Tests</name>
  <files>pkg/driver/node_test.go</files>
  <action>
Create a table-driven test that exercises both block and filesystem volume modes for a complete operation, validating the different code paths are correctly exercised.

Add `TestNodeOperations_BothVolumeModes` that covers:

```go
func TestNodeOperations_BothVolumeModes(t *testing.T) {
    tests := []struct {
        name              string
        volumeMode        string  // "block" or "filesystem"
        expectFormat      bool    // Stage: should Format be called?
        expectStageMount  bool    // Stage: should Mount be called?
        expectMetadata    bool    // Stage: should device metadata file exist?
        expectPublishMount bool   // Publish: should Mount be called?
        expectUnmount     bool    // Unstage: should Unmount be called?
    }{
        {
            name:              "filesystem volume - full lifecycle",
            volumeMode:        "filesystem",
            expectFormat:      true,
            expectStageMount:  true,
            expectMetadata:    false,
            expectPublishMount: true,
            expectUnmount:     true,
        },
        {
            name:              "block volume - full lifecycle",
            volumeMode:        "block",
            expectFormat:      false,
            expectStageMount:  false,
            expectMetadata:    true,
            expectPublishMount: true,  // bind mount device to file
            expectUnmount:     false,  // no filesystem to unmount at unstage
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Setup temp dirs
            // Setup mocks with tracking
            // Create capability based on volumeMode
            // Execute Stage, Publish, Unpublish, Unstage
            // Verify expectations at each step
        })
    }
}
```

This test provides:
1. Side-by-side comparison of both modes
2. Clear documentation of expected differences
3. Quick regression detection if behavior changes
4. Table structure makes it easy to add edge cases

Implementation notes:
- Reset mock tracking between operations (formatCalled, mountCalled, etc.)
- Use t.Run for clear failure reporting
- Check file/directory existence for metadata and targets
- Clean up between subtests
  </action>
  <verify>
Run the comprehensive test:
```bash
go test -v -run "TestNodeOperations_BothVolumeModes" ./pkg/driver/...
```
Both subtests (filesystem and block) should pass.
  </verify>
  <done>
- TestNodeOperations_BothVolumeModes exists with table-driven structure
- Both "filesystem volume - full lifecycle" and "block volume - full lifecycle" subtests pass
- Test verifies different behavior for Format, Mount, metadata, Unmount
- Clear documentation of expected differences between modes
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Error Message Quality and Full Test Suite</name>
  <files>pkg/driver/controller_test.go</files>
  <action>
Verify that error messages for invalid volume mode combinations follow the WHAT/WHY/HOW pattern, and run the full test suite to confirm no regressions.

1. **Add error message structure test** in controller_test.go:

```go
func TestValidateVolumeCapabilities_ErrorMessageStructure(t *testing.T) {
    cs, _ := testControllerServer(t)

    // RWX filesystem should produce actionable error
    err := cs.validateVolumeCapabilities([]*csi.VolumeCapability{
        {
            AccessMode: &csi.VolumeCapability_AccessMode{
                Mode: csi.VolumeCapability_AccessMode_MULTI_NODE_MULTI_WRITER,
            },
            AccessType: &csi.VolumeCapability_Mount{
                Mount: &csi.VolumeCapability_MountVolume{FsType: "ext4"},
            },
        },
    })

    if err == nil {
        t.Fatal("expected error for RWX filesystem")
    }

    errMsg := err.Error()

    // WHAT: identifies the problem
    if !strings.Contains(errMsg, "RWX") {
        t.Error("error should mention RWX (what's wrong)")
    }

    // WHY: explains the reason
    if !strings.Contains(errMsg, "corruption") || !strings.Contains(errMsg, "risk") {
        t.Error("error should explain why (corruption risk)")
    }

    // HOW: provides remediation
    if !strings.Contains(errMsg, "volumeMode: Block") {
        t.Error("error should provide fix (use volumeMode: Block)")
    }
}
```

2. **Run full test suite** to verify no regressions:
```bash
make test
```

3. **Run coverage** to verify test coverage:
```bash
go test -cover ./pkg/driver/...
```

Ensure coverage is at least maintained or improved from Phase 11 baseline (~48%).
  </action>
  <verify>
Run all verification commands:
```bash
# Error message test
go test -v -run "TestValidateVolumeCapabilities_ErrorMessageStructure" ./pkg/driver/...

# Full test suite
make test

# Coverage check
go test -cover ./pkg/driver/...
```
All tests pass, coverage >= 48%.
  </verify>
  <done>
- TestValidateVolumeCapabilities_ErrorMessageStructure exists and passes
- Error message contains WHAT (RWX), WHY (corruption risk), HOW (volumeMode: Block)
- Full test suite passes (`make test`)
- Test coverage maintained or improved (>= 48% in pkg/driver)
- BLOCK-06 satisfied: No regression in filesystem volume functionality
- BLOCK-07 satisfied: Clear, actionable error messages for invalid combinations
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **All new tests pass:**
```bash
go test -v -run "FilesystemVolume_Unchanged|BothVolumeModes|ErrorMessageStructure" ./pkg/driver/...
```

2. **Full test suite passes:**
```bash
make test
```

3. **No regression in existing tests:**
All previously passing tests still pass.

4. **Coverage maintained:**
```bash
go test -cover ./pkg/driver/...
```
Coverage >= 48% in pkg/driver.

5. **Build succeeds:**
```bash
make build
```
</verification>

<success_criteria>
- [ ] TestNodePublishVolume_FilesystemVolume_Unchanged passes
- [ ] TestNodeUnpublishVolume_FilesystemVolume_Unchanged passes
- [ ] TestNodeOperations_BothVolumeModes passes for both block and filesystem
- [ ] TestValidateVolumeCapabilities_ErrorMessageStructure passes
- [ ] `make test` succeeds with no failures
- [ ] Test coverage >= 48% in pkg/driver
- [ ] `make build` succeeds
- [ ] BLOCK-06 requirement satisfied (no regression)
- [ ] BLOCK-07 requirement satisfied (clear error messages)
</success_criteria>

<output>
After completion, create `.planning/phases/12-compatibility-and-quality/12-01-SUMMARY.md`
</output>
