---
phase: 14-error-resilience-mount-storm-prevention
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/driver.go
  - pkg/driver/node.go
  - pkg/nvme/orphan.go
  - pkg/nvme/nqn.go
  - pkg/nvme/nqn_test.go
  - cmd/rds-csi-plugin/main.go
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Driver refuses to start if CSI_MANAGED_NQN_PREFIX env var is not set"
    - "Driver refuses to start if NQN prefix fails validation (invalid format)"
    - "Orphan cleaner only disconnects volumes matching configured NQN prefix"
    - "System volumes (nixos-*) are never disconnected by orphan cleaner"
  artifacts:
    - path: "pkg/nvme/nqn.go"
      provides: "NQN prefix validation and matching functions"
      exports: ["ValidateNQNPrefix", "NQNMatchesPrefix", "envManagedNQNPrefix"]
    - path: "pkg/nvme/nqn_test.go"
      provides: "Unit tests for NQN validation"
      min_lines: 50
    - path: "pkg/nvme/orphan.go"
      provides: "Updated orphan cleaner using configurable prefix"
      contains: "NQNMatchesPrefix"
  key_links:
    - from: "pkg/driver/driver.go"
      to: "pkg/nvme/nqn.go"
      via: "ValidateNQNPrefix call at startup"
      pattern: "ValidateNQNPrefix"
    - from: "pkg/nvme/orphan.go"
      to: "pkg/nvme/nqn.go"
      via: "NQNMatchesPrefix for filtering"
      pattern: "NQNMatchesPrefix"
    - from: "cmd/rds-csi-plugin/main.go"
      to: "CSI_MANAGED_NQN_PREFIX"
      via: "Environment variable check"
      pattern: "CSI_MANAGED_NQN_PREFIX"
---

<objective>
Implement configurable NQN prefix validation to prevent system volume disconnection.

Purpose: Prevent the CSI driver from accidentally disconnecting system volumes (e.g., NixOS diskless nodes that mount /var from RDS via NVMe-oF with NQN pattern nixos-*). This is a critical safety feature discovered during Phase 13 - without it, the orphan cleaner could brick nodes.

Output: NQN validation module with fail-fast startup, updated orphan cleaner using configurable prefix.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-error-resilience-mount-storm-prevention/14-CONTEXT.md
@.planning/phases/14-error-resilience-mount-storm-prevention/14-RESEARCH.md
@pkg/nvme/orphan.go
@pkg/driver/driver.go
@cmd/rds-csi-plugin/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NQN validation module</name>
  <files>pkg/nvme/nqn.go, pkg/nvme/nqn_test.go</files>
  <action>
Create new file `pkg/nvme/nqn.go` with:

1. Define constant for env var name:
   ```go
   const EnvManagedNQNPrefix = "CSI_MANAGED_NQN_PREFIX"
   ```

2. Implement `ValidateNQNPrefix(prefix string) error`:
   - Return error if prefix is empty: "managed NQN prefix is required (set CSI_MANAGED_NQN_PREFIX)"
   - Return error if prefix > 223 bytes (NVMe spec limit)
   - Return error if prefix doesn't start with "nqn."
   - Return error if prefix doesn't contain ":" (required NQN format)
   - Return nil if valid

3. Implement `NQNMatchesPrefix(nqn, prefix string) bool`:
   - Return true if nqn starts with prefix
   - Case-sensitive comparison (per NVMe spec)

4. Implement `GetManagedNQNPrefix() (string, error)`:
   - Read from os.Getenv(EnvManagedNQNPrefix)
   - Call ValidateNQNPrefix and return result

Create comprehensive tests in `pkg/nvme/nqn_test.go`:
- Test empty prefix fails
- Test too-long prefix fails
- Test invalid format (missing nqn. prefix) fails
- Test invalid format (missing colon) fails
- Test valid prefix passes: "nqn.2000-02.com.mikrotik:pvc-"
- Test NQNMatchesPrefix with matching NQN
- Test NQNMatchesPrefix with non-matching NQN (e.g., "nqn.2000-02.com.mikrotik:nixos-")
  </action>
  <verify>
Run `go test ./pkg/nvme/... -run TestNQN -v` and confirm all tests pass.
Run `go build ./...` to confirm no compilation errors.
  </verify>
  <done>
NQN validation module exists with ValidateNQNPrefix, NQNMatchesPrefix, GetManagedNQNPrefix functions. All unit tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update orphan cleaner to use configurable prefix</name>
  <files>pkg/nvme/orphan.go, pkg/nvme/orphan_test.go</files>
  <action>
Update `pkg/nvme/orphan.go`:

1. Add field to OrphanCleaner struct:
   ```go
   managedNQNPrefix string
   ```

2. Update NewOrphanCleaner to accept prefix parameter:
   ```go
   func NewOrphanCleaner(connector Connector, managedNQNPrefix string) *OrphanCleaner
   ```

3. Replace hardcoded prefix check (line 52) with NQNMatchesPrefix:
   ```go
   // BEFORE (hardcoded):
   if !strings.HasPrefix(nqn, "nqn.2000-02.com.mikrotik:pvc-") {

   // AFTER (configurable):
   if !NQNMatchesPrefix(nqn, oc.managedNQNPrefix) {
       klog.V(4).Infof("Skipping non-managed volume (NQN %s doesn't match prefix %s)", nqn, oc.managedNQNPrefix)
       continue
   }
   ```

4. Update test file if exists to pass prefix to NewOrphanCleaner

Note: Do NOT change behavior for system volumes - they will naturally be skipped because they don't match the pvc- prefix pattern.
  </action>
  <verify>
Run `go test ./pkg/nvme/... -v` and confirm all tests pass.
Verify grep shows NQNMatchesPrefix used in orphan.go: `grep -n "NQNMatchesPrefix" pkg/nvme/orphan.go`
  </verify>
  <done>
OrphanCleaner uses configurable NQN prefix via NQNMatchesPrefix. Hardcoded prefix check removed. System volumes (nixos-*) will be skipped.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire NQN validation into driver startup</name>
  <files>pkg/driver/driver.go, cmd/rds-csi-plugin/main.go</files>
  <action>
Update `pkg/driver/driver.go`:

1. Add field to Driver struct:
   ```go
   managedNQNPrefix string
   ```

2. Add field to DriverConfig:
   ```go
   ManagedNQNPrefix string
   ```

3. In NewDriver(), validate NQN prefix at startup (fail fast):
   ```go
   // Validate NQN prefix for node plugin (required for orphan cleaner safety)
   if config.EnableNode {
       if config.ManagedNQNPrefix == "" {
           return nil, fmt.Errorf("managed NQN prefix is required for node plugin (set %s)", nvme.EnvManagedNQNPrefix)
       }
       if err := nvme.ValidateNQNPrefix(config.ManagedNQNPrefix); err != nil {
           return nil, fmt.Errorf("invalid NQN prefix: %w", err)
       }
       driver.managedNQNPrefix = config.ManagedNQNPrefix
       klog.Infof("Driver managing volumes with NQN prefix: %s", config.ManagedNQNPrefix)
   }
   ```

4. Store prefix in driver for later use by node server

Update `cmd/rds-csi-plugin/main.go`:

1. Read env var at startup:
   ```go
   managedNQNPrefix := os.Getenv(nvme.EnvManagedNQNPrefix)
   ```

2. Add to DriverConfig:
   ```go
   config := driver.DriverConfig{
       // ... existing fields ...
       ManagedNQNPrefix: managedNQNPrefix,
   }
   ```

3. Update orphan cleaner instantiation in node startup (around line 167):
   ```go
   cleaner := nvme.NewOrphanCleaner(cleanupConnector, managedNQNPrefix)
   ```

Note: Controller mode does not require NQN prefix (only node plugin uses orphan cleaner and NVMe connections).
  </action>
  <verify>
1. Build: `go build ./...`
2. Test without env var (should fail): `./bin/rds-csi-plugin-* -node -node-id=test` should exit with "managed NQN prefix is required"
3. Test with invalid prefix: `CSI_MANAGED_NQN_PREFIX=invalid ./bin/rds-csi-plugin-* -node -node-id=test` should exit with "NQN prefix must start with 'nqn.'"
4. Test valid startup message: `CSI_MANAGED_NQN_PREFIX="nqn.2000-02.com.mikrotik:pvc-" ./bin/rds-csi-plugin-* -node -node-id=test -v=5 2>&1 | head -20` should show "Driver managing volumes with NQN prefix"
  </verify>
  <done>
Driver refuses to start without valid CSI_MANAGED_NQN_PREFIX. Startup validates prefix format. OrphanCleaner receives configurable prefix.
  </done>
</task>

</tasks>

<verification>
1. Unit tests pass: `go test ./pkg/nvme/... -v`
2. Build succeeds: `go build ./...`
3. Driver fails to start without env var
4. Driver fails to start with invalid prefix format
5. Driver starts successfully with valid prefix
6. Orphan cleaner logs show configured prefix being used
</verification>

<success_criteria>
- NQN validation module exists with comprehensive tests
- Driver refuses to start if CSI_MANAGED_NQN_PREFIX is missing or invalid
- OrphanCleaner uses configurable prefix instead of hardcoded value
- System volumes (nixos-*) are protected from disconnection
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-error-resilience-mount-storm-prevention/14-01-SUMMARY.md`
</output>
