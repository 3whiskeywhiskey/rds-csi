---
phase: 26-volume-snapshots
plan: 05
type: execute
wave: 5
depends_on: ["26-03"]
files_modified:
  - deploy/kubernetes/rbac.yaml
  - deploy/kubernetes/controller.yaml
  - deploy/kubernetes/snapshotclass.yaml
autonomous: true

must_haves:
  truths:
    - "Controller ClusterRole has RBAC permissions for snapshot.storage.k8s.io API group resources"
    - "csi-snapshotter sidecar container runs alongside the controller with correct CSI socket mount"
    - "VolumeSnapshotClass resource exists with driver name rds.csi.srvlab.io and Delete deletion policy"
  artifacts:
    - path: "deploy/kubernetes/rbac.yaml"
      provides: "RBAC rules for volumesnapshotclasses, volumesnapshotcontents, volumesnapshots"
      contains: "snapshot.storage.k8s.io"
    - path: "deploy/kubernetes/controller.yaml"
      provides: "csi-snapshotter sidecar container definition"
      contains: "csi-snapshotter"
    - path: "deploy/kubernetes/snapshotclass.yaml"
      provides: "VolumeSnapshotClass CRD instance for RDS driver"
      contains: "VolumeSnapshotClass"
  key_links:
    - from: "deploy/kubernetes/controller.yaml (csi-snapshotter)"
      to: "deploy/kubernetes/rbac.yaml"
      via: "ServiceAccount rds-csi-controller uses ClusterRole with snapshot permissions"
      pattern: "rds-csi-controller"
    - from: "deploy/kubernetes/snapshotclass.yaml"
      to: "pkg/driver/driver.go"
      via: "driver field matches DriverName constant"
      pattern: "rds.csi.srvlab.io"
---

<objective>
Add Kubernetes deployment manifests for snapshot support: RBAC permissions, csi-snapshotter sidecar, and VolumeSnapshotClass.

Purpose: The CSI driver code implements snapshot RPCs, but Kubernetes needs the external-snapshotter sidecar to bridge VolumeSnapshot CRDs to CSI calls, RBAC to authorize it, and a VolumeSnapshotClass to configure it.
Output: Updated RBAC with snapshot permissions, controller deployment with csi-snapshotter sidecar, new VolumeSnapshotClass manifest.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/26-volume-snapshots/26-CONTEXT.md
@.planning/phases/26-volume-snapshots/26-RESEARCH.md
@deploy/kubernetes/rbac.yaml
@deploy/kubernetes/controller.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add snapshot RBAC permissions and csi-snapshotter sidecar</name>
  <files>deploy/kubernetes/rbac.yaml, deploy/kubernetes/controller.yaml</files>
  <action>
  **1. Update deploy/kubernetes/rbac.yaml:**

  Add the following RBAC rules to the `rds-csi-controller-role` ClusterRole, after the existing `csidrivers` rule (before the closing `---` separator for the Node ClusterRole):

  ```yaml
  # VolumeSnapshot access (for csi-snapshotter sidecar)
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshotclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshotcontents"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshotcontents/status"]
    verbs: ["update", "patch"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshots"]
    verbs: ["get", "list"]
  ```

  **2. Update deploy/kubernetes/controller.yaml:**

  Add the csi-snapshotter sidecar container AFTER the existing csi-resizer container and BEFORE the liveness-probe container. Follow the exact same pattern as other sidecars (env, volumeMounts, resources):

  ```yaml
        # CSI external-snapshotter sidecar (for snapshot operations)
        - name: csi-snapshotter
          image: registry.k8s.io/sig-storage/csi-snapshotter:v8.2.0
          args:
            - "--csi-address=$(ADDRESS)"
            - "--v=5"
            - "--timeout=300s"
            - "--leader-election=true"
            - "--leader-election-namespace=rds-csi"
          env:
            - name: ADDRESS
              value: /var/lib/csi/sockets/pluginproxy/csi.sock
          volumeMounts:
            - name: socket-dir
              mountPath: /var/lib/csi/sockets/pluginproxy/
          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
  ```

  IMPORTANT: Use csi-snapshotter v8.2.0 as recommended by RESEARCH.md (not v8.4.0 which adds VolumeGroupSnapshot v1beta2 we don't need).
  </action>
  <verify>
  Run `kubectl apply --dry-run=client -f deploy/kubernetes/rbac.yaml` and `kubectl apply --dry-run=client -f deploy/kubernetes/controller.yaml` to validate YAML syntax (if kubectl is available). Otherwise, validate YAML manually by checking indentation.
  </verify>
  <done>RBAC includes snapshot.storage.k8s.io permissions. Controller deployment includes csi-snapshotter v8.2.0 sidecar with correct socket mount and resource limits.</done>
</task>

<task type="auto">
  <name>Task 2: Create VolumeSnapshotClass manifest</name>
  <files>deploy/kubernetes/snapshotclass.yaml</files>
  <action>
  Create a new file `deploy/kubernetes/snapshotclass.yaml` with the VolumeSnapshotClass definition:

  ```yaml
  ---
  # VolumeSnapshotClass for RDS CSI Driver
  # Requires VolumeSnapshot CRDs to be installed cluster-wide:
  #   kubectl kustomize https://github.com/kubernetes-csi/external-snapshotter/client/config/crd | kubectl create -f -
  # And snapshot-controller to be deployed:
  #   kubectl kustomize https://github.com/kubernetes-csi/external-snapshotter/deploy/kubernetes/snapshot-controller | kubectl create -f -
  apiVersion: snapshot.storage.k8s.io/v1
  kind: VolumeSnapshotClass
  metadata:
    name: rds-csi-snapclass
    labels:
      app: rds-csi
  driver: rds.csi.srvlab.io
  deletionPolicy: Delete
  # parameters: {}
  # No special parameters needed for Btrfs snapshots.
  # Optional parameters that can be added:
  #   btrfsFSLabel: "storage-pool"  # Override Btrfs filesystem label (default: storage-pool)
  ```

  The comments include the prerequisite commands for installing VolumeSnapshot CRDs and snapshot-controller, since these are cluster-wide dependencies that must be installed before the VolumeSnapshotClass can be created (per RESEARCH.md).
  </action>
  <verify>
  Verify the file exists and has correct YAML structure. Check that the driver field matches `rds.csi.srvlab.io` (the DriverName constant).
  </verify>
  <done>VolumeSnapshotClass manifest exists at deploy/kubernetes/snapshotclass.yaml with driver=rds.csi.srvlab.io, deletionPolicy=Delete, and installation prerequisite comments.</done>
</task>

</tasks>

<verification>
- RBAC yaml is valid and includes 4 snapshot.storage.k8s.io rules
- Controller yaml includes csi-snapshotter container with v8.2.0 image
- csi-snapshotter mounts the same socket-dir as other sidecars
- VolumeSnapshotClass yaml has correct apiVersion (snapshot.storage.k8s.io/v1)
- VolumeSnapshotClass driver matches DriverName constant (rds.csi.srvlab.io)
- VolumeSnapshotClass has deletionPolicy: Delete
</verification>

<success_criteria>
1. RBAC rules grant access to volumesnapshotclasses, volumesnapshotcontents, volumesnapshotcontents/status, volumesnapshots
2. csi-snapshotter v8.2.0 sidecar added to controller deployment with leader election
3. VolumeSnapshotClass created with correct driver name and deletion policy
4. All YAML files are syntactically valid
5. Installation prerequisites documented in VolumeSnapshotClass comments
</success_criteria>

<output>
After completion, create `.planning/phases/26-volume-snapshots/26-05-SUMMARY.md`
</output>
