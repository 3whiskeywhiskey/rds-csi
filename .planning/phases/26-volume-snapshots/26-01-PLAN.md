---
phase: 26-volume-snapshots
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/rds/types.go
  - pkg/utils/snapshotid.go
  - pkg/rds/client.go
  - pkg/rds/mock.go
autonomous: true

must_haves:
  truths:
    - "SnapshotInfo type captures name, source volume, size, creation time, read-only flag, and filesystem label"
    - "Snapshot IDs follow snap-<uuid> format and are validated against command injection"
    - "MockClient supports all snapshot operations (create, delete, get, list, restore) for testing"
    - "RDSClient interface declares snapshot methods alongside existing volume methods"
  artifacts:
    - path: "pkg/rds/types.go"
      provides: "SnapshotInfo, CreateSnapshotOptions, SnapshotNotFoundError types"
      contains: "SnapshotInfo"
    - path: "pkg/utils/snapshotid.go"
      provides: "Snapshot ID generation, validation, and name-to-ID conversion"
      exports: ["GenerateSnapshotID", "ValidateSnapshotID", "SnapshotNameToID"]
    - path: "pkg/rds/client.go"
      provides: "RDSClient interface with snapshot methods"
      contains: "CreateSnapshot"
    - path: "pkg/rds/mock.go"
      provides: "MockClient with snapshot map and snapshot CRUD operations"
      contains: "snapshots"
  key_links:
    - from: "pkg/rds/mock.go"
      to: "pkg/rds/types.go"
      via: "SnapshotInfo type usage"
      pattern: "SnapshotInfo"
    - from: "pkg/utils/snapshotid.go"
      to: "pkg/utils/volumeid.go"
      via: "Mirrors VolumeID patterns (safeSlotPattern reuse)"
      pattern: "safeSlotPattern"
---

<objective>
Create the snapshot data model foundation: types, ID utilities, interface extension, and mock implementation.

Purpose: All subsequent snapshot plans depend on these types and interfaces. This establishes the contract that RDS commands, controller RPCs, and tests build upon.
Output: SnapshotInfo type, snapshot ID utilities, extended RDSClient interface, and fully functional MockClient for snapshot operations.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-volume-snapshots/26-CONTEXT.md
@.planning/phases/26-volume-snapshots/26-RESEARCH.md
@pkg/rds/types.go
@pkg/rds/client.go
@pkg/rds/mock.go
@pkg/utils/volumeid.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Snapshot types and ID utilities</name>
  <files>pkg/rds/types.go, pkg/utils/snapshotid.go</files>
  <action>
  1. In `pkg/rds/types.go`, add the following types after the existing `VolumeNotFoundError`:

  ```go
  // SnapshotInfo represents an RDS Btrfs snapshot
  type SnapshotInfo struct {
      Name          string    // Snapshot name (snap-<uuid>)
      SourceVolume  string    // Source volume slot (pvc-<uuid>)
      FileSizeBytes int64     // Size of snapshot (same as source volume)
      CreatedAt     time.Time // Creation timestamp
      ReadOnly      bool      // Should always be true for snapshots
      FSLabel       string    // Btrfs filesystem label
  }

  // CreateSnapshotOptions contains parameters for creating a snapshot
  type CreateSnapshotOptions struct {
      Name         string // snap-<uuid>
      SourceVolume string // pvc-<uuid> (parent subvolume)
      FSLabel      string // Btrfs filesystem label
  }

  // SnapshotNotFoundError is returned when a snapshot is not found
  type SnapshotNotFoundError struct {
      Name string
  }

  func (e *SnapshotNotFoundError) Error() string {
      return fmt.Sprintf("snapshot not found: %s", e.Name)
  }
  ```

  2. Create `pkg/utils/snapshotid.go` with snapshot ID utilities mirroring the volumeid.go patterns:

  - `const SnapshotIDPrefix = "snap-"`
  - `var snapshotIDPattern` -- regex matching `^snap-[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$`
  - `GenerateSnapshotID() string` -- returns `snap-<uuid>` using `uuid.New()`
  - `SnapshotNameToID(name string) string` -- deterministic snapshot ID from name using UUID v5 (same volumeNamespace as volumeid.go, but use a different namespace UUID to avoid collisions with volume IDs -- create `snapshotNamespace`)
  - `ValidateSnapshotID(snapshotID string) error` -- mirrors ValidateVolumeID logic:
    - Empty check
    - Strict `snap-<uuid>` pattern check
    - Fallback to `safeSlotPattern` for CSI sanity test IDs
    - Reject `snap-` prefix with non-UUID format
    - Length check (max 250)
  - Reuse `safeSlotPattern` from volumeid.go (it's package-level var, already accessible within the utils package)

  IMPORTANT: Use the same `uuid` and `regexp` imports as volumeid.go. Do NOT create a separate namespace -- reuse the same `volumeNamespace` for SnapshotNameToID since volume names and snapshot names are inherently different strings (volume names come from PV names, snapshot names come from VolumeSnapshot names, so collisions are impossible).
  </action>
  <verify>
  Run `go build ./pkg/...` to verify compilation. Run `go vet ./pkg/utils/...` to check for issues.
  </verify>
  <done>SnapshotInfo, CreateSnapshotOptions, SnapshotNotFoundError types exist in types.go. snapshotid.go has GenerateSnapshotID, ValidateSnapshotID, SnapshotNameToID functions. All compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: RDSClient interface extension and MockClient snapshot support</name>
  <files>pkg/rds/client.go, pkg/rds/mock.go</files>
  <action>
  1. In `pkg/rds/client.go`, extend the `RDSClient` interface with snapshot methods after the existing `GetAddress()` method:

  ```go
  // Snapshot operations
  CreateSnapshot(opts CreateSnapshotOptions) (*SnapshotInfo, error)
  DeleteSnapshot(snapshotID string) error
  GetSnapshot(snapshotID string) (*SnapshotInfo, error)
  ListSnapshots() ([]SnapshotInfo, error)
  RestoreSnapshot(snapshotID string, newVolumeOpts CreateVolumeOptions) error
  ```

  2. In `pkg/rds/mock.go`, implement all snapshot methods:

  - Add `snapshots map[string]*SnapshotInfo` field to MockClient struct
  - Initialize `snapshots: make(map[string]*SnapshotInfo)` in NewMockClient()
  - Add test helpers: `AddSnapshot(s *SnapshotInfo)`, `RemoveSnapshot(name string)`
  - Implement `CreateSnapshot`: check error, verify source volume exists in `m.volumes`, check idempotency (snapshot with same name already exists -- if same source return existing, if different source return error), create SnapshotInfo with ReadOnly=true and CreatedAt=time.Now(), store in map
  - Implement `DeleteSnapshot`: check error, idempotent (return nil if not found), delete from map
  - Implement `GetSnapshot`: check error, return copy if found, return SnapshotNotFoundError if not
  - Implement `ListSnapshots`: return all snapshots as slice (copy values)
  - Implement `RestoreSnapshot`: check error, verify snapshot exists, create new volume in `m.volumes` using newVolumeOpts (same pattern as CreateVolume but don't error if source is a snapshot)

  All methods must follow the existing MockClient patterns: acquire mutex, check errors via `checkError()`, return copies to prevent mutation.

  IMPORTANT: The sshClient in commands.go does NOT yet implement these methods -- that is Plan 02. The compiler will show errors for sshClient, which is expected. We need to add stub implementations to make it compile. Add stubs to a new section at the bottom of commands.go:

  ```go
  // Snapshot operations (stubs - implemented in Plan 26-02)
  func (c *sshClient) CreateSnapshot(opts CreateSnapshotOptions) (*SnapshotInfo, error) {
      return nil, fmt.Errorf("snapshot operations not yet implemented")
  }
  func (c *sshClient) DeleteSnapshot(snapshotID string) error {
      return fmt.Errorf("snapshot operations not yet implemented")
  }
  func (c *sshClient) GetSnapshot(snapshotID string) (*SnapshotInfo, error) {
      return nil, fmt.Errorf("snapshot operations not yet implemented")
  }
  func (c *sshClient) ListSnapshots() ([]SnapshotInfo, error) {
      return nil, fmt.Errorf("snapshot operations not yet implemented")
  }
  func (c *sshClient) RestoreSnapshot(snapshotID string, newVolumeOpts CreateVolumeOptions) error {
      return fmt.Errorf("snapshot operations not yet implemented")
  }
  ```
  </action>
  <verify>
  Run `go build ./pkg/...` to verify ALL packages compile (including driver package that uses RDSClient interface). Run `go test ./pkg/rds/... -count=1` to verify existing mock tests still pass.
  </verify>
  <done>RDSClient interface includes 5 snapshot methods. MockClient has full snapshot map with CRUD operations. sshClient has stub implementations. All packages compile. Existing tests pass.</done>
</task>

</tasks>

<verification>
- `go build ./...` compiles without errors
- `go vet ./pkg/...` reports no issues
- `go test ./pkg/rds/... -count=1` passes (existing mock tests unbroken)
- `go test ./pkg/utils/... -count=1` passes
- SnapshotInfo type has all 6 fields (Name, SourceVolume, FileSizeBytes, CreatedAt, ReadOnly, FSLabel)
- MockClient.CreateSnapshot is idempotent (same name + same source = return existing)
- MockClient.DeleteSnapshot is idempotent (not found = return nil)
- ValidateSnapshotID rejects command injection characters
</verification>

<success_criteria>
1. Types (SnapshotInfo, CreateSnapshotOptions, SnapshotNotFoundError) defined in types.go
2. Snapshot ID utilities (generate, validate, name-to-ID) in snapshotid.go
3. RDSClient interface extended with 5 snapshot methods
4. MockClient implements all 5 snapshot methods with idempotency
5. sshClient has stub implementations (returns "not yet implemented")
6. Full project compiles: `go build ./...` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/26-volume-snapshots/26-01-SUMMARY.md`
</output>
