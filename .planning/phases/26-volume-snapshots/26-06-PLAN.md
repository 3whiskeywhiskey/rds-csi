---
phase: 26-volume-snapshots
plan: 06
type: execute
wave: 5
depends_on: ["26-04"]
files_modified:
  - test/sanity/sanity_test.go
  - pkg/driver/controller_test.go
autonomous: true

must_haves:
  truths:
    - "CSI sanity tests are configured with TestSnapshotParameters to enable snapshot test suite"
    - "Controller unit tests cover CreateSnapshot, DeleteSnapshot, ListSnapshots, and CreateVolume from snapshot"
    - "Unit tests validate idempotency, error cases, and pagination"
    - "All existing tests continue to pass alongside new snapshot tests"
  artifacts:
    - path: "test/sanity/sanity_test.go"
      provides: "Sanity test configuration with snapshot parameters enabled"
      contains: "TestSnapshotParameters"
    - path: "pkg/driver/controller_test.go"
      provides: "Controller snapshot RPC unit tests"
      contains: "TestCreateSnapshot"
  key_links:
    - from: "test/sanity/sanity_test.go"
      to: "pkg/driver/controller.go"
      via: "Sanity tests exercise CreateSnapshot/DeleteSnapshot/ListSnapshots via CSI socket"
      pattern: "sanity.Test"
    - from: "pkg/driver/controller_test.go"
      to: "pkg/rds/mock.go"
      via: "Unit tests use MockClient for snapshot operations"
      pattern: "MockClient"
---

<objective>
Add snapshot testing: configure CSI sanity tests for snapshot operations and add controller unit tests for all snapshot RPCs.

Purpose: Validates CSI spec compliance (sanity tests) and correctness (unit tests) for snapshot operations. SNAP-07 requires sanity tests to pass.
Output: Sanity tests configured for snapshots, comprehensive unit tests for all snapshot controller RPCs.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/26-volume-snapshots/26-CONTEXT.md
@.planning/phases/26-volume-snapshots/26-RESEARCH.md
@.planning/phases/26-volume-snapshots/26-04-SUMMARY.md
@test/sanity/sanity_test.go
@pkg/driver/controller_test.go
@pkg/rds/mock.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure CSI sanity tests for snapshot operations</name>
  <files>test/sanity/sanity_test.go</files>
  <action>
  Update the CSI sanity test configuration in `test/sanity/sanity_test.go` to enable snapshot testing.

  Add the following to the sanity config section (after the existing `config.TestVolumeParameters` assignment):

  ```go
  // Snapshot test parameters (enables snapshot sanity test suite)
  config.TestSnapshotParameters = map[string]string{
      // No special parameters needed for Btrfs snapshots
      // btrfsFSLabel is resolved to default "storage-pool" by the controller
  }
  ```

  This tells the CSI sanity test framework to run snapshot-specific tests (CreateSnapshot, DeleteSnapshot, ListSnapshots) in addition to the existing volume tests.

  IMPORTANT: The sanity test framework will exercise:
  - CreateSnapshot with a valid source volume
  - CreateSnapshot idempotency (same name twice)
  - DeleteSnapshot
  - DeleteSnapshot for non-existent snapshot
  - ListSnapshots with and without filters
  - ListSnapshots pagination

  The mock RDS server needs to support Btrfs snapshot commands. Check if the mock server at `test/mock/` needs to be updated to handle `/disk/btrfs/subvolume` commands. If the mock server uses the MockClient from `pkg/rds/mock.go` (which now supports snapshots from Plan 01), it should work. If the mock server is an SSH server that parses commands, it needs to be extended.

  Review `test/mock/` to determine if the mock RDS SSH server needs snapshot command handlers. If so:
  - Add handlers for `/disk/btrfs/subvolume/add`, `/disk/btrfs/subvolume/remove`, `/disk/btrfs/subvolume/print`
  - These handlers should delegate to the mock's internal state (snapshot map)
  - Follow the existing pattern of command parsing and RouterOS-formatted output

  The key commands the sshClient will send:
  - `/disk/btrfs/subvolume/add read-only=yes parent=<vol> fs=<label> name=<snap>` (CreateSnapshot)
  - `/disk/btrfs/subvolume/remove [find where name=<snap>]` (DeleteSnapshot)
  - `/disk/btrfs/subvolume/print detail where name=<snap>` (GetSnapshot)
  - `/disk/btrfs/subvolume/print where name~"snap-"` (ListSnapshots)
  - `/disk/btrfs/subvolume/add parent=<snap> fs=<label> name=<vol>` (RestoreSnapshot - no read-only)
  </action>
  <verify>
  Run `go test ./test/sanity/... -v -count=1 -timeout=120s` to verify sanity tests pass with snapshot support enabled. If snapshot sanity tests fail, diagnose and fix the issue (likely mock server needs snapshot command handling).
  </verify>
  <done>CSI sanity tests configured with TestSnapshotParameters. All sanity tests pass including snapshot operations. Mock server handles Btrfs snapshot commands.</done>
</task>

<task type="auto">
  <name>Task 2: Controller unit tests for snapshot RPCs</name>
  <files>pkg/driver/controller_test.go</files>
  <action>
  Add comprehensive unit tests for snapshot controller RPCs. Create or extend `pkg/driver/controller_test.go` with the following test functions. Use the existing test patterns in the file (MockClient setup, direct RPC calls).

  **TestCreateSnapshot:**
  - Setup: Create a driver with MockClient, add a test volume to MockClient
  - Test cases (table-driven):
    1. Success: valid name + valid source volume -> returns snapshot with correct fields
    2. Missing name -> InvalidArgument error
    3. Missing source volume ID -> InvalidArgument error
    4. Source volume not found -> NotFound error
    5. Idempotent: call twice with same name + same source -> returns same snapshot
    6. Name conflict: same name + different source -> AlreadyExists error
    7. RDS client error -> Internal error

  **TestDeleteSnapshot:**
  - Test cases:
    1. Success: delete existing snapshot -> empty response
    2. Missing snapshot ID -> InvalidArgument error
    3. Delete non-existent snapshot -> success (idempotent, NOT error)
    4. RDS client error -> Internal error

  **TestListSnapshots:**
  - Test cases:
    1. Empty list: no snapshots -> empty response
    2. List all: multiple snapshots -> returns all with correct fields
    3. Filter by snapshot ID: returns single snapshot
    4. Filter by snapshot ID (not found): returns empty (not error)
    5. Filter by source volume: returns matching snapshots only
    6. Pagination: max_entries=1 with 3 snapshots -> returns 1 + next_token
    7. Pagination: use next_token -> returns remaining entries
    8. Invalid starting_token -> Aborted error

  **TestCreateVolumeFromSnapshot:**
  - Test cases:
    1. Success: CreateVolume with VolumeContentSource.Snapshot -> restored volume with ContentSource
    2. Snapshot not found -> NotFound error
    3. Requested size smaller than snapshot size -> volume created at snapshot size
    4. RDS restore error -> Internal error

  Each test should:
  - Use `rds.NewMockClient()` for the RDS backend
  - Create ControllerServer with a properly configured Driver
  - Call the RPC method directly
  - Assert response fields and error codes using `status.Code(err)`
  - Clean up between tests

  Follow the existing test style in the file. If the file doesn't exist, create it with proper package declaration and imports.
  </action>
  <verify>
  Run `go test ./pkg/driver/... -v -run "TestCreateSnapshot|TestDeleteSnapshot|TestListSnapshots|TestCreateVolumeFromSnapshot" -count=1` to verify all new tests pass. Then run `go test ./pkg/driver/... -count=1` to verify ALL driver tests (old + new) pass.
  </verify>
  <done>Controller unit tests cover CreateSnapshot, DeleteSnapshot, ListSnapshots, and CreateVolume from snapshot with idempotency, error cases, and pagination. All tests pass.</done>
</task>

</tasks>

<verification>
- `go test ./test/sanity/... -v -count=1 -timeout=120s` passes (including snapshot sanity tests)
- `go test ./pkg/driver/... -v -count=1` passes (all unit tests)
- `go test ./... -count=1` passes (full test suite)
- `make test` passes
- Snapshot sanity tests validate CSI spec compliance (SNAP-07)
- Unit tests cover idempotency, error codes, pagination
</verification>

<success_criteria>
1. CSI sanity test suite runs and passes with snapshot operations enabled
2. CreateSnapshot unit tests cover success, idempotency, name conflict, missing volume, errors
3. DeleteSnapshot unit tests cover success, idempotency (not found = success), errors
4. ListSnapshots unit tests cover empty list, filtering, pagination with tokens
5. CreateVolume from snapshot unit tests cover success, not found, size enforcement
6. All existing tests continue to pass (no regressions)
7. `make test` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/26-volume-snapshots/26-06-SUMMARY.md`
</output>
