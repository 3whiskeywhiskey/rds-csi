---
phase: 25.1-attachment-reconciliation-rds-resilience
plan: 03
subsystem: driver-integration, resilience
tags: [driver, connection-manager, node-watcher, startup-reconciliation, health-check, probe, integration]

# Dependency graph
requires:
  - phase: 25.1-01
    provides: NodeWatcher, TriggerReconcile mechanism, attachment reconciliation event handling
  - phase: 25.1-02
    provides: ConnectionManager with exponential backoff and OnReconnect callback
provides:
  - Fully wired Phase 25.1 components in production driver lifecycle
  - Connection-aware Probe health check reflecting RDS state
  - Automatic startup reconciliation on driver initialization
  - Event-driven node watcher triggering reconciliation on node failures
  - RDS reconnection triggering attachment reconciliation
affects:
  - Production deployments (health checks now reflect RDS connection state)
  - Kubernetes liveness/readiness probes (ready=false when RDS disconnected)
  - Future phases relying on attachment reconciliation infrastructure

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Driver lifecycle wiring pattern: register node watcher after informer cache sync
    - Connection manager integration with OnReconnect callback
    - Health check layering: prefer ConnectionManager, fallback to RDSClient
    - Startup reconciliation triggered after reconciler started

key-files:
  created: []
  modified:
    - pkg/driver/driver.go
    - pkg/driver/driver_test.go
    - pkg/driver/identity.go
    - pkg/driver/identity_test.go
    - pkg/driver/events.go

key-decisions:
  - "Probe prefers connectionManager.IsConnected() over rdsClient.IsConnected() (uses monitor state)"
  - "Node watcher registered after informer caches synced (avoids race conditions)"
  - "Connection manager started after attachment reconciler initialized (callback dependency)"
  - "Startup reconciliation uses TriggerReconcile() not direct reconcile() (respects deduplication)"
  - "Connection manager stopped before RDS client closed (clean shutdown order)"

patterns-established:
  - "Lifecycle wiring order: informers → node watcher → reconciler → connection manager → startup reconciliation"
  - "Health check pattern: prefer manager state, fallback to client state, record metrics"
  - "Event reason constants for RDS connection lifecycle (RDSDisconnected, RDSReconnected, StartupReconciliation)"

# Metrics
duration: 10min
completed: 2026-02-05
---

# Phase 25.1 Plan 03: Driver Integration & Health-Aware Probe Summary

**Driver integrates startup reconciliation, node watcher, connection manager, and connection-aware Probe health checks with Prometheus metrics**

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-05T19:24:32Z
- **Completed:** 2026-02-05T19:34:32Z (estimated)
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments

- Driver.Run() wires NodeWatcher to node informer for event-driven reconciliation on node failures
- ConnectionManager started with OnReconnect callback triggering attachment reconciliation after RDS reconnection
- Startup reconciliation triggered on driver initialization (clears stale attachments from previous runs)
- Probe health check reflects actual RDS connection state via ConnectionManager (ready=false when disconnected)
- Probe records Prometheus metrics on every call (continuous connection state signal)
- All 53 CSI sanity tests pass (no regressions)

## Task Commits

Each task was committed atomically:

1. **Task 1: Wire startup reconciliation, node watcher, and connection manager into driver** - `b8d0a52` (feat)
2. **Task 2: Make Probe health check connection-aware with metrics** - `0a404b4` (feat)
3. **Task 3: Run full test suite and verify integration** - (verification only, no commit)

## Files Created/Modified

- `pkg/driver/driver.go` - Added nodeWatcher and connectionManager fields, wired components in Run(), shutdown in Stop()
- `pkg/driver/driver_test.go` - Tests verifying nodeWatcher/connectionManager nil in node-only mode
- `pkg/driver/identity.go` - Enhanced Probe to check connectionManager.IsConnected() and record metrics
- `pkg/driver/identity_test.go` - 5 new tests covering connection state scenarios (connected/disconnected/fallback/metrics)
- `pkg/driver/events.go` - Added RDS connection event reason constants

## Decisions Made

**1. Probe prefers connectionManager.IsConnected() over rdsClient.IsConnected()**
- Rationale: ConnectionManager monitors connection state continuously in background. Using its state is more accurate than checking raw client connection (which may not reflect recent disconnections until next operation).

**2. Node watcher registered after informer caches synced**
- Rationale: Per Pitfall 1 in plan - node watcher depends on informer cache being populated. Registering before sync could cause handlers to fire with empty cache, leading to incorrect reconciliation decisions.

**3. Connection manager started after attachment reconciler initialized**
- Rationale: OnReconnect callback calls attachmentReconciler.TriggerReconcile(). Starting connection manager before reconciler exists would cause nil pointer dereference.

**4. Startup reconciliation uses TriggerReconcile() not direct reconcile()**
- Rationale: The reconciler is already started by this point. TriggerReconcile() handles deduplication properly and doesn't bypass the reconciler's own state management.

**5. Connection manager stopped before RDS client closed**
- Rationale: Connection manager monitor goroutine uses RDS client. Stopping monitor first ensures no concurrent access during client shutdown.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**ConnectionManager constructor returns error**
- Issue: Plan showed `d.connectionManager = rds.NewConnectionManager(cmConfig)` but NewConnectionManager actually returns `(*ConnectionManager, error)`
- Resolution: Added error handling: `connectionManager, err := rds.NewConnectionManager(config); if err != nil { return fmt.Errorf(...) }`
- Impact: Proper error handling, no functional change

**Test mock complexity**
- Issue: Initial test approach tried to mock RDSClient interface with minimal implementation, but RDSClient has 11 methods
- Resolution: Used rds.MockClient directly (already exists, fully implements interface)
- Impact: Cleaner tests, leveraged existing mock infrastructure

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Complete:** Phase 25.1 fully integrated
- Startup reconciliation clears stale attachments on driver start
- Node watcher triggers reconciliation on node NotReady/Deletion events
- Connection manager monitors RDS health and reconnects automatically
- Post-reconnection triggers attachment reconciliation via callback
- Probe returns ready=false when RDS disconnected (Kubernetes marks pod not ready)

**Ready for:** Phase 25.2 (if exists) or Phase 26

**Blockers:** None

**Concerns:**
- Pre-existing test failures in pkg/driver (14 failures in controller/node tests) are unrelated to Phase 25.1 changes
- All Phase 25.1 tests pass (attachment: 82.9% coverage, rds: 71.4% coverage)
- All 53 CSI sanity tests pass

---
*Phase: 25.1-attachment-reconciliation-rds-resilience*
*Completed: 2026-02-05*
