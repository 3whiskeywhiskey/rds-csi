---
phase: 25.1-attachment-reconciliation-rds-resilience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/attachment/reconciler.go
  - pkg/attachment/reconciler_test.go
  - pkg/attachment/node_watcher.go
  - pkg/attachment/node_watcher_test.go
autonomous: true

must_haves:
  truths:
    - "Node becoming NotReady triggers immediate attachment reconciliation"
    - "Node deletion triggers immediate attachment reconciliation"
    - "TriggerReconcile skips if reconciliation already in progress"
    - "Periodic reconciliation continues alongside event-driven triggers"
  artifacts:
    - path: "pkg/attachment/node_watcher.go"
      provides: "Node event handler for informer integration"
      exports: ["NodeWatcher", "NewNodeWatcher"]
    - path: "pkg/attachment/reconciler.go"
      provides: "TriggerReconcile method on AttachmentReconciler"
      contains: "TriggerReconcile"
    - path: "pkg/attachment/node_watcher_test.go"
      provides: "Unit tests for node watcher event handling"
    - path: "pkg/attachment/reconciler_test.go"
      provides: "Tests for TriggerReconcile deduplication"
  key_links:
    - from: "pkg/attachment/node_watcher.go"
      to: "pkg/attachment/reconciler.go"
      via: "NodeWatcher calls reconciler.TriggerReconcile()"
      pattern: "reconciler\\.TriggerReconcile"
    - from: "pkg/attachment/node_watcher.go"
      to: "k8s.io/client-go/tools/cache"
      via: "Returns ResourceEventHandlerFuncs for informer registration"
      pattern: "cache\\.ResourceEventHandlerFuncs"
---

<objective>
Add event-driven attachment reconciliation triggered by Kubernetes node state changes.

Purpose: The 2026-02-05 production incident showed that periodic reconciliation (5min interval) is too slow to detect stale attachments after node failures. Adding a node informer watcher provides immediate detection when nodes become NotReady or are deleted, triggering reconciliation within seconds instead of minutes.

Output: NodeWatcher component + TriggerReconcile mechanism on AttachmentReconciler, both with comprehensive tests.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25.1-attachment-reconciliation-rds-resilience/25.1-RESEARCH.md

# Existing code to extend
@pkg/attachment/reconciler.go
@pkg/attachment/reconciler_test.go
@pkg/attachment/manager.go
@pkg/attachment/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TriggerReconcile to AttachmentReconciler</name>
  <files>pkg/attachment/reconciler.go, pkg/attachment/reconciler_test.go</files>
  <action>
Add a `TriggerReconcile()` method to AttachmentReconciler that triggers an immediate reconciliation pass. Implementation requirements:

1. Add a `triggerCh chan struct{}` field to AttachmentReconciler (buffered, size 1).
2. Initialize it in NewAttachmentReconciler.
3. `TriggerReconcile()` does a non-blocking send on triggerCh. If channel already has a pending trigger, skip (deduplication). This prevents race conditions between node watcher and periodic reconciler (Pitfall 3 from research).
4. Update `run()` method to select on triggerCh alongside ticker and stop channels. When triggerCh fires, call `r.reconcile(ctx)` and drain the trigger.
5. Log at V(2) level when trigger fires vs periodic tick for debugging.

Do NOT modify the reconcile() method itself - it already handles concurrent access correctly via manager's per-volume locks.

Add tests in reconciler_test.go:
- Test TriggerReconcile causes immediate reconciliation (use a mock with known stale attachment)
- Test multiple rapid TriggerReconcile calls don't cause duplicate reconciliation runs
- Test TriggerReconcile works when reconciler is not running (no panic)
  </action>
  <verify>
Run `cd /Users/whiskey/code/rds-csi && go build ./pkg/attachment/...` compiles cleanly.
Run `cd /Users/whiskey/code/rds-csi && go test ./pkg/attachment/... -run TestTrigger -v` passes.
  </verify>
  <done>
AttachmentReconciler.TriggerReconcile() triggers immediate reconciliation. Multiple triggers are deduplicated. No deadlocks or panics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NodeWatcher for informer integration</name>
  <files>pkg/attachment/node_watcher.go, pkg/attachment/node_watcher_test.go</files>
  <action>
Create pkg/attachment/node_watcher.go implementing a NodeWatcher that integrates with Kubernetes node informers.

Implementation:
1. `NodeWatcher` struct with fields: `reconciler *AttachmentReconciler`, `metrics *observability.Metrics` (optional, may be nil).
2. `NewNodeWatcher(reconciler *AttachmentReconciler, metrics *observability.Metrics) *NodeWatcher` constructor.
3. `GetEventHandlers() cache.ResourceEventHandlerFuncs` method that returns handlers for:
   - **UpdateFunc:** Detect transition from Ready to NotReady (compare old/new node conditions). On transition, log at Info level "Node %s became NotReady, triggering attachment reconciliation" and call `reconciler.TriggerReconcile()`.
   - **DeleteFunc:** Log at Info level "Node %s deleted, triggering attachment reconciliation" and call `reconciler.TriggerReconcile()`. Handle tombstone objects (cache.DeletedFinalStateUnknown) properly per client-go patterns.
   - **AddFunc:** No action needed (new nodes don't create stale attachments).
4. Helper function `isNodeReady(node *corev1.Node) bool` that checks node conditions for NodeReady=True.
5. If metrics is non-nil, record reconcile trigger events via `metrics.RecordReconcileAction("node_watcher_trigger")`.

Create pkg/attachment/node_watcher_test.go with tests:
- Test UpdateFunc detects Ready->NotReady transition and calls TriggerReconcile
- Test UpdateFunc ignores NotReady->NotReady (no change)
- Test UpdateFunc ignores Ready->Ready (no change)
- Test DeleteFunc triggers reconciliation
- Test DeleteFunc handles tombstone objects without panic
- Test nil metrics doesn't panic

Use fake/mock reconciler for testing - create a simple testable wrapper or use the existing reconciler with a test configuration.
  </action>
  <verify>
Run `cd /Users/whiskey/code/rds-csi && go build ./pkg/attachment/...` compiles cleanly.
Run `cd /Users/whiskey/code/rds-csi && go test ./pkg/attachment/... -run TestNodeWatcher -v` passes.
Run `cd /Users/whiskey/code/rds-csi && go vet ./pkg/attachment/...` passes.
  </verify>
  <done>
NodeWatcher detects node NotReady transitions and deletions, triggering immediate attachment reconciliation. Tombstone objects handled correctly. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `go build ./pkg/attachment/...` compiles without errors
- `go test ./pkg/attachment/... -v` all tests pass (existing + new)
- `go vet ./pkg/attachment/...` no issues
- No import cycles introduced
</verification>

<success_criteria>
1. TriggerReconcile() method exists on AttachmentReconciler with deduplication
2. NodeWatcher correctly detects Ready->NotReady transitions
3. NodeWatcher correctly handles node deletions (including tombstones)
4. All existing reconciler tests still pass
5. New tests cover trigger deduplication and node event handling
</success_criteria>

<output>
After completion, create `.planning/phases/25.1-attachment-reconciliation-rds-resilience/25.1-01-SUMMARY.md`
</output>
