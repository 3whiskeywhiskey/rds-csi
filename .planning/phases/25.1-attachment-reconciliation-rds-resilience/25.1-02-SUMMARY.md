---
phase: 25.1-attachment-reconciliation-rds-resilience
plan: 02
subsystem: observability, infra
tags: prometheus, metrics, backoff, retry, connection-pooling, resilience

# Dependency graph
requires:
  - phase: 25-04
    provides: Prometheus metrics infrastructure for CSI operations
  - phase: 25-01
    provides: RDS client interface and mock implementation
provides:
  - RDS connection health monitoring with automatic reconnection
  - Prometheus metrics for RDS connection state and reconnection attempts
  - ConnectionManager with exponential backoff for production resilience
  - MockClient with configurable connection state for testing
affects:
  - 25.1-03 (will integrate ConnectionManager into controller)
  - 25.1-04 (probe health checks will use ConnectionManager.IsConnected())

# Tech tracking
tech-stack:
  added:
    - cenkalti/backoff/v4 (exponential backoff with jitter)
  patterns:
    - Background connection monitoring with 5-second polling
    - Exponential backoff with jitter (1s→2s→4s→8s→16s max)
    - OnReconnect callback pattern for triggering reconciliation
    - Graceful shutdown via context cancellation or Stop()

key-files:
  created:
    - pkg/rds/connection_manager.go (automatic reconnection with backoff)
    - pkg/rds/connection_manager_test.go (comprehensive connection manager tests)
  modified:
    - pkg/observability/prometheus.go (added RDS connection metrics)
    - pkg/observability/prometheus_test.go (tests for connection metrics)
    - pkg/rds/mock.go (added SetConnected for testing)
    - go.mod (added backoff dependency)

key-decisions:
  - "Exponential backoff with jitter (RandomizationFactor=0.1) prevents thundering herd on RDS restart"
  - "ConnectionManager polls every 5 seconds (production-friendly, not chatty)"
  - "MaxElapsedTime=0 for background reconnection (never give up)"
  - "Close old SSH session before reconnecting to prevent session leaks"
  - "ConnectionManager is a monitor, not a proxy - callers use GetClient() directly"

patterns-established:
  - "Background connection monitoring pattern: StartMonitor(ctx) with ticker and reconnection loop"
  - "OnReconnect callback for triggering reconciliation after connection restored"
  - "MockClient configurable state pattern: SetConnected() for testing disconnection scenarios"

# Metrics
duration: 7min
completed: 2026-02-05
---

# Phase 25.1 Plan 02: Attachment Reconciliation & RDS Resilience Summary

**RDS ConnectionManager with exponential backoff (1s→16s) and Prometheus metrics for connection state tracking**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-05T19:14:07Z
- **Completed:** 2026-02-05T19:20:48Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments
- RDS connection state tracked in Prometheus (1=connected, 0=disconnected)
- Automatic reconnection with exponential backoff prevents manual intervention after RDS crashes
- OnReconnect callback enables triggering attachment reconciliation after connection restored
- Comprehensive tests including disconnection detection, backoff timing, and graceful shutdown

## Task Commits

Each task was committed atomically:

1. **Task 1: Add RDS connection Prometheus metrics** - `0f505d6` (feat)
2. **Task 2: Create RDS ConnectionManager with exponential backoff** - `4f6553d` (feat)

## Files Created/Modified
- `pkg/observability/prometheus.go` - Added rds_connection_state gauge, rds_reconnect_total counter, rds_reconnect_duration histogram
- `pkg/observability/prometheus_test.go` - Tests for all RDS connection metrics
- `pkg/rds/connection_manager.go` - Background monitor with automatic reconnection and exponential backoff
- `pkg/rds/connection_manager_test.go` - Tests for disconnection detection, backoff behavior, OnReconnect callback
- `pkg/rds/mock.go` - Extended with SetConnected() and configurable IsConnected() for testing
- `go.mod` - Added cenkalti/backoff/v4 dependency
- `go.sum` - Dependency checksums

## Decisions Made

- **Exponential backoff with jitter**: RandomizationFactor=0.1 prevents thundering herd when multiple controllers reconnect to RDS simultaneously after crash
- **5-second polling interval**: Balances responsiveness (detect disconnection within 5s) with low overhead (not chatty)
- **MaxElapsedTime=0**: Background reconnection never gives up (appropriate for production - RDS will eventually come back)
- **Close before reconnect**: Prevents SSH session leaks by closing old connection before attempting new one
- **Monitor pattern, not proxy**: ConnectionManager doesn't wrap every RDSClient method - callers use GetClient() and handle connection errors directly (fail fast with codes.Unavailable per CSI spec)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**Test timing issue in TestStartMonitor_DetectsDisconnection**: Initial test expected disconnection to persist, but MockClient.Connect() succeeds by default, causing immediate reconnection. Fixed by setting persistent error to prevent reconnection in that test. This led to better test design that explicitly controls connection state.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for integration:**
- Plan 25.1-03 can integrate ConnectionManager into controller service with OnReconnect triggering attachment reconciliation
- Plan 25.1-04 can implement probe health checks using ConnectionManager.IsConnected()

**Blockers:** None

**Concerns:** None - ConnectionManager is self-contained and well-tested

---
*Phase: 25.1-attachment-reconciliation-rds-resilience*
*Completed: 2026-02-05*
