---
phase: 25.1-attachment-reconciliation-rds-resilience
plan: 01
subsystem: attachment-reconciliation
tags: [kubernetes, node-watcher, informer, attachment-manager, event-driven]

# Dependency graph
requires:
  - phase: 24-e2e-testing
    provides: Attachment manager with periodic reconciliation
provides:
  - Event-driven attachment reconciliation triggered by node state changes
  - NodeWatcher component for Kubernetes node informer integration
  - TriggerReconcile mechanism with deduplication
affects: [25.1-02-rds-connection-pool, 25.1-03-reconciler-probe]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Event-driven reconciliation alongside periodic reconciliation
    - Non-blocking channel sends for trigger deduplication
    - Node informer integration via ResourceEventHandlerFuncs

key-files:
  created:
    - pkg/attachment/node_watcher.go
    - pkg/attachment/node_watcher_test.go
  modified:
    - pkg/attachment/reconciler.go
    - pkg/attachment/reconciler_test.go

key-decisions:
  - "Use buffered channel (size 1) for trigger deduplication - prevents race conditions"
  - "TriggerReconcile safe to call when reconciler not running (no-op, no panic)"
  - "Detect Ready->NotReady transitions only (ignore NotReady->NotReady)"
  - "Handle tombstone objects in DeleteFunc per client-go patterns"

patterns-established:
  - "Trigger deduplication: non-blocking send on buffered channel"
  - "Safe shutdown: clear triggerCh in Stop() to prevent use-after-stop"
  - "Node readiness check: iterate conditions for NodeReady=True"

# Metrics
duration: 6min
completed: 2026-02-05
---

# Phase 25.1 Plan 01: Node Event-Driven Reconciliation Summary

**Event-driven attachment reconciliation with NodeWatcher triggering on node NotReady and deletion events**

## Performance

- **Duration:** 6 min 27 sec
- **Started:** 2026-02-05T19:12:50Z
- **Completed:** 2026-02-05T19:19:18Z
- **Tasks:** 2
- **Files modified:** 4 (2 created, 2 modified)

## Accomplishments
- AttachmentReconciler now responds to node events within seconds (vs 5min periodic interval)
- NodeWatcher integrates with Kubernetes node informers via ResourceEventHandlerFuncs
- TriggerReconcile deduplication prevents concurrent reconciliation storms
- Comprehensive tests cover event handling, tombstones, and nil metrics safety

## Task Commits

Each task was committed atomically:

1. **Task 1: Add TriggerReconcile to AttachmentReconciler** - `dbb8c35` (feat)
2. **Task 2: Create NodeWatcher for informer integration** - `ee2309d` (feat)

## Files Created/Modified
- `pkg/attachment/reconciler.go` - Added triggerCh, TriggerReconcile method, select on triggerCh in run()
- `pkg/attachment/reconciler_test.go` - Tests for TriggerReconcile (immediate, deduplication, not running, after stop)
- `pkg/attachment/node_watcher.go` - NodeWatcher with GetEventHandlers() for node informer integration
- `pkg/attachment/node_watcher_test.go` - Tests for UpdateFunc, DeleteFunc, tombstone handling, isNodeReady

## Decisions Made

**1. Buffered channel size 1 for deduplication**
- Rationale: Prevents race conditions between node watcher and periodic reconciler. Non-blocking send ensures trigger requests don't block event handlers.

**2. TriggerReconcile safe when reconciler not running**
- Rationale: Node informers may fire events during controller startup/shutdown. Safe no-op prevents panics.

**3. Ready->NotReady transition detection**
- Rationale: NotReady->NotReady has no new information. Only transitions indicate node state degradation requiring immediate reconciliation.

**4. Tombstone handling in DeleteFunc**
- Rationale: Client-go informers may send DeletedFinalStateUnknown when cache falls behind. Extracting from tombstone prevents handler crashes.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**Test hang in AfterStop test (fixed)**
- Issue: Test called Stop() before reconciler goroutine started
- Solution: Added 10ms sleep before Stop() to ensure goroutine initialized
- Root cause: Race between Start() returning and run() goroutine executing

## Next Phase Readiness

- Node event-driven reconciliation complete
- Ready for 25.1-02 (RDS connection pool with retry/backoff)
- NodeWatcher will be registered in controller startup (integration task in later plan)

---
*Phase: 25.1-attachment-reconciliation-rds-resilience*
*Completed: 2026-02-05*
