---
phase: 10-upstream-contribution
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - /tmp/kubevirt-fork (PR created)
  - .planning/phases/10-upstream-contribution/10-02-PR-DESCRIPTION.md
autonomous: false

must_haves:
  truths:
    - "PR opened against kubevirt/kubevirt main branch"
    - "PR description includes issue references (#6564, #9708, #16520)"
    - "PR includes release notes block"
    - "PR has clear before/after explanation"
  artifacts:
    - path: ".planning/phases/10-upstream-contribution/10-02-PR-DESCRIPTION.md"
      provides: "PR description draft"
      contains: "Fixes kubevirt/kubevirt#6564"
  key_links:
    - from: "PR description"
      to: "upstream issues"
      via: "Fixes #number syntax"
      pattern: "Fixes kubevirt/kubevirt#"
---

<objective>
Open upstream PR against kubevirt/kubevirt with complete description and await initial review.

Purpose: Get the hotplug fix into upstream KubeVirt for all users to benefit
Output: PR URL, documented process for handling review feedback
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.5-ROADMAP.md
@.planning/phases/10-upstream-contribution/10-RESEARCH.md
@.planning/phases/10-upstream-contribution/10-01-SUMMARY.md
@.planning/phases/09-implement-fix/09-01-CODEPATH.md
@.planning/phases/09-implement-fix/09-03-VALIDATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Draft PR description document</name>
  <files>.planning/phases/10-upstream-contribution/10-02-PR-DESCRIPTION.md</files>
  <action>
    Create PR description following KubeVirt's template format. Use content from:
    - 09-01-CODEPATH.md for technical explanation
    - 09-03-VALIDATION.md for testing evidence
    - 10-RESEARCH.md for PR format patterns

    PR description structure (per 10-RESEARCH.md Pattern 2):

    ```markdown
    **What this PR does / why we need it:**

    Fixes a race condition in volume hotplug where concurrent hotplugging of
    multiple volumes causes the virt-controller to delete old attachment pods
    before new volumes reach the Ready phase, resulting in VM pause and I/O errors.

    **Before:** `cleanupAttachmentPods()` deleted old pods immediately when new
    pods existed, regardless of volume readiness state. This caused the block device
    for existing volumes to disappear from the VM when a new volume was hotplugged.

    **After:** `cleanupAttachmentPods()` waits until all hotplug volumes reach
    `VolumeReady` phase before deleting old attachment pods.

    **The fix:**
    - Add `allHotplugVolumesReady()` helper that checks if all hotplug volumes have
      reached VolumeReady phase in VMI status
    - Modify `cleanupAttachmentPods()` to early return if volumes not ready
    - Guard conditions ensure volume removal (numReadyVolumes=0) is unaffected

    **Which issue(s) this PR fixes:**

    Fixes https://github.com/kubevirt/kubevirt/issues/6564
    Fixes https://github.com/kubevirt/kubevirt/issues/9708
    Related to https://github.com/kubevirt/kubevirt/issues/16520

    **Special notes for your reviewer:**

    - This is a first-time contribution from this account
    - Validated on production-like cluster with nested K3s worker VM
    - Multi-volume concurrent hotplug confirmed working without VM pause or I/O errors
    - Volume removal path tested and confirmed unaffected
    - Unit tests cover: bug reproduction, normal operation, single-volume regression, multi-volume edge case

    **Release note:**
    ```release-note
    Fix race condition in volume hotplug that caused VM pause and I/O errors
    when hotplugging multiple volumes concurrently
    ```
    ```

    Save to 10-02-PR-DESCRIPTION.md for reference during PR creation.
  </action>
  <verify>
    - File exists at .planning/phases/10-upstream-contribution/10-02-PR-DESCRIPTION.md
    - Contains all required sections per KubeVirt template
    - References issues #6564, #9708, #16520
    - Has release-note block
  </verify>
  <done>PR description drafted and saved</done>
</task>

<task type="auto">
  <name>Task 2: Open PR via GitHub CLI</name>
  <files>/tmp/kubevirt-fork</files>
  <action>
    1. Navigate to fork:
       ```bash
       cd /tmp/kubevirt-fork
       ```

    2. Verify we're on the correct branch with clean state:
       ```bash
       git status
       git log --oneline -3
       ```

    3. Open PR using gh CLI:
       ```bash
       gh pr create \
         --repo kubevirt/kubevirt \
         --base main \
         --head whiskey-works:hotplug-fix-v1 \
         --title "fix(hotplug): wait for new pod volumes ready before deleting old pod" \
         --body-file /Users/whiskey/code/rds-csi/.planning/phases/10-upstream-contribution/10-02-PR-DESCRIPTION.md
       ```

    4. If gh CLI not authenticated to kubevirt org, use web UI alternative:
       - Go to https://github.com/kubevirt/kubevirt/compare/main...whiskey-works:kubevirt:hotplug-fix-v1
       - Use the description from 10-02-PR-DESCRIPTION.md

    5. Record the PR URL for future reference.

    IMPORTANT: As first-time contributor, expect `needs-ok-to-test` label. CI won't run until org member approves with `/ok-to-test`.
  </action>
  <verify>
    - PR created successfully (gh pr create returns URL)
    - PR visible at github.com/kubevirt/kubevirt/pulls
    - PR targets main branch
    - PR body matches our description
  </verify>
  <done>PR opened against kubevirt/kubevirt</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>PR opened against kubevirt/kubevirt repository</what-built>
  <how-to-verify>
    1. Visit the PR URL provided in Task 2 output
    2. Verify PR description is complete and well-formatted
    3. Check PR has expected labels (likely `needs-ok-to-test`, `size/M`)
    4. Confirm commits show proper DCO sign-off
    5. Note: CI won't run until org member comments `/ok-to-test`

    If any issues with the PR:
    - Wrong description: Edit PR body via GitHub UI
    - Missing sign-off: Fix locally, force push, PR auto-updates
    - Wrong base branch: Close and recreate PR

    Expected initial state:
    - PR shows as "Open"
    - Labels include `needs-ok-to-test` (first-time contributor)
    - No CI runs yet (waiting for approval)
    - DCO check should show "Signed-off-by" present

    Next steps after verification:
    - Wait for org member to comment `/ok-to-test` to trigger CI
    - Respond to any reviewer questions
    - Address feedback with fixup commits (avoid amend, use new commits)
    - Keep branch up to date with main if needed (`git rebase upstream/main`)
  </how-to-verify>
  <resume-signal>Confirm PR URL and initial state, then type "approved" to complete phase</resume-signal>
</task>

</tasks>

<verification>
1. PR description document exists and follows KubeVirt template
2. PR opened successfully via gh CLI or web UI
3. PR targets kubevirt/kubevirt main branch
4. PR includes all required sections (description, issue refs, release notes)
5. User confirms PR is visible and properly formatted
</verification>

<success_criteria>
- 10-02-PR-DESCRIPTION.md exists with complete PR body
- PR URL obtained and recorded
- PR visible on kubevirt/kubevirt repository
- User confirms PR state is correct
</success_criteria>

<output>
After completion, create `.planning/phases/10-upstream-contribution/10-02-SUMMARY.md`

Include:
- PR URL
- Initial labels/status
- Expected next steps (await /ok-to-test)
- Timeline expectations (24-48h for initial review per research)
</output>
