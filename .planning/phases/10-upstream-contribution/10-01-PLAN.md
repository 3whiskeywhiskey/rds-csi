---
phase: 10-upstream-contribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /tmp/kubevirt-fork/.git (commits rebased and signed)
autonomous: true

must_haves:
  truths:
    - "All commits have DCO sign-off (Signed-off-by line)"
    - "Branch is rebased on upstream main"
    - "Commit messages follow conventional format"
    - "No focused test markers (FDescribe, FIt) in code"
  artifacts:
    - path: "/tmp/kubevirt-fork/pkg/virt-controller/watch/vmi/volume-hotplug.go"
      provides: "Fix implementation"
      contains: "allHotplugVolumesReady"
    - path: "/tmp/kubevirt-fork/pkg/virt-controller/watch/vmi/vmi_test.go"
      provides: "Unit tests for fix"
      contains: "should NOT delete old pod when new pod volumes are not ready"
  key_links:
    - from: "hotplug-fix-v1 branch"
      to: "upstream kubevirt/kubevirt main"
      via: "git rebase"
      pattern: "rebased on upstream main"
---

<objective>
Prepare the hotplug fix commits for upstream contribution to kubevirt/kubevirt.

Purpose: Ensure all commits meet KubeVirt contribution requirements before opening PR
Output: Clean git history with DCO-signed commits rebased on upstream main
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.5-ROADMAP.md
@.planning/phases/10-upstream-contribution/10-RESEARCH.md
@.planning/phases/09-implement-fix/09-01-SUMMARY.md
@.planning/phases/09-implement-fix/09-02-SUMMARY.md
@.planning/phases/09-implement-fix/09-03-VALIDATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify fork state and add upstream remote</name>
  <files>/tmp/kubevirt-fork</files>
  <action>
    1. Navigate to fork: `cd /tmp/kubevirt-fork`
    2. Verify branch: `git branch` (should show hotplug-fix-v1)
    3. Add upstream remote if not exists: `git remote add upstream https://github.com/kubevirt/kubevirt.git`
    4. Fetch upstream: `git fetch upstream`
    5. Check current commit history: `git log --oneline -5`

    Expected state:
    - Current branch: hotplug-fix-v1
    - Commits include: cc1b700 (fix), 6546421 (tests)
    - Remote upstream added pointing to kubevirt/kubevirt
  </action>
  <verify>
    - `git remote -v` shows upstream pointing to kubevirt/kubevirt
    - `git log --oneline -5` shows fix and test commits
    - `git branch` shows hotplug-fix-v1 checked out
  </verify>
  <done>Fork state verified, upstream remote configured</done>
</task>

<task type="auto">
  <name>Task 2: Check for focused test markers and clean if needed</name>
  <files>/tmp/kubevirt-fork/pkg/virt-controller/watch/vmi/vmi_test.go</files>
  <action>
    1. Check for focused test markers that would skip other tests:
       `grep -n "FDescribe\|FIt\|FContext" /tmp/kubevirt-fork/pkg/virt-controller/watch/vmi/vmi_test.go`

    2. If any found, remove the "F" prefix:
       - FDescribe -> Describe
       - FIt -> It
       - FContext -> Context

    3. Verify no focused markers remain:
       `grep -c "FDescribe\|FIt\|FContext" /tmp/kubevirt-fork/pkg/virt-controller/watch/vmi/vmi_test.go || echo "Clean"`

    This is a critical check - focused test markers in PRs will cause CI to run only subset of tests.
  </action>
  <verify>
    - grep returns no matches for FDescribe, FIt, FContext
    - Test file has normal Describe/It/Context markers
  </verify>
  <done>Test file clean of focused markers</done>
</task>

<task type="auto">
  <name>Task 3: Rebase on upstream main and add DCO sign-off</name>
  <files>/tmp/kubevirt-fork (git history)</files>
  <action>
    1. First, check if commits already have sign-off:
       `git log --format="%B" HEAD~2..HEAD | grep -c "Signed-off-by" || echo "0"`

    2. Rebase interactively to squash fix and test into proper commits with sign-off:
       NOTE: We need to maintain separate commits but ensure each has DCO sign-off.

       Option A - If commits already have sign-off, just rebase on main:
       ```bash
       git rebase upstream/main
       ```

       Option B - If sign-off missing, rebase with sign-off amendment:
       ```bash
       git rebase --exec 'git commit --amend --no-edit -n -s' -i upstream/main
       ```

       This adds Signed-off-by to each commit during rebase.

    3. Resolve any conflicts during rebase (unlikely for isolated fix).

    4. After rebase, verify sign-off present on all commits:
       `git log --format="%B" HEAD~2..HEAD | grep "Signed-off-by"`

    5. Force push to origin (our fork):
       `git push -f origin hotplug-fix-v1`

    IMPORTANT: The sign-off email must match a verified email on the GitHub account.
    Check with: `git config user.email`
  </action>
  <verify>
    - `git log --oneline upstream/main..HEAD` shows our commits on top of upstream main
    - Each commit has "Signed-off-by:" line visible in `git log -2 --format=full`
    - `git push -f origin hotplug-fix-v1` succeeds
  </verify>
  <done>Commits rebased on upstream main with DCO sign-off, pushed to fork</done>
</task>

</tasks>

<verification>
1. Fork at /tmp/kubevirt-fork is on hotplug-fix-v1 branch
2. Upstream remote points to kubevirt/kubevirt
3. No focused test markers (FDescribe, FIt) in test file
4. All commits have Signed-off-by line
5. Branch rebased on upstream/main
6. Changes pushed to origin (whiskey-works/kubevirt)
</verification>

<success_criteria>
- `git remote get-url upstream` returns https://github.com/kubevirt/kubevirt.git
- `grep -c "FDescribe\|FIt\|FContext" /tmp/kubevirt-fork/pkg/virt-controller/watch/vmi/vmi_test.go` returns 0 or "No such file"
- `git log --format="%B" HEAD~2..HEAD | grep -c "Signed-off-by"` returns 2 or more
- `git log --oneline upstream/main..HEAD | wc -l` returns at least 1 (our commits)
- Remote branch pushed successfully
</success_criteria>

<output>
After completion, create `.planning/phases/10-upstream-contribution/10-01-SUMMARY.md`
</output>
