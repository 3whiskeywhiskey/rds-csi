---
phase: 15-volumeattachment-based-state-rebuild
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/attachment/va_lister.go
  - pkg/attachment/va_lister_test.go
autonomous: true

must_haves:
  truths:
    - "VolumeAttachment listing filters by driver name rds.csi.srvlab.io"
    - "VolumeAttachment listing only returns attached volumes (status.attached=true)"
    - "Listing handles empty results gracefully (returns empty slice, not nil)"
  artifacts:
    - path: "pkg/attachment/va_lister.go"
      provides: "VolumeAttachment listing and filtering helpers"
      exports: ["ListDriverVolumeAttachments", "FilterAttachedVolumeAttachments"]
    - path: "pkg/attachment/va_lister_test.go"
      provides: "Unit tests for VA listing"
      contains: "TestListDriverVolumeAttachments"
  key_links:
    - from: "pkg/attachment/va_lister.go"
      to: "k8s.io/client-go/kubernetes"
      via: "StorageV1().VolumeAttachments().List"
      pattern: "StorageV1\\(\\)\\.VolumeAttachments\\(\\)\\.List"
---

<objective>
Create VolumeAttachment listing helpers that filter by driver name and attachment status.

Purpose: Foundation for VA-based state rebuild. These helpers will be used by RebuildStateFromVolumeAttachments to query Kubernetes for authoritative attachment state.

Output: pkg/attachment/va_lister.go with tested listing functions
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-volumeattachment-based-state-rebuild/15-RESEARCH.md

@pkg/attachment/manager.go
@pkg/attachment/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VolumeAttachment listing helpers</name>
  <files>pkg/attachment/va_lister.go</files>
  <action>
Create pkg/attachment/va_lister.go with:

1. ListDriverVolumeAttachments function:
   - Takes context.Context and kubernetes.Interface as parameters
   - Lists ALL VolumeAttachments using k8sClient.StorageV1().VolumeAttachments().List()
   - Filters client-side for va.Spec.Attacher == "rds.csi.srvlab.io" (driverName constant exists in rebuild.go)
   - Returns []*storagev1.VolumeAttachment and error
   - Handles empty result (return empty slice, not nil)
   - Log at V(2) level when filtering

2. FilterAttachedVolumeAttachments function:
   - Takes []*storagev1.VolumeAttachment input
   - Returns only those with va.Status.Attached == true
   - Pure function (no API calls)

3. GroupVolumeAttachmentsByVolume function:
   - Takes []*storagev1.VolumeAttachment input
   - Returns map[string][]*storagev1.VolumeAttachment (volumeID -> VAs)
   - Extracts volumeID from va.Spec.Source.PersistentVolumeName
   - Skip entries with nil PersistentVolumeName (log warning)

Import storagev1 "k8s.io/api/storage/v1" for VolumeAttachment type.
Use existing driverName constant from rebuild.go (or define locally if needed for package isolation).
  </action>
  <verify>
go build ./pkg/attachment/... compiles without errors
  </verify>
  <done>
va_lister.go exports three functions: ListDriverVolumeAttachments, FilterAttachedVolumeAttachments, GroupVolumeAttachmentsByVolume
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for VA listing helpers</name>
  <files>pkg/attachment/va_lister_test.go</files>
  <action>
Create pkg/attachment/va_lister_test.go with tests:

1. TestListDriverVolumeAttachments:
   - Use fake.NewSimpleClientset() from k8s.io/client-go/kubernetes/fake
   - Create test VolumeAttachments: 2 for our driver, 1 for different driver
   - Verify only our driver's VAs are returned
   - Verify empty result returns empty slice (not nil)

2. TestFilterAttachedVolumeAttachments:
   - Create VAs with status.attached=true and status.attached=false
   - Verify only attached VAs are returned

3. TestGroupVolumeAttachmentsByVolume:
   - Create 3 VAs: 2 for same volume (migration), 1 for different volume
   - Verify grouping returns correct map structure
   - Verify VA with nil PersistentVolumeName is skipped

Use table-driven tests where appropriate.
Create helper function createTestVolumeAttachment(name, attacher, volumeID, nodeID string, attached bool) to reduce boilerplate.
  </action>
  <verify>
go test ./pkg/attachment/... -run "TestListDriver|TestFilterAttached|TestGroup" -v passes
  </verify>
  <done>
All three VA listing functions have passing unit tests with edge cases covered
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
go build ./pkg/attachment/...

# Tests pass
go test ./pkg/attachment/... -run "VA" -v

# New file exists with expected exports
grep -E "^func (List|Filter|Group)" pkg/attachment/va_lister.go
```
</verification>

<success_criteria>
1. pkg/attachment/va_lister.go compiles and exports three functions
2. Unit tests pass for all three functions
3. Functions handle edge cases: empty input, nil PersistentVolumeName, no matching driver
</success_criteria>

<output>
After completion, create `.planning/phases/15-volumeattachment-based-state-rebuild/15-01-SUMMARY.md`
</output>
