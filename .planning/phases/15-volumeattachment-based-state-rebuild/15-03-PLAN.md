---
phase: 15-volumeattachment-based-state-rebuild
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - pkg/attachment/persist.go
autonomous: true

must_haves:
  truths:
    - "PV annotations are written for debugging but never read during rebuild"
    - "Code comments clarify annotations are informational-only"
    - "Annotation mismatch with VA state does not affect behavior"
  artifacts:
    - path: "pkg/attachment/persist.go"
      provides: "Write-through PV annotations (informational only)"
      contains: "informational"
  key_links:
    - from: "pkg/attachment/persist.go"
      to: "pkg/attachment/manager.go"
      via: "Called from TrackAttachmentWithMode"
      pattern: "persistAttachment"
---

<objective>
Document PV annotations as informational-only and add comments clarifying they are never read during rebuild.

Purpose: Clear documentation that VolumeAttachment is now source of truth. Prevents future confusion about annotation purpose.

Output: Updated persist.go with clear documentation that annotations are write-only for debugging
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-volumeattachment-based-state-rebuild/15-RESEARCH.md

@pkg/attachment/persist.go
@pkg/attachment/manager.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add informational-only documentation to persist.go</name>
  <files>pkg/attachment/persist.go</files>
  <action>
Update persist.go with clear documentation:

1. Add package-level documentation at top of file:
```go
// persist.go handles PV annotation persistence for attachment state.
//
// IMPORTANT: These annotations are INFORMATIONAL ONLY for debugging/observability.
// They are written during ControllerPublishVolume but NEVER read during state rebuild.
// VolumeAttachment objects are the authoritative source of truth for attachment state.
//
// Why write-only annotations?
// - Backward compatibility: kubectl describe pv shows attachment info
// - Debugging: Operators can see which node a volume is attached to
// - Observability: External tools may read annotations for dashboards
//
// Why NOT read during rebuild?
// - Annotations can become stale (clearing may fail, manual kubectl edits)
// - VolumeAttachment objects are managed by external-attacher (authoritative)
// - Reading annotations would contradict VolumeAttachment state
```

2. Update persistAttachment function comment:
```go
// persistAttachment writes attachment metadata to PV annotations for debugging.
// These annotations are INFORMATIONAL ONLY - they are never read during state rebuild.
// VolumeAttachment objects are the authoritative source of truth.
func (am *AttachmentManager) persistAttachment(ctx context.Context, volumeID, nodeID string) error {
```

3. Update clearAttachment function comment:
```go
// clearAttachment removes attachment annotations from a PV.
// This is called when a volume is fully detached to keep annotations accurate.
// Note: Even if clearing fails, behavior is correct because annotations are
// never read during rebuild - VolumeAttachment absence is authoritative.
func (am *AttachmentManager) clearAttachment(ctx context.Context, volumeID string) error {
```

4. Update annotation constant comments:
```go
const (
    // AnnotationAttachedNode stores the node ID for debugging/observability.
    // Informational only - never read during state rebuild.
    AnnotationAttachedNode = "rds.csi.srvlab.io/attached-node"

    // AnnotationAttachedAt stores the attachment timestamp for debugging.
    // Informational only - never read during state rebuild.
    AnnotationAttachedAt = "rds.csi.srvlab.io/attached-at"
)
```
  </action>
  <verify>
go build ./pkg/attachment/... compiles
grep -c "informational" pkg/attachment/persist.go returns >= 3
  </verify>
  <done>
persist.go clearly documents that annotations are informational-only, never read during rebuild
  </done>
</task>

<task type="auto">
  <name>Task 2: Update manager.go comments for consistency</name>
  <files>pkg/attachment/manager.go</files>
  <action>
Update comments in manager.go where persistAttachment/clearAttachment are called:

1. In TrackAttachmentWithMode, update comment:
```go
    // Persist to PV annotations for debugging/observability (informational only)
    // Note: If persistence fails, we rollback in-memory state because the
    // annotation write is part of the operation contract, even though
    // annotations are not authoritative.
    if err := am.persistAttachment(ctx, volumeID, nodeID); err != nil {
```

2. In UntrackAttachment, update comment:
```go
    // Clear PV annotations (informational only, outside of lock - I/O operation)
    // Log warning if it fails but don't fail the operation
    // (VolumeAttachment is source of truth during rebuild, not annotations)
    if err := am.clearAttachment(ctx, volumeID); err != nil {
```

3. In RemoveNodeAttachment, update comment around clearAttachment call:
```go
        // Clear PV annotations to keep them accurate for debugging
        // Note: Even if this fails, rebuild uses VolumeAttachments not annotations
        if err := am.clearAttachment(ctx, volumeID); err != nil {
```
  </action>
  <verify>
go build ./pkg/attachment/... compiles
grep "informational" pkg/attachment/manager.go returns >= 1
  </verify>
  <done>
manager.go comments clarify that annotations are informational, VA is authoritative
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
go build ./pkg/attachment/...

# Documentation present
grep -c "informational" pkg/attachment/persist.go
grep "VolumeAttachment" pkg/attachment/persist.go | head -3

# Tests still pass (no behavior change)
go test ./pkg/attachment/... -v
```
</verification>

<success_criteria>
1. persist.go has clear package-level documentation about informational-only annotations
2. All annotation-related functions have updated comments
3. manager.go comments clarify VA is authoritative
4. No behavior changes - only documentation updates
5. All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-volumeattachment-based-state-rebuild/15-03-SUMMARY.md`
</output>
