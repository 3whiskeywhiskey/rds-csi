---
phase: 15-volumeattachment-based-state-rebuild
plan: 04
type: execute
wave: 3
depends_on: ["15-02", "15-03"]
files_modified:
  - pkg/attachment/rebuild_test.go
autonomous: true

must_haves:
  truths:
    - "Controller restart rebuilds state correctly from VolumeAttachments"
    - "Stale PV annotations do not affect rebuilt state"
    - "Migration state is correctly detected from dual VolumeAttachments"
    - "Backward compatibility: volumes with stale annotations work correctly"
  artifacts:
    - path: "pkg/attachment/rebuild_test.go"
      provides: "Comprehensive tests for VA-based rebuild"
      contains: "TestRebuildStateFromVolumeAttachments"
  key_links:
    - from: "pkg/attachment/rebuild_test.go"
      to: "k8s.io/client-go/kubernetes/fake"
      via: "fake.NewSimpleClientset for testing"
      pattern: "fake\\.NewSimpleClientset"
---

<objective>
Comprehensive testing for VolumeAttachment-based state rebuild covering restart scenarios, migration detection, and stale annotation handling.

Purpose: Validate that the new VA-based rebuild correctly handles all scenarios including controller restarts, KubeVirt migrations, and backward compatibility with existing deployments that may have stale annotations.

Output: pkg/attachment/rebuild_test.go with thorough test coverage
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-volumeattachment-based-state-rebuild/15-RESEARCH.md

@pkg/attachment/rebuild.go
@pkg/attachment/va_lister.go
@pkg/attachment/manager.go
@pkg/attachment/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test basic VA-based rebuild scenarios</name>
  <files>pkg/attachment/rebuild_test.go</files>
  <action>
Create/update pkg/attachment/rebuild_test.go with tests for basic scenarios:

1. TestRebuildStateFromVolumeAttachments_SingleAttachment:
   - Create fake clientset with 1 VolumeAttachment (attached=true)
   - Create corresponding PV with AccessModes
   - Call RebuildStateFromVolumeAttachments
   - Verify attachment state exists with correct volumeID, nodeID, accessMode

2. TestRebuildStateFromVolumeAttachments_MultipleVolumes:
   - Create 3 VolumeAttachments for different volumes
   - Verify all 3 are rebuilt correctly

3. TestRebuildStateFromVolumeAttachments_NoAttachments:
   - Create fake clientset with no VolumeAttachments
   - Verify rebuild succeeds with empty state

4. TestRebuildStateFromVolumeAttachments_DetachedVA:
   - Create VA with status.attached=false
   - Verify it is NOT included in rebuilt state

5. TestRebuildStateFromVolumeAttachments_OtherDriverVA:
   - Create VA with different spec.attacher
   - Verify it is NOT included in rebuilt state

Use helper functions:
- createFakeVolumeAttachment(name, attacher, volumeID, nodeID string, attached bool) *storagev1.VolumeAttachment
- createFakePV(volumeID string, accessModes []corev1.PersistentVolumeAccessMode) *corev1.PersistentVolume
  </action>
  <verify>
go test ./pkg/attachment/... -run "TestRebuildStateFromVolumeAttachments_Single|TestRebuildStateFromVolumeAttachments_Multiple|TestRebuildStateFromVolumeAttachments_No|TestRebuildStateFromVolumeAttachments_Detached|TestRebuildStateFromVolumeAttachments_Other" -v passes
  </verify>
  <done>
Basic rebuild scenarios have passing tests covering single/multiple volumes, no VAs, detached VAs, other driver VAs
  </done>
</task>

<task type="auto">
  <name>Task 2: Test migration detection from dual VolumeAttachments</name>
  <files>pkg/attachment/rebuild_test.go</files>
  <action>
Add tests for migration state detection:

1. TestRebuildStateFromVolumeAttachments_MigrationState:
   - Create 2 VolumeAttachments for SAME volume (different nodes)
   - Create PV with ReadWriteMany access mode
   - Call rebuild
   - Verify:
     - state.Nodes has 2 entries
     - state.MigrationStartedAt is set (older VA's timestamp)
     - state.AccessMode is "RWX"

2. TestRebuildStateFromVolumeAttachments_MigrationTimestamp:
   - Create 2 VAs with different CreationTimestamps
   - Verify MigrationStartedAt equals older VA's timestamp

3. TestRebuildStateFromVolumeAttachments_MoreThanTwoVAs:
   - Create 3 VolumeAttachments for same volume (anomaly case)
   - Verify warning is logged
   - Verify only first 2 VAs are used for rebuild

4. TestRebuildStateFromVolumeAttachments_AccessModeFallback:
   - Create VA but PV does not exist
   - Verify AccessMode defaults to "RWO"
   - Verify no error (graceful handling)

Use metav1.Time with different values to test timestamp handling.
  </action>
  <verify>
go test ./pkg/attachment/... -run "TestRebuildStateFromVolumeAttachments_Migration|TestRebuildStateFromVolumeAttachments_MoreThan|TestRebuildStateFromVolumeAttachments_AccessMode" -v passes
  </verify>
  <done>
Migration state detection tests pass, including timestamp handling and edge cases
  </done>
</task>

<task type="auto">
  <name>Task 3: Test backward compatibility with stale annotations</name>
  <files>pkg/attachment/rebuild_test.go</files>
  <action>
Add tests for backward compatibility:

1. TestRebuildStateFromVolumeAttachments_IgnoresStaleAnnotations:
   - Create PV with stale attachment annotations (different node than VA)
   - Create VA pointing to correct node
   - Call rebuild
   - Verify state uses VA's node, NOT annotation's node
   - This is the key test that proves annotations are ignored

2. TestRebuildStateFromVolumeAttachments_NoVAButHasAnnotation:
   - Create PV with attachment annotations but NO VolumeAttachment
   - Call rebuild
   - Verify volume is NOT in rebuilt state
   - (Previously this would have been rebuilt from annotation - now correctly absent)

3. TestRebuildStateFromVolumeAttachments_VAAndMatchingAnnotation:
   - Create VA and PV with matching annotations
   - Verify rebuild works (happy path)

4. TestRebuildStateFromAnnotations_StillWorks:
   - Test the deprecated function still works
   - Create PV with annotations, no VA
   - Call RebuildStateFromAnnotations (deprecated)
   - Verify it rebuilds from annotations
   - (Ensures we didn't break the fallback)

Add comment: "These tests verify that VolumeAttachment is the authoritative source of truth, and PV annotations are ignored during rebuild even when they contradict VA state."
  </action>
  <verify>
go test ./pkg/attachment/... -run "TestRebuildStateFromVolumeAttachments_Ignores|TestRebuildStateFromVolumeAttachments_NoVA|TestRebuildStateFromVolumeAttachments_VAAndMatching|TestRebuildStateFromAnnotations" -v passes
  </verify>
  <done>
Backward compatibility tests pass, proving annotations are ignored and VA is authoritative
  </done>
</task>

</tasks>

<verification>
```bash
# All rebuild tests pass
go test ./pkg/attachment/... -run "Rebuild" -v

# Coverage for rebuild.go
go test ./pkg/attachment/... -coverprofile=coverage.out
go tool cover -func=coverage.out | grep rebuild.go

# All tests in package pass
go test ./pkg/attachment/... -v
```
</verification>

<success_criteria>
1. Basic rebuild scenarios tested (single/multiple volumes, edge cases)
2. Migration detection from dual VAs tested with timestamp verification
3. Stale annotation handling proven (VA wins over contradicting annotation)
4. Backward compatibility verified (deprecated function still works)
5. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-volumeattachment-based-state-rebuild/15-04-SUMMARY.md`
</output>
