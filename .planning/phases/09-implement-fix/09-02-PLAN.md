---
phase: 09-implement-fix
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - pkg/virt-controller/watch/vmi/volume-hotplug_test.go
autonomous: true

must_haves:
  truths:
    - "New unit test verifies old pod kept alive when new pod volumes not ready"
    - "New unit test verifies old pod deleted when new pod volumes are ready"
    - "All existing hotplug tests still pass"
  artifacts:
    - path: "pkg/virt-controller/watch/vmi/volume-hotplug_test.go"
      provides: "Unit tests for the fix"
      contains: "TestCleanupAttachmentPods"
  key_links:
    - from: "volume-hotplug_test.go"
      to: "cleanupAttachmentPods"
      via: "test invocation"
      pattern: "cleanupAttachmentPods|VolumeReady"
---

<objective>
Add unit tests covering the fix logic in cleanupAttachmentPods, and verify all existing hotplug unit tests still pass.

Purpose: Unit tests are required for upstream PR acceptance and verify the fix logic works correctly.

Output:
- New unit tests for the readiness-check fix
- Confirmation existing tests pass
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/milestones/v0.5-ROADMAP.md
@.planning/phases/09-implement-fix/09-01-SUMMARY.md

KubeVirt fork: https://github.com/whiskey-works/kubevirt
Branch: hotplug-fix-v1
Working directory: /tmp/kubevirt-fork

KubeVirt uses Ginkgo/Gomega for testing. Follow existing test patterns.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for the fix</name>
  <files>
    pkg/virt-controller/watch/vmi/volume-hotplug_test.go
  </files>
  <action>
1. Navigate to the fork and ensure on the fix branch:
   ```bash
   cd /tmp/kubevirt-fork
   git checkout hotplug-fix-v1
   ```

2. Read the existing test file to understand patterns:
   - pkg/virt-controller/watch/vmi/volume-hotplug_test.go
   - Look for how VolumeStatus is mocked
   - Look for how attachment pods are created in tests

3. Add test cases for the fix (using Ginkgo/Gomega patterns):

   **Test Case 1: Old pod NOT deleted when new pod volumes not ready (BUG REPRODUCTION + FIX)**
   - This test reproduces the original bug: it would FAIL on unpatched KubeVirt (old pod deleted prematurely) and PASS with our fix
   - Setup: VMI with 2 volumes, VolumeStatus for vol1 = VolumeReady, vol2 = VolumePending
   - Setup: Old attachment pod exists with vol1, new pod exists with vol1+vol2
   - Action: Call cleanupAttachmentPods
   - Assert: Old pod NOT deleted (still exists in client)
   - Note: This satisfies KVFIX-02 "Create test case that reliably reproduces the issue"

   **Test Case 2: Old pod deleted when all new pod volumes ready**
   - Setup: VMI with 2 volumes, both VolumeStatus = VolumeReady
   - Setup: Old attachment pod with vol1, new pod with vol1+vol2
   - Action: Call cleanupAttachmentPods
   - Assert: Old pod IS deleted

   **Test Case 3: Single volume hotplug still works (regression test)**
   - Setup: VMI with 1 volume, VolumeStatus = VolumeReady
   - Setup: Only one attachment pod (no old pod)
   - Action: Call cleanupAttachmentPods
   - Assert: No error, no unexpected deletions

   **Test Case 4: Volume removal still works (regression test)**
   - Setup: VMI with 1 volume remaining, 1 volume being removed
   - Setup: Old pod has 2 volumes, new pod has 1 volume
   - Action: Verify removal path is not affected
   - Assert: Removal proceeds correctly

4. Follow existing test patterns exactly:
   - Use BeforeEach for setup
   - Use It() blocks for each test case
   - Use Gomega matchers (Expect, BeNil, HaveLen, etc.)
   - Mock the Kubernetes client appropriately

5. Commit the tests:
   ```bash
   git add pkg/virt-controller/watch/vmi/volume-hotplug_test.go
   git commit -m "test(hotplug): add unit tests for volume readiness check

   Tests verify that cleanupAttachmentPods:
   - Keeps old pod alive when new pod volumes not ready
   - Deletes old pod when all new pod volumes are ready
   - Does not regress single-volume hotplug
   - Does not regress volume removal"
   ```
  </action>
  <verify>
    - New test cases exist in volume-hotplug_test.go
    - Tests follow Ginkgo/Gomega patterns
    - Commit exists on hotplug-fix-v1 branch
  </verify>
  <done>
    Unit tests for the fix are committed, covering both the fix and regression scenarios
  </done>
</task>

<task type="auto">
  <name>Task 2: Run hotplug unit tests and verify pass</name>
  <files>
    pkg/virt-controller/watch/vmi/volume-hotplug_test.go
  </files>
  <action>
1. Run the unit tests for the hotplug package:
   ```bash
   cd /tmp/kubevirt-fork

   # KubeVirt uses Bazel, but we can also run go test directly for unit tests
   # First, try go test
   go test -v ./pkg/virt-controller/watch/vmi/... -run "Hotplug|hotplug" 2>&1 | head -100

   # If that fails due to dependencies, try:
   # make test-unit WHAT=./pkg/virt-controller/watch/vmi/...
   ```

2. If tests fail:
   - Read the failure messages carefully
   - Fix any issues in the test code or the fix itself
   - Re-run until tests pass

3. Verify no regressions:
   - All existing hotplug tests should still pass
   - New tests should pass

4. If Bazel is required and complex, document what commands would run the tests and mark as "tests written, run pending CI"

5. Push the branch to enable CI:
   ```bash
   git push origin hotplug-fix-v1
   ```
  </action>
  <verify>
    - go test or bazel test command executed
    - Test results show all tests passing (or documented for CI)
    - Branch pushed to origin
  </verify>
  <done>
    All hotplug unit tests pass including new tests, branch pushed for CI verification
  </done>
</task>

</tasks>

<verification>
1. New test cases exist for the readiness check logic
2. Tests cover: not-ready blocks delete, ready allows delete, single-volume works, removal works
3. All tests pass (or documented for CI if local run not feasible)
4. Branch pushed to remote
</verification>

<success_criteria>
- volume-hotplug_test.go has new test cases for the fix
- Tests follow existing Ginkgo/Gomega patterns
- No test regressions
- Branch pushed to origin/hotplug-fix-v1
</success_criteria>

<output>
After completion, create `.planning/phases/09-implement-fix/09-02-SUMMARY.md`
</output>
