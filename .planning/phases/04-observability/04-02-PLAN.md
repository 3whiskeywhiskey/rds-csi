---
phase: 04-observability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/observability/prometheus.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Prometheus metrics are defined with proper namespace and labels"
    - "Metrics cover volume operations, NVMe connections, mounts, stale mounts, and orphan cleanup"
    - "Handler() method returns http.Handler for metrics endpoint"
  artifacts:
    - path: "pkg/observability/prometheus.go"
      provides: "Prometheus metrics registry with CSI-specific metrics"
      exports: ["NewMetrics", "Metrics", "Handler"]
      min_lines: 150
    - path: "go.mod"
      provides: "prometheus/client_golang dependency"
      contains: "github.com/prometheus/client_golang"
  key_links:
    - from: "pkg/observability/prometheus.go"
      to: "prometheus.NewRegistry()"
      via: "registry creation"
      pattern: "prometheus\\.NewRegistry"
    - from: "pkg/observability/prometheus.go"
      to: "promhttp.HandlerFor"
      via: "HTTP handler"
      pattern: "promhttp\\.HandlerFor"
---

<objective>
Create Prometheus metrics package with CSI-specific metrics for volume operations, NVMe connections, mounts, and health tracking.

Purpose: Enable operators to monitor driver behavior, diagnose issues, and set up alerts via Prometheus/Grafana.
Output: New pkg/observability/prometheus.go with complete metrics definitions and HTTP handler.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-observability/04-RESEARCH.md
@pkg/security/metrics.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prometheus/client_golang dependency</name>
  <files>go.mod, go.sum</files>
  <action>
Add the Prometheus Go client library to the project:

```bash
go get github.com/prometheus/client_golang/prometheus
go get github.com/prometheus/client_golang/prometheus/promhttp
```

This adds:
- prometheus package for Counter, Gauge, Histogram, CounterVec, etc.
- promhttp package for HTTP handler to serve /metrics endpoint

Version should be v1.20.0+ (latest stable).
  </action>
  <verify>Run `go mod tidy && go build ./...` to verify dependency is resolved.</verify>
  <done>go.mod includes github.com/prometheus/client_golang as a dependency.</done>
</task>

<task type="auto">
  <name>Task 2: Create Prometheus metrics package</name>
  <files>pkg/observability/prometheus.go</files>
  <action>
Create new file pkg/observability/prometheus.go with:

1. Package declaration: `package observability`

2. Constants:
   - namespace = "rds_csi" (prefix for all metrics)

3. Metrics struct with all collectors:
   - volumeOpsTotal (*prometheus.CounterVec) - labels: operation, status
   - volumeOpsDuration (*prometheus.HistogramVec) - labels: operation
   - nvmeConnectsTotal (*prometheus.CounterVec) - labels: status
   - nvmeConnectDuration (prometheus.Histogram)
   - nvmeConnectionsActive (prometheus.Gauge)
   - mountOpsTotal (*prometheus.CounterVec) - labels: operation, status
   - staleMountsDetectedTotal (prometheus.Counter)
   - staleRecoveriesTotal (*prometheus.CounterVec) - labels: status
   - orphansCleanedTotal (prometheus.Counter)
   - eventsPostedTotal (*prometheus.CounterVec) - labels: reason

4. NewMetrics() *Metrics function:
   - Creates new prometheus.Registry() (NOT DefaultRegistry to avoid panic on restart)
   - Creates and registers all metrics with proper Opts (Namespace, Name, Help, Buckets for histograms)
   - Returns Metrics struct

5. Handler() http.Handler method:
   - Returns promhttp.HandlerFor(m.registry, promhttp.HandlerOpts{EnableOpenMetrics: true})

6. Recording methods:
   - RecordVolumeOp(operation string, err error, duration time.Duration)
   - RecordNVMeConnect(err error, duration time.Duration)
   - RecordNVMeDisconnect()
   - RecordMountOp(operation string, err error)
   - RecordStaleMountDetected()
   - RecordStaleRecovery(err error)
   - RecordOrphanCleaned()
   - RecordEventPosted(reason string)

Follow patterns from RESEARCH.md "Complete Prometheus Metrics Setup" code example.

Metric naming conventions:
- Counters end in _total
- Histograms end in _seconds
- Use snake_case
- Use namespace prefix (rds_csi_)

Histogram buckets for duration metrics: []float64{0.1, 0.25, 0.5, 1, 2.5, 5, 10, 30, 60}
  </action>
  <verify>
1. Run `go build ./pkg/observability/...` to verify compilation
2. Check imports are correct: `go vet ./pkg/observability/...`
  </verify>
  <done>pkg/observability/prometheus.go exists with complete Metrics struct, NewMetrics constructor, Handler method, and all recording methods.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles successfully
2. `go vet ./pkg/observability/...` reports no issues
3. Verify metrics are defined: `grep -c "prometheus.New" pkg/observability/prometheus.go` shows 10+ occurrences
4. Verify namespace: `grep "rds_csi" pkg/observability/prometheus.go` confirms namespace usage
</verification>

<success_criteria>
- prometheus/client_golang added to go.mod
- pkg/observability/prometheus.go created with all metrics
- All metrics use rds_csi_ namespace
- Handler() method returns valid http.Handler
- Code compiles and passes vet
</success_criteria>

<output>
After completion, create `.planning/phases/04-observability/04-02-SUMMARY.md`
</output>
