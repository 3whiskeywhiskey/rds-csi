---
phase: 04-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/driver.go
  - pkg/driver/node.go
autonomous: true

must_haves:
  truths:
    - "Driver declares GET_VOLUME_STATS and VOLUME_CONDITION node service capabilities"
    - "NodeGetVolumeStats always returns VolumeCondition (healthy or unhealthy)"
    - "Kubelet can query volume health via NodeGetVolumeStats"
  artifacts:
    - path: "pkg/driver/driver.go"
      provides: "Node service capabilities including GET_VOLUME_STATS and VOLUME_CONDITION"
      contains: "NodeServiceCapability_RPC_GET_VOLUME_STATS"
    - path: "pkg/driver/node.go"
      provides: "NodeGetVolumeStats with VolumeCondition always returned"
      contains: "VolumeCondition{"
  key_links:
    - from: "pkg/driver/driver.go"
      to: "csi.NodeServiceCapability_RPC_VOLUME_CONDITION"
      via: "capability declaration"
      pattern: "VOLUME_CONDITION"
    - from: "pkg/driver/node.go"
      to: "VolumeCondition"
      via: "response construction"
      pattern: "Abnormal:\\s*(true|false)"
---

<objective>
Add CSI node service capabilities for volume health reporting and ensure NodeGetVolumeStats always returns VolumeCondition.

Purpose: Enable Kubelet to monitor volume health status and detect unhealthy volumes proactively.
Output: Updated driver.go with GET_VOLUME_STATS and VOLUME_CONDITION capabilities, updated node.go with always-present VolumeCondition in NodeGetVolumeStats response.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-observability/04-RESEARCH.md
@pkg/driver/driver.go
@pkg/driver/node.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GET_VOLUME_STATS and VOLUME_CONDITION capabilities</name>
  <files>pkg/driver/driver.go</files>
  <action>
Update the addNodeServiceCapabilities() function to declare two additional capabilities:

1. NodeServiceCapability_RPC_GET_VOLUME_STATS - enables volume stats reporting
2. NodeServiceCapability_RPC_VOLUME_CONDITION - enables VolumeCondition in responses

Add these after the existing STAGE_UNSTAGE_VOLUME and EXPAND_VOLUME capabilities:

```go
{
    Type: &csi.NodeServiceCapability_Rpc{
        Rpc: &csi.NodeServiceCapability_RPC{
            Type: csi.NodeServiceCapability_RPC_GET_VOLUME_STATS,
        },
    },
},
{
    Type: &csi.NodeServiceCapability_Rpc{
        Rpc: &csi.NodeServiceCapability_RPC{
            Type: csi.NodeServiceCapability_RPC_VOLUME_CONDITION,
        },
    },
},
```

Note: These capabilities are defined in CSI spec v1.3+ which we have (v1.10.0 in go.mod).
  </action>
  <verify>Run `go build ./...` to verify the code compiles with the new capabilities.</verify>
  <done>driver.go declares GET_VOLUME_STATS and VOLUME_CONDITION capabilities in nscaps slice.</done>
</task>

<task type="auto">
  <name>Task 2: Update NodeGetVolumeStats to always return VolumeCondition</name>
  <files>pkg/driver/node.go</files>
  <action>
Modify NodeGetVolumeStats to ALWAYS return VolumeCondition in the response, even for healthy volumes.

Currently the function:
- Returns VolumeCondition{Abnormal: true, Message: ...} only when stale mount detected
- Returns no VolumeCondition when volume is healthy (lines 463-478)

Update to:
1. Always construct a VolumeCondition at the end of the function
2. For healthy volumes: VolumeCondition{Abnormal: false, Message: "Volume is healthy"}
3. For stale mounts: VolumeCondition{Abnormal: true, Message: "Stale mount detected: [reason]"} (already exists)
4. For check errors: VolumeCondition{Abnormal: false, Message: "Health check inconclusive: [error]"}

Key changes:
- Remove the early return on stale mount (lines 447-454)
- Track stale/healthy status and reason
- Construct VolumeCondition before returning the response
- Always include VolumeCondition in the final response

Follow pattern from RESEARCH.md Pattern 2: NodeGetVolumeStats with VolumeCondition.
  </action>
  <verify>
1. Run `go build ./...` to verify compilation
2. Run `go test ./pkg/driver/... -v` to verify existing tests pass
  </verify>
  <done>NodeGetVolumeStats always returns VolumeCondition field in response, with Abnormal=false for healthy volumes and Abnormal=true for unhealthy volumes.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles successfully
2. `go test ./pkg/driver/... -v` passes all tests
3. Verify capabilities with grep: `grep -n "RPC_GET_VOLUME_STATS\|RPC_VOLUME_CONDITION" pkg/driver/driver.go`
4. Verify VolumeCondition always returned: `grep -n "VolumeCondition{" pkg/driver/node.go` shows multiple occurrences
</verification>

<success_criteria>
- driver.go declares GET_VOLUME_STATS and VOLUME_CONDITION in node service capabilities
- NodeGetVolumeStats returns VolumeCondition in ALL responses (healthy or not)
- All existing tests pass
- Code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-observability/04-01-SUMMARY.md`
</output>
