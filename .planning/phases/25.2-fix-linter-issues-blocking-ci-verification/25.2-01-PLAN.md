---
phase: 25.2-fix-linter-issues-blocking-ci-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .golangci.yml
  - pkg/driver/controller_test.go
  - pkg/driver/vmi_grouper.go
  - pkg/mount/procmounts.go
  - pkg/rds/connection_manager.go
  - pkg/utils/volumeid.go
  - test/e2e/helpers.go
autonomous: true

must_haves:
  truths:
    - "golangci-lint v2 config passes schema validation (golangci-lint config verify exits 0)"
    - "Linter settings (thresholds, exclusions) are applied correctly by golangci-lint v2"
    - "errcheck exclusion for _test.go files suppresses all 63 test errcheck violations (0 errcheck issues in lint output)"
    - "All 8 staticcheck issues are resolved in source code"
    - "make lint reports 0 issues"
  artifacts:
    - path: ".golangci.yml"
      provides: "Valid golangci-lint v2 configuration"
      contains: 'version: "2"'
    - path: "pkg/rds/connection_manager.go"
      provides: "Fixed error string capitalization (ST1005)"
    - path: "pkg/mount/procmounts.go"
      provides: "Fixed error string punctuation (ST1005)"
    - path: "pkg/utils/volumeid.go"
      provides: "Applied De Morgan's law (QF1001)"
    - path: "pkg/driver/vmi_grouper.go"
      provides: "Removed embedded field selectors (QF1008)"
  key_links:
    - from: ".golangci.yml"
      to: "golangci-lint v2 engine"
      via: "v2 config schema (version string, linters.settings, linters.exclusions)"
      pattern: 'version: "2"'
    - from: ".golangci.yml linters.exclusions.rules"
      to: "errcheck linter"
      via: "test file exclusion rule suppresses 63 errcheck violations in _test.go"
      pattern: "path.*_test\\.go.*errcheck"
---

<objective>
Fix the golangci-lint v2 configuration format and resolve all 8 staticcheck code issues to bring lint violations from 134 to 0.

Purpose: The golangci-lint v2 upgrade in Phase 25.1 left the config in a broken state -- `linters-settings`, `issues.exclude-rules`, and `version: 2` (number) are all v1 format that v2 silently ignores. This causes settings (complexity thresholds of 50) and exclusions (test file errcheck) to not apply, inflating the issue count from ~8 real issues to 134. Fixing the config format restores intended behavior, and the 8 staticcheck issues need simple mechanical code fixes.

Output: Valid v2 config, 0 lint issues from `make lint`
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25.2-fix-linter-issues-blocking-ci-verification/25.2-RESEARCH.md
@.golangci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix golangci-lint v2 configuration format</name>
  <files>.golangci.yml</files>
  <action>
Rewrite `.golangci.yml` to use proper golangci-lint v2 format. The current config has three structural issues that cause v2 to silently ignore settings:

1. **version field**: Change `version: 2` (number) to `version: "2"` (string)
2. **linters-settings**: Move entire `linters-settings:` block into `linters.settings:` (nested under `linters:`)
3. **issues.exclude-rules**: Move `issues.exclude-rules` to `linters.exclusions.rules` (nested under `linters:`)
4. **linters.default**: Add `default: none` under `linters:` since we explicitly list all enabled linters

The rewritten config must preserve all current settings and thresholds:
- errcheck: check-type-assertions true, exclude-functions for io.Closer.Close and os.File.Close
- errorlint: errorf true, comparison true, asserts true
- gocyclo: min-complexity 50 (current baseline, ratchet later)
- cyclop: max-complexity 50, skip-tests false
- Test file exclusions: errcheck excluded for _test.go, errorlint non-wrapping excluded for _test.go, errorlint type assertion excluded for test/mock/
- issues: max-issues-per-linter 0, max-same-issues 0

Also add an exclusion for ST1001 (dot imports) in test/e2e/ files since Ginkgo/Gomega use dot imports by convention.

Additionally, add `generated: lax` under `linters.exclusions` to skip generated code.

Remove the `run.timeout` field (v2 disables timeout by default).

After writing the config, run `golangci-lint config verify` to confirm schema validation passes.

**Critical: Verify errcheck exclusion works.** After config migration, explicitly confirm the errcheck exclusion for _test.go files is effective:
1. Run `golangci-lint run --enable errcheck 2>&1 | grep -c errcheck` and confirm the count is 0 (or only non-test files).
2. If errcheck violations still appear in _test.go files, the exclusion syntax is wrong. **Fallback:** Check the v2 exclusion format -- in v2, `linters.exclusions.rules` uses `path-except` / `path` with `linters: [errcheck]`. Try alternative syntax: `paths: ["_test\\.go"]` under the rule. If still failing, use `exclude-functions` to add specific test cleanup functions (os.RemoveAll, os.MkdirAll, os.Remove, os.Unsetenv) to the errcheck exclude-functions list as a last resort.
3. Do not proceed to Task 2 until errcheck test violations are confirmed suppressed.
  </action>
  <verify>
Run: `golangci-lint config verify` -- must exit 0 with no schema errors.
Run: `golangci-lint run 2>&1 | grep -c errcheck` -- must be 0 (errcheck exclusion for test files is working).
Run: `make lint 2>&1 | tail -20` -- should show only staticcheck issues (no cyclop, gocyclo, or errcheck test violations).
  </verify>
  <done>golangci-lint config verify passes, errcheck exclusion confirmed working (0 errcheck violations in output), lint output shows only ~8 staticcheck issues (not 134)</done>
</task>

<task type="auto">
  <name>Task 2: Fix all 8 staticcheck code issues</name>
  <files>pkg/driver/controller_test.go, pkg/driver/vmi_grouper.go, pkg/mount/procmounts.go, pkg/rds/connection_manager.go, pkg/utils/volumeid.go</files>
  <action>
Fix the 8 staticcheck violations. These are all mechanical, single-line fixes:

**ST1005 - Error string formatting (3 fixes):**
1. `pkg/rds/connection_manager.go:59` - Change `fmt.Errorf("Client is required")` to `fmt.Errorf("client is required")` (lowercase per Go convention)
2. `pkg/mount/procmounts.go:184` - Remove trailing period/punctuation from error string that ends with `. ` or similar punctuation
3. `pkg/mount/procmounts.go:203` - Same: remove trailing punctuation from error string

**QF1008 - Embedded field selector (2 fixes):**
4. `pkg/driver/vmi_grouper.go:169` - Change `pod.ObjectMeta.OwnerReferences` to `pod.OwnerReferences`
5. `pkg/driver/vmi_grouper.go:185` - Change `pod.ObjectMeta.OwnerReferences` to `pod.OwnerReferences`

**QF1004 - strings.ReplaceAll (1 fix):**
6. `pkg/driver/controller_test.go:2207` - Change `strings.Replace(tt.name, " ", "-", -1)` to `strings.ReplaceAll(tt.name, " ", "-")`

**QF1001 - De Morgan's law (1 fix):**
7. `pkg/utils/volumeid.go:213` - Apply De Morgan's law to simplify the boolean expression. Change `!((ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z') || ...)` to the equivalent form using De Morgan's law: `(ch < 'a' || ch > 'z') && (ch < 'A' || ch > 'Z') && ...`

**ST1001 - Dot imports (handled by exclusion):**
8. `test/e2e/helpers.go:8` - This is a Ginkgo/Gomega convention. Handled by adding an exclusion rule in Task 1 rather than changing code.

Read each file before editing. Make minimal, targeted changes to fix only the flagged lines.
  </action>
  <verify>
Run: `make lint` -- must exit 0 with "0 issues" or no issue output.
Run: `make test` -- must pass (no regressions from code changes).
  </verify>
  <done>All 8 staticcheck violations resolved, `make lint` shows 0 issues, tests pass</done>
</task>

</tasks>

<verification>
1. `golangci-lint config verify` exits 0 (valid v2 config)
2. `make lint` exits 0 with 0 issues
3. `make test` passes (no regressions)
4. `make build-local` succeeds (code still compiles)
</verification>

<success_criteria>
- golangci-lint v2 config is valid and applies all settings/exclusions correctly
- All 134 originally reported lint issues are resolved (126 via config fix, 8 via code fix)
- No new lint issues introduced
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/25.2-fix-linter-issues-blocking-ci-verification/25.2-01-SUMMARY.md`
</output>
