---
phase: 25.2-fix-linter-issues-blocking-ci-verification
plan: 01
subsystem: infra
tags: [golangci-lint, staticcheck, ci, code-quality]

# Dependency graph
requires:
  - phase: 25.1-attachment-reconciliation-rds-resilience
    provides: golangci-lint v2 upgrade that exposed configuration issues
provides:
  - Valid golangci-lint v2 configuration with proper schema format
  - Clean codebase with 0 linter violations (down from 134)
  - Working CI linter checks for future PRs
affects: [26-volume-snapshots, all-future-phases]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - golangci-lint v2 config structure (linters.settings, linters.exclusions.rules)
    - Go error string conventions (lowercase, no trailing punctuation)

key-files:
  created: []
  modified:
    - .golangci.yml
    - pkg/rds/connection_manager.go
    - pkg/rds/connection_manager_test.go
    - pkg/mount/procmounts.go
    - pkg/driver/vmi_grouper.go
    - pkg/driver/controller_test.go
    - pkg/utils/volumeid.go

key-decisions:
  - "Use golangci-lint v2 string version field (version: \"2\") instead of numeric"
  - "Migrate linters-settings to linters.settings and exclude-rules to linters.exclusions.rules per v2 schema"
  - "Exclude ST1001 (dot imports) for test/e2e/ files (Ginkgo/Gomega convention)"
  - "Apply Go error string conventions (lowercase start, no trailing punctuation)"

patterns-established:
  - "golangci-lint v2 configuration schema: version as string, settings nested under linters"
  - "Exclusion rules use linters.exclusions.rules with path patterns"
  - "Test file exclusions use path regex (_test\\.go) instead of individual suppressions"

# Metrics
duration: 6min
completed: 2026-02-05
---

# Phase 25.2 Plan 01: Fix Linter Configuration and Code Issues Summary

**golangci-lint v2 config migrated to proper schema format, reducing linter violations from 134 to 0 by fixing config structure and 7 staticcheck code issues**

## Performance

- **Duration:** 6 minutes
- **Started:** 2026-02-05T21:33:32Z
- **Completed:** 2026-02-05T21:40:17Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Migrated .golangci.yml to valid golangci-lint v2 schema format (version string, nested settings/exclusions)
- Eliminated 126 false-positive lint violations caused by ignored config settings (complexity thresholds, test file exclusions)
- Fixed 7 staticcheck code quality issues (error strings, embedded field selectors, simplified boolean logic)
- Restored CI linter checks to working state (0 issues, full enforcement enabled)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix golangci-lint v2 configuration format** - `35b3fb0` (fix)
2. **Task 2: Fix all 7 staticcheck code issues** - `c74678d` (fix)

## Files Created/Modified
- `.golangci.yml` - Migrated to v2 schema: version string, linters.settings, linters.exclusions.rules, added ST1001 exclusion for e2e tests
- `pkg/rds/connection_manager.go` - Fixed ST1005: lowercase error message "client is required"
- `pkg/rds/connection_manager_test.go` - Updated test expectation to match corrected error message
- `pkg/mount/procmounts.go` - Fixed ST1005: removed trailing punctuation from 2 error strings (lines 184, 203)
- `pkg/driver/vmi_grouper.go` - Fixed QF1008: removed embedded ObjectMeta field selector (2 occurrences)
- `pkg/driver/controller_test.go` - Fixed QF1004: replaced strings.Replace with strings.ReplaceAll
- `pkg/utils/volumeid.go` - Fixed QF1001: applied De Morgan's law to simplify boolean validation logic

## Decisions Made

1. **Version field must be string:** Changed `version: 2` to `version: "2"` - v2 requires string format per schema validation
2. **Nested settings structure:** Moved top-level `linters-settings` to `linters.settings` - v2 uses nested structure for all linter config
3. **Nested exclusions structure:** Moved `issues.exclude-rules` to `linters.exclusions.rules` - v2 consolidates exclusions under linters block
4. **Explicit linter selection:** Added `linters.default: none` since we explicitly list enabled linters (prevents implicit additions)
5. **Generated code exclusion:** Added `linters.exclusions.generated: lax` to skip generated files automatically
6. **Ginkgo/Gomega convention:** Excluded ST1001 (dot imports) for test/e2e/ files - dot imports are idiomatic for BDD-style tests
7. **Removed invalid settings:** Dropped `cyclop.skip-tests` (not valid in v2) and `goimports` settings (linter not enabled)
8. **Error message test update:** Updated connection_manager_test.go to match corrected lowercase error message (maintains test coverage)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Test failure after error message fix**
- **Found during:** Task 2 verification (make test)
- **Issue:** TestNewConnectionManager_RequiresClient expected "Client is required" but code now returns "client is required" (lowercase per ST1005)
- **Fix:** Updated test expectation in pkg/rds/connection_manager_test.go:51 to match corrected error format
- **Files modified:** pkg/rds/connection_manager_test.go
- **Verification:** go test passes for pkg/rds
- **Committed in:** c74678d (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Test update required to maintain test coverage after applying staticcheck fix. No scope creep.

## Issues Encountered

**Config validation failures during migration:**
- First attempt used `cyclop.skip-tests: false` (not valid in v2 schema)
- First attempt included `goimports.local-prefixes` (linter not in enabled list)
- Resolution: Removed invalid fields, ran `golangci-lint config verify` after each change
- Verification: Config validates cleanly, all settings apply correctly

**Error message test mismatch:**
- ST1005 fix changed error capitalization, breaking test assertion
- Resolution: Updated test to match new lowercase convention (standard Go practice)
- Verification: All tests pass, error message correctness preserved

## Next Phase Readiness

**CI/CD unblocked:**
- golangci-lint v2 configuration valid and functional
- All 134 linter violations resolved (126 via config, 7 via code fixes, 1 via exclusion)
- `make lint` returns 0 issues, enabling enforcement on future PRs
- CI verification pipeline ready for Phase 26 (Volume Snapshots) and beyond

**Code quality baseline:**
- Error strings follow Go conventions (lowercase, no trailing punctuation)
- Simplified boolean logic per staticcheck recommendations
- Embedded field selectors removed for cleaner code
- Complexity thresholds (50) properly enforced by v2 config

**No blockers.** Ready to proceed with Phase 26.

---
*Phase: 25.2-fix-linter-issues-blocking-ci-verification*
*Completed: 2026-02-05*
