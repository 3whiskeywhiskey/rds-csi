# Phase 25.2: Fix Linter Issues Blocking CI Verification - Research

**Researched:** 2026-02-05
**Domain:** Go code quality, linter compliance, cyclomatic complexity refactoring
**Confidence:** HIGH

## Summary

Phase 25.2 addresses 134 pre-existing code quality issues exposed by the golangci-lint v2 upgrade in Phase 25.1. The migration from v1 to v2 configuration removed the test file exclusion rule for errcheck, revealing technical debt that blocks CI/CD pipeline verification.

The issues break down into four categories: 63 errcheck violations (unchecked error returns, primarily in test cleanup code), 56 cyclop violations (functions exceeding complexity 10 threshold), 7 gocyclo violations (functions exceeding complexity 30 threshold), and 8 staticcheck style violations (error string formatting, simplification opportunities).

The standard approach combines targeted fixes with strategic threshold adjustments. For errcheck: use `t.Cleanup()` for test resource cleanup (Go 1.14+ pattern) or explicit `_ = os.RemoveAll()` when intentionally ignoring errors. For complexity: extract helper methods to reduce CSI RPC handlers (CreateVolume: 24→≤10, ControllerPublishVolume: 48→≤30), refactor validation logic into separate functions, and justify keeping test complexity higher than production code. For staticcheck: apply automated fixes (strings.ReplaceAll, De Morgan simplifications) and follow Go error string conventions (lowercase, no punctuation).

**Primary recommendation:** Fix all errcheck violations using t.Cleanup() pattern for test cleanup; refactor high-complexity CSI RPC handlers (CreateVolume, ControllerPublishVolume, NodeStageVolume, NodeUnstageVolume) by extracting validation and error handling into helper methods; apply staticcheck auto-fixes for QF rules; adjust cyclop threshold to 15 for production code with justification that Go's explicit error handling inflates complexity scores while maintaining readability; set test file cyclop threshold to 20 acknowledging table-driven test patterns.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| golangci-lint | v2.1.5 | Multi-linter aggregator | Industry standard Go linter supporting 60+ linters, v2 uses YAML schema validation |
| errcheck | v1.7.0 | Unchecked error detector | Official Go team recommended linter, prevents silent error drops |
| gocyclo | v0.8.0 | Cyclomatic complexity | Standard McCabe complexity calculator for Go |
| cyclop | v1.2.1 | Package/function complexity | More granular than gocyclo, supports per-linter thresholds |
| staticcheck | 2024.1.1 | Static analysis suite | Official Go static analysis tool, covers style and correctness |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| testing | stdlib | Test infrastructure | Use t.Cleanup() for resource cleanup (Go 1.14+) |
| gofmt | stdlib | Code formatting | Already integrated in `make verify` |
| govet | stdlib | Suspicious construct detection | Already integrated in `make verify` |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Fixing complexity | Disabling cyclop/gocyclo | Technical debt accumulates, future refactoring harder |
| t.Cleanup() | defer with error check | t.Cleanup() works with panics, cleaner for test helpers |
| Threshold adjustment | Fix all violations | Some high complexity is justified (CSI spec compliance, table-driven tests) |
| Manual fixes | Automated refactoring tools | Manual provides context-aware improvements vs mechanical changes |

**Installation:**
```bash
# Already in go.mod and Makefile
make install-tools  # Installs golangci-lint v2.1.5
```

## Architecture Patterns

### Recommended Project Structure
```
.golangci.yml            # Linter configuration
pkg/
├── driver/
│   ├── controller.go         # High complexity: extract validation helpers
│   ├── node.go               # High complexity: extract staging helpers
│   ├── controller_test.go    # Errcheck violations: use t.Cleanup()
│   ├── node_test.go          # Errcheck violations: use t.Cleanup()
├── mount/
│   ├── procmounts.go         # ST1005: fix error string punctuation
├── rds/
│   ├── connection_manager.go # ST1005: fix error string capitalization
├── utils/
│   ├── volumeid.go           # QF1001: apply De Morgan's law
test/
├── e2e/
│   ├── helpers.go            # ST1001: remove dot import
```

### Pattern 1: Test Cleanup with t.Cleanup()
**What:** Use `t.Cleanup()` for resource cleanup instead of `defer os.RemoveAll()`
**When to use:** Test resource cleanup (temp directories, connections, mocks)
**Example:**
```go
// Source: Go 1.14+ testing patterns
// https://pkg.go.dev/testing#T.Cleanup

// BEFORE (errcheck violation):
func TestNodeStageVolume(t *testing.T) {
    tmpDir, _ := os.MkdirTemp("", "test")
    defer os.RemoveAll(tmpDir)  // errcheck: unchecked error
    // test code...
}

// AFTER (compliant):
func TestNodeStageVolume(t *testing.T) {
    tmpDir, err := os.MkdirTemp("", "test")
    require.NoError(t, err)
    t.Cleanup(func() {
        if err := os.RemoveAll(tmpDir); err != nil {
            t.Logf("cleanup failed: %v", err)
        }
    })
    // test code...
}
```

### Pattern 2: Extract Validation Helper
**What:** Reduce complexity by extracting validation logic into separate functions
**When to use:** CSI RPC handlers with complexity >10
**Example:**
```go
// Source: CSI driver patterns from Kubernetes community
// https://github.com/kubernetes-csi/csi-driver-host-path

// BEFORE (complexity 24):
func (cs *ControllerServer) CreateVolume(ctx context.Context, req *csi.CreateVolumeRequest) (*csi.CreateVolumeResponse, error) {
    if req.GetName() == "" {
        return nil, status.Error(codes.InvalidArgument, "volume name is required")
    }
    if req.GetVolumeCapabilities() == nil || len(req.GetVolumeCapabilities()) == 0 {
        return nil, status.Error(codes.InvalidArgument, "volume capabilities are required")
    }
    if err := cs.validateVolumeCapabilities(req.GetVolumeCapabilities()); err != nil {
        return nil, status.Errorf(codes.InvalidArgument, "invalid volume capabilities: %v", err)
    }
    requiredBytes := req.GetCapacityRange().GetRequiredBytes()
    if requiredBytes == 0 {
        requiredBytes = minVolumeSizeBytes
    }
    // ... 100 more lines
}

// AFTER (complexity ≤10):
func (cs *ControllerServer) CreateVolume(ctx context.Context, req *csi.CreateVolumeRequest) (*csi.CreateVolumeResponse, error) {
    if err := validateCreateVolumeRequest(req); err != nil {
        return nil, err
    }

    volumeID, requiredBytes := cs.computeVolumeParams(req)

    if existingVolume, err := cs.checkExistingVolume(volumeID); err == nil {
        return cs.handleIdempotentCreate(existingVolume, requiredBytes)
    }

    return cs.createNewVolume(ctx, volumeID, requiredBytes, req)
}

func validateCreateVolumeRequest(req *csi.CreateVolumeRequest) error {
    if req.GetName() == "" {
        return status.Error(codes.InvalidArgument, "volume name is required")
    }
    if req.GetVolumeCapabilities() == nil || len(req.GetVolumeCapabilities()) == 0 {
        return status.Error(codes.InvalidArgument, "volume capabilities are required")
    }
    return nil
}
```

### Pattern 3: Staticcheck Auto-Fixes
**What:** Apply staticcheck quick-fix suggestions for code simplification
**When to use:** QF (quick-fix) violations that don't change behavior
**Example:**
```go
// Source: staticcheck QF rules
// https://staticcheck.dev/docs/checks/

// QF1004: strings.ReplaceAll
// BEFORE:
name := strings.Replace(tt.name, " ", "-", -1)
// AFTER:
name := strings.ReplaceAll(tt.name, " ", "-")

// QF1008: Embedded field selector
// BEFORE:
for _, ownerRef := range pod.ObjectMeta.OwnerReferences {
// AFTER:
for _, ownerRef := range pod.OwnerReferences {

// QF1001: De Morgan's law
// BEFORE:
if !((ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z')) {
// AFTER:
if (ch < 'a' || ch > 'z') && (ch < 'A' || ch > 'Z') {

// ST1005: Error string formatting
// BEFORE:
return fmt.Errorf("Client is required")          // capitalized
return fmt.Errorf("timeout: %w.", err)           // punctuation
// AFTER:
return fmt.Errorf("client is required")
return fmt.Errorf("timeout: %w", err)
```

### Anti-Patterns to Avoid
- **Ignoring errors silently:** Use `_ = fn()` to explicitly mark intentional ignores, never just call `fn()` in production code
- **Over-refactoring tests:** Table-driven tests naturally have higher complexity, focus on production code first
- **Blanket threshold increases:** Adjust thresholds with justification, not to hide all violations
- **Breaking CSI idempotency:** When refactoring CreateVolume/DeleteVolume, preserve exact error codes and response semantics

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Test resource cleanup | Manual defer error checking | `t.Cleanup()` with logging | Handles panics, cleaner for nested tests, standard since Go 1.14 |
| Complexity measurement | Manual cyclomatic counting | gocyclo/cyclop linters | Industry standard, integrated with golangci-lint |
| Code refactoring automation | Manual find/replace | gopls code actions, staticcheck auto-fixes | Context-aware, preserves correctness |
| Error string validation | Manual style checking | staticcheck ST1005 | Enforces Go conventions automatically |

**Key insight:** Go tooling ecosystem provides high-quality linters and refactoring tools. Use them rather than manual verification or custom scripts. The testing.T.Cleanup() pattern is specifically designed for test resource management and handles edge cases (panics, nested tests) that defer doesn't.

## Common Pitfalls

### Pitfall 1: Breaking CSI Spec Compliance During Refactoring
**What goes wrong:** Extracting validation logic changes error code precedence, breaking CSI spec requirements (e.g., InvalidArgument must precede NotFound)
**Why it happens:** Helper extraction doesn't preserve validation order
**How to avoid:** Keep CSI spec comments in extracted helpers, run csi-sanity tests after refactoring
**Warning signs:** Sanity test failures after "cosmetic" refactoring

### Pitfall 2: Test Complexity Inflation from Table-Driven Tests
**What goes wrong:** Table-driven tests naturally accumulate complexity as test cases grow, cyclop flags them
**Why it happens:** Each test case adds conditional branches, loops add complexity
**How to avoid:** Set higher cyclop threshold for test files (15-20 vs 10 for production), extract test case validation into helpers
**Warning signs:** TestCSI_NegativeScenarios complexity >25 with 50+ test cases

### Pitfall 3: Silently Ignoring Cleanup Errors
**What goes wrong:** Using `_ = os.RemoveAll()` hides actual filesystem issues (permission errors, disk full)
**Why it happens:** Quick fix to pass errcheck without considering failure modes
**How to avoid:** Use `t.Cleanup()` with error logging, investigate repeated cleanup failures
**Warning signs:** CI tests leaving artifacts, flaky tests due to leftover state

### Pitfall 4: Over-Aggressive Threshold Lowering
**What goes wrong:** Setting cyclop threshold to 10 flags legitimate CSI handler complexity, forcing awkward refactoring
**Why it happens:** Copying generic Go linter configs without considering CSI driver domain
**How to avoid:** Go community accepts 12-15 for explicit error handling codebases, justify thresholds based on codebase patterns
**Warning signs:** All CreateVolume/DeleteVolume implementations need refactoring across industry drivers

### Pitfall 5: Golangci-lint v2 Config Regression
**What goes wrong:** Re-enabling test file exclusions after v2 migration defeats the purpose of fixing issues
**Why it happens:** Discomfort with 63 errcheck violations in test files
**How to avoid:** Fix violations instead of excluding, use t.Cleanup() pattern consistently
**Warning signs:** Adding back exclude-rules for _test.go errcheck

## Code Examples

Verified patterns from official sources:

### Errcheck: Test Cleanup Pattern
```go
// Source: Go testing package documentation
// https://pkg.go.dev/testing#T.Cleanup

func TestWithTempDir(t *testing.T) {
    tmpDir, err := os.MkdirTemp("", "rds-csi-test")
    if err != nil {
        t.Fatalf("failed to create temp dir: %v", err)
    }
    t.Cleanup(func() {
        if err := os.RemoveAll(tmpDir); err != nil {
            t.Logf("warning: failed to remove temp dir: %v", err)
        }
    })

    // Test code using tmpDir
}
```

### Complexity: CSI Handler Refactoring
```go
// Source: kubernetes-csi/csi-driver-host-path patterns
// https://github.com/kubernetes-csi/csi-driver-host-path

// Extract validation (reduces complexity by ~5)
func (cs *ControllerServer) CreateVolume(ctx context.Context, req *csi.CreateVolumeRequest) (*csi.CreateVolumeResponse, error) {
    params, err := cs.validateAndParseCreateRequest(req)
    if err != nil {
        return nil, err  // Already has proper gRPC status code
    }

    return cs.executeVolumeCreation(ctx, params)
}

func (cs *ControllerServer) validateAndParseCreateRequest(req *csi.CreateVolumeRequest) (*createParams, error) {
    // All validation logic in one place
    // Returns structured params or gRPC status error
}

func (cs *ControllerServer) executeVolumeCreation(ctx context.Context, params *createParams) (*csi.CreateVolumeResponse, error) {
    // Idempotency check, RDS creation, response building
}
```

### Staticcheck: Batch Fixes
```go
// Source: staticcheck documentation
// https://staticcheck.dev/docs/checks/

// Apply all QF (quick-fix) rules at once using staticcheck -fix
// Or manually:

// QF1004: strings.ReplaceAll (simple replacement)
- strings.Replace(s, old, new, -1)
+ strings.ReplaceAll(s, old, new)

// ST1005: Error string conventions
- fmt.Errorf("Volume not found")
+ fmt.Errorf("volume not found")

- fmt.Errorf("timeout: %w.", err)
+ fmt.Errorf("timeout: %w", err)

// ST1001: Remove dot imports (breaks Ginkgo/Gomega pattern)
// EXCEPTION: BDD test frameworks use dot imports by convention
// Keep for test/e2e/helpers.go, document in .golangci.yml
```

### Complexity: Threshold Configuration
```go
// Source: golangci-lint configuration
// .golangci.yml

linters-settings:
  cyclop:
    # Production code: Go's error handling inflates scores
    # Threshold 15 balances readability vs complexity
    max-complexity: 15
    skip-tests: false  # Still check tests, but separately

  gocyclo:
    # Only flag extremely high complexity (>30)
    # CSI handlers may legitimately reach 30-35 due to spec requirements
    min-complexity: 30

issues:
  exclude-rules:
    # Higher threshold for test files (table-driven tests)
    - path: _test\.go
      linters:
        - cyclop
      text: "complexity.*is (1[0-9]|20)"  # Allow up to 20 in tests
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| defer os.RemoveAll() in tests | t.Cleanup() with error logging | Go 1.14 (Feb 2020) | Handles panics, cleaner nested test cleanup |
| Exclude test files from errcheck | Fix violations with t.Cleanup() | golangci-lint v2 (Jan 2025) | Forces test quality improvements |
| Cyclomatic complexity threshold 10 | Threshold 12-15 for explicit error handling | Go community consensus (~2021) | Acknowledges Go's error handling pattern |
| golangci-lint v1 YAML | golangci-lint v2 YAML schema | golangci-lint v2.0.0 (Jan 2025) | Schema validation, stricter config parsing |
| strings.Replace(s, old, new, -1) | strings.ReplaceAll(s, old, new) | Go 1.12 (Feb 2019) | Clearer intent, standard library recommendation |

**Deprecated/outdated:**
- **golangci-lint v1 config format:** No longer supported in v2.x, use `golangci-lint migrate` to convert
- **Blanket test file exclusions:** v2 removes automatic test file exclusions, must be explicit
- **Complexity threshold 10 for all Go code:** Community recognizes 12-15 is more realistic for error-handling-heavy code

## Open Questions

Things that couldn't be fully resolved:

1. **Should we exclude test/e2e/helpers.go from ST1001 (dot imports)?**
   - What we know: Ginkgo/Gomega BDD frameworks use dot imports by convention (`. "github.com/onsi/gomega"`)
   - What's unclear: Whether to add exclusion or refactor to non-dot imports
   - Recommendation: Add exclusion for test/e2e/*.go with comment justifying Ginkgo pattern, keep for rest of codebase

2. **What's the right cyclop threshold for CSI RPC handlers?**
   - What we know: CreateVolume (24), ControllerPublishVolume (48) exceed threshold 10
   - What's unclear: Whether these are genuinely too complex or just CSI spec compliance artifacts
   - Recommendation: Refactor ControllerPublishVolume (48→30), accept CreateVolume (24) with complexity 15 threshold, document in config

3. **Should we fix or suppress gocyclo violations in integration tests?**
   - What we know: TestControllerIntegrationWithMockRDS (40), TestOrphanReconciler_WithMockRDS (41) exceed threshold 30
   - What's unclear: Whether to extract helpers or acknowledge integration test complexity is acceptable
   - Recommendation: Set gocyclo threshold to 45 for test/integration/*_test.go, these are end-to-end flows not unit logic

4. **How to handle main() complexity (31)?**
   - What we know: cmd/rds-csi-plugin/main.go:main() has complexity 31 from flag parsing, validation, and initialization
   - What's unclear: Standard pattern for CSI driver initialization complexity
   - Recommendation: Extract parseFlags(), validateConfig(), initializeDriver() helpers to reduce to <20

## Sources

### Primary (HIGH confidence)
- Go testing package - https://pkg.go.dev/testing - T.Cleanup() documentation
- golangci-lint v2 migration guide - https://golangci-lint.run/docs/product/migration-guide/ - Configuration changes
- staticcheck checks reference - https://staticcheck.dev/docs/checks/ - QF and ST rule explanations
- kubernetes-csi/csi-driver-host-path - https://github.com/kubernetes-csi/csi-driver-host-path - CSI handler patterns
- Go 1.14 release notes - https://go.dev/doc/go1.14 - T.Cleanup() introduction

### Secondary (MEDIUM confidence)
- Understanding Cyclomatic Complexity in Go - https://dev.to/l_walid/understanding-cyclomatic-complexity-in-go-a-comprehensive-guide-2lpl - Go-specific thresholds
- golang-nuts discussion on complexity - https://groups.google.com/g/golang-nuts/c/HNNUjE5VWos - Community consensus on thresholds
- Testing in Go: Clean Tests Using t.Cleanup - https://ieftimov.com/posts/testing-in-go-clean-tests-using-t-cleanup/ - Cleanup pattern examples

### Tertiary (LOW confidence)
- Refactoring Long Methods with Extract Method - https://codesignal.com/learn/courses/refactoring-by-leveraging-your-tests-with-go-testify - General refactoring guidance

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - golangci-lint v2, errcheck, gocyclo, cyclop, staticcheck are industry standard
- Architecture: HIGH - t.Cleanup() pattern is official Go 1.14+ recommendation, CSI refactoring patterns from kubernetes-csi
- Pitfalls: HIGH - Based on actual linter output and golangci-lint v2 migration issues observed in Phase 25.1

**Research date:** 2026-02-05
**Valid until:** 2026-03-05 (30 days - stable tooling, slow-moving conventions)

**Issue breakdown from actual linter run:**
- errcheck: 63 violations (46 in test files: os.RemoveAll, 17 in production: client.Close, os.Unsetenv)
- cyclop: 56 violations (functions >10 complexity, range 11-29)
- gocyclo: 7 violations (functions >30 complexity, range 31-48)
- staticcheck: 8 violations (3 ST1005 error strings, 2 QF1008 embedded fields, 1 QF1004 ReplaceAll, 1 QF1001 De Morgan, 1 ST1001 dot import)

**Key files requiring refactoring:**
- pkg/driver/controller.go: CreateVolume (24), ControllerPublishVolume (48), DeleteVolume (13), ControllerUnpublishVolume (23)
- pkg/driver/node.go: NodeStageVolume (36), NodeUnstageVolume (29), NodePublishVolume (26)
- pkg/driver/node_test.go: 20 errcheck violations (os.RemoveAll, os.MkdirAll)
- test/integration/*_test.go: 2 gocyclo violations (40, 41 complexity)
