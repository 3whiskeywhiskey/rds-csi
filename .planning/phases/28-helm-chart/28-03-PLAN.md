---
phase: 28-helm-chart
plan: 03
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - deploy/helm/rds-csi-driver/templates/storageclass.yaml
  - deploy/helm/rds-csi-driver/templates/snapshotclass.yaml
  - deploy/helm/rds-csi-driver/templates/service.yaml
  - deploy/helm/rds-csi-driver/templates/servicemonitor.yaml
  - deploy/helm/rds-csi-driver/templates/NOTES.txt
  - deploy/helm/rds-csi-driver/README.md
autonomous: true

must_haves:
  truths:
    - "StorageClass template iterates over storageClasses array and creates resources only when enabled=true"
    - "StorageClass parameters include nvmeAddress, nvmePort, volumePath with fallback to rds.* defaults"
    - "VolumeSnapshotClass template is conditional on snapshotClass.enabled"
    - "ServiceMonitor is conditional on both monitoring.enabled AND serviceMonitor.enabled AND CRD detection (or forceEnable)"
    - "Metrics Service exposes port from monitoring.port for Prometheus scraping"
    - "NOTES.txt shows post-install instructions including pod verification, StorageClass list, and metrics info"
    - "README.md documents installation, configuration, and all values.yaml options"
    - "RWX StorageClass is not created by default (enabled: false)"
  artifacts:
    - path: "deploy/helm/rds-csi-driver/templates/storageclass.yaml"
      provides: "Conditional StorageClass resources via loop"
      contains: "range .Values.storageClasses"
    - path: "deploy/helm/rds-csi-driver/templates/snapshotclass.yaml"
      provides: "Conditional VolumeSnapshotClass"
      contains: "VolumeSnapshotClass"
    - path: "deploy/helm/rds-csi-driver/templates/service.yaml"
      provides: "Metrics Service for Prometheus"
      contains: "kind: Service"
    - path: "deploy/helm/rds-csi-driver/templates/servicemonitor.yaml"
      provides: "Conditional Prometheus ServiceMonitor"
      contains: "monitoring.coreos.com/v1"
    - path: "deploy/helm/rds-csi-driver/templates/NOTES.txt"
      provides: "Post-install user instructions"
      contains: "kubectl get pods"
    - path: "deploy/helm/rds-csi-driver/README.md"
      provides: "Chart documentation"
      contains: "helm install"
  key_links:
    - from: "deploy/helm/rds-csi-driver/templates/storageclass.yaml"
      to: "deploy/helm/rds-csi-driver/values.yaml"
      via: "iterates storageClasses array with fallback to rds.* defaults"
      pattern: "range.*storageClasses"
    - from: "deploy/helm/rds-csi-driver/templates/servicemonitor.yaml"
      to: "deploy/helm/rds-csi-driver/templates/service.yaml"
      via: "ServiceMonitor selector matches Service labels"
      pattern: "matchLabels"
    - from: "deploy/helm/rds-csi-driver/templates/service.yaml"
      to: "deploy/helm/rds-csi-driver/templates/controller.yaml"
      via: "Service selector matches controller pod labels"
      pattern: "app.kubernetes.io/component.*controller"
---

<objective>
Create the feature templates (StorageClass, VolumeSnapshotClass, Service, ServiceMonitor), NOTES.txt post-install instructions, and chart README documentation.

Purpose: These are the user-facing chart features -- storage classes users reference in PVCs, monitoring integration with Prometheus, and documentation that guides installation and configuration. Without these, the chart deploys infrastructure but users can't use it.

Output: Complete chart with all conditional resources, post-install instructions, and comprehensive README documenting every configuration option.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-helm-chart/28-CONTEXT.md
@.planning/phases/28-helm-chart/28-RESEARCH.md
@deploy/kubernetes/snapshotclass.yaml
@examples/storageclass.yaml
@deploy/helm/rds-csi-driver/Chart.yaml
@deploy/helm/rds-csi-driver/values.yaml
@deploy/helm/rds-csi-driver/templates/_helpers.tpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StorageClass, VolumeSnapshotClass, Service, and ServiceMonitor templates</name>
  <files>
    deploy/helm/rds-csi-driver/templates/storageclass.yaml
    deploy/helm/rds-csi-driver/templates/snapshotclass.yaml
    deploy/helm/rds-csi-driver/templates/service.yaml
    deploy/helm/rds-csi-driver/templates/servicemonitor.yaml
  </files>
  <action>
**storageclass.yaml** - Loop over `.Values.storageClasses` array:
```yaml
{{- range $idx, $sc := .Values.storageClasses }}
{{- if $sc.enabled }}
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: {{ $sc.name }}
  {{- if $sc.isDefault }}
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
  {{- end }}
  labels:
    {{- include "rds-csi.labels" $ | nindent 4 }}
provisioner: rds.csi.srvlab.io
parameters:
  csi.storage.k8s.io/fstype: {{ $sc.fsType | default "ext4" | quote }}
  nvmeAddress: {{ $sc.nvmeAddress | default $.Values.rds.storageIP | quote }}
  nvmePort: {{ $sc.nvmePort | default (printf "%d" (int $.Values.rds.nvmePort)) | quote }}
  volumePath: {{ $sc.volumePath | default $.Values.rds.basePath | quote }}
volumeBindingMode: {{ $sc.volumeBindingMode | default "WaitForFirstConsumer" }}
reclaimPolicy: {{ $sc.reclaimPolicy | default "Delete" }}
allowVolumeExpansion: {{ $sc.allowVolumeExpansion | default true }}
{{- with $sc.mountOptions }}
mountOptions:
  {{- toYaml . | nindent 2 }}
{{- end }}
{{- end }}
{{- end }}
```

Note: The provisioner MUST be `rds.csi.srvlab.io` (hardcoded, matches CSIDriver name). StorageClass parameters (`nvmeAddress`, `nvmePort`, `volumePath`) are passed to CreateVolume and used by the controller -- these are CSI-level parameters, not driver flags. Default RWX class (rds-nvme-rwx) is `enabled: false` in values.yaml, so it won't be created unless user explicitly enables it. Per CONTEXT.md: "RWX enables multi-attach during migration windows (not for concurrent multi-writer filesystems like NFS)".

**snapshotclass.yaml** - Conditional VolumeSnapshotClass:
```yaml
{{- if .Values.snapshotClass.enabled }}
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: {{ .Values.snapshotClass.name }}
  labels:
    {{- include "rds-csi.labels" . | nindent 4 }}
driver: rds.csi.srvlab.io
deletionPolicy: {{ .Values.snapshotClass.deletionPolicy | default "Delete" }}
{{- end }}
```
Add a comment at the top noting VolumeSnapshot CRDs and snapshot-controller must be installed (same as deploy/kubernetes/snapshotclass.yaml).

**service.yaml** - Metrics Service (conditional on monitoring.enabled):
```yaml
{{- if .Values.monitoring.enabled }}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "rds-csi.fullname" . }}-metrics
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "rds-csi.labels" . | nindent 4 }}
    app.kubernetes.io/component: controller
spec:
  type: ClusterIP
  ports:
    - name: metrics
      port: {{ .Values.monitoring.port }}
      targetPort: {{ .Values.monitoring.port }}
      protocol: TCP
  selector:
    {{- include "rds-csi.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: controller
{{- end }}
```

**servicemonitor.yaml** - Conditional ServiceMonitor with CRD auto-detection:
```yaml
{{- if and .Values.monitoring.enabled .Values.monitoring.serviceMonitor.enabled }}
{{- if or .Values.monitoring.serviceMonitor.forceEnable (.Capabilities.APIVersions.Has "monitoring.coreos.com/v1") }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "rds-csi.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "rds-csi.labels" . | nindent 4 }}
    {{- with .Values.monitoring.serviceMonitor.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  selector:
    matchLabels:
      {{- include "rds-csi.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: controller
  endpoints:
    - port: metrics
      interval: {{ .Values.monitoring.serviceMonitor.interval | default "30s" }}
      path: /metrics
{{- end }}
{{- end }}
```
  </action>
  <verify>
Run `helm template test-release deploy/helm/rds-csi-driver/ --namespace rds-csi` and verify:
1. Only rds-nvme StorageClass is created (rds-nvme-rwx is disabled by default)
2. VolumeSnapshotClass is created with driver rds.csi.srvlab.io
3. Metrics Service is created on configured port
4. ServiceMonitor is NOT created (serviceMonitor.enabled defaults to false)
5. Run with `--set monitoring.serviceMonitor.enabled=true,monitoring.serviceMonitor.forceEnable=true` to verify ServiceMonitor renders

Verify StorageClass parameters have correct default values (nvmeAddress=10.42.68.1, nvmePort=4420).
  </verify>
  <done>Four feature templates render correctly. StorageClass loop creates only enabled classes with correct parameter defaults. ServiceMonitor has triple-conditional gate (monitoring + serviceMonitor + CRD detection). VolumeSnapshotClass is conditional.</done>
</task>

<task type="auto">
  <name>Task 2: Create NOTES.txt and chart README.md</name>
  <files>
    deploy/helm/rds-csi-driver/templates/NOTES.txt
    deploy/helm/rds-csi-driver/README.md
  </files>
  <action>
**NOTES.txt** - Post-install instructions shown after `helm install`:

Include these sections (all templated with conditionals):

1. **Header**: "Thank you for installing {{ .Chart.Name }}." with release name and namespace

2. **Verify deployment**:
   - Command to check controller pod: `kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/component=controller`
   - Command to check node pods: `kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/component=node`
   - Command to verify CSI driver registration: `kubectl get csidriver rds.csi.srvlab.io`

3. **Available StorageClasses**: Loop over `.Values.storageClasses`, list enabled ones with `(default)` annotation if isDefault

4. **Metrics** (conditional on monitoring.enabled):
   - Port-forward command: `kubectl port-forward -n {{ .Release.Namespace }} svc/{{ include "rds-csi.fullname" . }}-metrics {{ .Values.monitoring.port }}:{{ .Values.monitoring.port }}`
   - Warning if serviceMonitor.enabled but CRDs not detected

5. **Upgrade notice** (conditional on .Release.IsUpgrade):
   - Warning about `--reuse-values`, recommend `--reset-then-reuse-values`

6. **Prerequisites reminder**:
   - Secret must exist: `kubectl get secret {{ .Values.rds.secretName }} -n {{ .Release.Namespace }}`
   - If snapshotClass.enabled: Remind about VolumeSnapshot CRDs and snapshot-controller

7. **Documentation link**: GitHub URL

**README.md** - Comprehensive chart documentation:

Structure:
1. **Title and description**: RDS CSI Driver Helm Chart - Kubernetes CSI driver for MikroTik ROSE Data Server
2. **Prerequisites**: Kubernetes 1.26+, Helm 3.14+, RDS with RouterOS 7.1+, SSH key pair, NVMe/TCP network connectivity
3. **Quick Start**: 4 steps:
   - Create namespace: `kubectl create namespace rds-csi`
   - Create secret (show full YAML example with ssh-key and snmp-community keys, note `rds-private-key` and `rds-host-key` key names matching what the driver mounts)
   - Install chart: `helm install rds-csi ./deploy/helm/rds-csi-driver --namespace rds-csi`
   - Verify: `kubectl get pods -n rds-csi`
4. **Configuration**: Table of ALL values.yaml parameters with:
   - Parameter name (dot notation: `rds.managementIP`)
   - Description
   - Default value
   Group by section: rds, controller, node, sidecars, monitoring, storageClasses, snapshotClass
5. **Secret Structure**: Full example Secret YAML showing required keys (`rds-private-key`, `rds-host-key`, `snmp-community`)
6. **Storage Classes**: Explain rds-nvme (default RWO) and rds-nvme-rwx (opt-in for KubeVirt live migration). Include the CONTEXT.md note: "RWX enables KubeVirt live migration, NOT general-purpose shared filesystems."
7. **Monitoring**: How to enable ServiceMonitor, Prometheus scraping, RDS health metrics toggle
8. **Upgrading**: Use `--reset-then-reuse-values`, note independent chart vs app versioning
9. **Uninstalling**: `helm uninstall rds-csi -n rds-csi`. Note: PVs and PVCs are NOT deleted by uninstall

Do NOT include emojis in either file. Use plain text markers like `WARNING:`, `NOTE:`, `IMPORTANT:` instead.

Run `helm lint deploy/helm/rds-csi-driver/` after creating both files to verify the complete chart passes linting.
  </action>
  <verify>
Run `helm lint deploy/helm/rds-csi-driver/` -- should pass with 0 errors. Run `helm template test-release deploy/helm/rds-csi-driver/ --namespace rds-csi --show-only templates/NOTES.txt` to verify NOTES render. Verify README.md covers all configuration sections (rds, controller, node, sidecars, monitoring, storageClasses).
  </verify>
  <done>NOTES.txt renders with conditional sections based on values. README.md documents all configuration parameters, prerequisites, quick start, and upgrade instructions. Complete chart passes helm lint with no errors.</done>
</task>

</tasks>

<verification>
1. `helm lint deploy/helm/rds-csi-driver/` passes with 0 errors
2. `helm template test-release deploy/helm/rds-csi-driver/ --namespace rds-csi` renders complete chart:
   - 1 enabled StorageClass (rds-nvme), RWX class NOT rendered
   - VolumeSnapshotClass rendered
   - Metrics Service rendered
   - ServiceMonitor NOT rendered (disabled by default)
3. `helm template ... --set storageClasses[0].isDefault=true` adds default annotation to StorageClass
4. `helm template ... --set monitoring.serviceMonitor.enabled=true,monitoring.serviceMonitor.forceEnable=true` renders ServiceMonitor
5. NOTES.txt shows verification commands, available storage classes, and prerequisites
6. README.md has Quick Start, Configuration table, Secret Structure, and Upgrade sections
</verification>

<success_criteria>
- StorageClass loop correctly handles enabled/disabled and defaults from rds.* values
- ServiceMonitor triple-conditional prevents deployment failures on clusters without Prometheus Operator
- NOTES.txt provides actionable post-install guidance
- README.md documents all configuration options with defaults
- Complete chart passes helm lint with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-helm-chart/28-03-SUMMARY.md`
</output>
