---
phase: 28-helm-chart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - deploy/helm/rds-csi-driver/Chart.yaml
  - deploy/helm/rds-csi-driver/values.yaml
  - deploy/helm/rds-csi-driver/values.schema.json
  - deploy/helm/rds-csi-driver/.helmignore
  - deploy/helm/rds-csi-driver/templates/_helpers.tpl
autonomous: true

must_haves:
  truths:
    - "Chart.yaml declares apiVersion v2, name rds-csi-driver, version 1.0.0, appVersion 0.10.0"
    - "values.yaml contains flat structure with controller, node, rds, monitoring, sidecars, storageClasses sections"
    - "Required parameters (rds.managementIP, rds.secretName) are rejected by schema when missing at install time"
    - "_helpers.tpl provides name, fullname, chart, labels, selectorLabels, serviceAccountName helpers"
    - "Chart installs successfully with default values (all defaults are valid per schema)"
  artifacts:
    - path: "deploy/helm/rds-csi-driver/Chart.yaml"
      provides: "Chart metadata with apiVersion v2"
      contains: "apiVersion: v2"
    - path: "deploy/helm/rds-csi-driver/values.yaml"
      provides: "Default configuration values"
      contains: "managementIP"
    - path: "deploy/helm/rds-csi-driver/values.schema.json"
      provides: "JSON Schema validation for values"
      contains: "json-schema.org/draft-07"
    - path: "deploy/helm/rds-csi-driver/templates/_helpers.tpl"
      provides: "Reusable template helpers"
      contains: "define \"rds-csi.labels\""
    - path: "deploy/helm/rds-csi-driver/.helmignore"
      provides: "File exclusion patterns"
  key_links:
    - from: "deploy/helm/rds-csi-driver/values.yaml"
      to: "deploy/helm/rds-csi-driver/values.schema.json"
      via: "schema validates values structure"
      pattern: "required.*managementIP"
    - from: "deploy/helm/rds-csi-driver/templates/_helpers.tpl"
      to: "deploy/helm/rds-csi-driver/Chart.yaml"
      via: "helpers reference .Chart.Name and .Chart.AppVersion"
      pattern: "Chart\\.Name|Chart\\.AppVersion"
---

<objective>
Create the Helm chart skeleton with Chart.yaml, values.yaml, values.schema.json, .helmignore, and _helpers.tpl template helpers.

Purpose: Establishes the chart foundation that all subsequent template files depend on -- values structure, naming conventions, label helpers, and input validation. This is the backbone every other template imports from.

Output: A chart directory that passes `helm lint` with comprehensive values covering all driver configuration (RDS connection, controller/node settings, sidecars, monitoring, storage classes).
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-helm-chart/28-CONTEXT.md
@.planning/phases/28-helm-chart/28-RESEARCH.md
@deploy/kubernetes/controller.yaml
@deploy/kubernetes/node.yaml
@deploy/kubernetes/rbac.yaml
@deploy/kubernetes/csidriver.yaml
@cmd/rds-csi-plugin/main.go
@examples/storageclass.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Chart.yaml, .helmignore, and values.yaml</name>
  <files>
    deploy/helm/rds-csi-driver/Chart.yaml
    deploy/helm/rds-csi-driver/.helmignore
    deploy/helm/rds-csi-driver/values.yaml
  </files>
  <action>
Create Chart.yaml with:
- apiVersion: v2
- name: rds-csi-driver
- description: "Kubernetes CSI driver for MikroTik ROSE Data Server (NVMe/TCP)"
- type: application
- version: "1.0.0" (chart version, independent of driver)
- appVersion: "0.10.0" (driver version)
- kubeVersion: ">=1.26.0-0"
- home: https://github.com/3whiskeywhiskey/rds-csi-driver
- maintainers with name whiskey
- keywords: [csi, nvme, nvme-tcp, mikrotik, rds, storage, kubernetes]

Create .helmignore with standard patterns: .git, .gitignore, *.swp, *.bak, *.tmp, .DS_Store, .helmignore, .idea, *.tmproj, .vscode

Create values.yaml with flat structure per CONTEXT.md decisions. Reference existing manifests for exact values:

```yaml
# RDS connection configuration
rds:
  managementIP: "10.42.241.3"     # SSH management interface
  storageIP: "10.42.68.1"         # NVMe/TCP storage interface
  sshPort: 22
  nvmePort: 4420
  sshUser: "metal-csi"
  basePath: "/storage-pool/metal-csi"
  secretName: "rds-csi-secret"    # Pre-existing secret (user creates this)
  insecureSkipVerify: false       # NEVER true in production
  nqnPrefix: "nqn.2000-02.com.mikrotik:pvc-"

# Controller Deployment configuration
controller:
  replicas: 1                     # Single controller (no leader election for HA)
  image:
    repository: ghcr.io/3whiskeywhiskey/rds-csi
    tag: ""                       # Defaults to Chart.appVersion
    pullPolicy: Always
  logLevel: 5
  resources:
    requests: { cpu: 10m, memory: 64Mi }
    limits: { cpu: 200m, memory: 256Mi }
  nodeSelector: {}
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/master
      operator: Exists
      effect: NoSchedule
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: In
                values: ["true"]
  priorityClassName: system-cluster-critical
  # Orphan reconciler settings
  orphanReconciler:
    enabled: true
    checkInterval: 1h
    gracePeriod: 5m
    dryRun: true
  # Attachment management
  attachmentGracePeriod: 30s
  attachmentReconcileInterval: 5m
  # VMI serialization (KubeVirt)
  vmiSerialization:
    enabled: false
    cacheTTL: 60s

# Node DaemonSet configuration
node:
  image:
    repository: ghcr.io/3whiskeywhiskey/rds-csi
    tag: ""                       # Defaults to Chart.appVersion
    pullPolicy: Always
  logLevel: 5
  resources:
    requests: { cpu: 10m, memory: 128Mi }
    limits: { cpu: 200m, memory: 512Mi }
  kubeletPath: /var/lib/kubelet
  nodeSelector:
    kubernetes.io/os: linux
  tolerations:
    - operator: Exists            # Run on ALL nodes (CSI requirement)
  priorityClassName: system-node-critical
  terminationGracePeriodSeconds: 60
  registrar:
    image:
      repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
      tag: v2.10.0
    resources:
      requests: { cpu: 10m, memory: 32Mi }
      limits: { cpu: 100m, memory: 64Mi }
  livenessProbe:
    image:
      repository: registry.k8s.io/sig-storage/livenessprobe
      tag: v2.12.0
    resources:
      requests: { cpu: 10m, memory: 32Mi }
      limits: { cpu: 100m, memory: 64Mi }

# Controller sidecars
sidecars:
  provisioner:
    image:
      repository: registry.k8s.io/sig-storage/csi-provisioner
      tag: v4.0.0
    resources:
      requests: { cpu: 10m, memory: 64Mi }
      limits: { cpu: 100m, memory: 128Mi }
    additionalArgs:
      - "--timeout=300s"
      - "--feature-gates=Topology=false"
      - "--default-fstype=ext4"
  attacher:
    image:
      repository: registry.k8s.io/sig-storage/csi-attacher
      tag: v4.5.0
    resources:
      requests: { cpu: 10m, memory: 64Mi }
      limits: { cpu: 100m, memory: 128Mi }
    additionalArgs:
      - "--timeout=300s"
  resizer:
    image:
      repository: registry.k8s.io/sig-storage/csi-resizer
      tag: v1.10.0
    resources:
      requests: { cpu: 10m, memory: 64Mi }
      limits: { cpu: 100m, memory: 128Mi }
    additionalArgs:
      - "--timeout=300s"
      - "--handle-volume-inuse-error=false"
  snapshotter:
    image:
      repository: registry.k8s.io/sig-storage/csi-snapshotter
      tag: v8.2.0
    resources:
      requests: { cpu: 10m, memory: 64Mi }
      limits: { cpu: 100m, memory: 128Mi }
    additionalArgs:
      - "--timeout=300s"
  livenessProbe:
    image:
      repository: registry.k8s.io/sig-storage/livenessprobe
      tag: v2.12.0
    resources:
      requests: { cpu: 10m, memory: 32Mi }
      limits: { cpu: 100m, memory: 64Mi }

# Monitoring configuration
monitoring:
  enabled: true
  port: 9809
  serviceMonitor:
    enabled: false                # Set true if Prometheus Operator is installed
    forceEnable: false            # Override CRD auto-detection
    interval: 30s
    labels: {}                    # Additional labels for ServiceMonitor
  rdsMonitoring:
    enabled: true                 # Toggle RDS health metrics (SSH + SNMP)

# StorageClass configuration
storageClasses:
  - name: rds-nvme
    enabled: true
    isDefault: false
    fsType: ext4
    nvmeAddress: ""               # Defaults to rds.storageIP
    nvmePort: ""                  # Defaults to rds.nvmePort
    volumePath: ""                # Defaults to rds.basePath
    volumeBindingMode: WaitForFirstConsumer
    reclaimPolicy: Delete
    allowVolumeExpansion: true
    mountOptions: []
  - name: rds-nvme-rwx
    enabled: false                # Enable for KubeVirt live migration
    isDefault: false
    fsType: ext4
    nvmeAddress: ""
    nvmePort: ""
    volumePath: ""
    volumeBindingMode: WaitForFirstConsumer
    reclaimPolicy: Delete
    allowVolumeExpansion: true
    mountOptions: []
    # RWX: Required for KubeVirt live migration. Not for general-purpose shared filesystems.
    accessModes:
      - ReadWriteMany

# VolumeSnapshotClass
snapshotClass:
  enabled: true
  name: rds-csi-snapclass
  deletionPolicy: Delete

# Namespace configuration
namespace:
  create: false                   # Set true to create namespace via chart
```

IMPORTANT -- Secret key names and mount paths:

The existing deployed manifest (deploy/kubernetes/controller.yaml) uses these secret key names:
- `rds-private-key` (SSH private key)
- `rds-host-key` (SSH host public key)

The secret is mounted at `/etc/rds-csi` (not `/etc/rds-csi/ssh-key/`). This means the actual file paths inside the container are:
- `/etc/rds-csi/rds-private-key`
- `/etc/rds-csi/rds-host-key`

The driver's main.go has a default of `-rds-key-file=/etc/rds-csi/ssh-key/id_rsa` but the deployed manifest overrides this with `-rds-key-file=/etc/rds-csi/rds-private-key`. The Helm chart must follow the DEPLOYED convention (matching existing Secret format), NOT the main.go defaults.

The values.yaml comments should document the expected Secret structure:
```yaml
  # Secret must contain keys: rds-private-key (SSH private key), rds-host-key (SSH host public key)
  # Optional: snmp-community (SNMP community string for hardware monitoring)
  secretName: "rds-csi-secret"
```

This is 3 declarative config files with no logic or branching -- pure YAML/JSON declarations. The scope is appropriate for a single task despite 3 files because they are tightly coupled (values.yaml structure must match Chart.yaml appVersion and cross-references).

IMPORTANT: Match the exact flag names from cmd/rds-csi-plugin/main.go. The controller uses `-rds-address`, `-rds-port`, `-rds-user`, `-rds-key-file`, `-rds-host-key`, `-rds-insecure-skip-verify`, `-rds-volume-base-path`, `-endpoint`, `-node-id`, `-controller`, `-node`, `-v`, `-metrics-address`, `-enable-orphan-reconciler`, `-orphan-check-interval`, `-orphan-grace-period`, `-orphan-dry-run`, `-attachment-grace-period`, `-attachment-reconcile-interval`, `-enable-vmi-serialization`, `-vmi-cache-ttl`. The node uses env var `CSI_MANAGED_NQN_PREFIX` for NQN prefix.
  </action>
  <verify>
Run `ls -la deploy/helm/rds-csi-driver/` to confirm Chart.yaml, values.yaml, .helmignore exist. Verify Chart.yaml has apiVersion v2 and version 1.0.0. Verify values.yaml comments document the expected Secret key names (`rds-private-key`, `rds-host-key`) matching deploy/kubernetes/controller.yaml.
  </verify>
  <done>Chart.yaml, values.yaml, and .helmignore exist with all configuration sections matching existing manifest values and main.go flag names. Secret key names documented as rds-private-key and rds-host-key (matching deployed manifests, not main.go defaults).</done>
</task>

<task type="auto">
  <name>Task 2: Create _helpers.tpl and values.schema.json</name>
  <files>
    deploy/helm/rds-csi-driver/templates/_helpers.tpl
    deploy/helm/rds-csi-driver/values.schema.json
  </files>
  <action>
Create _helpers.tpl with these standard Helm helpers:

1. `rds-csi.name` - `default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-"`
2. `rds-csi.fullname` - follows standard pattern with fullnameOverride support, truncated to 63 chars
3. `rds-csi.chart` - `printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-"`
4. `rds-csi.labels` - Common labels: `helm.sh/chart`, selectorLabels, `app.kubernetes.io/version` (from .Chart.AppVersion), `app.kubernetes.io/managed-by`
5. `rds-csi.selectorLabels` - `app.kubernetes.io/name` and `app.kubernetes.io/instance`
6. `rds-csi.serviceAccountName` - returns fullname (we always create service accounts)
7. `rds-csi.driverName` - returns "rds.csi.srvlab.io" (the CSI driver name, not the chart name)

Create values.schema.json with JSON Schema draft-07:
- `rds` object: required fields `managementIP` (IP pattern), `secretName` (k8s name pattern). Optional: `storageIP`, `sshPort` (1-65535), `nvmePort` (1-65535), `sshUser` (string), `basePath` (starts with /), `insecureSkipVerify` (boolean), `nqnPrefix` (string)
- `controller` object: `replicas` (integer, min 1, max 1), `logLevel` (integer, 0-10)
- `node` object: `kubeletPath` (string, starts with /), `terminationGracePeriodSeconds` (integer, min 0)
- `storageClasses` array: items with required `name` (k8s name pattern, max 63), optional `enabled` (boolean), `isDefault` (boolean), `reclaimPolicy` (enum Delete/Retain), `volumeBindingMode` (enum Immediate/WaitForFirstConsumer), `allowVolumeExpansion` (boolean)
- `monitoring` object: `enabled` (boolean), `port` (integer, 1-65535)

Add `nameOverride` and `fullnameOverride` as optional string properties at root.

After both files are created, run `helm lint deploy/helm/rds-csi-driver/` to verify the chart skeleton is valid. If helm is not available, use `nix-shell -p kubernetes-helm --run "helm lint deploy/helm/rds-csi-driver/"`. The lint will show warnings about missing templates (expected at this stage) but should not error on Chart.yaml/values.yaml/helpers syntax.
  </action>
  <verify>
Run `helm lint deploy/helm/rds-csi-driver/` (or via nix-shell). Expect warnings about missing templates but no errors on chart structure. Verify _helpers.tpl defines at least 6 named templates. Verify values.schema.json is valid JSON with "$schema" field.
  </verify>
  <done>_helpers.tpl provides all standard label/name helpers. values.schema.json validates required fields (rds.managementIP, rds.secretName). helm lint passes with no structural errors.</done>
</task>

</tasks>

<verification>
1. `helm lint deploy/helm/rds-csi-driver/` passes (warnings OK, no errors)
2. Chart.yaml has apiVersion v2, version 1.0.0, appVersion 0.10.0
3. values.yaml covers all sections: rds, controller, node, sidecars, monitoring, storageClasses, snapshotClass
4. values.yaml documents Secret key names as `rds-private-key` and `rds-host-key` (matching deploy/kubernetes/controller.yaml)
5. _helpers.tpl defines rds-csi.name, rds-csi.fullname, rds-csi.labels, rds-csi.selectorLabels, rds-csi.serviceAccountName
6. values.schema.json validates rds.managementIP and rds.secretName as required
</verification>

<success_criteria>
- Chart skeleton passes helm lint with no structural errors
- All driver configuration options from main.go are represented in values.yaml
- Template helpers follow Helm best practices (standard label format)
- JSON Schema catches missing required fields at install time
- Secret key names in values.yaml comments match deployed manifest convention (rds-private-key, rds-host-key), not main.go defaults
</success_criteria>

<output>
After completion, create `.planning/phases/28-helm-chart/28-01-SUMMARY.md`
</output>
