---
phase: 02-stale-mount-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/driver/events.go
autonomous: true

must_haves:
  truths:
    - "Driver can post Warning events to PVC on mount failures"
    - "Events include volume ID, node name, and descriptive message"
    - "Event posting gracefully handles missing PVC"
  artifacts:
    - path: "pkg/driver/events.go"
      provides: "EventPoster for Kubernetes events"
      exports: ["EventPoster", "NewEventPoster", "PostMountFailure", "PostRecoveryAttempt"]
  key_links:
    - from: "pkg/driver/events.go"
      to: "k8s.io/client-go/tools/record"
      via: "EventRecorder interface"
      pattern: "record\\.EventRecorder"
---

<objective>
Kubernetes event posting for mount failures and recovery actions

Purpose: Enable operators to see mount issues via kubectl get events without digging through logs. Events are attached to PVCs so users watching their PVCs see relevant failures.

Output: events.go with EventPoster that posts Warning events to PVCs
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stale-mount-detection/02-RESEARCH.md
@.planning/phases/02-stale-mount-detection/02-CONTEXT.md
@pkg/reconciler/orphan_reconciler.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EventPoster for Kubernetes events</name>
  <files>pkg/driver/events.go</files>
  <action>
Create pkg/driver/events.go with EventPoster that posts events to PVCs.

Follow client-go EventRecorder pattern from research and existing orphan_reconciler.go patterns.

Implementation:

```go
package driver

import (
    "context"
    "fmt"

    corev1 "k8s.io/api/core/v1"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
    "k8s.io/apimachinery/pkg/runtime"
    "k8s.io/client-go/kubernetes"
    "k8s.io/client-go/kubernetes/scheme"
    typedcorev1 "k8s.io/client-go/kubernetes/typed/core/v1"
    "k8s.io/client-go/tools/record"
    "k8s.io/klog/v2"
)

// Event reasons - use consistent naming for filtering
const (
    EventReasonMountFailure     = "MountFailure"
    EventReasonRecoveryFailed   = "RecoveryFailed"
    EventReasonStaleMountDetected = "StaleMountDetected"
)

// EventPoster posts Kubernetes events for mount operations
type EventPoster struct {
    recorder  record.EventRecorder
    clientset kubernetes.Interface
}
```

Create NewEventPoster:
1. Accept kubernetes.Interface
2. Create EventBroadcaster with NewBroadcaster()
3. Start logging to klog.Infof
4. Start recording to EventSink (clientset.CoreV1().Events(""))
5. Create recorder with scheme.Scheme and EventSource{Component: "rds-csi-node"}

Create PostMountFailure method:
- Parameters: ctx, pvcNamespace, pvcName, volumeID, nodeName, reason, message
- Get PVC via clientset
- If PVC not found, log warning and return nil (don't fail)
- Post Warning event with EventReasonMountFailure
- Message format: "[volumeID] on [nodeName]: [message]"

Create PostRecoveryFailed method:
- Same pattern as PostMountFailure
- Use EventReasonRecoveryFailed
- Include attempt count and final error in message

Create PostStaleMountDetected method:
- Use EventReasonStaleMountDetected
- Normal event type (not Warning) since detection is informational
- Include old device path, new device path in message

Per CONTEXT.md decisions:
- Post events on failures only (no noise on successful recovery)
- Warning events for unrecoverable failures
- Verbose event content: volume ID, node name, device paths, what failed

Error handling:
- If PVC lookup fails (deleted, terminating), log warning and return nil
- Don't fail the operation just because event couldn't be posted
  </action>
  <verify>
go build ./pkg/driver/... compiles successfully
go vet ./pkg/driver/... passes
  </verify>
  <done>
EventPoster struct exists with recorder and clientset fields
NewEventPoster accepts kubernetes.Interface and returns *EventPoster
PostMountFailure posts Warning event to PVC
PostRecoveryFailed posts Warning event with attempt count
PostStaleMountDetected posts Normal event with device path info
  </done>
</task>

<task type="auto">
  <name>Task 2: Add EventPoster integration point to NodeServer</name>
  <files>pkg/driver/node.go</files>
  <action>
Add EventPoster field to NodeServer for later integration. This task only adds the field and constructor update - actual usage comes in Plan 04.

Modifications to node.go:

1. Add eventPoster field to NodeServer struct:
```go
type NodeServer struct {
    csi.UnimplementedNodeServer
    driver      *Driver
    nvmeConn    nvme.Connector
    mounter     mount.Mounter
    nodeID      string
    eventPoster *EventPoster  // NEW: for posting K8s events
}
```

2. Update NewNodeServer to accept optional clientset:
```go
// NewNodeServer creates a new Node service
// If k8sClient is provided, events will be posted for mount failures
func NewNodeServer(driver *Driver, nodeID string, k8sClient kubernetes.Interface) *NodeServer {
    var eventPoster *EventPoster
    if k8sClient != nil {
        eventPoster = NewEventPoster(k8sClient)
    }

    return &NodeServer{
        driver:      driver,
        nvmeConn:    nvme.NewConnector(),
        mounter:     mount.NewMounter(),
        nodeID:      nodeID,
        eventPoster: eventPoster,
    }
}
```

3. Add helper method to NodeServer:
```go
// postEvent posts an event if eventPoster is configured
// Silently does nothing if eventPoster is nil (events disabled)
func (ns *NodeServer) postEvent(ctx context.Context, pvcNamespace, pvcName, volumeID, reason, message string) {
    if ns.eventPoster == nil {
        return
    }
    // Actual posting handled by EventPoster methods
    // This is a placeholder for Plan 04 integration
}
```

Note: Existing callers of NewNodeServer will need to be updated to pass nil for k8sClient to maintain backward compatibility. Check cmd/rds-csi-plugin/main.go or wherever NodeServer is created.
  </action>
  <verify>
go build ./pkg/driver/... compiles successfully
go vet ./pkg/driver/... passes
  </verify>
  <done>
NodeServer has eventPoster field
NewNodeServer accepts optional kubernetes.Interface parameter
postEvent helper method exists (even if unused for now)
  </done>
</task>

</tasks>

<verification>
1. go build ./pkg/driver/... - all files compile
2. go vet ./pkg/driver/... - no issues
3. events.go exports EventPoster with all required methods
4. node.go NodeServer has eventPoster field
</verification>

<success_criteria>
- EventPoster can post Warning events to PVCs
- EventPoster gracefully handles missing PVCs
- NodeServer struct has eventPoster field ready for integration
- All code compiles and passes vet
</success_criteria>

<output>
After completion, create `.planning/phases/02-stale-mount-detection/02-02-SUMMARY.md`
</output>
