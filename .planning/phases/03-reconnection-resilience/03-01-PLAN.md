---
phase: 03-reconnection-resilience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/nvme/config.go
  - pkg/driver/params.go
  - pkg/utils/retry.go
autonomous: true

must_haves:
  truths:
    - "ConnectionConfig struct holds ctrl_loss_tmo, reconnect_delay, keep_alive_tmo"
    - "ParseNVMEConnectionParams extracts parameters from StorageClass with defaults"
    - "RetryWithBackoff provides exponential backoff with jitter using k8s wait.Backoff"
  artifacts:
    - path: "pkg/nvme/config.go"
      provides: "NVMe connection configuration struct and defaults"
      exports: ["ConnectionConfig", "DefaultConnectionConfig"]
    - path: "pkg/driver/params.go"
      provides: "StorageClass parameter parsing for NVMe connection"
      exports: ["NVMEConnectionParams", "ParseNVMEConnectionParams"]
    - path: "pkg/utils/retry.go"
      provides: "Exponential backoff retry utilities"
      exports: ["RetryWithBackoff", "DefaultBackoffConfig", "IsRetryableError"]
  key_links:
    - from: "pkg/nvme/config.go"
      to: "nvme connect command"
      via: "ConnectionConfig fields map to -l, -c, -k flags"
      pattern: "CtrlLossTmo.*ReconnectDelay.*KeepAliveTmo"
    - from: "pkg/utils/retry.go"
      to: "k8s.io/apimachinery/pkg/util/wait"
      via: "wait.ExponentialBackoffWithContext"
      pattern: "wait\\.ExponentialBackoffWithContext"
---

<objective>
Create foundational types and utilities for connection resilience: ConnectionConfig for NVMe kernel parameters, StorageClass parameter parsing, and exponential backoff retry utilities.

Purpose: Enable configurable NVMe connection parameters and standardized retry logic across the driver.
Output: Three new files providing reusable configuration and retry infrastructure.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-reconnection-resilience/03-RESEARCH.md

# Existing code patterns
@pkg/nvme/nvme.go
@pkg/driver/controller.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectionConfig struct for NVMe connection parameters</name>
  <files>pkg/nvme/config.go</files>
  <action>
Create pkg/nvme/config.go with:

1. ConnectionConfig struct:
   - CtrlLossTmo int: Controller loss timeout in seconds (-1 = unlimited, 600 = kernel default)
   - ReconnectDelay int: Delay between reconnect attempts in seconds (default 5)
   - KeepAliveTmo int: Keep-alive timeout in seconds (0 = kernel default)

2. DefaultConnectionConfig() function returning:
   - CtrlLossTmo: -1 (unlimited reconnection - production best practice)
   - ReconnectDelay: 5 (5 second retry interval)
   - KeepAliveTmo: 0 (use kernel default)

3. BuildConnectArgs(target Target, config ConnectionConfig) []string method:
   - Start with standard args: connect, -t, transport, -a, address, -s, port, -n, nqn
   - Add -l flag if CtrlLossTmo != 0 (ctrl_loss_tmo)
   - Add -c flag if ReconnectDelay > 0 (reconnect_delay)
   - Add -k flag if KeepAliveTmo > 0 (keep_alive_tmo)
   - Add -q flag if HostNQN != ""

Use fmt.Sprintf for integer to string conversion. Follow existing package patterns.
  </action>
  <verify>go build ./pkg/nvme/... compiles without errors</verify>
  <done>ConnectionConfig struct exists with defaults, BuildConnectArgs produces correct nvme connect arguments</done>
</task>

<task type="auto">
  <name>Task 2: Create StorageClass parameter parsing for NVMe connection</name>
  <files>pkg/driver/params.go</files>
  <action>
Create pkg/driver/params.go with:

1. Parameter key constants (matching research):
   - paramCtrlLossTmo = "ctrlLossTmo"
   - paramReconnectDelay = "reconnectDelay"
   - paramKeepAliveTmo = "keepAliveTmo"

2. NVMEConnectionParams struct:
   - CtrlLossTmo int
   - ReconnectDelay int
   - KeepAliveTmo int

3. ParseNVMEConnectionParams(params map[string]string) (NVMEConnectionParams, error):
   - Start with defaults: CtrlLossTmo=-1, ReconnectDelay=5, KeepAliveTmo=0
   - Parse each parameter with strconv.Atoi
   - Validate: ctrl_loss_tmo >= -1, reconnect_delay > 0, keep_alive_tmo >= 0
   - Return specific error messages for invalid values
   - Use fmt.Errorf for error wrapping

4. ToVolumeContext(params NVMEConnectionParams) map[string]string:
   - Converts params to string map for inclusion in VolumeContext
   - Uses fmt.Sprintf for int to string

Follow existing driver package patterns for error handling.
  </action>
  <verify>go build ./pkg/driver/... compiles without errors</verify>
  <done>ParseNVMEConnectionParams parses and validates StorageClass parameters with correct defaults</done>
</task>

<task type="auto">
  <name>Task 3: Create exponential backoff retry utilities</name>
  <files>pkg/utils/retry.go</files>
  <action>
Create pkg/utils/retry.go with:

1. Import "k8s.io/apimachinery/pkg/util/wait" (already in dependencies via client-go)

2. DefaultBackoffConfig() wait.Backoff:
   - Steps: 5 (maximum attempts)
   - Duration: 1 * time.Second (initial delay)
   - Factor: 2.0 (exponential factor - 1s, 2s, 4s, 8s, 16s)
   - Jitter: 0.1 (10% jitter to prevent thundering herd)

3. RetryWithBackoff(ctx context.Context, backoff wait.Backoff, fn func() error) error:
   - Wraps wait.ExponentialBackoffWithContext
   - Converts fn() error to (bool, error) for wait API
   - Returns true on nil error (success)
   - Returns false, nil on retryable error (retry)
   - Returns false, err on non-retryable error (stop)
   - Use IsRetryableError to determine if error is retryable

4. IsRetryableError(err error) bool:
   - Return false if err == nil
   - Check error string (case-insensitive) for retryable patterns:
     - "connection refused"
     - "connection timeout"
     - "no route to host"
     - "network unreachable"
     - "device did not appear"
     - "i/o timeout"
   - Return true if any pattern matches
   - Use strings.Contains and strings.ToLower

Follow existing utils package patterns. Use klog.V(3) for retry logging.
  </action>
  <verify>go build ./pkg/utils/... compiles without errors</verify>
  <done>RetryWithBackoff uses wait.ExponentialBackoffWithContext with 10% jitter and proper retryable error detection</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go build ./...` compiles entire project
2. `go vet ./...` reports no issues
3. New files exist at expected paths
4. DefaultConnectionConfig returns ctrl_loss_tmo=-1, reconnect_delay=5
5. ParseNVMEConnectionParams with empty map returns defaults
6. DefaultBackoffConfig includes Jitter: 0.1
</verification>

<success_criteria>
- ConnectionConfig struct can represent all NVMe connection parameters
- BuildConnectArgs produces correct nvme CLI arguments
- ParseNVMEConnectionParams handles both valid inputs and validation errors
- RetryWithBackoff integrates with k8s wait.Backoff for exponential backoff with jitter
- IsRetryableError correctly identifies network-related transient errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-reconnection-resilience/03-01-SUMMARY.md`
</output>
