---
phase: 21-code-quality-improvements
plan: 03
type: execute
wave: 2
depends_on: ["21-01", "21-02"]
files_modified:
  - .planning/codebase/CONCERNS.md
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - "All Phase 21 code smells documented with resolution status"
    - "Deferred items have explicit rationale and future milestone"
    - "Requirements document updated with QUAL-01 through QUAL-04 status"
  artifacts:
    - path: ".planning/codebase/CONCERNS.md"
      provides: "Updated code smell documentation"
      contains: "Resolution Status"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Requirement completion status"
      contains: "QUAL-01.*Complete"
  key_links:
    - from: ".planning/codebase/CONCERNS.md"
      to: ".planning/REQUIREMENTS.md"
      via: "Code smell resolution maps to requirements"
      pattern: "QUAL-"
---

<objective>
Update documentation to reflect code smell resolutions and document any deferred items with explicit rationale.

Purpose: Complete QUAL-04 requirement by ensuring all CONCERNS.md items are either resolved or documented as deferred with clear reasoning.

Output: Updated CONCERNS.md and REQUIREMENTS.md reflecting Phase 21 work.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-code-quality-improvements/21-01-SUMMARY.md
@.planning/phases/21-code-quality-improvements/21-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CONCERNS.md with resolution status</name>
  <files>.planning/codebase/CONCERNS.md</files>
  <action>
Update the "Code Smells & Quality Issues" section in CONCERNS.md:

1. Mark "Excessive Logging in Helper Methods" as RESOLVED:
```markdown
### Excessive Logging in Helper Methods

**Status:** RESOLVED (Phase 18)

**Resolution:** Consolidated 11 nearly-identical helper methods using table-driven LogOperation helper (operationConfigs map). Reduced from 300+ lines to 47 lines. See Phase 18 summary.
```

2. Mark "Duplication in Attachment Manager Logger" as RESOLVED:
```markdown
### Duplication in Attachment Manager Logger

**Status:** RESOLVED (Phase 21-01)

**Resolution:** Replaced switch statement in LogEvent() (lines 49-69) with severityMap table lookup. Reduced cyclomatic complexity from 5 to 1, eliminated 17 lines of duplicated switch logic.
```

3. Mark "Inconsistent Error Message Format" as RESOLVED:
```markdown
### Inconsistent Error Message Format

**Status:** RESOLVED (Phase 19)

**Resolution:** Established consistent error wrapping with %w format verb (96.1% compliance). Created sentinel errors for type-safe classification. Documented patterns in CONVENTIONS.md.
```

4. Mark "Logging Verbosity Inconsistency" as RESOLVED:
```markdown
### Logging Verbosity Inconsistency

**Status:** RESOLVED (Phase 18)

**Resolution:** Audited all V(3) logs, moved intermediate steps to V(4). DeleteVolume reduced from 6 V(3) statements to 1 outcome log at V(2). V(3) eliminated from codebase.
```

5. Add "Large Package Sizes" with DEFERRED status:
```markdown
### Large Package Sizes

**Status:** DEFERRED to v0.9.0

**Issue:** pkg/driver (3552 lines), pkg/rds (1834 lines), pkg/nvme (1655 lines) exceed typical package thresholds.

**Rationale for deferral:**
- Packages have clear responsibilities aligned with CSI architecture (Controller, Node, Identity)
- Splitting would increase import complexity without clear benefit
- Current structure is well-tested with 65% coverage
- Refactoring risk outweighs maintainability benefit at current scale

**Review criteria:** Reconsider if:
- Package exceeds 5000 lines
- Adding new feature would blur responsibility boundaries
- Test coverage drops due to package complexity
```

6. Update Analysis Date at bottom to reflect Phase 21 audit.
  </action>
  <verify>grep -c "Status: RESOLVED" .planning/codebase/CONCERNS.md shows 4+ resolved items</verify>
  <done>All code smells have resolution status, deferred items have explicit rationale</done>
</task>

<task type="auto">
  <name>Task 2: Update REQUIREMENTS.md with QUAL requirement status</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
Update the Code Quality requirements section:

1. Mark QUAL-01 as complete (error handling utilities - done in Phase 19):
```markdown
- [x] **QUAL-01**: Common error handling patterns extracted into reusable utilities
```
Add note: "Completed in Phase 19 with sentinel errors and Wrap*Error helpers in pkg/utils/errors.go"

2. Mark QUAL-02 as complete (severity mapping table):
```markdown
- [x] **QUAL-02**: Duplicated switch statements for severity mapping replaced with shared table
```
Add note: "Completed in Phase 21-01 with severityMap in pkg/security/logger.go"

3. Mark QUAL-03 as deferred (package refactoring):
```markdown
- [~] **QUAL-03**: Large packages refactored for better separation of concerns
```
Add note: "Deferred to v0.9.0 - packages functional, well-tested, refactoring risk > benefit"

4. Mark QUAL-04 as complete (code smell documentation):
```markdown
- [x] **QUAL-04**: Code smells from CONCERNS.md analysis resolved or explicitly documented as deferred
```
Add note: "Completed in Phase 21-03 - all items have resolution status"

5. Update traceability table for Phase 21:
```markdown
| QUAL-01 | Phase 19 (Phase 21) | Complete |
| QUAL-02 | Phase 21 | Complete |
| QUAL-03 | Phase 21 | Deferred |
| QUAL-04 | Phase 21 | Complete |
```

6. Update coverage count to reflect partial completion.
  </action>
  <verify>grep "QUAL-0" .planning/REQUIREMENTS.md shows all requirements with status markers</verify>
  <done>REQUIREMENTS.md reflects accurate status of all QUAL requirements</done>
</task>

</tasks>

<verification>
1. `grep "Status:" .planning/codebase/CONCERNS.md` shows resolution status for all code smells
2. `grep "QUAL-0" .planning/REQUIREMENTS.md` shows all requirements marked
3. `grep "DEFERRED" .planning/codebase/CONCERNS.md` shows rationale for deferred items
</verification>

<success_criteria>
1. CONCERNS.md code smells section has Status: RESOLVED or DEFERRED for each item
2. Deferred items have explicit rationale and review criteria
3. REQUIREMENTS.md QUAL requirements updated with accurate status
4. Traceability table reflects Phase 21 coverage
</success_criteria>

<output>
After completion, create `.planning/phases/21-code-quality-improvements/21-03-SUMMARY.md`
</output>
