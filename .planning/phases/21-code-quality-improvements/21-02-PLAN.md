---
phase: 21-code-quality-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .golangci.yml
autonomous: true

must_haves:
  truths:
    - "Cyclomatic complexity linter (gocyclo or cyclop) enabled in golangci-lint"
    - "Complexity thresholds set above current max to avoid false positives"
    - "Linter passes on current codebase without complexity violations"
  artifacts:
    - path: ".golangci.yml"
      provides: "Complexity linter configuration"
      contains: "gocyclo|cyclop"
  key_links:
    - from: ".golangci.yml"
      to: "golangci-lint"
      via: "Complexity enforcement"
      pattern: "max-complexity"
---

<objective>
Configure golangci-lint with complexity metrics (gocyclo/cyclop) to prevent future complexity regression.

Purpose: Establish complexity thresholds based on current baseline (max: 44) to catch new high-complexity code while allowing existing code to pass.

Output: Updated .golangci.yml with complexity linters enabled and configured.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-code-quality-improvements/21-RESEARCH.md (lines 287-301 - complexity thresholds)
@.golangci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gocyclo and cyclop linters to golangci-lint configuration</name>
  <files>.golangci.yml</files>
  <action>
Add complexity linters to .golangci.yml:

1. Add gocyclo and cyclop to the enabled linters list under `linters.enable`:
```yaml
    # Complexity linters
    - gocyclo     # Cyclomatic complexity per function
    - cyclop      # Function and package complexity
```

2. Add linter settings section for complexity thresholds:
```yaml
  gocyclo:
    # Threshold based on current baseline (max: 44 in RecordEvent)
    # Set to 50 to allow existing code, catch new violations
    # Target: Ratchet down to 30 by v0.8, 20 by v1.0
    min-complexity: 50

  cyclop:
    # Match gocyclo threshold
    max-complexity: 50
    # Skip generated code
    skip-tests: false
```

3. Add exclusion rules for known high-complexity functions that are acceptable:
```yaml
  exclude-rules:
    # Allow high complexity in metrics recording (table-driven switch)
    - path: pkg/security/metrics.go
      linters:
        - gocyclo
        - cyclop
      text: "RecordEvent"
```

The thresholds are intentionally high (50) because:
- Current max is 44 (RecordEvent in metrics.go)
- Prevents new high-complexity code
- Allows gradual ratcheting down without breaking existing code
  </action>
  <verify>golangci-lint run --no-config --enable=gocyclo --enable=cyclop ./pkg/... shows current violations</verify>
  <done>gocyclo and cyclop linters added to .golangci.yml with appropriate thresholds</done>
</task>

<task type="auto">
  <name>Task 2: Verify linter passes on current codebase</name>
  <files>.golangci.yml</files>
  <action>
1. Run golangci-lint with new configuration:
   golangci-lint run ./pkg/...

2. Verify no complexity violations are reported

3. Document baseline for future ratcheting:
   - Current max complexity: 44 (security.RecordEvent)
   - Threshold set: 50
   - Next milestone target: 30 (v0.8)
   - Final target: 20 (v1.0)

If any violations appear, either:
- Increase threshold (if legitimate existing code)
- Add specific exclusion rule (if known acceptable exception)
  </action>
  <verify>golangci-lint run ./pkg/... exits with code 0</verify>
  <done>Linter passes cleanly with complexity linters enabled</done>
</task>

</tasks>

<verification>
1. `grep -A2 "gocyclo\|cyclop" .golangci.yml` shows linter configuration
2. `golangci-lint run ./pkg/...` passes without complexity errors
3. `golangci-lint linters | grep -E "gocyclo|cyclop"` shows linters enabled
</verification>

<success_criteria>
1. gocyclo linter enabled with threshold >= 50
2. cyclop linter enabled with matching threshold
3. golangci-lint passes on entire codebase
4. Complexity baseline documented for future ratcheting
</success_criteria>

<output>
After completion, create `.planning/phases/21-code-quality-improvements/21-02-SUMMARY.md`
</output>
