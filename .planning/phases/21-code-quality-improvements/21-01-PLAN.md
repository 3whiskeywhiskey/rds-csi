---
phase: 21-code-quality-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/security/logger.go
  - pkg/security/logger_test.go
autonomous: true

must_haves:
  truths:
    - "Severity-to-verbosity mapping uses table lookup instead of switch"
    - "LogEvent() cyclomatic complexity reduced by eliminating switch"
    - "All existing logger tests pass"
  artifacts:
    - path: "pkg/security/logger.go"
      provides: "Table-driven severity mapping"
      contains: "severityMap = map\\[EventSeverity\\]"
    - path: "pkg/security/logger_test.go"
      provides: "Tests for severity mapping"
      contains: "TestLogEvent"
  key_links:
    - from: "pkg/security/logger.go"
      to: "severityMap"
      via: "LogEvent() uses map lookup"
      pattern: "severityMap\\[event.Severity\\]"
---

<objective>
Replace the severity-to-verbosity switch statement in LogEvent() with a table-driven map lookup.

Purpose: Eliminate the remaining duplicated switch pattern identified in CONCERNS.md (lines 49-69), reducing cyclomatic complexity and improving maintainability.

Output: Refactored logger.go with map-based severity routing, all tests passing.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md (lines 120-160 - severity mapping duplication)
@pkg/security/logger.go (lines 40-81 - LogEvent method with switch)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract severity mapping to package-level map</name>
  <files>pkg/security/logger.go</files>
  <action>
Create a package-level type and map to replace the switch statement in LogEvent() (lines 49-69):

1. Add severityMapping struct above LogEvent():
```go
// severityMapping defines how a severity level maps to klog behavior
type severityMapping struct {
    verbosity klog.Level
    logFunc   func(args ...interface{})
}

// severityMap maps EventSeverity to klog verbosity and logging function
// This is a table-driven replacement for the switch in LogEvent()
var severityMap = map[EventSeverity]severityMapping{
    SeverityInfo:     {verbosity: 2, logFunc: func(args ...interface{}) { klog.V(2).Info(args...) }},
    SeverityWarning:  {verbosity: 1, logFunc: klog.Warning},
    SeverityError:    {verbosity: 0, logFunc: klog.Error},
    SeverityCritical: {verbosity: 0, logFunc: klog.Error},
}
```

2. Replace the switch in LogEvent() (lines 49-69) with:
```go
// Look up severity mapping (default to Info if unknown)
mapping, ok := severityMap[event.Severity]
if !ok {
    mapping = severityMap[SeverityInfo]
}
logFunc := mapping.logFunc
```

3. Remove the unused `verbosity` variable declaration since it's only used in the switch.

The switch (21 lines) becomes a map lookup (4 lines), reducing cyclomatic complexity from 5 to 1 in this section.
  </action>
  <verify>go build ./pkg/security/... compiles without errors</verify>
  <done>severityMap exists at package level, LogEvent() uses map lookup instead of switch</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for severity mapping edge cases</name>
  <files>pkg/security/logger_test.go</files>
  <action>
Add a test to verify severity mapping behavior for all cases:

```go
func TestLogEventSeverityMapping(t *testing.T) {
    // Test that all defined severities are handled
    testCases := []struct {
        name     string
        severity EventSeverity
    }{
        {"Info", SeverityInfo},
        {"Warning", SeverityWarning},
        {"Error", SeverityError},
        {"Critical", SeverityCritical},
        {"Unknown", EventSeverity("unknown")}, // Should default to Info behavior
    }

    logger := NewLogger()
    for _, tc := range testCases {
        t.Run(tc.name, func(t *testing.T) {
            event := NewSecurityEvent(
                EventSSHConnectionAttempt,
                CategoryAuthentication,
                tc.severity,
                "test message",
            )
            // Should not panic - verifies map lookup handles all cases
            logger.LogEvent(event)
        })
    }
}
```

This test verifies:
- All known severities are handled
- Unknown severity defaults gracefully (no panic, uses Info)
  </action>
  <verify>go test ./pkg/security/... -run TestLogEventSeverityMapping passes</verify>
  <done>TestLogEventSeverityMapping exists and passes, covering all severity values including unknown</done>
</task>

<task type="auto">
  <name>Task 3: Verify all existing tests pass and measure complexity reduction</name>
  <files>pkg/security/logger.go, pkg/security/logger_test.go</files>
  <action>
1. Run full test suite for security package:
   go test ./pkg/security/... -v

2. Verify no regressions in existing functionality

3. Document complexity reduction:
   - Before: switch with 5 cases (cyclomatic complexity contribution: 5)
   - After: map lookup with if/else (cyclomatic complexity contribution: 1)
   - Lines reduced: 21 -> 4 (17 lines saved)

4. Run linter to verify no new issues:
   golangci-lint run ./pkg/security/...
  </action>
  <verify>All tests pass, golangci-lint reports no errors</verify>
  <done>Test suite passes, complexity reduced, linter clean</done>
</task>

</tasks>

<verification>
1. `go test ./pkg/security/... -v` passes all tests
2. `grep -n "severityMap\[" pkg/security/logger.go` shows map lookup usage
3. `grep -c "case Severity" pkg/security/logger.go` returns 0 (no switch cases)
4. `golangci-lint run ./pkg/security/...` reports no errors
</verification>

<success_criteria>
1. severityMap defined at package level with all severity mappings
2. LogEvent() uses map lookup instead of switch statement
3. All existing security package tests pass
4. New test covers severity mapping edge cases
5. Lines of code in LogEvent() reduced by ~17 lines
</success_criteria>

<output>
After completion, create `.planning/phases/21-code-quality-improvements/21-01-SUMMARY.md`
</output>
