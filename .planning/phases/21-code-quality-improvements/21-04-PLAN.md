---
phase: 21-code-quality-improvements
plan: 04
type: execute
wave: 2
depends_on: ["21-01", "21-02"]
files_modified:
  - .planning/STATE.md
  - .planning/ROADMAP.md
autonomous: true

must_haves:
  truths:
    - "STATE.md reflects Phase 21 completion"
    - "ROADMAP.md Phase 21 marked complete with all plans checked"
    - "v0.7.1 milestone marked as shipped"
  artifacts:
    - path: ".planning/STATE.md"
      provides: "Updated project state"
      contains: "Phase: 21 of 21"
    - path: ".planning/ROADMAP.md"
      provides: "Updated roadmap"
      contains: "21-01-PLAN.md.*\\[x\\]"
  key_links:
    - from: ".planning/STATE.md"
      to: ".planning/ROADMAP.md"
      via: "Phase completion status"
      pattern: "Phase 21.*complete"
---

<objective>
Finalize Phase 21 and mark v0.7.1 milestone complete.

Purpose: Update project state to reflect completion of the Code Quality and Logging Cleanup milestone, preparing for the next development cycle.

Output: Updated STATE.md and ROADMAP.md with Phase 21 complete and v0.7.1 shipped.
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-code-quality-improvements/21-01-SUMMARY.md
@.planning/phases/21-code-quality-improvements/21-02-SUMMARY.md
@.planning/phases/21-code-quality-improvements/21-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update STATE.md with Phase 21 completion</name>
  <files>.planning/STATE.md</files>
  <action>
Update STATE.md to reflect Phase 21 completion:

1. Update Current Position section:
```markdown
## Current Position

Phase: 21 of 21 (Code Quality Improvements)
Plan: 4 of 4 complete
Status: Phase complete - code quality milestone shipped
Last activity: [DATE] - Completed Phase 21 with 4 plans, v0.7.1 shipped
```

2. Update Progress bar to 100%:
```markdown
Progress: [████████████████████████████████████] 100% (79/79 total plans across all phases)
```

3. Update Performance Metrics:
```markdown
| v0.7.1 Code Quality and Logging Cleanup | 17-21 | 20/20 | Shipped [DATE] |
```

4. Add Phase 21 decisions to Accumulated Context:
```markdown
- Phase 21 (DATE): **Code quality improvements complete with complexity enforcement**
  - Severity mapping switch replaced with table-driven severityMap lookup
  - golangci-lint configured with gocyclo/cyclop at threshold 50 (baseline: 44)
  - All CONCERNS.md code smells resolved or deferred with rationale
  - Large package refactoring deferred to v0.9.0 (risk > benefit)
  - Impact: Codebase maintainability improved, complexity regression prevented
```

5. Update Session Continuity:
```markdown
## Session Continuity

Last session: [DATE]
Stopped at: Completed 21-04-PLAN.md (milestone finalization) - v0.7.1 complete
Resume file: None
Next action: Plan next milestone or release v0.7.1
```
  </action>
  <verify>grep "Phase: 21 of 21" .planning/STATE.md shows correct phase number</verify>
  <done>STATE.md updated with Phase 21 completion and v0.7.1 shipped status</done>
</task>

<task type="auto">
  <name>Task 2: Update ROADMAP.md to mark Phase 21 complete and v0.7.1 shipped</name>
  <files>.planning/ROADMAP.md</files>
  <action>
Update ROADMAP.md:

1. Update milestone status at top:
```markdown
- ✅ **v0.7.1 Code Quality and Logging Cleanup** - Phases 17-21 (shipped [DATE])
```

2. Update Phase 21 section:
```markdown
### Phase 21: Code Quality Improvements

**Goal**: Extract common patterns and resolve documented code smells

**Depends on**: Phase 20

**Requirements**: QUAL-01, QUAL-02, QUAL-03, QUAL-04

**Success Criteria** (what must be TRUE):
1. ✅ Common error handling patterns extracted into pkg/utils/errors.go
2. ✅ Duplicated severity mapping switch statements replaced with shared table
3. ~~ Large packages refactored for better separation of concerns (deferred v0.9.0)
4. ✅ All code smells from CONCERNS.md either resolved or explicitly documented as deferred
5. ✅ Codebase maintainability score improved (measured by golangci-lint complexity metrics)

**Plans**: 4 plans

Plans:
- [x] 21-01-PLAN.md — Replace severity switch with table-driven severityMap
- [x] 21-02-PLAN.md — Configure complexity metrics in golangci-lint
- [x] 21-03-PLAN.md — Update CONCERNS.md and REQUIREMENTS.md documentation
- [x] 21-04-PLAN.md — Finalize phase and ship v0.7.1 milestone
```

3. Update Progress table:
```markdown
| 21. Code Quality Improvements | v0.7.1 | 4/4 | Complete | [DATE] |
```

4. Update timestamp at bottom:
```markdown
_Last updated: [DATE] (Phase 21 complete - v0.7.1 shipped)_
```
  </action>
  <verify>grep "21-01-PLAN.md.*\[x\]" .planning/ROADMAP.md shows plan marked complete</verify>
  <done>ROADMAP.md updated with Phase 21 complete and v0.7.1 milestone shipped</done>
</task>

<task type="auto">
  <name>Task 3: Verify all tests pass and commit milestone</name>
  <files></files>
  <action>
1. Run full test suite to verify no regressions:
   make test

2. Run linter to verify no issues:
   make lint

3. Verify coverage enforcement passes:
   make test-coverage-check

4. Create milestone commit:
   git add -A
   git commit -m "docs(21): complete code quality improvements phase

Phase 21: Code Quality Improvements
- Replaced severity switch with table-driven severityMap lookup
- Configured gocyclo/cyclop complexity linters (threshold: 50)
- Updated CONCERNS.md with resolution status for all items
- Package refactoring deferred to v0.9.0 (risk > benefit)

Milestone v0.7.1 shipped:
- Phases 17-21 complete (20 plans)
- Test infrastructure fixed
- Logging noise reduced
- Error handling standardized
- Test coverage at 65% with enforcement
- Complexity metrics enforced"

5. Push to dev branch:
   git push origin dev
  </action>
  <verify>git log -1 --oneline shows milestone commit</verify>
  <done>Milestone committed and pushed, v0.7.1 complete</done>
</task>

</tasks>

<verification>
1. `make test` passes all tests
2. `make lint` reports no errors
3. `grep "v0.7.1.*shipped" .planning/ROADMAP.md` shows milestone complete
4. `git log -1` shows milestone commit
</verification>

<success_criteria>
1. STATE.md shows Phase 21 of 21 complete
2. ROADMAP.md v0.7.1 milestone marked shipped
3. All tests pass
4. Linter passes with complexity metrics
5. Milestone committed and pushed
</success_criteria>

<output>
After completion, create `.planning/phases/21-code-quality-improvements/21-04-SUMMARY.md`
</output>
