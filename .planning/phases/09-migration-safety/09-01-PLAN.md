---
phase: 09-migration-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/attachment/types.go
  - pkg/attachment/manager.go
  - pkg/driver/controller.go
  - pkg/driver/params.go
autonomous: true

must_haves:
  truths:
    - "AttachmentState tracks migration start time for dual-attach scenarios"
    - "StorageClass parameter migrationTimeoutSeconds is parsed and validated"
    - "Secondary attachment records migration timestamp automatically"
    - "Default migration timeout is 5 minutes (300 seconds)"
  artifacts:
    - path: "pkg/attachment/types.go"
      provides: "MigrationStartedAt and MigrationTimeout fields in AttachmentState"
      contains: "MigrationStartedAt"
    - path: "pkg/attachment/manager.go"
      provides: "Migration tracking in AddSecondaryAttachment"
      contains: "MigrationStartedAt"
    - path: "pkg/driver/params.go"
      provides: "ParseMigrationTimeout function"
      contains: "migrationTimeoutSeconds"
  key_links:
    - from: "pkg/driver/controller.go"
      to: "pkg/driver/params.go"
      via: "ParseMigrationTimeout call in ControllerPublishVolume"
      pattern: "ParseMigrationTimeout"
    - from: "pkg/attachment/manager.go"
      to: "pkg/attachment/types.go"
      via: "MigrationStartedAt field assignment"
      pattern: "MigrationStartedAt.*=.*time\\.Now"
---

<objective>
Extend AttachmentState to track migration timing and parse configurable timeout from StorageClass

Purpose: Enable migration-specific timeout tracking so Phase 9 Plan 2 can distinguish migration dual-attach from RWO conflicts
Output: AttachmentState with migration fields, ParseMigrationTimeout helper, AddSecondaryAttachment records migration start
</objective>

<execution_context>
@/Users/whiskey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/whiskey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.5-ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-migration-safety/09-RESEARCH.md
@.planning/phases/08-core-rwx-capability/08-02-SUMMARY.md

# Key existing code
@pkg/attachment/types.go
@pkg/attachment/manager.go
@pkg/driver/params.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AttachmentState with migration tracking fields</name>
  <files>pkg/attachment/types.go</files>
  <action>
Add two new fields to the AttachmentState struct:

```go
// MigrationStartedAt is when dual-attach began (secondary node attached).
// nil if not currently in migration state. Used for timeout calculation.
MigrationStartedAt *time.Time

// MigrationTimeout is the maximum duration allowed for migration dual-attach.
// Parsed from StorageClass parameter migrationTimeoutSeconds.
// Zero value means use default (5 minutes).
MigrationTimeout time.Duration
```

Add these fields after the existing AccessMode field to keep related state together.

Add a helper method to check if migration is active:
```go
// IsMigrating returns true if volume is in dual-attach migration state.
func (as *AttachmentState) IsMigrating() bool {
    return as.MigrationStartedAt != nil && len(as.Nodes) > 1
}
```

Add a helper method to check if migration has exceeded timeout:
```go
// IsMigrationTimedOut returns true if migration exceeded configured timeout.
// Returns false if not migrating or timeout is zero (disabled).
func (as *AttachmentState) IsMigrationTimedOut() bool {
    if as.MigrationStartedAt == nil || as.MigrationTimeout == 0 {
        return false
    }
    return time.Since(*as.MigrationStartedAt) > as.MigrationTimeout
}
```
  </action>
  <verify>grep -n "MigrationStartedAt" pkg/attachment/types.go shows the new field</verify>
  <done>AttachmentState has MigrationStartedAt, MigrationTimeout fields and IsMigrating(), IsMigrationTimedOut() helpers</done>
</task>

<task type="auto">
  <name>Task 2: Add ParseMigrationTimeout to params.go</name>
  <files>pkg/driver/params.go</files>
  <action>
Add a new function to parse and validate migration timeout from StorageClass parameters:

```go
const (
    // Default migration timeout (5 minutes)
    DefaultMigrationTimeout = 5 * time.Minute
    // Minimum allowed timeout (30 seconds - anything less is unrealistic)
    MinMigrationTimeout = 30 * time.Second
    // Maximum allowed timeout (1 hour - prevent indefinite dual-attach)
    MaxMigrationTimeout = 1 * time.Hour
)

// ParseMigrationTimeout extracts and validates migrationTimeoutSeconds from parameters.
// Returns DefaultMigrationTimeout if not specified or invalid.
// Clamps value to [MinMigrationTimeout, MaxMigrationTimeout] range.
func ParseMigrationTimeout(params map[string]string) time.Duration {
    timeoutStr, ok := params["migrationTimeoutSeconds"]
    if !ok || timeoutStr == "" {
        return DefaultMigrationTimeout
    }

    seconds, err := strconv.Atoi(timeoutStr)
    if err != nil {
        klog.Warningf("Invalid migrationTimeoutSeconds '%s' (not an integer), using default %v",
            timeoutStr, DefaultMigrationTimeout)
        return DefaultMigrationTimeout
    }

    if seconds <= 0 {
        klog.Warningf("Invalid migrationTimeoutSeconds '%d' (must be positive), using default %v",
            seconds, DefaultMigrationTimeout)
        return DefaultMigrationTimeout
    }

    timeout := time.Duration(seconds) * time.Second

    // Clamp to valid range
    if timeout < MinMigrationTimeout {
        klog.Warningf("migrationTimeoutSeconds %v too short (min %v), using minimum",
            timeout, MinMigrationTimeout)
        return MinMigrationTimeout
    }

    if timeout > MaxMigrationTimeout {
        klog.Warningf("migrationTimeoutSeconds %v too long (max %v), using maximum",
            timeout, MaxMigrationTimeout)
        return MaxMigrationTimeout
    }

    return timeout
}
```

Add required imports: "strconv", "time", "k8s.io/klog/v2"
  </action>
  <verify>grep -n "ParseMigrationTimeout" pkg/driver/params.go shows the new function</verify>
  <done>ParseMigrationTimeout function parses and validates migrationTimeoutSeconds with range clamping</done>
</task>

<task type="auto">
  <name>Task 3: Update AddSecondaryAttachment to track migration</name>
  <files>pkg/attachment/manager.go</files>
  <action>
Modify AddSecondaryAttachment to:
1. Accept migrationTimeout as a parameter
2. Record MigrationStartedAt timestamp when secondary attachment is added

Update function signature:
```go
// AddSecondaryAttachment adds a second node attachment for RWX volumes during migration.
// Records migration start time for timeout tracking.
// Returns error if volume not attached, not RWX, or already has 2 nodes.
func (am *AttachmentManager) AddSecondaryAttachment(ctx context.Context, volumeID, nodeID string, migrationTimeout time.Duration) error {
```

Inside the function, after appending the new NodeAttachment, add:
```go
    // Track migration start time for timeout enforcement
    now := time.Now()
    existing.MigrationStartedAt = &now
    existing.MigrationTimeout = migrationTimeout

    klog.V(2).Infof("Tracked secondary attachment: volume=%s, node=%s, timeout=%v (migration target)",
        volumeID, nodeID, migrationTimeout)
```

Also add a method to clear migration state when migration completes:
```go
// ClearMigrationState clears migration tracking fields.
// Called when source node detaches, completing migration.
func (am *AttachmentManager) ClearMigrationState(volumeID string) {
    am.mu.Lock()
    defer am.mu.Unlock()

    if state, exists := am.attachments[volumeID]; exists {
        state.MigrationStartedAt = nil
        state.MigrationTimeout = 0
    }
}
```

Update RemoveNodeAttachment to clear migration state when removing the primary node (index 0) since that indicates migration completion:
```go
    // If removing primary node (migration source), clear migration state
    // Primary was index 0, so if the removed node was at index 0 before removal, migration completed
    if found && len(newNodes) == 1 {
        // Down to 1 node - migration completed, clear migration state
        existing.MigrationStartedAt = nil
        existing.MigrationTimeout = 0
        klog.V(2).Infof("Migration completed for volume %s, cleared migration state", volumeID)
    }
```
  </action>
  <verify>grep -n "MigrationStartedAt" pkg/attachment/manager.go shows migration tracking in AddSecondaryAttachment</verify>
  <done>AddSecondaryAttachment accepts timeout param and records migration start; RemoveNodeAttachment clears migration on completion</done>
</task>

</tasks>

<verification>
1. `go build ./...` - code compiles
2. `make test` - existing tests pass (may need minor updates)
3. Verify AttachmentState has new fields: grep "MigrationStartedAt" pkg/attachment/types.go
4. Verify ParseMigrationTimeout exists: grep "ParseMigrationTimeout" pkg/driver/params.go
5. Verify AddSecondaryAttachment tracks migration: grep "MigrationStartedAt" pkg/attachment/manager.go
</verification>

<success_criteria>
- AttachmentState struct has MigrationStartedAt (*time.Time) and MigrationTimeout (time.Duration) fields
- IsMigrating() and IsMigrationTimedOut() helper methods exist and work correctly
- ParseMigrationTimeout correctly parses "migrationTimeoutSeconds" from params with validation
- AddSecondaryAttachment requires migrationTimeout parameter and sets migration tracking fields
- RemoveNodeAttachment clears migration state when migration completes (down to 1 node)
- All existing tests pass (or are updated to use new signature)
</success_criteria>

<output>
After completion, create `.planning/phases/09-migration-safety/09-01-SUMMARY.md`
</output>
