---
milestone: v0.7.0
audited: 2026-02-04T06:35:00Z
status: gaps_found
scores:
  requirements: 3/4
  phases: 1/2
  integration: 10/11
  flows: 3/4
gaps:
  requirements:
    - VAL-03: Migration metrics not recorded (SetMetrics never called)
  integration:
    - AttachmentManager.SetMetrics() never wired during driver initialization
  flows:
    - Migration metrics recording broken (am.metrics is nil)
tech_debt: []
---

# Milestone v0.7.0 Audit Report

**Milestone Goal:** Use Kubernetes VolumeAttachment objects as source of truth for attachment state and complete migration metrics observability

**Audited:** 2026-02-04T06:35:00Z
**Status:** GAPS FOUND
**Overall Assessment:** Phase 15 is production-ready and fully integrated. Phase 16 is functionally complete but has one critical missing wire preventing metrics recording.

## Executive Summary

### Phase Completion

| Phase | Plans | Status | Result |
|-------|-------|--------|--------|
| 15: VolumeAttachment-Based State Rebuild | 4/4 | Complete | ✅ PASS |
| 16: Migration Metrics Emission | 0/3 | Planned | ❌ NOT STARTED |

### Requirements Coverage

| Requirement | Description | Status | Evidence |
|------------|-------------|--------|----------|
| ATTACH-01 | VolumeAttachment is source of truth | ✅ SATISFIED | rebuild.go:205-214 lists VAs, annotations in deprecated function only |
| ATTACH-02 | Grace period still works | ✅ SATISFIED | rebuild.go:175-184 detects migration from multiple VAs |
| ATTACH-03 | PV annotations are informational | ✅ SATISFIED | 7 "informational" comments, never read during rebuild |
| ATTACH-04 | No stale state possible | ✅ SATISFIED | Test proves: No VA = no state, even with annotation present |
| VAL-03 | Migration metrics emission | ❌ UNSATISFIED | Metrics framework complete but SetMetrics never called |

**Score:** 4/5 requirements satisfied (80%)

### Integration Quality

**Connected Exports:** 10/11
**Orphaned Exports:** 0
**Missing Wires:** 1 (critical)
**Broken Flows:** 1 (migration metrics)

**Integration Score:** 10/11 (91%)

## Phase 15: VolumeAttachment-Based State Rebuild

### Status: ✅ COMPLETE AND PRODUCTION-READY

**Goal:** Controller rebuilds attachment state from VolumeAttachment objects instead of PV annotations

**Plans:**
- ✅ 15-01: VolumeAttachment listing helpers (2 min)
- ✅ 15-02: Rebuild state from VolumeAttachments (96 sec)
- ✅ 15-03: PV annotations informational-only documentation (2 min)
- ✅ 15-04: Comprehensive testing (3 min 21 sec)

**Total Duration:** ~8 minutes

### Success Criteria Verification

| Criterion | Status | Evidence |
|-----------|--------|----------|
| 1. VolumeAttachment is source of truth | ✅ VERIFIED | On startup, controller lists VAs and rebuilds state (rebuild.go:205-214) |
| 2. Grace period still works | ✅ VERIFIED | Multiple VAs detected → migration state (rebuild.go:175-184) |
| 3. PV annotations are informational | ✅ VERIFIED | 7 comments clarify write-only, never read in RebuildStateFromVolumeAttachments |
| 4. No stale state possible | ✅ VERIFIED | Test: NoVAButHasAnnotation with annotation but no VA → state empty |
| 5. Backward compatible | ✅ VERIFIED | Test: IgnoresStaleAnnotations proves VA wins over stale annotation |

**All 5 success criteria met.**

### Integration Verification

**E2E Flow 1: Controller Startup → VA-Based Rebuild**

```
1. cmd/rds-csi-plugin/main.go creates Driver
   ✅ Verified

2. Driver.Run() creates AttachmentManager
   ✅ driver.go:186-188

3. Driver.Run() calls Initialize()
   ✅ driver.go:378

4. Initialize() calls RebuildStateFromVolumeAttachments()
   ✅ rebuild.go:243

5. Lists/filters/groups VolumeAttachments
   ✅ rebuild.go:205-214 uses all 15-01 helpers

6. Rebuilds AttachmentState with AccessMode lookup
   ✅ rebuild.go:224, lookupAccessMode at line 144

7. Controller ready to serve RPCs
   ✅ Verified by TestAttachmentManager_RebuildState
```

**Status:** ✅ COMPLETE - All 7 steps verified

**E2E Flow 2: Migration Detection from Dual VAs**

```
1. Controller restarts with 2 VAs for same volume
   ✅ Simulated in test

2. GroupVolumeAttachmentsByVolume groups both VAs
   ✅ va_lister.go:49-64

3. rebuildVolumeState receives 2 VAs
   ✅ rebuild.go:132-188

4. Creates 2 NodeAttachment entries
   ✅ rebuild.go:147-164

5. Detects len(vas) > 1 → sets MigrationStartedAt
   ✅ rebuild.go:175-184

6. State includes migration metadata
   ✅ Test: TestRebuildStateFromVolumeAttachments_MigrationState
```

**Status:** ✅ COMPLETE - Migration state survives restarts

**E2E Flow 3: Stale Annotations Ignored**

```
1. PV has annotation: "node-1"
2. VolumeAttachment says: "node-2"
3. RebuildStateFromVolumeAttachments never reads annotations
   ✅ rebuild.go:196-235 has NO annotation access
4. State uses node-2 (from VA)
   ✅ Test: IgnoresStaleAnnotations
5. Annotation mismatch has no effect
   ✅ Proven by test assertions
```

**Status:** ✅ COMPLETE - Annotations provably ignored

### Test Coverage

**Overall:** 84.5%
**Critical Functions:**
- RebuildState: 100.0%
- rebuildVolumeState: 95.8%
- lookupAccessMode: 90.0%
- RebuildStateFromVolumeAttachments: 86.4%
- Initialize: 80.0%

**Test Count:** 14 comprehensive tests
- 5 basic rebuild scenarios
- 4 migration detection tests
- 4 backward compatibility tests
- 1 manager integration test (fixed)

**All 37 tests in pkg/attachment/ passing.**

### Key Artifacts

| Artifact | LOC | Status | Purpose |
|----------|-----|--------|---------|
| va_lister.go | 65 | ✅ Complete | VolumeAttachment listing/filtering/grouping |
| va_lister_test.go | 259 | ✅ Complete | Edge case coverage for listing helpers |
| rebuild.go | 250 | ✅ Complete | VA-based state rebuild (authoritative) |
| rebuild_test.go | 546 | ✅ Complete | 14 comprehensive tests |
| persist.go | 148 | ✅ Updated | Write-only annotations (informational) |

### Commits

```
3885862 feat(15-01): add VolumeAttachment listing helpers
07eff11 test(15-01): add unit tests for VolumeAttachment listing helpers
012a21f feat(15-02): add RebuildStateFromVolumeAttachments function
0cdeacb refactor(15-02): wire Initialize to use VA-based rebuild
a62f33b docs(15-03): document PV annotations as informational-only
1c655a9 docs(15-03): update manager.go comments for VA authority
ccbf2f4 test(15-04): add basic VA-based rebuild test scenarios
0645e92 test(15-04): add migration detection tests for VA-based rebuild
3f72d9e test(15-04): add backward compatibility tests for stale annotations
f4d6eee fix(15-04): update manager_test to use VolumeAttachment objects
```

**Total:** 10 atomic commits across 4 plans

### Anti-Patterns Found

**None.** Clean implementation:
- No TODOs in critical paths
- No placeholder content
- No empty implementations
- Deprecated function properly marked

### Phase 15 Conclusion

✅ **PRODUCTION READY**

Phase 15 achieves all stated goals:
- VolumeAttachment objects are now authoritative source of truth
- PV annotations are informational-only (debugging aid)
- Migration state detection survives controller restarts
- Stale annotation bugs eliminated by design
- Comprehensive test coverage with all tests passing

**Recommendation:** Phase 15 changes can be deployed to production immediately.

---

## Phase 16: Migration Metrics Emission

### Status: ⚠️ NOT STARTED (PARTIAL FRAMEWORK EXISTS)

**Goal:** Populate migration metrics to enable observability of KubeVirt live migrations

**Plans:**
- ❌ 16-01: Wire PostMigrationCompleted in ControllerUnpublishVolume (not started)
- ❌ 16-02: Add migration detection logic and metric population (not started)
- ❌ 16-03: Testing with simulated and real KubeVirt migrations (not started)

**Status:** 0/3 plans executed

### What Exists (Unplanned)

**Metrics Framework (from Phase 10):**
- ✅ Metric definitions (prometheus.go:208-231)
  - `rds_csi_migration_migrations_total{result="success|failed|timeout"}`
  - `rds_csi_migration_duration_seconds` (histogram)
  - `rds_csi_migration_active_migrations` (gauge)

- ✅ Recording methods (prometheus.go:374-387)
  - `RecordMigrationStarted()` - increments active gauge
  - `RecordMigrationResult(result, duration)` - increments counter, records duration

- ✅ Call sites in AttachmentManager (from Phase 9)
  - manager.go:151: `RecordMigrationStarted()` called in AddSecondaryAttachment
  - manager.go:370: `RecordMigrationResult("success")` called in RemoveNodeAttachment
  - controller.go:549: `RecordMigrationResult("timeout")` called on timeout

- ✅ Tests (prometheus_test.go:500-614)
  - TestRecordMigrationStarted
  - TestRecordMigrationResult_Success
  - TestRecordMigrationResult_Timeout

### Critical Gap: Missing Wire

**Location:** `/Users/whiskey/code/rds-csi/pkg/driver/driver.go:186-188`

**Current code:**
```go
driver.attachmentManager = attachment.NewAttachmentManager(config.K8sClient)
klog.Info("Attachment manager created")
```

**Missing line:**
```go
driver.attachmentManager = attachment.NewAttachmentManager(config.K8sClient)
if config.Metrics != nil {
    driver.attachmentManager.SetMetrics(config.Metrics)  // ← NEVER CALLED
}
klog.Info("Attachment manager created")
```

**Impact:**
- `am.metrics` is nil at runtime
- Guard clauses prevent metric recording: `if am.metrics != nil`
- All `RecordMigration*()` calls become no-ops
- Migration functionality works, but observability is broken

**Evidence:**
```bash
# Search for SetMetrics calls to AttachmentManager
$ grep -r "attachmentManager.*SetMetrics" pkg/
# Result: No matches found

# Verify SetMetrics method exists
$ grep "func.*SetMetrics" pkg/attachment/manager.go
# Result: func (am *AttachmentManager) SetMetrics(metrics *observability.Metrics)
```

### Broken E2E Flow

**Flow: Migration Metrics Recording**

```
1. KubeVirt starts migration
   ✅ Works

2. ControllerPublishVolume receives second attach
   ✅ Works

3. AddSecondaryAttachment called
   ✅ Works

4. RecordMigrationStarted called
   ❌ BROKEN: am.metrics is nil, guard clause prevents execution

5. active_migrations gauge increments
   ❌ BROKEN: Never happens

6. Migration completes, ControllerUnpublishVolume called
   ✅ Works

7. RemoveNodeAttachment detects transition from 2→1 nodes
   ✅ Works

8. RecordMigrationResult("success") called
   ❌ BROKEN: am.metrics is nil, guard clause prevents execution

9. migrations_total increments
   ❌ BROKEN: Never happens

10. migration_duration_seconds recorded
    ❌ BROKEN: Never happens
```

**Broken at:** Steps 4, 5, 8, 9, 10
**Root cause:** SetMetrics never called during initialization

### Requirements Coverage

| Requirement | Status | Evidence |
|-------------|--------|----------|
| PostMigrationCompleted called | ⚠️ PARTIAL | Event posted (controller.go:792) but NOT a metric |
| migrations_total increments | ❌ BROKEN | RecordMigrationResult exists but metrics=nil |
| migration_duration_seconds recorded | ❌ BROKEN | Same root cause - SetMetrics never called |
| Metrics queryable in Prometheus | ❌ BROKEN | Metrics registered but never updated (always zero) |

**Note:** PostMigrationCompleted is a Kubernetes **event** (for kubectl describe), not a Prometheus metric. The event works correctly. The **metrics** recording is broken.

### Why This Wasn't Caught

1. **Unit tests don't verify wiring**
   - manager_test.go:922 creates AttachmentManager without metrics
   - Tests verify state changes, not metric recording
   - prometheus_test.go tests metrics methods in isolation

2. **No integration test**
   - No test exercises full path: driver init → migration → metrics check
   - Would require checking am.metrics != nil after initialization

3. **Historical context**
   - AttachmentManager created in Phase 5/6 (before metrics framework)
   - Migration metrics added in Phase 10
   - SetMetrics method added but wiring step missed

### Impact Analysis

**Functional Impact:**
- ✅ Migration **functionality** works correctly
  - Dual-attach during migration works
  - Timeout detection works
  - State cleanup works
  - Migration state survives restarts (Phase 15)

- ❌ Migration **observability** is broken
  - No visibility into migration count
  - No visibility into migration duration
  - No alerting on migration failures/timeouts
  - Operators must rely on KubeVirt's platform metrics

**Workaround:**
- KubeVirt emits its own migration metrics at platform level
- RDS CSI driver metrics would provide volume-level detail
- Not critical for operation but reduces observability

### Phase 16 Conclusion

❌ **GAP FOUND - OBSERVABILITY BROKEN**

**Status:** Phase 16 functionally complete but observability broken due to missing wire.

**One-line fix available:**
```go
// File: pkg/driver/driver.go:188
driver.attachmentManager.SetMetrics(config.Metrics)
```

**Recommendation:** Either fix immediately (2 minutes) or defer to v0.7.1 and document as known limitation.

---

## Cross-Phase Integration

### Wiring Summary

**Total Exports:** 11
**Connected:** 10 (91%)
**Orphaned:** 0 (0%)
**Missing Wires:** 1 (9%)

### Connected Exports (10)

1. **ListDriverVolumeAttachments** → Called by RebuildStateFromVolumeAttachments (rebuild.go:205)
2. **FilterAttachedVolumeAttachments** → Called by RebuildStateFromVolumeAttachments (rebuild.go:211)
3. **GroupVolumeAttachmentsByVolume** → Called by RebuildStateFromVolumeAttachments (rebuild.go:214)
4. **RebuildStateFromVolumeAttachments** → Called by Initialize (rebuild.go:243)
5. **rebuildVolumeState** → Called by RebuildStateFromVolumeAttachments (rebuild.go:224)
6. **lookupAccessMode** → Called by rebuildVolumeState (rebuild.go:144)
7. **Initialize** → Called by Driver.Run (driver.go:378)
8. **persistAttachment** → Called by TrackAttachmentWithMode (manager.go:102) - write-only
9. **clearAttachment** → Called by UntrackAttachment, RemoveNodeAttachment (manager.go:188, 351) - write-only
10. **RebuildStateFromAnnotations** → Deprecated, used only in backward compatibility tests

### Missing Wires (1)

❌ **AttachmentManager.SetMetrics() never called**
- Expected: Driver initialization wires metrics to AttachmentManager
- Actual: SetMetrics method exists but never invoked
- Impact: Migration metrics recording broken
- Fix: Add one line in driver.go:188

### Integration Health

**Phase 15 Integration:** ✅ EXCELLENT
- All exports properly wired
- All E2E flows complete
- No orphaned code
- Test coverage validates behavior

**Phase 16 Integration:** ❌ BROKEN
- Metrics framework complete
- Call sites exist
- Critical wire missing (SetMetrics)
- Tests verify methods but not integration

---

## Milestone Definition of Done

**From ROADMAP.md:**

> Use Kubernetes VolumeAttachment objects as source of truth for attachment state and complete migration metrics observability

### Decomposition

**Part 1: VolumeAttachment as source of truth**
- ✅ ACHIEVED by Phase 15
- Controller rebuilds from VAs, not annotations
- Stale state bug eliminated by design
- Production-ready

**Part 2: Complete migration metrics observability**
- ❌ NOT ACHIEVED by Phase 16
- Metrics framework exists but not wired
- Migration functionality works but metrics always zero
- One-line fix available

### Milestone Achievement

**Score:** 50% (1/2 goals achieved)

**Status:** Partially achieved - Phase 15 complete, Phase 16 has critical gap

---

## Gap Analysis

### Critical Gaps (Blockers)

**1. VAL-03: Migration Metrics Not Recorded**

**Description:** AttachmentManager.SetMetrics() is never called during driver initialization, causing all migration metric recording to be silently skipped.

**Impact:**
- Operators have no visibility into migration count
- No alerting on migration failures/timeouts
- No duration metrics for performance analysis
- Reduces confidence in migration stability

**Affected Flow:** Migration metrics recording (E2E flow 4)

**Owning Phase:** Phase 16 (planned but not started)

**Root Cause:** SetMetrics method added in Phase 10 but wiring step missed during driver initialization refactoring

**Fix Complexity:** TRIVIAL (1 line, 2 minutes)

**Fix Location:** `/Users/whiskey/code/rds-csi/pkg/driver/driver.go:188`

**Proposed Fix:**
```go
driver.attachmentManager = attachment.NewAttachmentManager(config.K8sClient)
if config.Metrics != nil {
    driver.attachmentManager.SetMetrics(config.Metrics)  // ← ADD THIS LINE
}
klog.Info("Attachment manager created")
```

**Testing Required:**
- Unit test: Verify SetMetrics is called with non-nil config.Metrics
- Integration test: Trigger migration, verify migrations_total > 0

**Alternative:** Document as known limitation, defer to v0.7.1

---

## Recommendations

### Option 1: Fix Gap and Complete v0.7.0 (RECOMMENDED)

**Actions:**
1. Add SetMetrics wire in driver.go:188 (2 minutes)
2. Add unit test verifying metrics wiring (5 minutes)
3. Manual test: trigger migration, query /metrics endpoint (5 minutes)
4. Update ROADMAP.md to mark Phase 16 as complete (1 minute)
5. Run /gsd:audit-milestone again to verify gap closure

**Total time:** ~15 minutes

**Benefit:** Milestone achieves both stated goals, complete observability

**Risk:** VERY LOW - SetMetrics is a simple setter, metrics framework already tested

### Option 2: Accept Gap and Complete with Tech Debt

**Actions:**
1. Update v0.7.0 definition of done to note observability gap
2. Create Phase 16.1 or defer to v0.7.1
3. Document workaround (use KubeVirt platform metrics)
4. Complete milestone with known limitation

**Benefit:** Faster milestone closure, migration functionality works

**Risk:** MEDIUM - Operators may be confused by always-zero metrics

**Precedent:** v0.6.0 deferred VAL-03 (same gap!) - this is the closure opportunity

### Option 3: Plan Phase 16 Properly

**Actions:**
1. Run /gsd:plan-phase 16 to create detailed execution plan
2. Execute Phase 16 with full workflow (research, plan-check, verifier)
3. Add comprehensive testing including E2E validation
4. Complete v0.7.0 with full Phase 16 implementation

**Total time:** ~2 hours (research, planning, execution, verification)

**Benefit:** Thorough implementation with full testing coverage

**Risk:** LOW - Framework exists, just needs wiring and tests

---

## Verdict

### Phase 15: VolumeAttachment-Based State Rebuild
✅ **PRODUCTION READY** - Deploy immediately

- All requirements satisfied
- All success criteria met
- Comprehensive test coverage (84.5%)
- All E2E flows complete
- No anti-patterns or tech debt
- Clean atomic commits

### Phase 16: Migration Metrics Emission
❌ **INCOMPLETE** - One critical wire missing

- Migration functionality works
- Metrics framework complete but not wired
- One-line fix available
- Choose Option 1 (fix now) or Option 2 (defer to v0.7.1)

### Milestone v0.7.0
⚠️ **GAPS FOUND** - 50% achievement (1/2 goals)

**Achieved:**
- ✅ VolumeAttachment as source of truth (Phase 15)

**Not Achieved:**
- ❌ Complete migration metrics observability (Phase 16)

**Recommendation:** Execute Option 1 (15 minutes) to achieve 100% milestone completion.

---

## Appendix: Requirements Traceability

| ID | Requirement | Phase | Status | Evidence |
|----|-------------|-------|--------|----------|
| ATTACH-01 | VolumeAttachment is source of truth | 15 | ✅ SATISFIED | rebuild.go:205-214 |
| ATTACH-02 | Grace period still works | 15 | ✅ SATISFIED | rebuild.go:175-184 |
| ATTACH-03 | PV annotations are informational | 15 | ✅ SATISFIED | persist.go:1-16, 7 comments |
| ATTACH-04 | No stale state possible | 15 | ✅ SATISFIED | TestRebuildStateFromVolumeAttachments_NoVAButHasAnnotation |
| VAL-03 | Migration metrics emission | 16 | ❌ UNSATISFIED | SetMetrics never called (driver.go:188) |

**Total:** 4/5 satisfied (80%)

---

## Appendix: File Change Summary

### Files Created (Phase 15)

| File | LOC | Purpose |
|------|-----|---------|
| pkg/attachment/va_lister.go | 65 | VolumeAttachment listing/filtering/grouping |
| pkg/attachment/va_lister_test.go | 259 | Tests for VA helpers |
| pkg/attachment/rebuild_test.go | 546 | Comprehensive VA-based rebuild tests |

**Total new code:** 870 lines

### Files Modified (Phase 15)

| File | Changes | Purpose |
|------|---------|---------|
| pkg/attachment/rebuild.go | +100 lines | Add RebuildStateFromVolumeAttachments, deprecate annotation-based |
| pkg/attachment/persist.go | Documentation | Clarify write-only nature of annotations |
| pkg/attachment/manager.go | Documentation | Update comments for VA authority |
| pkg/attachment/manager_test.go | Test fix | Update to use VolumeAttachment objects |

### Files Needing Change (Phase 16 Gap)

| File | Line | Change Required |
|------|------|-----------------|
| pkg/driver/driver.go | 188 | Add: `driver.attachmentManager.SetMetrics(config.Metrics)` |

---

_Audit completed: 2026-02-04T06:35:00Z_
_Auditor: Claude (gsd-integration-checker + orchestrator aggregation)_
_Next action: Fix gap (Option 1) or plan gap closure (Option 2/3)_
