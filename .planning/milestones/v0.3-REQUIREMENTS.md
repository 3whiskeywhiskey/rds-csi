# Requirements: RDS CSI Driver v0.3.0 Volume Fencing

**Defined:** 2026-01-31
**Core Value:** Prevent volume ping-pong between nodes so KubeVirt VMs don't pause

## v0.3.0 Requirements

Requirements for volume fencing release. Each maps to roadmap phases.

### Attachment Tracking

- [ ] **FENCE-01**: AttachmentManager tracks volume-to-node attachments in memory with sync.RWMutex
- [ ] **FENCE-02**: Attachment state persisted to PV annotations (rds.csi.srvlab.io/attached-node)
- [ ] **FENCE-03**: Attachment state rebuilt from PV annotations on controller startup
- [ ] **FENCE-04**: Per-volume locking prevents race conditions during concurrent publish requests
- [ ] **FENCE-05**: Background reconciliation detects and cleans stale attachments
- [ ] **FENCE-06**: Reattachment grace period (30s default) prevents false conflicts during KubeVirt migrations

### CSI Compliance

- [ ] **CSI-01**: ControllerPublishVolume returns OK if volume already attached to same node with compatible capabilities
- [ ] **CSI-02**: ControllerPublishVolume returns FAILED_PRECONDITION (code 9) if volume attached to different node for RWO
- [ ] **CSI-03**: ControllerUnpublishVolume is idempotent — returns success even if volume not currently attached
- [ ] **CSI-04**: PUBLISH_UNPUBLISH_VOLUME capability declared in ControllerGetCapabilities
- [ ] **CSI-05**: ControllerPublishVolume returns publish_context with NVMe connection parameters (address, port, nqn)
- [ ] **CSI-06**: ControllerPublishVolume validates node exists before rejecting — handles deleted node edge case

### Observability

- [ ] **OBS-01**: Prometheus metrics for attachment operations (attach_total, detach_total, conflicts_total, duration)
- [ ] **OBS-02**: Kubernetes events posted for attachment conflicts and errors

## Future Requirements

Deferred to later milestones.

### Advanced Fencing

- **ADV-01**: RDS-side host NQN ACLs for storage-level enforcement
- **ADV-02**: Force detach after 6-minute timeout (matches Kubernetes default)

## Out of Scope

| Feature | Reason |
|---------|--------|
| NVMe Reservations | RDS hardware doesn't support SCSI/NVMe reservations |
| Live migration with RWO | Requires RWX access mode, not supported by this driver |
| Blocking Unpublish on NVMe disconnect | Node may be unreachable — would cause hangs |
| Storage-level locking | NVMe/TCP doesn't support multi-initiator coordination |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| FENCE-01 | Phase 5 | Pending |
| FENCE-02 | Phase 5 | Pending |
| FENCE-03 | Phase 5 | Pending |
| FENCE-04 | Phase 5 | Pending |
| FENCE-05 | Phase 7 | Pending |
| FENCE-06 | Phase 7 | Pending |
| CSI-01 | Phase 6 | Pending |
| CSI-02 | Phase 6 | Pending |
| CSI-03 | Phase 6 | Pending |
| CSI-04 | Phase 6 | Pending |
| CSI-05 | Phase 6 | Pending |
| CSI-06 | Phase 6 | Pending |
| OBS-01 | Phase 7 | Pending |
| OBS-02 | Phase 7 | Pending |

**Coverage:**
- v0.3.0 requirements: 14 total
- Mapped to phases: 14 (100% coverage)
- Unmapped: 0

**Phase Distribution:**
- Phase 5 (Attachment Manager Foundation): 4 requirements
- Phase 6 (CSI Publish/Unpublish): 6 requirements
- Phase 7 (Robustness and Observability): 4 requirements

---
*Requirements defined: 2026-01-31*
*Last updated: 2026-01-31 after roadmap creation*
