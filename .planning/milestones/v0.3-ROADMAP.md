# Milestone v0.3: Volume Fencing

**Status:** In Progress
**Phases:** 5-7
**Total Plans:** TBD

## Overview

This roadmap prevents volume ping-pong between nodes by implementing ControllerPublishVolume and ControllerUnpublishVolume. Three phases build from foundation to production-ready: establishing the AttachmentManager with persistent state, implementing CSI compliance for publish/unpublish operations, and adding robustness via reconciliation and observability. The driver will enforce ReadWriteOnce semantics at the controller level, preventing simultaneous access that causes KubeVirt VM pauses.

## Phases

### Phase 5: Attachment Manager Foundation
**Goal**: Driver tracks volume-to-node attachments with persistent state that survives controller restarts
**Depends on**: Phase 4 (Observability from v1)
**Requirements**: FENCE-01, FENCE-02, FENCE-03, FENCE-04
**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. AttachmentManager tracks which volumes are attached to which nodes in memory
2. Attachment state persists to PV annotations and survives controller pod restarts
3. Per-volume locks prevent race conditions when multiple attach requests arrive
4. Controller can rebuild full attachment state from PV annotations on startup

Plans:
- TBD (pending phase planning)

**Details:**
- AttachmentManager with sync.RWMutex for thread-safe in-memory tracking
- PV annotation `rds.csi.srvlab.io/attached-node` for state persistence
- Per-volume mutex map for concurrent publish request safety
- Startup reconciliation rebuilds state by scanning all PVs

### Phase 6: CSI Publish/Unpublish Implementation
**Goal**: Driver enforces ReadWriteOnce semantics through CSI ControllerPublishVolume and ControllerUnpublishVolume
**Depends on**: Phase 5
**Requirements**: CSI-01, CSI-02, CSI-03, CSI-04, CSI-05, CSI-06
**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. ControllerPublishVolume returns OK if volume already attached to the same node (idempotent)
2. ControllerPublishVolume returns FAILED_PRECONDITION (code 9) if volume attached to different node for RWO volumes
3. ControllerPublishVolume validates requested node exists in Kubernetes before rejecting attachment
4. ControllerUnpublishVolume succeeds even if volume not currently attached (idempotent)
5. ControllerGetCapabilities declares PUBLISH_UNPUBLISH_VOLUME capability
6. ControllerPublishVolume returns publish_context with NVMe connection parameters (address, port, nqn)

Plans:
- TBD (pending phase planning)

**Details:**
- Implement ControllerPublishVolume with attachment tracking integration
- Implement ControllerUnpublishVolume with cleanup logic
- Node existence validation via Kubernetes API before rejecting
- Publish context includes nvme_address, nvme_port, nvme_nqn from RDS
- Update ControllerGetCapabilities to declare new capability

### Phase 7: Robustness and Observability
**Goal**: Production operators can monitor attachment conflicts and driver handles stale state gracefully
**Depends on**: Phase 6
**Requirements**: FENCE-05, FENCE-06, OBS-01, OBS-02
**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. Background reconciliation detects and cleans stale attachments from deleted nodes
2. Reattachment grace period (30s default) prevents false conflicts during KubeVirt live migrations
3. Prometheus metrics expose attachment operations (attach_total, detach_total, conflicts_total, duration_seconds)
4. Kubernetes events posted to PVCs for attachment conflicts and errors

Plans:
- TBD (pending phase planning)

**Details:**
- Background reconciler runs every 5 minutes to detect stale attachments
- Grace period tracked per volume with last-detach timestamp
- Prometheus metrics with rds_csi_attachment_ prefix
- EventPoster extended with attachment event types (Conflict, Attached, Detached)
- Reconciliation checks node existence via Kubernetes API

---

## Milestone Summary

**Decimal Phases:** None (no urgent insertions yet)

**Key Decisions:**
- TBD (will be captured during planning and execution)

**Issues Targeted:**
- Volume ping-pong between nodes every ~7 minutes
- `CONFLICT: PVC is in use by VMI` errors in KubeVirt
- No controller-level enforcement of ReadWriteOnce

**Issues Deferred:**
- RDS-side host NQN ACLs (v0.4 ADV-01)
- Force detach timeout (v0.4 ADV-02)

**Technical Debt Incurred:**
- TBD (will be tracked during execution)

---

*For previous milestones, see .planning/milestones/v1-ROADMAP.md*
*Milestone started: 2026-01-31*
