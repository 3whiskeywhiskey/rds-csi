# Milestone v0.6: Block Volume Support

**Status:** In Progress
**Phases:** 11-13
**Total Plans:** 4 (3 for Phase 11, 1 for Phase 12, TBD for Phase 13)

## Overview

This roadmap implements CSI block volume support to enable KubeVirt VMs with RDS storage. Three phases build from implementation to validation: modifying the node plugin to handle block volumes without filesystem formatting, ensuring existing filesystem volumes work without regression, and validating end-to-end VM boot and live migration on the metal cluster. The driver will create block device files for VMs while maintaining backward compatibility with filesystem volumes.

## Phases

### Phase 11: Block Volume Node Operations (COMPLETE)
**Goal**: Node plugin handles block volumes without formatting filesystem
**Depends on**: Phase 10 (RWX capability exists)
**Requirements**: BLOCK-01, BLOCK-02, BLOCK-03, BLOCK-04, BLOCK-05
**Plans**: 3 plans
**Status**: Complete (2026-02-03)

**Success Criteria** (what must be TRUE):
1. NodeStageVolume connects to NVMe target for block volumes without creating filesystem
2. NodePublishVolume creates block device file at target path (e.g., /var/lib/kubelet/pods/XXX/volumeDevices/pvc-YYY)
3. Block device file is accessible by VM workload with correct major/minor numbers
4. NodeUnpublishVolume successfully removes block device file
5. NodeUnstageVolume disconnects NVMe target for block volumes correctly

Plans:
- [x] 11-01-PLAN.md — MakeFile helper and NodeStageVolume block support
- [x] 11-02-PLAN.md — NodePublishVolume and NodeUnpublishVolume block support
- [x] 11-03-PLAN.md — NodeUnstageVolume block support and unit tests

**Details:**
- Detect volumeMode from volume context or capability in NodeStageVolume
- For block volumes: connect to NVMe target, resolve device path, store metadata (skip mkfs/mount)
- Create staging directory for metadata storage (device path, NQN, etc.)
- NodePublishVolume reads device path from staging metadata
- Use bind mount to expose block device at target path (simpler than mknod)
- NodeUnpublishVolume removes block device file (unmount not applicable)
- NodeUnstageVolume reads metadata, validates device not in use, disconnects NVMe

### Phase 12: Compatibility and Quality
**Goal**: Existing filesystem volumes work without regression, clear error messages
**Depends on**: Phase 11
**Requirements**: BLOCK-06, BLOCK-07
**Plans**: 1 plan

**Success Criteria** (what must be TRUE):
1. Existing filesystem-mode PVCs mount successfully (no regression from block volume changes)
2. Driver returns clear error if user requests unsupported volume mode combination
3. Unit tests cover both block and filesystem volume paths

Plans:
- [ ] 12-01-PLAN.md — Comprehensive regression tests and error message validation

**Details:**
- Regression testing with existing filesystem volumes (ext4 mount)
- Unit tests for both volume modes (table-driven tests)
- Clear error messages for invalid combinations
- Code coverage for new block volume code paths
- Manual testing with sample PVCs (both block and filesystem)

### Phase 13: Hardware Validation
**Goal**: KubeVirt VMs boot and live migrate successfully on metal cluster
**Depends on**: Phase 12
**Requirements**: VAL-01, VAL-02, VAL-03
**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. KubeVirt VM boots successfully with RDS block volume on metal cluster
2. VM can read and write data to block volume (I/O validation)
3. KubeVirt live migration completes end-to-end (VM moves between nodes)
4. Migration metrics (migrations_total, migration_duration_seconds) are emitted correctly
5. No data corruption detected after migration (checksum validation)

Plans:
- [ ] 13-01-PLAN.md — TBD during planning

**Details:**
- Deploy updated driver to metal cluster (kubectl apply)
- Create RWX block PVC for testing
- Create KubeVirt VM with volume attachment
- Boot VM and validate I/O (dd, fio, or similar)
- Trigger live migration (kubectl virt migrate)
- Validate migration completes without errors
- Check Prometheus metrics for migration events
- Verify data integrity post-migration (checksum comparison)
- Document any findings or gotchas

---

## Milestone Summary

**Decimal Phases:** None (no urgent insertions yet)

**Key Decisions:**
- ROADMAP-7: Block volume support for KubeVirt VMs (primary use case)
- ROADMAP-8: Bind mount approach for block device file exposure (simpler than mknod)
- ROADMAP-9: Metadata storage in staging directory (enables device path resolution)

**Issues Targeted:**
- KubeVirt VMs fail to start because NodeStageVolume formats devices as ext4
- Block volume support missing from node plugin
- Need hardware validation on metal cluster

**Issues Deferred:**
- Volume snapshots for block volumes (separate milestone)
- Volume cloning support (separate milestone)
- Volume expansion for block volumes (separate milestone)

**Technical Debt Incurred:**
- None so far (clean implementation in Phase 11)

---

*Milestone started: 2026-02-03*
