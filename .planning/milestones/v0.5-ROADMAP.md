# Roadmap: RDS CSI Driver

## Milestones

- v1 Production Stability - Phases 1-4 (shipped 2026-01-31)
- v0.3.0 Volume Fencing - Phases 5-7 (shipped 2026-02-03)
- v0.5.0 KubeVirt Live Migration - Phases 8-10 (shipped 2026-02-03)
- v0.6.0 Block Volume Support - Phases 11-14 (complete 2026-02-04)
- v0.7.0 State Management Refactoring - Phase 15 (planned)

## Phases

<details>
<summary>v1 Production Stability (Phases 1-4) - SHIPPED 2026-01-31</summary>

### Phase 1: Device Path Resolution
**Goal**: Volumes remain accessible after NVMe controller renumbering
**Plans**: 4 plans

Plans:
- [x] 01-01: NQN-based device path resolution
- [x] 01-02: Device path validation and caching
- [x] 01-03: Stale mount detection and cleanup
- [x] 01-04: Integration with NodeStageVolume/NodeUnstageVolume

### Phase 2: Connection Resilience
**Goal**: NVMe connections automatically recover from network hiccups
**Plans**: 4 plans

Plans:
- [x] 02-01: Kernel reconnection parameters (ctrl_loss_tmo, reconnect_delay)
- [x] 02-02: Orphaned subsystem detection and cleanup
- [x] 02-03: Remount on device path change
- [x] 02-04: Connection state validation in NodeGetVolumeStats

### Phase 3: Observability
**Goal**: Operators can monitor and debug volume issues
**Plans**: 5 plans

Plans:
- [x] 03-01: Prometheus metrics endpoint
- [x] 03-02: CSI operation metrics (CreateVolume, NodeStageVolume, etc.)
- [x] 03-03: Device path resolution metrics
- [x] 03-04: Kubernetes event posting for mount failures
- [x] 03-05: VolumeCondition health reporting

### Phase 4: Testing and Validation
**Goal**: All reconnection scenarios validated on metal cluster
**Plans**: 4 plans

Plans:
- [x] 04-01: Unit tests for DeviceResolver and DeviceValidator
- [x] 04-02: E2E tests for controller renumbering scenarios
- [x] 04-03: Manual testing: RDS restart, network partition
- [x] 04-04: Deployment validation on metal cluster

</details>

<details>
<summary>v0.3.0 Volume Fencing (Phases 5-7) - SHIPPED 2026-02-03</summary>

### Phase 5: Attachment Manager
**Goal**: Track and persist volume-to-node attachments
**Plans**: 4 plans

Plans:
- [x] 05-01: AttachmentManager with in-memory state
- [x] 05-02: PV annotation persistence for attachment metadata
- [x] 05-03: AttachmentState struct with timestamps
- [x] 05-04: Grace period mechanism for KubeVirt migration handoff

### Phase 6: Controller Publish/Unpublish
**Goal**: Prevent multi-node attachment conflicts
**Plans**: 4 plans

Plans:
- [x] 06-01: ControllerPublishVolume with RWO enforcement
- [x] 06-02: ControllerUnpublishVolume with cleanup and idempotency
- [x] 06-03: Attachment conflict detection (return FAILED_PRECONDITION)
- [x] 06-04: Prometheus metrics for attachment operations

### Phase 7: Reconciliation and Testing
**Goal**: Stale attachments cleaned up automatically
**Plans**: 4 plans

Plans:
- [x] 07-01: Background reconciler for stale attachment cleanup
- [x] 07-02: Deleted node detection via Kubernetes API
- [x] 07-03: E2E tests for attachment conflict scenarios
- [x] 07-04: Deployment validation with real KubeVirt workloads

</details>

<details>
<summary>v0.5.0 KubeVirt Live Migration (Phases 8-10) - SHIPPED 2026-02-03</summary>

### Phase 8: Core RWX Capability
**Goal**: KubeVirt VMs can live migrate using RWX block PVCs
**Requirements**: RWX-01, RWX-02, RWX-03
**Plans**: 3 plans

Plans:
- [x] 08-01: Add MULTI_NODE_MULTI_WRITER capability and RWX block-only validation
- [x] 08-02: Modify AttachmentManager to allow 2-node attachment for RWX block volumes
- [x] 08-03: Comprehensive unit tests

### Phase 9: Migration Safety
**Goal**: Migration dual-attachment is distinguishable from RWO conflicts
**Requirements**: SAFETY-01, SAFETY-02, SAFETY-03, SAFETY-04
**Plans**: 4 plans

Plans:
- [x] 09-01: Extend AttachmentState for migration tracking and configurable timeout
- [x] 09-02: Separate migration timeout from RWO conflict detection logic
- [x] 09-03: Device-in-use verification in NodeUnstageVolume
- [x] 09-04: Comprehensive unit tests

### Phase 10: Observability and Validation
**Goal**: Operators can monitor migrations and users understand safe RWX usage
**Requirements**: OBS-01, OBS-02, OBS-03
**Plans**: 5 plans

Plans:
- [x] 10-01: Prometheus migration metrics (migrations_total, duration, active_migrations)
- [x] 10-02: Kubernetes migration events on PVC
- [x] 10-03: Wire metrics/events into attachment manager and controller
- [x] 10-04: User documentation for RWX safety
- [x] 10-05: Gap closure: Wire PostMigrationCompleted in ControllerUnpublishVolume

</details>

<details>
<summary>v0.6.0 Block Volume Support (Phases 11-14) - COMPLETE 2026-02-04</summary>

**Milestone Goal:** Implement CSI block volume support to enable KubeVirt VMs with RDS storage

#### Phase 11: Block Volume Node Operations
**Goal**: Node plugin handles block volumes without formatting filesystem
**Depends on**: Phase 10 (RWX capability exists)
**Requirements**: BLOCK-01, BLOCK-02, BLOCK-03, BLOCK-04, BLOCK-05
**Success Criteria** (what must be TRUE):
  1. NodeStageVolume connects to NVMe target for block volumes without creating filesystem
  2. NodePublishVolume creates block device file at target path (e.g., /var/lib/kubelet/pods/XXX/volumeDevices/pvc-YYY)
  3. Block device file is accessible by VM workload with correct major/minor numbers
  4. NodeUnpublishVolume successfully removes block device file
  5. NodeUnstageVolume disconnects NVMe target for block volumes correctly
**Plans**: 3 plans

Plans:
- [x] 11-01-PLAN.md - MakeFile helper and NodeStageVolume block support
- [x] 11-02-PLAN.md - NodePublishVolume and NodeUnpublishVolume block support
- [x] 11-03-PLAN.md - NodeUnstageVolume block support and unit tests

#### Phase 12: Compatibility and Quality
**Goal**: Existing filesystem volumes work without regression, clear error messages
**Depends on**: Phase 11
**Requirements**: BLOCK-06, BLOCK-07
**Success Criteria** (what must be TRUE):
  1. Existing filesystem-mode PVCs mount successfully (no regression from block volume changes)
  2. Driver returns clear error if user requests unsupported volume mode combination
  3. Unit tests cover both block and filesystem volume paths
**Plans**: 1 plan

Plans:
- [x] 12-01-PLAN.md - Regression tests and error message validation

#### Phase 13: Hardware Validation
**Goal**: KubeVirt VMs boot and live migrate successfully on metal cluster
**Depends on**: Phase 12
**Requirements**: VAL-01, VAL-02, VAL-03
**Success Criteria** (what must be TRUE):
  1. KubeVirt VM boots successfully with RDS block volume on metal cluster
  2. VM can read and write data to block volume (I/O validation)
  3. KubeVirt live migration completes end-to-end (VM moves between nodes)
  4. Migration metrics (migrations_total, migration_duration_seconds) are emitted correctly
  5. No data corruption detected after migration (checksum validation)
**Plans**: 1 plan

Plans:
- [x] 13-01-PLAN.md - Hardware validation on metal cluster

#### Phase 14: Error Resilience and Mount Storm Prevention
**Goal**: Prevent corrupted filesystems from causing cluster-wide mount storms and system volume interference
**Depends on**: Phase 13
**Requirements**: PROTECT-01, PROTECT-02, RESILIENCE-01, RESILIENCE-02, RESILIENCE-03, RESILIENCE-04
**Success Criteria** (what must be TRUE):
  1. **NQN filtering prevents system volume disconnect** - Driver only manages volumes with configurable NQN prefix (default: `pvc-`), refuses to disconnect system volumes (e.g., `nixos-*`)
  2. **Configurable NQN prefix** - Managed NQN prefix is configurable via Helm value `nqnPrefix` and env var `CSI_MANAGED_NQN_PREFIX`, defaults to `nqn.2000-02.com.mikrotik:pvc-`
  3. Procmounts parsing has timeout protection (max 10s)
  4. Duplicate mount detection prevents mount storms (max 100 entries per device)
  5. Graceful shutdown completes within 30s even during stuck operations
  6. Filesystem health check runs before NodeStageVolume mount
  7. Circuit breaker prevents retry storms on repeatedly failing volumes
**Plans**: 4 plans

Plans:
- [x] 14-01-PLAN.md - NQN prefix validation and configurable filtering
- [x] 14-02-PLAN.md - Safe procmounts parsing with timeout and duplicate detection
- [x] 14-03-PLAN.md - Circuit breaker and filesystem health checks
- [x] 14-04-PLAN.md - Graceful shutdown and deployment configuration

</details>

### v0.7.0 State Management Refactoring and Observability (Planned)

**Milestone Goal:** Use Kubernetes VolumeAttachment objects as source of truth for attachment state and complete migration metrics observability

#### Phase 15: VolumeAttachment-Based State Rebuild
**Goal**: Controller rebuilds attachment state from VolumeAttachment objects instead of PV annotations
**Depends on**: Phase 14
**Requirements**: ATTACH-01, ATTACH-02, ATTACH-03, ATTACH-04
**Success Criteria** (what must be TRUE):
  1. **VolumeAttachment is source of truth** - On startup, controller lists VolumeAttachment objects and rebuilds state from them (not PV annotations)
  2. **Grace period still works** - Multi-attach during KubeVirt migration is detected correctly from multiple VolumeAttachment objects
  3. **PV annotations are informational** - Annotations (attached-node, attached-at) are written for debugging but never read during rebuild
  4. **No stale state possible** - If VolumeAttachment doesn't exist, volume is definitely detached (no annotation-based false positives)
  5. **Backward compatible** - Existing volumes with stale annotations are handled correctly (annotations ignored during rebuild)
**Rationale**:
  - VolumeAttachment objects are managed by external-attacher (authoritative source)
  - PV annotations can become stale (e.g., if clearing fails, or manual kubectl operations)
  - Current fix (62197ce) clears annotations on detach, but VolumeAttachment-based rebuild is more architecturally correct
  - Aligns with CSI best practices (external-attacher owns attachment lifecycle)
**Plans**: 4 plans

Plans:
- [x] 15-01-PLAN.md - VolumeAttachment listing helpers and filtering
- [x] 15-02-PLAN.md - Rebuild state from VolumeAttachments on startup
- [x] 15-03-PLAN.md - PV annotations informational-only documentation
- [x] 15-04-PLAN.md - Comprehensive testing for restart scenarios

#### Phase 16: Migration Metrics Emission
**Goal**: Populate migration metrics to enable observability of KubeVirt live migrations
**Depends on**: Phase 15
**Requirements**: VAL-03 (from v0.6.0 audit - tech debt closure)
**Success Criteria** (what must be TRUE):
  1. **PostMigrationCompleted called** - ControllerUnpublishVolume detects migration completion and calls migrationTracker.PostMigrationCompleted
  2. **migrations_total increments** - Counter increases when migrations complete successfully
  3. **migration_duration_seconds recorded** - Histogram captures time between MigrationStartedAt and completion
  4. **Metrics queryable in Prometheus** - Operators can query migration count and duration via /metrics endpoint
**Rationale**:
  - Phase 10 created metrics framework but PostMigrationCompleted was never wired
  - v0.6.0 hardware validation showed functional migration works but metrics not emitted
  - Non-blocking for v0.6.0 but valuable for production observability
  - Closes tech debt identified in v0.6.0 milestone audit
**Plans**: TBD

Plans:
- [ ] 16-01-PLAN.md - Wire PostMigrationCompleted in ControllerUnpublishVolume
- [ ] 16-02-PLAN.md - Add migration detection logic and metric population
- [ ] 16-03-PLAN.md - Testing with simulated and real KubeVirt migrations

## Progress

**Execution Order:**
Phases execute in numeric order: 11 -> 12 -> 13 -> 14 -> 15 -> 16

| Phase | Milestone | Plans Complete | Status | Completed |
|-------|-----------|----------------|--------|-----------|
| 1. Device Path Resolution | v1 | 4/4 | Complete | 2026-01-31 |
| 2. Connection Resilience | v1 | 4/4 | Complete | 2026-01-31 |
| 3. Observability | v1 | 5/5 | Complete | 2026-01-31 |
| 4. Testing and Validation | v1 | 4/4 | Complete | 2026-01-31 |
| 5. Attachment Manager | v0.3.0 | 4/4 | Complete | 2026-02-03 |
| 6. Controller Publish/Unpublish | v0.3.0 | 4/4 | Complete | 2026-02-03 |
| 7. Reconciliation and Testing | v0.3.0 | 4/4 | Complete | 2026-02-03 |
| 8. RWX Capability | v0.5.0 | 3/3 | Complete | 2026-02-03 |
| 9. Migration Safety and Tracking | v0.5.0 | 4/4 | Complete | 2026-02-03 |
| 10. Observability and Validation | v0.5.0 | 5/5 | Complete | 2026-02-03 |
| 11. Block Volume Node Operations | v0.6.0 | 3/3 | Complete | 2026-02-03 |
| 12. Compatibility and Quality | v0.6.0 | 1/1 | Complete | 2026-02-03 |
| 13. Hardware Validation | v0.6.0 | 1/1 | Complete | 2026-02-04 |
| 14. Error Resilience | v0.6.0 | 4/4 | Complete | 2026-02-03 |
| 15. VolumeAttachment-Based State | v0.7.0 | 4/4 | Complete | 2026-02-04 |
| 16. Migration Metrics Emission | v0.7.0 | 0/3 | Planned | - |
