# Roadmap: RDS CSI Driver

## Milestones

- âœ… **v1 Production Stability** - Phases 1-4 (shipped 2026-01-31)
- âœ… **v0.3.0 Volume Fencing** - Phases 5-7 (shipped 2026-02-03)
- âœ… **v0.5.0 KubeVirt Live Migration** - Phases 8-10 (shipped 2026-02-03)
- ðŸš§ **v0.6.0 Block Volume Support** - Phases 11-13 (in progress)

## Phases

<details>
<summary>âœ… v1 Production Stability (Phases 1-4) - SHIPPED 2026-01-31</summary>

### Phase 1: Device Path Resolution
**Goal**: Volumes remain accessible after NVMe controller renumbering
**Plans**: 4 plans

Plans:
- [x] 01-01: NQN-based device path resolution
- [x] 01-02: Device path validation and caching
- [x] 01-03: Stale mount detection and cleanup
- [x] 01-04: Integration with NodeStageVolume/NodeUnstageVolume

### Phase 2: Connection Resilience
**Goal**: NVMe connections automatically recover from network hiccups
**Plans**: 4 plans

Plans:
- [x] 02-01: Kernel reconnection parameters (ctrl_loss_tmo, reconnect_delay)
- [x] 02-02: Orphaned subsystem detection and cleanup
- [x] 02-03: Remount on device path change
- [x] 02-04: Connection state validation in NodeGetVolumeStats

### Phase 3: Observability
**Goal**: Operators can monitor and debug volume issues
**Plans**: 5 plans

Plans:
- [x] 03-01: Prometheus metrics endpoint
- [x] 03-02: CSI operation metrics (CreateVolume, NodeStageVolume, etc.)
- [x] 03-03: Device path resolution metrics
- [x] 03-04: Kubernetes event posting for mount failures
- [x] 03-05: VolumeCondition health reporting

### Phase 4: Testing and Validation
**Goal**: All reconnection scenarios validated on metal cluster
**Plans**: 4 plans

Plans:
- [x] 04-01: Unit tests for DeviceResolver and DeviceValidator
- [x] 04-02: E2E tests for controller renumbering scenarios
- [x] 04-03: Manual testing: RDS restart, network partition
- [x] 04-04: Deployment validation on metal cluster

</details>

<details>
<summary>âœ… v0.3.0 Volume Fencing (Phases 5-7) - SHIPPED 2026-02-03</summary>

### Phase 5: Attachment Manager
**Goal**: Track and persist volume-to-node attachments
**Plans**: 4 plans

Plans:
- [x] 05-01: AttachmentManager with in-memory state
- [x] 05-02: PV annotation persistence for attachment metadata
- [x] 05-03: AttachmentState struct with timestamps
- [x] 05-04: Grace period mechanism for KubeVirt migration handoff

### Phase 6: Controller Publish/Unpublish
**Goal**: Prevent multi-node attachment conflicts
**Plans**: 4 plans

Plans:
- [x] 06-01: ControllerPublishVolume with RWO enforcement
- [x] 06-02: ControllerUnpublishVolume with cleanup and idempotency
- [x] 06-03: Attachment conflict detection (return FAILED_PRECONDITION)
- [x] 06-04: Prometheus metrics for attachment operations

### Phase 7: Reconciliation and Testing
**Goal**: Stale attachments cleaned up automatically
**Plans**: 4 plans

Plans:
- [x] 07-01: Background reconciler for stale attachment cleanup
- [x] 07-02: Deleted node detection via Kubernetes API
- [x] 07-03: E2E tests for attachment conflict scenarios
- [x] 07-04: Deployment validation with real KubeVirt workloads

</details>

<details>
<summary>âœ… v0.5.0 KubeVirt Live Migration (Phases 8-10) - SHIPPED 2026-02-03</summary>

### Phase 8: Core RWX Capability
**Goal**: KubeVirt VMs can live migrate using RWX block PVCs
**Requirements**: RWX-01, RWX-02, RWX-03
**Plans**: 3 plans

Plans:
- [x] 08-01: Add MULTI_NODE_MULTI_WRITER capability and RWX block-only validation
- [x] 08-02: Modify AttachmentManager to allow 2-node attachment for RWX block volumes
- [x] 08-03: Comprehensive unit tests

### Phase 9: Migration Safety
**Goal**: Migration dual-attachment is distinguishable from RWO conflicts
**Requirements**: SAFETY-01, SAFETY-02, SAFETY-03, SAFETY-04
**Plans**: 4 plans

Plans:
- [x] 09-01: Extend AttachmentState for migration tracking and configurable timeout
- [x] 09-02: Separate migration timeout from RWO conflict detection logic
- [x] 09-03: Device-in-use verification in NodeUnstageVolume
- [x] 09-04: Comprehensive unit tests

### Phase 10: Observability and Validation
**Goal**: Operators can monitor migrations and users understand safe RWX usage
**Requirements**: OBS-01, OBS-02, OBS-03
**Plans**: 5 plans

Plans:
- [x] 10-01: Prometheus migration metrics (migrations_total, duration, active_migrations)
- [x] 10-02: Kubernetes migration events on PVC
- [x] 10-03: Wire metrics/events into attachment manager and controller
- [x] 10-04: User documentation for RWX safety
- [x] 10-05: Gap closure: Wire PostMigrationCompleted in ControllerUnpublishVolume

</details>

### ðŸš§ v0.6.0 Block Volume Support (In Progress)

**Milestone Goal:** Implement CSI block volume support to enable KubeVirt VMs with RDS storage

#### Phase 11: Block Volume Node Operations
**Goal**: Node plugin handles block volumes without formatting filesystem
**Depends on**: Phase 10 (RWX capability exists)
**Requirements**: BLOCK-01, BLOCK-02, BLOCK-03, BLOCK-04, BLOCK-05
**Success Criteria** (what must be TRUE):
  1. NodeStageVolume connects to NVMe target for block volumes without creating filesystem
  2. NodePublishVolume creates block device file at target path (e.g., /var/lib/kubelet/pods/XXX/volumeDevices/pvc-YYY)
  3. Block device file is accessible by VM workload with correct major/minor numbers
  4. NodeUnpublishVolume successfully removes block device file
  5. NodeUnstageVolume disconnects NVMe target for block volumes correctly
**Plans**: 3 plans

Plans:
- [x] 11-01-PLAN.md â€” MakeFile helper and NodeStageVolume block support
- [x] 11-02-PLAN.md â€” NodePublishVolume and NodeUnpublishVolume block support
- [x] 11-03-PLAN.md â€” NodeUnstageVolume block support and unit tests

#### Phase 12: Compatibility and Quality
**Goal**: Existing filesystem volumes work without regression, clear error messages
**Depends on**: Phase 11
**Requirements**: BLOCK-06, BLOCK-07
**Success Criteria** (what must be TRUE):
  1. Existing filesystem-mode PVCs mount successfully (no regression from block volume changes)
  2. Driver returns clear error if user requests unsupported volume mode combination
  3. Unit tests cover both block and filesystem volume paths
**Plans**: TBD

Plans:
- [ ] 12-01: TBD during planning

#### Phase 13: Hardware Validation
**Goal**: KubeVirt VMs boot and live migrate successfully on metal cluster
**Depends on**: Phase 12
**Requirements**: VAL-01, VAL-02, VAL-03
**Success Criteria** (what must be TRUE):
  1. KubeVirt VM boots successfully with RDS block volume on metal cluster
  2. VM can read and write data to block volume (I/O validation)
  3. KubeVirt live migration completes end-to-end (VM moves between nodes)
  4. Migration metrics (migrations_total, migration_duration_seconds) are emitted correctly
  5. No data corruption detected after migration (checksum validation)
**Plans**: TBD

Plans:
- [ ] 13-01: TBD during planning

## Progress

**Execution Order:**
Phases execute in numeric order: 11 â†’ 12 â†’ 13

| Phase | Milestone | Plans Complete | Status | Completed |
|-------|-----------|----------------|--------|-----------|
| 1. Device Path Resolution | v1 | 4/4 | Complete | 2026-01-31 |
| 2. Connection Resilience | v1 | 4/4 | Complete | 2026-01-31 |
| 3. Observability | v1 | 5/5 | Complete | 2026-01-31 |
| 4. Testing and Validation | v1 | 4/4 | Complete | 2026-01-31 |
| 5. Attachment Manager | v0.3.0 | 4/4 | Complete | 2026-02-03 |
| 6. Controller Publish/Unpublish | v0.3.0 | 4/4 | Complete | 2026-02-03 |
| 7. Reconciliation and Testing | v0.3.0 | 4/4 | Complete | 2026-02-03 |
| 8. RWX Capability | v0.5.0 | 3/3 | Complete | 2026-02-03 |
| 9. Migration Safety and Tracking | v0.5.0 | 4/4 | Complete | 2026-02-03 |
| 10. Observability and Validation | v0.5.0 | 5/5 | Complete | 2026-02-03 |
| 11. Block Volume Node Operations | v0.6.0 | 3/3 | Complete | 2026-02-03 |
| 12. Compatibility and Quality | v0.6.0 | 0/TBD | Not started | - |
| 13. Hardware Validation | v0.6.0 | 0/TBD | Not started | - |
