# Milestone v0.7.1: Code Quality and Logging Cleanup

**Status:** ðŸš§ IN PROGRESS
**Phases:** 17-21
**Total Plans:** TBD

## Overview

Systematic codebase audit and refactoring to improve maintainability, reduce log noise, and address technical debt identified in CONCERNS.md analysis.

**Problem being solved:** After six milestones of rapid feature delivery, the codebase has accumulated technical debt in logging verbosity, error handling consistency, test coverage gaps, and code duplication. This milestone addresses these issues systematically before continuing with new features.

**Key focus areas:**
- Fix failing tests to establish stable baseline
- Reduce production log noise through verbosity rationalization
- Standardize error handling with proper wrapping
- Expand test coverage to >80% on critical packages
- Extract common patterns and eliminate code duplication

## Phases

### Phase 17: Test Infrastructure Fix

**Goal**: Fix failing block volume tests to establish stable test baseline

**Depends on**: Phase 16 (previous milestone)

**Requirements**: TEST-01

**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. Block volume test suite runs without nil pointer dereferences
2. All existing tests pass consistently in CI
3. Test infrastructure supports adding new block volume tests
4. Root cause of nil pointer issue documented

**Rationale**:
- Cannot reliably add new tests until existing tests pass
- Failing tests block CI/CD confidence
- Must fix test infrastructure before expanding coverage in Phase 20
- BLOCKING for rest of milestone

Plans:
- [ ] 17-01: TBD during planning

---

### Phase 18: Logging Cleanup

**Goal**: Reduce production log noise through systematic verbosity rationalization

**Depends on**: Phase 17

**Requirements**: LOG-01, LOG-02, LOG-03, LOG-04

**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. Security logger consolidated from 300+ lines to <50 lines with configurable helper
2. DeleteVolume operation produces maximum 2 log statements per operation (down from 4-6)
3. All CSI operations audited with info=actionable, debug=diagnostic separation documented
4. Severity mapping uses table-driven approach instead of switch statements
5. Production logs contain only actionable information at info level

**Rationale**:
- Current logging produces 4-6 V(3) statements per operation, creating noise
- Security logger has 11 duplicate methods (300+ lines of duplication)
- Severity mapping uses switch statements in multiple places
- Operators struggle to filter signal from noise in production logs

Plans:
- [ ] 18-01: TBD during planning

---

### Phase 19: Error Handling Standardization

**Goal**: Consistent error patterns with proper context propagation across all packages

**Depends on**: Phase 18

**Requirements**: ERR-01, ERR-02, ERR-03, ERR-04

**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. All 160+ error returns using %v converted to %w for proper error wrapping
2. Every error includes contextual information (operation, volume ID, node, reason)
3. Error handling patterns documented in CONVENTIONS.md
4. Error paths audited with no silent failures or missing context

**Rationale**:
- Inconsistent error formatting makes parsing/alerting difficult
- Many errors use %v instead of %w, losing error chain
- Missing context in errors makes troubleshooting harder
- No documented error handling patterns for contributors

Plans:
- [ ] 19-01: TBD during planning

---

### Phase 20: Test Coverage Expansion

**Goal**: Increase test coverage to >80% on all critical packages

**Depends on**: Phase 19

**Requirements**: TEST-02, TEST-03, TEST-04, TEST-05, TEST-06

**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. SSH client test coverage increased from 0% to >80%
2. RDS package test coverage increased from 44.5% to >80%
3. Mount package test coverage increased from 55.9% to >80%
4. NVMe package test coverage increased from 43.3% to >80%
5. Zero-coverage files now have comprehensive tests (ssh_client.go, server.go, persist.go, client.go)
6. Critical error paths have explicit test coverage

**Rationale**:
- Several critical packages have <50% coverage
- Four files have 0% coverage (ssh_client.go, server.go, persist.go, client.go)
- Error paths are under-tested
- Low coverage increases risk of regressions

Plans:
- [ ] 20-01: TBD during planning

---

### Phase 21: Code Quality Improvements

**Goal**: Extract common patterns and resolve documented code smells

**Depends on**: Phase 20

**Requirements**: QUAL-01, QUAL-02, QUAL-03, QUAL-04

**Plans**: TBD

**Success Criteria** (what must be TRUE):
1. Common error handling patterns extracted into pkg/utils/errors.go
2. Duplicated severity mapping switch statements replaced with shared table
3. Large packages refactored for better separation of concerns
4. All code smells from CONCERNS.md either resolved or explicitly documented as deferred
5. Codebase maintainability score improved (measured by golangci-lint complexity metrics)

**Rationale**:
- Code duplication makes maintenance harder
- Large packages difficult to navigate and test
- Code smells documented in CONCERNS.md analysis
- Extract patterns before they spread further

Plans:
- [ ] 21-01: TBD during planning

---

## Milestone Summary

**Key Decisions:**
- TBD during execution

**Issues Resolved:**
- TBD during execution

**Issues Deferred:**
- TBD during execution

**Technical Debt Incurred:**
- TBD during execution

---

_For current project status, see .planning/ROADMAP.md_
