# Requirements Archive: v0.6.0 Block Volume Support

**Archived:** 2026-02-04
**Status:** ✅ SHIPPED
**Core Value:** Volumes remain accessible after NVMe-oF reconnections

This is the archived requirements specification for v0.6.0.
For current requirements, see `.planning/REQUIREMENTS.md` (will be created for next milestone).

---

## v1 Requirements

### Block Volume Operations

- [x] **BLOCK-01**: NodeStageVolume skips filesystem formatting when `volumeMode: Block`
  - **Outcome:** Validated - NodeStageVolume detects block mode and skips Format() and Mount() calls
  - **Evidence:** Phase 11 VERIFICATION lines 78-86

- [x] **BLOCK-02**: NodeStageVolume stores device path metadata in staging directory for block volumes
  - **Outcome:** Validated - Device metadata written to staging/device file
  - **Evidence:** Phase 11 VERIFICATION line 247
  - **Note:** Initially used, but Phase 13 architectural change removed dependency on metadata file for block volumes

- [x] **BLOCK-03**: NodePublishVolume creates block device file at target path using mknod
  - **Outcome:** Validated with modification - Originally specified mknod, implemented as bind mount in Phase 11, then switched back to mknod in Phase 13
  - **Evidence:** Phase 13 SUMMARY - Uses syscall.Mknod (major:minor 259:24)
  - **Rationale:** mknod prevents devtmpfs mount propagation, eliminates mount storms

- [x] **BLOCK-04**: NodeUnpublishVolume unmounts and removes block device file
  - **Outcome:** Validated - os.RemoveAll(targetPath) works for both block and filesystem
  - **Evidence:** Phase 11 VERIFICATION lines 103-104

- [x] **BLOCK-05**: NodeUnstageVolume handles both filesystem and block volumes correctly
  - **Outcome:** Validated - Branches correctly for block vs filesystem volumes
  - **Evidence:** Phase 11 VERIFICATION lines 107-114

### Quality and Compatibility

- [x] **BLOCK-06**: Existing filesystem volume functionality works without regression
  - **Outcome:** Validated - All 4 filesystem tests pass (Stage/Unstage/Publish/Unpublish)
  - **Evidence:** Phase 12 VERIFICATION - Test coverage 48% → 49.7%

- [x] **BLOCK-07**: Clear error messages for invalid volume mode combinations
  - **Outcome:** Validated - Error contains WHAT (problem) + HOW (remediation)
  - **Evidence:** Phase 12 VERIFICATION lines 117-119

### Hardware Validation

- [x] **VAL-01**: KubeVirt VM boots successfully with RDS block volume on metal cluster
  - **Outcome:** Validated - VM reached Running phase, block device accessible as vdb
  - **Evidence:** Phase 13 SUMMARY lines 101-103
  - **Hardware:** CirrOS VM with 5Gi RWX block PVC on RDS storage
  - **Note:** Checkbox in REQUIREMENTS.md not updated during milestone but functionality fully validated

- [x] **VAL-02**: KubeVirt live migration completes end-to-end (VM migrates between nodes)
  - **Outcome:** Validated - Migration succeeded, r740xd → c4140, ~15s duration
  - **Evidence:** Phase 13 SUMMARY lines 109-113
  - **Note:** Checkbox in REQUIREMENTS.md not updated during milestone but functionality fully validated

- [x] **VAL-03**: Migration metrics and events are emitted correctly during validation
  - **Outcome:** Partial - Migration functionally works but metrics not emitted
  - **Evidence:** Phase 13 SUMMARY lines 114-118
  - **Status:** Non-blocking observability gap, deferred to v0.7.0 Phase 16
  - **Mitigation:** KubeVirt emits its own migration metrics at platform level

## Future Requirements

(Deferred to later milestones)

- CSI volume snapshots for block volumes
- Volume cloning support
- Volume expansion for block volumes
- Cluster filesystem support (GFS2/OCFS2) for true RWX filesystem volumes

## Out of Scope

- **Filesystem-mode RWX volumes**: v0.5.0 explicitly rejects these to prevent data corruption; block-only RWX is the correct approach for KubeVirt
- **Volume encryption**: Separate concern, not related to block vs filesystem mode
- **NFS wrapper**: Defeats NVMe/TCP latency benefits; users should use NFS CSI if needed

## Traceability

| Requirement | Phase | Status | Outcome |
|-------------|-------|--------|---------|
| BLOCK-01 | Phase 11 | Complete | Validated - Skip format for block volumes |
| BLOCK-02 | Phase 11 | Complete | Validated - Device metadata written |
| BLOCK-03 | Phase 11 | Complete | Validated - mknod approach (revised in Phase 13) |
| BLOCK-04 | Phase 11 | Complete | Validated - Cleanup works for both modes |
| BLOCK-05 | Phase 11 | Complete | Validated - Branching logic correct |
| BLOCK-06 | Phase 12 | Complete | Validated - No regressions |
| BLOCK-07 | Phase 12 | Complete | Validated - Error messages actionable |
| VAL-01 | Phase 13 | Complete | Validated - VM boot successful |
| VAL-02 | Phase 13 | Complete | Validated - Migration successful |
| VAL-03 | Phase 13 | Partial | Metrics not emitted (deferred to v0.7.0) |

**Coverage:**
- v1 requirements: 10 total
- Fully satisfied: 9
- Partially satisfied: 1 (VAL-03 - non-blocking observability gap)
- Mapped to phases: 10/10 ✓

---

## Phase 14 Implicit Requirements

Phase 14 added comprehensive error resilience features beyond the original v0.6.0 requirements:

- [x] **PROTECT-01**: NQN filtering prevents system volume disconnect
- [x] **PROTECT-02**: Configurable NQN prefix via Helm and env var
- [x] **RESILIENCE-01**: Procmounts parsing timeout (10s)
- [x] **RESILIENCE-02**: Duplicate mount detection (max 100 entries)
- [x] **RESILIENCE-03**: Graceful shutdown within 30s
- [x] **RESILIENCE-04**: Filesystem health check before mount
- [x] **RESILIENCE-05**: Circuit breaker prevents retry storms

All Phase 14 requirements validated per Phase 14 VERIFICATION report.

---

## Milestone Summary

**Shipped:** 9 of 10 v1 requirements fully satisfied, 1 partially satisfied (non-blocking)

**Adjusted During Implementation:**
- BLOCK-03: Initially implemented as bind mount (Phase 11), switched to mknod (Phase 13) to prevent mount storms
- BLOCK-02: Device metadata file created but later made optional for block volumes (Phase 13 architectural change)

**Dropped:** None

**Added During Milestone:**
- Phase 14 error resilience requirements (PROTECT-01/02, RESILIENCE-01/02/03/04) - discovered mount storm issue during Phase 13 execution
- Circuit breaker requirement (RESILIENCE-05) - prevents retry storms on corrupted volumes

**Tech Debt:**
- VAL-03 migration metrics emission deferred to v0.7.0 Phase 16
- Progressive validation tests (VAL-01 through VAL-05 detailed breakdown) skipped - foundation validated in Phases 11-12
- Data integrity checksum test not implemented - relying on NVMe/TCP transport integrity

**Critical Fixes During Validation:**
- commit 0ea6bee: mknod for block volumes (prevents devtmpfs mount storm)
- commit 62197ce: Clear PV annotations on detachment (fixes stale attachment state)
- commit e2303ce: Pre-mount storm detection activated
- commit dc4140f: Smart orphaned mount cleanup

---

*Requirements defined: 2026-02-03*
*Archived: 2026-02-04 as part of v0.6.0 milestone completion*
