# Milestone v0.5: KubeVirt Hotplug Fix

## Problem Statement

KubeVirt has a longstanding bug (since 2021) where hotplugging multiple volumes to the same VM causes I/O errors and VM pauses. When a new volume is hotplugged, KubeVirt recreates the attachment pod, which destroys the block devices serving existing volumes.

**Related Issues:**
- https://github.com/kubevirt/kubevirt/issues/6564 (Oct 2021)
- https://github.com/kubevirt/kubevirt/issues/9708 (May 2023)
- https://github.com/kubevirt/kubevirt/issues/16520 (Jan 2026 - active)

**Impact:** Nested K3s clusters using kubevirt-csi-driver cannot safely attach multiple volumes to VMs.

## Requirements

### KVFIX-01: Fork and CI/CD Setup
Fork kubevirt/kubevirt to our GitHub and configure GitHub Actions to build and push container images to a registry we control.

**Acceptance Criteria:**
- [ ] Fork exists at github.com/<org>/kubevirt
- [ ] GitHub Actions workflow builds virt-controller and virt-handler images
- [ ] Images pushed to ghcr.io or equivalent registry
- [ ] Can deploy custom-built KubeVirt to test cluster

### KVFIX-02: Root Cause Analysis
Deep dive into the attachment pod lifecycle code to understand exactly when and why the old pod is deleted before the new pod is ready.

**Acceptance Criteria:**
- [ ] Document the exact code path that causes the bug
- [ ] Identify the minimal change needed to fix the handoff
- [ ] Create test case that reliably reproduces the issue

### KVFIX-03: Implement Fix
Modify virt-controller to not delete old attachment pods until new pod volumes are ready.

**Acceptance Criteria:**
- [ ] Old attachment pod kept alive during volume handoff
- [ ] New attachment pod fully ready before old pod deletion
- [ ] No regression in single-volume hotplug scenarios
- [ ] No regression in volume removal scenarios

### KVFIX-04: Testing and Validation
Verify the fix works in our nested K3s environment.

**Acceptance Criteria:**
- [ ] Multi-volume hotplug test passes (3+ volumes simultaneously)
- [ ] No VM pauses or I/O errors during hotplug
- [ ] Live migration with hotplugged volumes still works
- [ ] Volume removal still works correctly

### KVFIX-05: Upstream Contribution
Prepare the fix for upstream contribution to kubevirt/kubevirt.

**Acceptance Criteria:**
- [ ] PR opened against kubevirt/kubevirt
- [ ] Includes unit tests
- [ ] Includes e2e test if feasible
- [ ] Passes upstream CI

## Out of Scope

- Fixes to kubevirt-csi-driver (separate repo)
- Changes to rds-csi-driver
- General KubeVirt improvements unrelated to hotplug

## Dependencies

- Access to test cluster with KubeVirt
- Nested K3s environment for validation
- Container registry for custom images

---

*Created: 2026-01-31*
*Motivation: GitHub issue #12 - concurrent volume operations causing VM pauses*
