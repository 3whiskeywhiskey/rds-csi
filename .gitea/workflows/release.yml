name: Release

# Full test suite + multi-arch build for tagged releases
# Triggered manually or by pushing a tag

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.9.0)'
        required: true
        type: string

env:
  REGISTRY: git.whiskey.works
  IMAGE_NAME: whiskey/rds-csi

jobs:
  full-test:
    name: Run Full Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          go mod download
          make install-tools

      - name: Run all tests
        run: |
          echo "Running verification..."
          make verify

          echo "Running unit tests..."
          make test

          echo "Running sanity tests..."
          go test -v -race -timeout 15m ./test/sanity/...

          echo "Running stress tests..."
          go test -v -race -timeout 5m ./test/mock/... -run TestConcurrent

          echo "âœ… All tests passed"

      - name: Check coverage
        run: |
          make test-coverage
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"

          if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            echo "âŒ Coverage ${COVERAGE}% is below 60% threshold"
            exit 1
          fi

  build-release:
    name: Build Release Images
    runs-on: ubuntu-latest
    needs: full-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${{ github.ref_name }}"
          fi

          GIT_COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${GIT_COMMIT}" >> $GITHUB_OUTPUT
          echo "date=${BUILD_DATE}" >> $GITHUB_OUTPUT

          echo "Building release ${VERSION}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Uncomment when ready to push to registry
      # - name: Log in to registry
      #   run: echo "${{ secrets.REGISTRY_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.REGISTRY_USER }} --password-stdin

      - name: Build multi-arch images
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-arg GIT_COMMIT=${{ steps.version.outputs.commit }} \
            --build-arg GIT_TAG=${{ steps.version.outputs.version }} \
            --build-arg BUILD_DATE=${{ steps.version.outputs.date }} \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --load \
            .

          echo "âœ… Multi-arch images built"

      # Uncomment when ready to push to registry
      # - name: Push images
      #   run: |
      #     docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
      #     docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Create release notes
        id: notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          PREV_TAG=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")

          cat > release-notes.md <<EOF
          ## Release ${VERSION}

          **Built:** ${{ steps.version.outputs.date }}
          **Commit:** ${{ steps.version.outputs.commit }}

          ### Container Images

          \`\`\`
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          \`\`\`

          **Platforms:** linux/amd64, linux/arm64

          EOF

          if [ -n "$PREV_TAG" ]; then
            echo "### Changes since ${PREV_TAG}" >> release-notes.md
            echo "" >> release-notes.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%an)" --no-merges >> release-notes.md
          fi

          cat release-notes.md

      # Create Gitea release using tea CLI
      # Uncomment and configure when tea is available
      # - name: Create Gitea release
      #   run: |
      #     tea release create \
      #       --tag ${{ steps.version.outputs.version }} \
      #       --title "Release ${{ steps.version.outputs.version }}" \
      #       --note "$(cat release-notes.md)" \
      #       --asset ./bin/rds-csi-plugin-*

      - name: Release summary
        run: |
          echo "## ðŸŽ‰ Release ${{ steps.version.outputs.version }}"
          echo ""
          echo "âœ… Tests passed"
          echo "âœ… Multi-arch images built"
          echo ""
          echo "**Next steps:**"
          echo "1. Uncomment registry push in this workflow"
          echo "2. Configure tea CLI for Gitea releases"
          echo "3. Push images and create release"
